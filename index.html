<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>ZAPHYROS Tools v3</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=DM+Sans:wght@400;500&family=Dancing+Script:wght@600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
/* â”€â”€â”€ TEMEL AYARLAR â”€â”€â”€ */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0d0d11; --surf:#16161e; --surf2:#1e1e28;
  --acc:#f5c842; --green:#3db87a; --red:#e05252;
  --text:#edeae2; --muted:#6a6a7e; --border:#252530;
}
html,body{height:100%;overflow:hidden;background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif}
body{display:flex;flex-direction:column;max-width:100vw;}

/* â”€â”€â”€ HEADER â”€â”€â”€ */
header{
  flex-shrink:0;display:flex;align-items:center;justify-content:space-between;
  padding:8px 12px;background:var(--surf);border-bottom:1px solid var(--border);height:56px;
}
.h-title{font-family:'Syne',sans-serif;font-weight:800;font-size:1rem;}
.h-title span{color:var(--acc)}
.h-sig{font-family:'Dancing Script',cursive;color:var(--acc);font-size:0.9rem;margin-top:-2px}

/* â”€â”€â”€ NAVIGASYON (DÃœZELTÄ°LMÄ°Å) â”€â”€â”€ */
.nav-cards{
  flex-shrink:0;display:grid;grid-template-columns:repeat(4,1fr);gap:5px;padding:8px;
}
.nc{
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  padding:8px 2px;border-radius:10px;cursor:pointer;
  font-family:'Syne',sans-serif;font-weight:700;font-size:.6rem;text-align:center;
  color:#fff;opacity:0.5;transition:0.2s;border:2px solid transparent;
}
.nc.active{opacity:1;border-color:rgba(255,255,255,0.4);transform:translateY(-2px)}
.nc-icon{font-size:1.1rem;margin-bottom:2px}
/* Renkler */
.nc[data-tab="photo"]{background:linear-gradient(135deg,#1d4ed8,#2563eb)}
.nc[data-tab="merge"]{background:linear-gradient(135deg,#047857,#059669)}
.nc[data-tab="split"]{background:linear-gradient(135deg,#b45309,#d97706)} /* Yan Yana */
.nc[data-tab="sign"] {background:linear-gradient(135deg,#6d28d9,#7c3aed)}

/* â”€â”€â”€ SEKME YAPISI â”€â”€â”€ */
.tab-panel{display:none;flex:1;flex-direction:column;overflow:hidden;min-height:0}
.tab-panel.active{display:flex}
.scroll-area{flex:1;overflow-y:auto;padding:10px;-webkit-overflow-scrolling:touch}

/* â”€â”€â”€ DROP ZONE & INPUTS â”€â”€â”€ */
.dz{
  border:2px dashed var(--border);border-radius:10px;padding:20px;text-align:center;
  background:var(--surf);position:relative;margin-bottom:10px;
}
.dz input{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;z-index:10}

/* â”€â”€â”€ LÄ°STELER â”€â”€â”€ */
#photo-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:8px}
.pi{position:relative;border-radius:8px;overflow:hidden;background:var(--surf2);aspect-ratio:1}
.pi img{width:100%;height:100%;object-fit:cover}
.pi-del{
  position:absolute;top:2px;right:2px;background:rgba(220,38,38,0.8);color:#fff;
  border:none;width:24px;height:24px;border-radius:4px;z-index:5;
}

.mi{
  display:flex;align-items:center;padding:10px;background:var(--surf);
  border:1px solid var(--border);border-radius:8px;margin-bottom:6px;
}
.mi-name{flex:1;font-size:0.8rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin:0 10px}

/* â”€â”€â”€ BUTONLAR (ALT BAR) â”€â”€â”€ */
.abar{
  padding:10px;background:var(--surf);border-top:1px solid var(--border);
  display:flex;gap:8px;padding-bottom:calc(10px + env(safe-area-inset-bottom));
}
.btn{
  border:none;border-radius:8px;font-family:'Syne',sans-serif;font-weight:700;
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  transition:0.2s;height:44px;
}
.btn:disabled{opacity:0.3;cursor:not-allowed}
.btn-sm{width:44px;background:var(--surf2);color:var(--text);border:1px solid var(--border)}
.btn-main{flex:1;color:#fff;font-size:0.9rem}
.bg-blue{background:#2563eb} .bg-green{background:#059669} 
.bg-orange{background:#d97706} .bg-purple{background:#7c3aed} .bg-red{background:#dc2626}

/* â”€â”€â”€ PAYLAÅIM BARI â”€â”€â”€ */
.share-bar{
  display:none;gap:8px;padding:10px;background:#132e22;border-top:1px solid #1f4b37;
  padding-bottom:calc(10px + env(safe-area-inset-bottom));
}
.share-bar.visible{display:flex}

/* â”€â”€â”€ Ä°MZA / BÃ–LME Ã–ZEL â”€â”€â”€ */
.empty-state{
  flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;
  color:var(--muted);gap:15px;text-align:center;padding:20px;
}
.file-btn{
  position:relative;background:var(--surf2);border:1px solid var(--border);
  padding:10px 20px;border-radius:8px;color:var(--text);font-weight:600;
}
.file-btn input{position:absolute;inset:0;opacity:0;cursor:pointer}

/* Ä°mza Kanvas AlanÄ± */
.sign-area{flex:1;background:#0a0a0e;position:relative;overflow:hidden;display:flex;justify-content:center;align-items:center}
.sign-cvs-wrap{position:relative;box-shadow:0 0 20px rgba(0,0,0,0.5)}
.sign-cvs-wrap canvas{display:block;max-width:100%;}
.sov{position:absolute;border:2px dashed var(--acc);cursor:move;z-index:100}
.sov img{width:100%;height:100%;display:block;pointer-events:none}
.sov-del{
  position:absolute;top:-12px;right:-12px;width:24px;height:24px;
  background:red;color:white;border-radius:50%;text-align:center;line-height:24px;
  cursor:pointer;pointer-events:auto;
}
.close-doc{
  position:absolute;top:10px;right:10px;z-index:999;
  background:rgba(220,38,38,0.9);color:white;border:none;
  padding:5px 10px;border-radius:6px;font-weight:bold;cursor:pointer;
}

/* â”€â”€â”€ PROGRESS & MODAL â”€â”€â”€ */
.overlay{
  position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:2000;
  display:none;align-items:center;justify-content:center;flex-direction:column;
}
.overlay.open{display:flex}
.toast{
  position:fixed;top:20px;left:50%;transform:translateX(-50%);
  background:var(--surf2);border:1px solid var(--acc);padding:8px 16px;
  border-radius:20px;z-index:3000;display:none;font-size:0.8rem;
}
.split-grid{
  display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:8px;padding:10px;
}
.sp-page{border:2px solid transparent;border-radius:6px;overflow:hidden;opacity:0.6;cursor:pointer}
.sp-page.sel{border-color:var(--acc);opacity:1;transform:scale(0.95)}
</style>
</head>
<body>

<header>
  <div class="h-title">ZAPHYROS <span>Tools</span></div>
  <div class="h-sig">v3.0</div>
</header>

<div class="nav-cards">
  <div class="nc active" data-tab="photo">
    <div class="nc-icon">ğŸ“·</div><div>Foto</div>
  </div>
  <div class="nc" data-tab="merge">
    <div class="nc-icon">ğŸ”—</div><div>BirleÅŸtir</div>
  </div>
  <div class="nc" data-tab="split">
    <div class="nc-icon">âœ‚ï¸</div><div>BÃ¶l</div>
  </div>
  <div class="nc" data-tab="sign">
    <div class="nc-icon">âœï¸</div><div>Ä°mzala</div>
  </div>
</div>

<div class="tab-panel active" id="tab-photo">
  <div class="scroll-area">
    <div class="dz">
      <input type="file" id="phInput" multiple accept="image/*">
      <div style="font-size:2rem">ğŸ“·</div>
      <div>FotoÄŸraf Ekle</div>
    </div>
    <div id="photo-list"></div>
  </div>
  <div class="abar">
    <button class="btn btn-sm bg-red" id="phClear">ğŸ—‘</button>
    <button class="btn btn-main bg-blue" id="phMake">ğŸ“„ PDF Yap</button>
  </div>
  <div class="share-bar" id="sb-photo">
    <button class="btn btn-main bg-green share-trigger">Whatsapp / PaylaÅŸ</button>
    <button class="btn btn-sm dl-trigger">â¬‡</button>
  </div>
</div>

<div class="tab-panel" id="tab-merge">
  <div class="scroll-area">
    <div class="dz">
      <input type="file" id="mgInput" multiple accept="application/pdf">
      <div style="font-size:2rem">ğŸ”—</div>
      <div>PDF Ekle</div>
    </div>
    <div id="merge-list"></div>
  </div>
  <div class="abar">
    <button class="btn btn-sm bg-red" id="mgClear">ğŸ—‘</button>
    <button class="btn btn-main bg-green" id="mgMake">ğŸ”— BirleÅŸtir</button>
  </div>
  <div class="share-bar" id="sb-merge">
    <button class="btn btn-main bg-green share-trigger">PaylaÅŸ</button>
    <button class="btn btn-sm dl-trigger">â¬‡</button>
  </div>
</div>

<div class="tab-panel" id="tab-split">
  <div class="empty-state" id="sp-empty">
    <div style="font-size:3rem">âœ‚ï¸</div>
    <h3>PDF BÃ¶l</h3>
    <button class="file-btn">
      ğŸ“„ PDF SeÃ§
      <input type="file" id="spInput" accept="application/pdf">
    </button>
  </div>
  
  <div id="sp-loaded" style="display:none;flex:1;flex-direction:column;overflow:hidden">
    <div style="padding:10px;background:var(--surf2);font-size:0.8rem;text-align:center">
      SeÃ§ili: <b id="sp-sel-count">0</b> sayfa
    </div>
    <div class="scroll-area" id="sp-grid"></div>
  </div>

  <div class="abar" id="sp-abar" style="display:none">
    <button class="btn btn-sm bg-red" id="spClear">âœ•</button>
    <button class="btn btn-main bg-orange" id="spMake">âœ‚ï¸ BÃ¶l ve Ä°ndir</button>
  </div>
  <div class="share-bar" id="sb-split">
    <button class="btn btn-main bg-green share-trigger">PaylaÅŸ</button>
    <button class="btn btn-sm dl-trigger">â¬‡</button>
  </div>
</div>

<div class="tab-panel" id="tab-sign">
  <div class="empty-state" id="sg-empty">
    <div style="font-size:3rem">âœï¸</div>
    <h3>Ä°mzala</h3>
    <button class="file-btn">
      ğŸ“„ PDF SeÃ§
      <input type="file" id="sgInput" accept="application/pdf">
    </button>
    <button class="file-btn">
      ğŸ–¼ï¸ Resim SeÃ§
      <input type="file" id="sgImgInput" accept="image/*">
    </button>
  </div>

  <div id="sg-loaded" style="display:none;flex:1;flex-direction:column;position:relative">
    <button class="close-doc" id="sgClose">KAPAT âœ•</button>
    <div class="sign-area">
      <div class="sign-cvs-wrap" id="sgWrap">
        <canvas id="sgCanvas"></canvas>
      </div>
    </div>
    <div style="padding:10px;background:var(--surf2);display:flex;justify-content:center;gap:10px">
      <button class="btn btn-sm" id="sgPrev">â—„</button>
      <span style="align-self:center" id="sgPageInd">1 / 1</span>
      <button class="btn btn-sm" id="sgNext">â–º</button>
    </div>
  </div>

  <div class="abar" id="sg-abar" style="display:none">
    <button class="btn btn-main bg-purple" id="sgDrawBtn">âœï¸ Ä°mza Ã‡iz</button>
    <button class="btn btn-main bg-blue" id="sgSaveBtn">ğŸ’¾ Kaydet</button>
  </div>
  <div class="share-bar" id="sb-sign">
    <button class="btn btn-main bg-green share-trigger">PaylaÅŸ</button>
    <button class="btn btn-sm dl-trigger">â¬‡</button>
  </div>
</div>

<div class="overlay" id="drawModal">
  <div style="background:#fff;padding:10px;border-radius:10px;width:95%;max-width:400px">
    <h3 style="color:#000;margin-bottom:10px">Ä°mzanÄ± Ã‡iz</h3>
    <canvas id="pad" style="border:1px solid #ccc;width:100%;height:200px;touch-action:none"></canvas>
    <div style="display:flex;gap:10px;margin-top:10px">
      <button class="btn btn-main bg-red" onclick="clearPad()">Temizle</button>
      <button class="btn btn-main bg-green" onclick="savePad()">Tamam</button>
    </div>
    <button class="btn btn-sm" style="width:100%;margin-top:5px;background:#eee;color:#000" onclick="closePad()">Ä°ptal</button>
  </div>
</div>

<div class="overlay" id="loader">
  <div style="color:#fff;font-size:1.5rem">Ä°ÅŸleniyor...</div>
</div>
<div class="toast" id="toast">Bildirim</div>

<script>
/* â”€â”€â”€ GÃœVENLÄ° DOM BAÄLAYICI â”€â”€â”€ */
function on(id, evt, fn) {
  const el = document.getElementById(id);
  if(el) el.addEventListener(evt, fn);
  else console.warn('Element not found:', id);
}
function el(id) { return document.getElementById(id); }
function show(id) { if(el(id)) el(id).style.display = 'flex'; }
function hide(id) { if(el(id)) el(id).style.display = 'none'; }
function notify(msg) { 
  const t = el('toast'); t.textContent=msg; t.style.display='block'; 
  setTimeout(()=>t.style.display='none', 3000);
}

// Global DeÄŸiÅŸkenler
const pdfjs = window.pdfjsLib;
pdfjs.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
const { PDFDocument } = PDFLib;

let photos = [];
let mergeFiles = [];
let splitBytes = null, splitDoc = null, splitSel = new Set();
let signBytes = null, signDoc = null, signPage = 1, signTotal = 0, signScale = 1;
let signatures = []; // {page:1, x, y, w, h, data}
let isSignImg = false; 

/* â”€â”€â”€ NAVIGASYON â”€â”€â”€ */
document.querySelectorAll('.nc').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.nc').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    btn.classList.add('active');
    el('tab-' + btn.dataset.tab).classList.add('active');
  });
});

/* â”€â”€â”€ 1. FOTOÄRAF â”€â”€â”€ */
on('phInput', 'change', e => {
  Array.from(e.target.files).forEach(f => {
    const reader = new FileReader();
    reader.onload = ev => {
      photos.push(ev.target.result);
      renderPhotos();
    };
    reader.readAsDataURL(f);
  });
  e.target.value = '';
});

function renderPhotos() {
  const list = el('photo-list'); list.innerHTML = '';
  photos.forEach((src, i) => {
    const div = document.createElement('div'); div.className = 'pi';
    div.innerHTML = `<img src="${src}"><button class="pi-del" onclick="delPhoto(${i})">âœ•</button>`;
    list.appendChild(div);
  });
}
window.delPhoto = i => { photos.splice(i, 1); renderPhotos(); };
on('phClear', 'click', () => { photos = []; renderPhotos(); });

on('phMake', 'click', async () => {
  if(!photos.length) return notify('FotoÄŸraf yok!');
  el('loader').classList.add('open');
  try {
    const doc = new window.jspdf.jsPDF();
    for(let i=0; i<photos.length; i++) {
      if(i>0) doc.addPage();
      const img = new Image(); img.src = photos[i];
      await new Promise(r => img.onload = r);
      // Basit A4 sÄ±ÄŸdÄ±rma
      const props = doc.getImageProperties(img);
      const pdfW = 210, pdfH = 297;
      const ratio = props.width / props.height;
      let w = pdfW, h = w / ratio;
      if(h > pdfH) { h = pdfH; w = h * ratio; }
      doc.addImage(photos[i], 'JPEG', (pdfW-w)/2, (pdfH-h)/2, w, h);
    }
    const blob = doc.output('blob');
    prepareShare('sb-photo', blob, 'photos.pdf');
    notify('PDF HazÄ±r!');
  } catch(e) { notify('Hata: ' + e.message); }
  el('loader').classList.remove('open');
});

/* â”€â”€â”€ 2. BÄ°RLEÅTÄ°RME â”€â”€â”€ */
on('mgInput', 'change', async e => {
  for(let f of e.target.files) {
    mergeFiles.push({ name: f.name, data: await f.arrayBuffer() });
  }
  renderMerge();
  e.target.value = '';
});

function renderMerge() {
  const list = el('merge-list'); list.innerHTML = '';
  mergeFiles.forEach((f, i) => {
    const div = document.createElement('div'); div.className = 'mi';
    div.innerHTML = `<div class="mi-name">${f.name}</div><button style="color:red;border:none;background:none" onclick="delMerge(${i})">âœ•</button>`;
    list.appendChild(div);
  });
}
window.delMerge = i => { mergeFiles.splice(i, 1); renderMerge(); };
on('mgClear', 'click', () => { mergeFiles = []; renderMerge(); });

on('mgMake', 'click', async () => {
  if(mergeFiles.length < 2) return notify('En az 2 PDF gerekli');
  el('loader').classList.add('open');
  try {
    const merged = await PDFDocument.create();
    for(let file of mergeFiles) {
      const src = await PDFDocument.load(file.data);
      const pages = await merged.copyPages(src, src.getPageIndices());
      pages.forEach(p => merged.addPage(p));
    }
    const bytes = await merged.save();
    prepareShare('sb-merge', new Blob([bytes], {type:'application/pdf'}), 'merged.pdf');
    notify('BirleÅŸtirildi!');
  } catch(e) { notify('Hata: ' + e.message); }
  el('loader').classList.remove('open');
});

/* â”€â”€â”€ 3. BÃ–LME (Fix: ID ve ShareBar) â”€â”€â”€ */
on('spInput', 'change', async e => {
  const f = e.target.files[0]; if(!f) return;
  el('loader').classList.add('open');
  try {
    splitBytes = await f.arrayBuffer();
    splitDoc = await pdfjs.getDocument(splitBytes.slice(0)).promise;
    splitSel.clear();
    
    // Grid oluÅŸtur
    const grid = el('sp-grid'); grid.innerHTML = '';
    for(let i=1; i<=splitDoc.numPages; i++) {
      const div = document.createElement('div'); 
      div.className = 'sp-page'; div.textContent = i;
      div.style.display = 'flex'; div.style.alignItems='center'; div.style.justifyContent='center';
      div.style.background = '#fff'; div.style.color='#000'; div.style.fontWeight='bold';
      
      div.onclick = () => {
        if(splitSel.has(i)) splitSel.delete(i); else splitSel.add(i);
        div.classList.toggle('sel');
        el('sp-sel-count').innerText = splitSel.size;
      };
      grid.appendChild(div);
    }
    
    hide('sp-empty'); show('sp-loaded'); show('sp-abar');
    // Ã–nceki paylaÅŸÄ±m barÄ±nÄ± gizle
    el('sb-split').classList.remove('visible');
  } catch(e) { notify('PDF aÃ§Ä±lamadÄ±'); }
  el('loader').classList.remove('open');
  e.target.value = '';
});

on('spClear', 'click', () => {
  hide('sp-loaded'); hide('sp-abar'); show('sp-empty');
  el('sb-split').classList.remove('visible');
  splitBytes = null;
});

on('spMake', 'click', async () => {
  if(!splitSel.size) return notify('Sayfa seÃ§medin!');
  el('loader').classList.add('open');
  try {
    const src = await PDFDocument.load(splitBytes);
    const newDoc = await PDFDocument.create();
    const indices = Array.from(splitSel).sort((a,b)=>a-b).map(p => p-1);
    const pages = await newDoc.copyPages(src, indices);
    pages.forEach(p => newDoc.addPage(p));
    const bytes = await newDoc.save();
    
    prepareShare('sb-split', new Blob([bytes], {type:'application/pdf'}), 'split.pdf');
    notify('BÃ¶lÃ¼ndÃ¼!');
  } catch(e) { notify('Hata: ' + e.message); }
  el('loader').classList.remove('open');
});

/* â”€â”€â”€ 4. Ä°MZALA (Fix: Kapatma ve Ã‡Ã¶kme) â”€â”€â”€ */
on('sgInput', 'change', async e => loadSignFile(e.target.files[0], false));
on('sgImgInput', 'change', async e => loadSignFile(e.target.files[0], true));

async function loadSignFile(f, isImg) {
  if(!f) return;
  el('loader').classList.add('open');
  isSignImg = isImg;
  signatures = [];
  try {
    if(isImg) {
      const url = URL.createObjectURL(f);
      const img = new Image(); img.src = url;
      await new Promise(r => img.onload = r);
      const cvs = el('sgCanvas');
      // Max width constraint
      const maxW = window.innerWidth - 20;
      signScale = Math.min(maxW / img.width, 1);
      cvs.width = img.width * signScale;
      cvs.height = img.height * signScale;
      cvs.getContext('2d').drawImage(img, 0, 0, cvs.width, cvs.height);
      signPage = 1; signTotal = 1;
      signBytes = f; // Blob olarak sakla
    } else {
      signBytes = await f.arrayBuffer();
      signDoc = await pdfjs.getDocument(signBytes.slice(0)).promise;
      signTotal = signDoc.numPages;
      signPage = 1;
      await renderSignPage();
    }
    
    hide('sg-empty'); show('sg-loaded'); show('sg-abar');
    el('sb-sign').classList.remove('visible');
    el('sgPageInd').textContent = `${signPage} / ${signTotal}`;
  } catch(e) { notify('Dosya aÃ§ma hatasÄ±'); console.log(e)}
  el('loader').classList.remove('open');
}

// PDF Sayfa Render
async function renderSignPage() {
  if(isSignImg) return;
  const page = await signDoc.getPage(signPage);
  const vp = page.getViewport({scale: 1});
  const cvs = el('sgCanvas');
  const maxW = window.innerWidth - 20;
  signScale = Math.min(maxW / vp.width, 1.5); // Mobile zoom
  const scaledVp = page.getViewport({scale: signScale});
  
  cvs.width = scaledVp.width;
  cvs.height = scaledVp.height;
  await page.render({canvasContext: cvs.getContext('2d'), viewport: scaledVp}).promise;
  
  // Ä°mzalarÄ± tekrar yerleÅŸtir (sadece bu sayfa iÃ§in olanlarÄ± gÃ¶ster)
  document.querySelectorAll('.sov').forEach(e => e.remove());
  signatures.filter(s => s.page === signPage).forEach(addSigToDom);
}

// Dosya Kapatma
on('sgClose', 'click', () => {
  hide('sg-loaded'); hide('sg-abar'); show('sg-empty');
  el('sb-sign').classList.remove('visible');
  document.querySelectorAll('.sov').forEach(e => e.remove());
  signatures = []; signBytes = null;
});

// Sayfa GeÃ§iÅŸ
on('sgPrev', 'click', () => { if(signPage > 1) { signPage--; renderSignPage(); el('sgPageInd').textContent=`${signPage} / ${signTotal}`; }});
on('sgNext', 'click', () => { if(signPage < signTotal) { signPage++; renderSignPage(); el('sgPageInd').textContent=`${signPage} / ${signTotal}`; }});

/* â”€â”€â”€ Ä°MZA EKLEME MANTIÄI â”€â”€â”€ */
on('sgDrawBtn', 'click', () => {
  el('drawModal').classList.add('open');
  setupPad();
});

let padCtx;
function setupPad() {
  const cvs = el('pad');
  cvs.width = cvs.clientWidth; cvs.height = 200;
  padCtx = cvs.getContext('2d');
  padCtx.lineWidth = 3; padCtx.lineCap = 'round';
  
  let drawing = false;
  cvs.onpointerdown = e => { drawing = true; padCtx.beginPath(); padCtx.moveTo(e.offsetX, e.offsetY); }
  cvs.onpointermove = e => { if(drawing) { padCtx.lineTo(e.offsetX, e.offsetY); padCtx.stroke(); }}
  cvs.onpointerup = () => drawing = false;
}
window.clearPad = () => padCtx.clearRect(0,0,999,999);
window.closePad = () => el('drawModal').classList.remove('open');
window.savePad = () => {
  const data = el('pad').toDataURL();
  addSigToDom({page: signPage, x: 50, y: 50, w: 100, h: 50, data: data});
  signatures.push({page: signPage, x: 50, y: 50, w: 100, h: 50, data: data});
  closePad();
};

function addSigToDom(sig) {
  const div = document.createElement('div');
  div.className = 'sov';
  div.style.left = sig.x + 'px'; div.style.top = sig.y + 'px';
  div.style.width = sig.w + 'px'; div.style.height = sig.h + 'px';
  
  div.innerHTML = `<img src="${sig.data}"><div class="sov-del">âœ•</div>`;
  el('sgWrap').appendChild(div);
  
  // Silme
  div.querySelector('.sov-del').addEventListener('touchstart', (e) => {
    e.stopPropagation(); // Touch event bubbling'i engelle
    div.remove();
    const idx = signatures.indexOf(sig);
    if(idx > -1) signatures.splice(idx, 1);
  }, {passive: false});
    // Click fallback for desktop
    div.querySelector('.sov-del').addEventListener('click', (e) => {
    e.stopPropagation(); 
    div.remove();
    const idx = signatures.indexOf(sig);
    if(idx > -1) signatures.splice(idx, 1);
  });

  // Basit SÃ¼rÃ¼kleme
  let isDrag = false, sx=0, sy=0;
  div.addEventListener('touchstart', e => {
    isDrag = true; sx = e.touches[0].clientX - div.offsetLeft; sy = e.touches[0].clientY - div.offsetTop;
  });
  div.addEventListener('touchmove', e => {
    if(!isDrag) return;
    e.preventDefault();
    const x = e.touches[0].clientX - sx;
    const y = e.touches[0].clientY - sy;
    div.style.left = x + 'px'; div.style.top = y + 'px';
    sig.x = x; sig.y = y;
  });
  div.addEventListener('touchend', () => isDrag = false);
}

on('sgSaveBtn', 'click', async () => {
  if(!signatures.length) return notify('Ä°mza yok!');
  el('loader').classList.add('open');
  try {
    if(isSignImg) {
      // Resim Ã¼zerine Ã§iz
      const cvs = document.createElement('canvas');
      const baseImg = new Image(); baseImg.src = URL.createObjectURL(signBytes);
      await new Promise(r => baseImg.onload = r);
      cvs.width = baseImg.width; cvs.height = baseImg.height;
      const ctx = cvs.getContext('2d');
      ctx.drawImage(baseImg, 0, 0);
      
      // Ä°mzalarÄ± yerleÅŸtir (Scale faktÃ¶rÃ¼nÃ¼ tersine Ã§evir)
      const ratio = baseImg.width / el('sgCanvas').width;
      signatures.forEach(s => {
        const img = new Image(); img.src = s.data;
        ctx.drawImage(img, s.x * ratio, s.y * ratio, s.w * ratio, s.h * ratio);
      });
      cvs.toBlob(b => prepareShare('sb-sign', b, 'signed.png'));
    } else {
      // PDF
      const pdfDoc = await PDFDocument.load(signBytes);
      for(let s of signatures) {
        const page = pdfDoc.getPages()[s.page-1];
        const {width, height} = page.getSize();
        // Koordinat dÃ¶nÃ¼ÅŸÃ¼mÃ¼ (DOM -> PDF)
        const cvsW = el('sgCanvas').width;
        const cvsH = el('sgCanvas').height;
        const scaleX = width / cvsW;
        const scaleY = height / cvsH;
        
        const img = await pdfDoc.embedPng(s.data);
        page.drawImage(img, {
          x: s.x * scaleX,
          y: height - ((s.y + s.h) * scaleY), // PDF koordinat sistemi ters
          width: s.w * scaleX,
          height: s.h * scaleY
        });
      }
      const bytes = await pdfDoc.save();
      prepareShare('sb-sign', new Blob([bytes], {type:'application/pdf'}), 'signed.pdf');
    }
    notify('Ä°mzalandÄ±!');
  } catch(e) { notify('Hata: ' + e.message); console.log(e)}
  el('loader').classList.remove('open');
});

/* â”€â”€â”€ PAYLAÅIM FONKSÄ°YONU â”€â”€â”€ */
function prepareShare(barId, blob, name) {
  const bar = el(barId);
  bar.classList.add('visible');
  
  // Ã–nceki listenerlarÄ± temizlemek iÃ§in klonlama
  const newBar = bar.cloneNode(true);
  bar.parentNode.replaceChild(newBar, bar);
  
  newBar.querySelector('.share-trigger').onclick = async () => {
    const file = new File([blob], name, { type: blob.type });
    if(navigator.share && navigator.canShare({ files: [file] })) {
      try { await navigator.share({ files: [file], title: 'Zaphyros' }); } 
      catch(e) { if(e.name !== 'AbortError') alert('PaylaÅŸÄ±m hatasÄ±: ' + e.message); }
    } else {
      alert('CihazÄ±nÄ±z doÄŸrudan paylaÅŸÄ±mÄ± desteklemiyor, indirme baÅŸlÄ±yor.');
      dlFile(blob, name);
    }
  };
  
  newBar.querySelector('.dl-trigger').onclick = () => dlFile(blob, name);
}

function dlFile(blob, name) {
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = name;
  a.click();
}

</script>
</body>
</html>

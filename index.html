<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>ZAPHYROS Photo Tools</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=DM+Sans:wght@400;500&family=Dancing+Script:wght@600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0d0d11;--surf:#16161e;--surf2:#1e1e28;--surf3:#252530;
  --acc:#f5c842;--acc2:#f07840;--green:#3db87a;--red:#e05252;
  --blue:#2563eb;--teal:#059669;--purple:#7c3aed;
  --text:#edeae2;--muted:#6a6a7e;--border:#252530;
  --ease:cubic-bezier(.4,0,.2,1);
}
html,body{height:100%;overflow:hidden}
body{
  font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);
  display:flex;flex-direction:column;height:100dvh;max-width:100vw;overflow-x:hidden;
}

/* â”€â”€â”€ HEADER â”€â”€â”€ */
header{
  flex-shrink:0;display:flex;align-items:center;justify-content:space-between;
  padding:8px 12px;background:var(--surf);border-bottom:1px solid var(--border);
  gap:8px;min-height:56px;
}
.h-brand{
  display:flex;flex-direction:column;align-items:flex-start;gap:0;flex-shrink:0;
}
.h-title{
  font-family:'Syne',sans-serif;font-weight:800;font-size:1rem;
  color:var(--text);letter-spacing:-.2px;line-height:1.1;
}
.h-title span{color:var(--acc)}
.h-sig{
  font-family:'Dancing Script',cursive;font-weight:600;font-size:.88rem;
  background:linear-gradient(120deg,#f5c842,#e8920a);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
  filter:drop-shadow(0 0 6px rgba(245,200,66,.4));
  letter-spacing:.5px;line-height:1.2;margin-top:-1px;
}
.h-right{display:flex;align-items:center;gap:6px;flex-shrink:0}
.lang-btn{
  background:var(--surf2);border:1px solid var(--border);
  color:var(--muted);font-family:'Syne',sans-serif;font-weight:700;font-size:.66rem;
  padding:4px 7px;border-radius:7px;cursor:pointer;
  touch-action:manipulation;transition:all .15s;flex-shrink:0;
}
.lang-btn.active{background:var(--acc);border-color:var(--acc);color:#111}
.hpill{
  background:var(--surf2);border:1px solid var(--border);
  padding:4px 10px;border-radius:999px;font-size:.7rem;color:var(--muted);white-space:nowrap;
}
.hpill b{color:var(--acc)}

/* â”€â”€â”€ NAV CARDS â”€â”€â”€ */
.nav-cards{
  flex-shrink:0;display:grid;grid-template-columns:repeat(4,1fr);gap:6px;
  padding:8px 10px;
}
.nc{
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:3px;padding:10px 2px;border-radius:12px;border:2px solid transparent;
  cursor:pointer;font-family:'Syne',sans-serif;font-weight:700;font-size:.63rem;
  text-align:center;line-height:1.2;color:#fff;
  transition:opacity .13s,border-color .13s,transform .1s;
  touch-action:manipulation;-webkit-tap-highlight-color:transparent;user-select:none;
}
.nc:active{transform:scale(.93)}
.nc.active{border-color:rgba(255,255,255,.5);box-shadow:0 3px 14px rgba(0,0,0,.4)}
.nc:not(.active){opacity:.5}
.nc-icon{font-size:1.2rem;line-height:1}
.nc.c1{background:linear-gradient(135deg,#1d4ed8,#2563eb)}
.nc.c2{background:linear-gradient(135deg,#047857,#059669)}
.nc.c3{background:linear-gradient(135deg,#6d28d9,#7c3aed)}
.nc.c4{background:linear-gradient(135deg,#b45309,#d97706)}

/* â”€â”€â”€ TAB PANELS â”€â”€â”€ */
.tab-panel{display:none;flex:1;flex-direction:column;overflow:hidden;min-height:0;min-width:0}
.tab-panel.active{display:flex}
.scroll{
  flex:1;overflow-y:auto;overflow-x:hidden;
  -webkit-overflow-scrolling:touch;padding:10px;
}

/* â”€â”€â”€ SETTINGS BAR â”€â”€â”€ */
.sbar{
  flex-shrink:0;display:flex;gap:8px;padding:7px 10px;
  background:var(--surf);border-bottom:1px solid var(--border);
  overflow-x:auto;scrollbar-width:none;
}
.sbar::-webkit-scrollbar{display:none}
.sc{display:flex;flex-direction:column;gap:2px;flex-shrink:0}
.sc label{font-size:.59rem;color:var(--muted);text-transform:uppercase;letter-spacing:.06em}
select{
  background:var(--surf2);border:1px solid var(--border);color:var(--text);
  border-radius:7px;padding:5px 8px;font-size:.78rem;font-family:inherit;cursor:pointer;outline:none;
}
input[type=range]{accent-color:var(--acc);cursor:pointer;width:80px}
.qval{font-size:.75rem;color:var(--acc);font-weight:700;min-width:28px}

/* â”€â”€â”€ DROP ZONE â”€â”€â”€ */
.dz{
  border:2px dashed var(--border);border-radius:11px;padding:20px 12px;
  text-align:center;background:var(--surf);cursor:pointer;
  transition:border .2s,background .2s;margin-bottom:10px;
  position:relative;
}
.dz:hover,.dz.over{border-color:var(--acc);background:rgba(245,200,66,.04)}
.dz input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
.dz-icon{font-size:1.6rem;margin-bottom:3px}
.dz h3{font-family:'Syne',sans-serif;font-size:.86rem;margin-bottom:2px}
.dz p{font-size:.71rem;color:var(--muted)}

/* â”€â”€â”€ PHOTO GRID â”€â”€â”€ */
#photo-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(115px,1fr));gap:8px}
.pi{
  border-radius:10px;background:var(--surf2);
  display:flex;flex-direction:column;overflow:hidden;
  animation:pop .2s var(--ease);cursor:default;
}
@keyframes pop{from{opacity:0;transform:scale(.88)}to{opacity:1;transform:scale(1)}}
.pi-hnd{
  height:22px;background:rgba(255,255,255,.04);
  display:flex;align-items:center;justify-content:center;
  cursor:grab;color:var(--muted);font-size:.78rem;letter-spacing:3px;
  user-select:none;touch-action:none;
  border-bottom:1px solid rgba(255,255,255,.05);flex-shrink:0;
}
.pi img{width:100%;height:110px;object-fit:cover;display:block;pointer-events:none}
.pi-bar{
  display:flex;align-items:center;padding:4px 5px;gap:3px;
  background:rgba(0,0,0,.3);border-top:1px solid rgba(255,255,255,.05);flex-shrink:0;
}
.pi-num{font-size:.62rem;font-weight:700;color:var(--muted);flex:1;padding-left:1px}
.ib{
  width:34px;height:32px;border-radius:7px;border:none;cursor:pointer;
  font-size:12px;display:flex;align-items:center;justify-content:center;
  touch-action:manipulation;-webkit-tap-highlight-color:transparent;transition:opacity .12s;
}
.ib:active{opacity:.65}
.ib.ed{background:rgba(37,99,235,.25);color:#60a5fa}
.ib.sg{background:rgba(124,58,237,.25);color:#a78bfa}
.ib.dl{background:rgba(224,82,82,.22);color:#f87171}
.ghost{opacity:.2;border:2px dashed var(--acc)}
.chosen{box-shadow:0 6px 24px rgba(0,0,0,.5);z-index:5}

/* â”€â”€â”€ ACTION BAR â”€â”€â”€ */
.abar{
  flex-shrink:0;display:flex;align-items:center;gap:7px;
  padding:9px 10px;background:var(--surf);border-top:2px solid var(--border);
  padding-bottom:calc(9px + env(safe-area-inset-bottom));
}
.abtn-sm{
  width:44px;height:44px;flex-shrink:0;
  border-radius:10px;border:1.5px solid var(--border);
  background:var(--surf2);color:var(--text);
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  font-size:1rem;touch-action:manipulation;transition:opacity .12s;
  position:relative;overflow:hidden;
}
.abtn-sm:disabled{opacity:.3;cursor:not-allowed}
.abtn-sm.red{border-color:var(--red);color:var(--red);background:rgba(224,82,82,.1)}
.abtn-main{
  flex:1;height:44px;min-width:0;
  border-radius:10px;border:none;
  font-family:'Syne',sans-serif;font-weight:700;font-size:.88rem;
  cursor:pointer;display:flex;align-items:center;justify-content:center;gap:5px;
  touch-action:manipulation;transition:opacity .12s;
  -webkit-tap-highlight-color:transparent;white-space:nowrap;overflow:hidden;
}
.abtn-main:disabled{opacity:.3;cursor:not-allowed}
.abtn-main:active{opacity:.8}
.abtn-blue  {background:linear-gradient(135deg,#1d4ed8,#3b82f6);color:#fff}
.abtn-teal  {background:linear-gradient(135deg,#047857,#10b981);color:#fff}
.abtn-purple{background:linear-gradient(135deg,#6d28d9,#8b5cf6);color:#fff}
.abtn-orange{background:linear-gradient(135deg,#b45309,#f59e0b);color:#fff}

/* â”€â”€â”€ MERGE LIST â”€â”€â”€ */
.mlist{display:flex;flex-direction:column;gap:8px;margin-bottom:10px}
.mi{
  display:flex;align-items:center;gap:8px;
  background:var(--surf);border:1px solid var(--border);
  border-radius:10px;padding:10px 11px;cursor:grab;animation:pop .2s var(--ease);
}
.mi-drag{color:var(--muted);font-size:.9rem;flex-shrink:0;user-select:none}
.mi-info{flex:1;min-width:0}
.mi-name{font-size:.81rem;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.mi-pages{font-size:.7rem;color:var(--muted);margin-top:1px}
.mi-del{
  background:transparent;border:1px solid var(--border);color:var(--red);
  border-radius:7px;width:30px;height:30px;cursor:pointer;font-size:13px;
  flex-shrink:0;display:flex;align-items:center;justify-content:center;
}
.close-doc-btn{
  background:rgba(224,82,82,.15);border:1px solid var(--red);color:var(--red);
  border-radius:8px;width:32px;height:32px;cursor:pointer;font-size:16px;
  flex-shrink:0;display:flex;align-items:center;justify-content:center;
  margin-left:auto;z-index:10;touch-action:manipulation;
}

/* â”€â”€â”€ SIGN TAB â”€â”€â”€ */
.sign-empty{
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  flex:1;gap:14px;color:var(--muted);text-align:center;padding:24px;
}
.sign-empty .big{font-size:3rem;opacity:.3}
.sign-empty-row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
.open-btn{
  padding:10px 16px;border-radius:10px;border:1.5px solid var(--border);
  background:var(--surf2);color:var(--text);font-family:'Syne',sans-serif;
  font-weight:700;font-size:.82rem;cursor:pointer;
  display:flex;align-items:center;gap:6px;
  position:relative;overflow:hidden;touch-action:manipulation;
}
.open-btn input{position:absolute;inset:0;opacity:0;cursor:pointer}
.sign-loaded{display:none;flex:1;flex-direction:column;overflow:hidden;min-height:0}
.sign-topbar{
  flex-shrink:0;display:flex;align-items:center;justify-content:space-between;
  padding:6px 12px;background:var(--surf);border-bottom:1px solid var(--border);gap:8px;
}
.sfname{font-size:.76rem;color:var(--muted);flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.sfname b{color:var(--acc)}
.schange{display:flex;gap:5px;flex-shrink:0}
.sch{
  padding:4px 8px;border-radius:7px;border:1px solid var(--border);
  background:var(--surf2);color:var(--muted);font-size:.7rem;cursor:pointer;
  position:relative;overflow:hidden;
}
.sch input{position:absolute;inset:0;opacity:0;cursor:pointer}
.sign-layout{display:flex;flex:1;overflow:hidden;min-height:0}
.sign-thumbs{
  flex-shrink:0;width:78px;overflow-y:auto;overflow-x:hidden;
  background:var(--surf);border-right:1px solid var(--border);
  padding:6px;display:flex;flex-direction:column;gap:5px;
  scrollbar-width:thin;
}
.tw{
  position:relative;cursor:pointer;border-radius:5px;overflow:hidden;
  border:2px solid transparent;transition:border-color .15s;flex-shrink:0;
}
.tw.active{border-color:var(--acc)}
.tw canvas{width:100%;display:block}
.tn{
  position:absolute;bottom:2px;left:3px;
  background:rgba(0,0,0,.7);color:#fff;font-size:.55rem;font-weight:700;
  padding:1px 4px;border-radius:999px;
}
/* The key: sign-preview is the scroll container, ppw is relative-positioned */
.sign-preview{
  flex:1;overflow:auto;background:#0a0a0e;
  display:flex;align-items:flex-start;justify-content:center;
  padding:16px;
}
.ppw{
  position:relative; /* overlay anchor */
  display:inline-block;line-height:0;flex-shrink:0;
}
.ppw canvas{display:block;border-radius:3px;box-shadow:0 6px 28px rgba(0,0,0,.7)}

/* â”€â”€â”€ SIGNATURE OVERLAY â”€â”€â”€ */
.sov{
  position:absolute;left:0;top:0; /* base position; actual pos via transform */
  border:1.5px dashed rgba(245,200,66,.9);
  border-radius:3px;
  will-change:transform;
  -webkit-transform:translateZ(0);
}
.sov img{
  display:block;width:100%;height:100%;
  pointer-events:none;user-select:none;
  -webkit-user-drag:none;
}
.sov-del{
  position:absolute;top:-12px;right:-12px;
  background:var(--red);color:#fff;border:2px solid #0d0d11;
  border-radius:50%;width:24px;height:24px;
  cursor:pointer;font-size:12px;
  display:flex;align-items:center;justify-content:center;
  z-index:3;line-height:1;touch-action:manipulation;
}
.sov-rz{
  position:absolute;bottom:-10px;right:-10px;
  width:22px;height:22px;background:var(--acc);
  border-radius:4px;cursor:se-resize;z-index:3;
  display:flex;align-items:center;justify-content:center;
  font-size:12px;color:#111;touch-action:none;
}

/* â”€â”€â”€ MODALS â”€â”€â”€ */
.modal{
  display:none;position:fixed;inset:0;
  background:rgba(0,0,0,.9);backdrop-filter:blur(8px);
  z-index:400;flex-direction:column;max-width:100vw;overflow:hidden;
}
.modal.open{display:flex}
.mhdr{
  flex-shrink:0;display:flex;align-items:center;justify-content:space-between;
  padding:11px 14px;background:var(--surf);border-bottom:1px solid var(--border);
}
.mhdr h2{font-family:'Syne',sans-serif;font-size:.92rem}
.mhdr span{font-size:.72rem;color:var(--muted)}
.mtb{
  flex-shrink:0;display:flex;gap:5px;padding:7px 10px;
  background:var(--surf2);overflow-x:auto;scrollbar-width:none;align-items:center;
}
.mtb::-webkit-scrollbar{display:none}
.tb{
  padding:5px 10px;border-radius:7px;border:1px solid var(--border);
  background:var(--surf);color:var(--text);font-size:.75rem;cursor:pointer;
  white-space:nowrap;flex-shrink:0;display:flex;align-items:center;gap:3px;
  touch-action:manipulation;
}
.tb.active{background:var(--acc);color:#111;border-color:var(--acc);font-weight:600}
.mcvs{
  flex:1;overflow:hidden;position:relative;background:#0a0a0e;
  display:flex;align-items:center;justify-content:center;
}
.mcvs img{max-width:100%;max-height:100%;display:block}
.mftr{
  flex-shrink:0;display:flex;gap:7px;padding:9px 12px;
  background:var(--surf);border-top:1px solid var(--border);
  padding-bottom:calc(9px + env(safe-area-inset-bottom));
}
.mfbtn{
  padding:11px 14px;border-radius:10px;border:none;
  font-family:'Syne',sans-serif;font-weight:700;font-size:.84rem;
  cursor:pointer;display:flex;align-items:center;justify-content:center;gap:5px;
  touch-action:manipulation;transition:opacity .12s;
}
.mfbtn:active{opacity:.75}
.mf-cancel{background:var(--surf2);color:var(--text);border:1px solid var(--border);flex:1}
.mf-reset {background:var(--surf2);color:var(--muted);border:1px solid var(--border)}
.mf-apply {background:linear-gradient(135deg,var(--green),#27a065);color:#fff;flex:2}
.divv{width:1px;background:var(--border);margin:0 1px;align-self:stretch;flex-shrink:0}

/* â”€â”€â”€ SIGNATURE DRAW â”€â”€â”€ */
.sig-wrap{flex:1;display:flex;position:relative;background:#f4f4ec;overflow:hidden}
#sigCvs{display:block;touch-action:none;width:100%;height:100%}
.sig-hint{
  position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  font-size:.92rem;color:#bbb;pointer-events:none;transition:opacity .2s;
}
.sig-hint.gone{opacity:0}
.cdot{
  width:24px;height:24px;border-radius:50%;cursor:pointer;
  border:3px solid transparent;transition:border-color .15s,transform .12s;flex-shrink:0;
  touch-action:manipulation;
}
.cdot.active{border-color:#fff;transform:scale(1.15)}

/* â”€â”€â”€ PROGRESS â”€â”€â”€ */
.prog-bg{
  display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);
  backdrop-filter:blur(6px);z-index:600;align-items:center;justify-content:center;
}
.prog-bg.open{display:flex}
.prog-card{
  background:var(--surf);border:1px solid var(--border);
  border-radius:14px;padding:24px 28px;text-align:center;min-width:220px;max-width:80vw;
}
.prog-card h3{font-family:'Syne',sans-serif;margin-bottom:12px;font-size:.92rem}
.prog-track{width:100%;height:6px;background:var(--surf2);border-radius:999px;overflow:hidden;margin-bottom:8px}
.prog-fill{height:100%;background:linear-gradient(90deg,var(--acc),var(--acc2));border-radius:999px;transition:width .2s var(--ease);width:0%}
.prog-note{font-size:.76rem;color:var(--muted)}

/* â”€â”€â”€ TOAST â”€â”€â”€ */
.toast{
  position:fixed;top:60px;left:50%;max-width:90vw;
  transform:translateX(-50%) translateY(-8px);
  background:var(--surf2);border:1px solid var(--border);
  color:var(--text);padding:7px 16px;border-radius:9px;
  font-size:.79rem;opacity:0;pointer-events:none;
  transition:opacity .25s,transform .25s;z-index:700;
  white-space:normal;text-align:center;
}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.empty{
  grid-column:1/-1;text-align:center;padding:22px;
  color:var(--muted);font-size:.79rem;line-height:1.9;
}

/* â”€â”€â”€ SHARE BAR â”€â”€â”€ */
.share-bar{
  flex-shrink:0;display:none;align-items:center;gap:8px;
  padding:8px 10px;background:rgba(61,184,122,.07);
  border-top:1px solid rgba(61,184,122,.2);
}
.share-bar.visible{display:flex}
.share-btn{
  flex:1;height:42px;border-radius:10px;border:1.5px solid rgba(61,184,122,.6);
  background:rgba(61,184,122,.15);color:var(--green);
  font-family:'Syne',sans-serif;font-weight:700;font-size:.84rem;
  cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;
  touch-action:manipulation;
}
.share-btn:active{opacity:.7}
.share-dl{
  height:42px;padding:0 13px;border-radius:10px;border:1px solid var(--border);
  background:var(--surf2);color:var(--muted);font-size:.78rem;cursor:pointer;
  display:flex;align-items:center;gap:5px;white-space:nowrap;touch-action:manipulation;
}
.share-dl:active{opacity:.7}

/* â”€â”€â”€ PDF SPLIT TAB â”€â”€â”€ */
.split-empty{
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  flex:1;gap:14px;color:var(--muted);text-align:center;padding:24px;
}
.split-empty .big{font-size:3rem;opacity:.3}
.split-loaded{display:none;flex:1;flex-direction:column;overflow:hidden;min-height:0}
.split-topbar{
  flex-shrink:0;display:flex;align-items:center;gap:8px;
  padding:9px 13px;background:var(--surf);border-bottom:1px solid var(--border);
}
.split-fname{font-size:.79rem;font-weight:500;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.split-badge{
  flex-shrink:0;background:var(--surf2);border:1px solid var(--border);
  padding:3px 9px;border-radius:999px;font-size:.7rem;color:var(--muted);
}
.split-badge b{color:var(--acc)}
.split-range-area{
  flex-shrink:0;padding:11px 13px;background:var(--surf2);border-bottom:1px solid var(--border);
}
.split-range-lbl{font-size:.71rem;color:var(--muted);margin-bottom:5px}
.split-range-lbl b{color:var(--acc)}
.split-range-inp{
  width:100%;background:var(--surf);border:1.5px solid var(--border);
  color:var(--text);border-radius:9px;padding:9px 12px;font-size:.88rem;
  font-family:'DM Sans',sans-serif;outline:none;transition:border-color .15s;
}
.split-range-inp:focus{border-color:var(--acc)}
.split-range-hint{font-size:.67rem;color:var(--muted);margin-top:4px}
.split-page-grid{
  flex:1;overflow-y:auto;overflow-x:hidden;padding:10px;
  display:grid;grid-template-columns:repeat(auto-fill,minmax(78px,1fr));gap:8px;
  align-content:start;
}
.spt{
  border-radius:8px;overflow:hidden;border:2px solid transparent;
  transition:border-color .15s,transform .1s;background:var(--surf);
  position:relative;cursor:pointer;
}
.spt:active{transform:scale(.93)}
.spt.sel{border-color:var(--acc);box-shadow:0 2px 10px rgba(245,200,66,.25)}
.spt canvas{width:100%;display:block}
.spt-num{
  position:absolute;bottom:3px;left:3px;
  background:rgba(0,0,0,.75);color:#fff;font-size:.57rem;font-weight:700;
  padding:1px 5px;border-radius:999px;
}
.spt.sel .spt-num{background:var(--acc);color:#111}

/* â”€â”€â”€ SCAN MODE BUTTON â”€â”€â”€ */
.tb.scan-on{background:rgba(61,184,122,.18);color:#34d399;border-color:rgba(61,184,122,.5)}
</style>
</head>
<body>

<header>
  <div class="h-brand">
    <div class="h-title">Photo to <span>PDF</span></div>
    <div class="h-sig">zaphyros</div>
  </div>
  <div class="h-right">
    <button class="lang-btn active" id="btnTR" onclick="setLang('tr')">TR</button>
    <button class="lang-btn" id="btnEN" onclick="setLang('en')">EN</button>
    <div class="hpill" id="cPill">Foto: <b>0</b></div>
  </div>
</header>

<div class="nav-cards">
  <div class="nc c1 active" data-tab="photo">
    <div class="nc-icon">ğŸ“·</div>
    <div data-i="nav_photo">Fotoâ†’PDF</div>
  </div>
  <div class="nc c2" data-tab="merge">
    <div class="nc-icon">ğŸ”—</div>
    <div data-i="nav_merge">BirleÅŸtir</div>
  </div>
  <div class="nc c4" data-tab="split">
    <div class="nc-icon">âœ‚ï¸</div>
    <div data-i="nav_split">PDF BÃ¶l</div>
  </div>
  <div class="nc c3" data-tab="sign">
    <div class="nc-icon">âœï¸</div>
    <div data-i="nav_sign">Ä°mzala</div>
  </div>
</div>

<div class="tab-panel active" id="tab-photo">
  <div class="sbar">
    <div class="sc">
      <label data-i="lbl_page">Sayfa</label>
      <select id="selPage">
        <option value="a4">A4</option><option value="a5">A5</option>
        <option value="letter">Letter</option><option value="square" data-i="opt_sq">Kare</option>
      </select>
    </div>
    <div class="sc">
      <label data-i="lbl_ori">YÃ¶n</label>
      <select id="selOri">
        <option value="auto" data-i="opt_auto">Otomatik</option>
        <option value="portrait" data-i="opt_port">Dikey</option>
        <option value="landscape" data-i="opt_land">Yatay</option>
      </select>
    </div>
    <div class="sc">
      <label data-i="lbl_marg">Kenar</label>
      <select id="selMarg">
        <option value="8">8mm</option>
        <option value="0" data-i="opt_none">KenarsÄ±z</option>
        <option value="15">15mm</option>
      </select>
    </div>
    <div class="sc">
      <label data-i="lbl_qual">Kalite: <span class="qval" id="qval">85%</span></label>
      <input type="range" id="qrange" min="40" max="100" value="85">
    </div>
  </div>
  <div class="scroll">
    <div class="dz" id="photoDZ">
      <input type="file" id="photoIn" multiple accept="image/*">
      <div class="dz-icon">ğŸ“·</div>
      <h3 data-i="dz_ph_h">FotoÄŸraf Ekle</h3>
      <p data-i="dz_ph_p">TÄ±kla veya sÃ¼rÃ¼kle Â· JPG, PNG, WebP</p>
    </div>
    <div id="photo-list">
      <div class="empty" id="photoEmpty" data-i="empty_ph">ğŸ“‚ HenÃ¼z fotoÄŸraf eklenmedi.</div>
    </div>
  </div>
  <div class="abar">
    <button class="abtn-sm" title="Ekle">
      ï¼‹<input type="file" id="photoIn2" multiple accept="image/*" style="position:absolute;inset:0;opacity:0;cursor:pointer">
    </button>
    <button class="abtn-sm red" id="phClearBtn" disabled>ğŸ—‘</button>
    <button class="abtn-main abtn-blue" id="phPdfBtn" disabled data-i="btn_cpdf">ğŸ“„ PDF OluÅŸtur</button>
  </div>
  <div class="share-bar" id="photoShareBar">
    <button class="share-btn" id="photoShareBtn">ğŸ”— <span data-i="btn_share">PaylaÅŸ</span></button>
    <button class="share-dl" id="photoSaveDlBtn">â¬‡ <span data-i="btn_save">Kaydet</span></button>
  </div>
</div>

<div class="tab-panel" id="tab-merge">
  <div class="scroll">
    <div class="dz" id="mergeDZ">
      <input type="file" id="mergeIn" multiple accept="application/pdf,.pdf">
      <div class="dz-icon">ğŸ“„</div>
      <h3 data-i="dz_mg_h">PDF DosyalarÄ± Ekle</h3>
      <p data-i="dz_mg_p">BirleÅŸtirmek istediÄŸin PDF'leri seÃ§</p>
    </div>
    <div class="mlist" id="mergeList">
      <div class="empty" id="mergeEmpty" data-i="empty_mg">ğŸ“‚ HenÃ¼z PDF eklenmedi.</div>
    </div>
  </div>
  <div class="abar">
    <button class="abtn-sm">
      ï¼‹<input type="file" id="mergeIn2" multiple accept="application/pdf,.pdf" style="position:absolute;inset:0;opacity:0;cursor:pointer">
    </button>
    <button class="abtn-sm red" id="mgClearBtn" disabled>ğŸ—‘</button>
    <button class="abtn-main abtn-teal" id="mgBtn" disabled data-i="btn_merge">ğŸ”— BirleÅŸtir</button>
  </div>
  <div class="share-bar" id="mergeShareBar">
    <button class="share-btn" id="mergeShareBtn">ğŸ”— <span data-i="btn_share">PaylaÅŸ</span></button>
    <button class="share-dl" id="mergeSaveDlBtn">â¬‡ <span data-i="btn_save">Kaydet</span></button>
  </div>
</div>

<div class="tab-panel" id="tab-split">
  <div class="split-empty" id="splitEmpty">
    <div class="big">âœ‚ï¸</div>
    <div style="font-weight:500;color:var(--text);font-size:.9rem" data-i="split_ttl">PDF BÃ¶l</div>
    <div style="font-size:.75rem" data-i="split_sub">Sayfa aralÄ±ÄŸÄ± seÃ§erek yeni PDF oluÅŸtur</div>
    <label class="open-btn" style="margin-top:4px">
      ğŸ“„ <span data-i="btn_opdf">PDF AÃ§</span>
      <input type="file" id="splitPdfIn" accept="application/pdf,.pdf">
    </label>
  </div>
  <div class="split-loaded" id="splitLoaded">
    <div class="split-topbar">
      <div class="split-fname" id="splitFname">-</div>
      <div class="split-badge"><b id="splitTotal">0</b> <span data-i="lbl_pages">sayfa</span></div>
    </div>
    <div class="split-range-area">
      <div class="split-range-lbl" data-i="split_range_lbl">Sayfa aralÄ±ÄŸÄ±: <b id="splitPreview">-</b></div>
      <input class="split-range-inp" id="splitRangeInp" type="text" placeholder="Ã¶r: 1-3, 5, 7-9">
      <div class="split-range-hint" data-i="split_range_hint">VirgÃ¼lle ayÄ±r Â· Ã–rnek: 1-3, 5, 8-10</div>
    </div>
    <div class="split-page-grid" id="splitPageGrid"></div>
  </div>
  <div class="abar" id="splitAbar" style="display:none">
    <button class="abtn-sm red" id="splitClearBtn">ğŸ—‘</button>
    <button class="abtn-main abtn-orange" id="splitBtn" disabled data-i="btn_split">âœ‚ï¸ BÃ¶l ve Ä°ndir</button>
  </div>
  <div class="share-bar" id="splitShareBar">
    <button class="share-btn" id="splitShareBtn">ğŸ”— <span data-i="btn_share">PaylaÅŸ</span></button>
    <button class="share-dl" id="splitSaveDlBtn">â¬‡ <span data-i="btn_save">Kaydet</span></button>
  </div>
</div>

<div class="tab-panel" id="tab-sign">
  <div class="sign-empty" id="signEmpty">
    <div class="big">âœï¸</div>
    <div style="font-weight:500;color:var(--text);font-size:.9rem" data-i="sign_ttl">DosyayÄ± seÃ§</div>
    <div style="font-size:.75rem" data-i="sign_sub">PDF veya fotoÄŸraf</div>
    <div class="sign-empty-row">
      <label class="open-btn">ğŸ“„ <span data-i="btn_opdf">PDF AÃ§</span><input type="file" id="signPdfIn" accept="application/pdf,.pdf"></label>
      <label class="open-btn">ğŸ–¼ï¸ <span data-i="btn_oimg">Foto AÃ§</span><input type="file" id="signImgIn" accept="image/*"></label>
    </div>
  </div>
  <div class="sign-loaded" id="signLoaded">
    <div class="sign-topbar">
      <div class="sfname"><b id="sFname">-</b> Â· <span id="sPcount">0</span> <span id="sPlabel" data-i="lbl_pages">sayfa</span></div>
      <button class="close-doc-btn" id="closeSignFile" title="DosyayÄ± Kapat">âœ•</button>
    </div>
    <div class="sign-layout">
      <div class="sign-thumbs" id="signThumbs"></div>
      <div class="sign-preview" id="signPreview">
        <div class="ppw" id="ppw"><canvas id="mainCvs"></canvas></div>
      </div>
    </div>
  </div>
  <div class="abar" id="signAbar" style="display:none">
    <button class="abtn-sm red" id="clrSigsBtn">ğŸ—‘</button>
    <button class="abtn-main abtn-purple" id="drawSigBtn" data-i="btn_draw_sig">âœï¸ Ä°mza Ã‡iz</button>
    <button class="abtn-main abtn-blue" id="dlSignedBtn" data-i="btn_dl_signed">ğŸ“„ Ä°ndir</button>
  </div>
  <div class="share-bar" id="signShareBar">
    <button class="share-btn" id="signShareBtn">ğŸ”— <span data-i="btn_share">PaylaÅŸ</span></button>
    <button class="share-dl" id="signSaveDlBtn">â¬‡ <span data-i="btn_save">Kaydet</span></button>
  </div>
</div>

<div class="modal" id="cropModal">
  <div class="mhdr"><h2>âœ‚ï¸ <span data-i="crop_ttl">DÃ¼zenle</span></h2><span id="cropIdx"></span></div>
  <div class="mtb">
    <span style="font-size:.64rem;color:var(--muted)" data-i="lbl_ratio">Oran:</span>
    <button class="tb active" data-ratio="free" data-i="opt_free">Serbest</button>
    <button class="tb" data-ratio="1">1:1</button>
    <button class="tb" data-ratio="1.333">4:3</button>
    <button class="tb" data-ratio="1.778">16:9</button>
    <button class="tb" data-ratio="0.707">A4</button>
    <div class="divv"></div>
    <button class="tb" id="rotL">â†º</button>
    <button class="tb" id="rotR">â†»</button>
    <button class="tb" id="flipH">â‡„</button>
    <button class="tb" id="flipV">â‡…</button>
    <button class="tb" id="zIn">+</button>
    <button class="tb" id="zOut">âˆ’</button>
    <div class="divv"></div>
    <button class="tb" id="scanBtn" data-i="btn_scan">ğŸ“„ Tarama</button>
  </div>
  <div class="mcvs"><img id="cropImg" src="" alt=""></div>
  <div class="mftr">
    <button class="mfbtn mf-cancel" id="cancelCrop" data-i="btn_cancel">Ä°ptal</button>
    <button class="mfbtn mf-reset" id="resetCrop" data-i="btn_reset">SÄ±fÄ±rla</button>
    <button class="mfbtn mf-apply" id="applyCrop" data-i="btn_apply">âœ“ Uygula</button>
  </div>
</div>

<div class="modal" id="sigModal">
  <div class="mhdr">
    <h2>âœï¸ <span data-i="sig_ttl">Ä°mzanÄ± Ã‡iz</span></h2>
    <span data-i="sig_sub">Parmak veya mouse</span>
  </div>
  <div class="mtb">
    <span style="font-size:.64rem;color:var(--muted)" data-i="lbl_clr">Renk:</span>
    <div class="cdot active" data-c="#111111" style="background:#111111"></div>
    <div class="cdot" data-c="#1a3a8f" style="background:#1a3a8f" title="Lacivert"></div>
    <div class="cdot" data-c="#1565C0" style="background:#1565C0" title="MÃ¼rekkep Mavi"></div>
    <div class="cdot" data-c="#8a1414" style="background:#8a1414" title="KÄ±rmÄ±zÄ±"></div>
    <div class="divv"></div>
    <span style="font-size:.64rem;color:var(--muted)" data-i="lbl_thk">KalÄ±nlÄ±k:</span>
    <button class="tb" data-w="2" data-i="w_thin">Ä°nce</button>
    <button class="tb active" data-w="3" data-i="w_mid">Orta</button>
    <button class="tb" data-w="5" data-i="w_thick">KalÄ±n</button>
    <div class="divv"></div>
    <button class="tb" id="clrSigCvs" data-i="btn_clear">ğŸ—‘ Temizle</button>
  </div>
  <div class="sig-wrap">
    <canvas id="sigCvs"></canvas>
    <div class="sig-hint" id="sigHint" data-i="sig_hint">âœï¸ Buraya imzanÄ± Ã§iz</div>
  </div>
  <div class="mftr">
    <button class="mfbtn mf-cancel" id="cancelSig" data-i="btn_cancel">Ä°ptal</button>
    <button class="mfbtn mf-apply" id="applySig" data-i="btn_place">âœ“ YerleÅŸtir</button>
  </div>
</div>

<div class="prog-bg" id="progBg">
  <div class="prog-card">
    <h3 id="progTitle">Ä°ÅŸleniyorâ€¦</h3>
    <div class="prog-track"><div class="prog-fill" id="progFill"></div></div>
    <div class="prog-note" id="progNote">â€¦</div>
  </div>
</div>
<div class="toast" id="toast"></div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   i18n
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const S={
tr:{
  nav_photo:'Fotoâ†’PDF',nav_merge:'BirleÅŸtir',nav_sign:'Ä°mzala',
  lbl_page:'Sayfa',lbl_ori:'YÃ¶n',lbl_marg:'Kenar',lbl_qual:'Kalite:',
  lbl_ratio:'Oran:',lbl_clr:'Renk:',lbl_thk:'KalÄ±nlÄ±k:',lbl_pages:'sayfa',
  opt_sq:'Kare',opt_auto:'Otomatik',opt_port:'Dikey',opt_land:'Yatay',opt_none:'KenarsÄ±z',opt_free:'Serbest',
  dz_ph_h:'FotoÄŸraf Ekle',dz_ph_p:'TÄ±kla veya sÃ¼rÃ¼kle Â· JPG, PNG, WebP',
  dz_mg_h:'PDF DosyalarÄ± Ekle',dz_mg_p:'BirleÅŸtirmek istediÄŸin PDF\'leri seÃ§',
  empty_ph:'ğŸ“‚ HenÃ¼z fotoÄŸraf eklenmedi.',empty_mg:'ğŸ“‚ HenÃ¼z PDF eklenmedi.',
  btn_cpdf:'ğŸ“„ PDF OluÅŸtur',btn_merge:'ğŸ”— BirleÅŸtir',
  sign_ttl:'DosyayÄ± seÃ§',sign_sub:'PDF veya fotoÄŸraf desteklenir',
  btn_opdf:'PDF AÃ§',btn_oimg:'Foto AÃ§',
  btn_draw_sig:'âœï¸ Ä°mza Ã‡iz',btn_dl_signed:'ğŸ“„ Ä°ndir',
  crop_ttl:'DÃ¼zenle / KÄ±rp',btn_cancel:'Ä°ptal',btn_reset:'SÄ±fÄ±rla',btn_apply:'âœ“ Uygula',
  sig_ttl:'Ä°mzanÄ± Ã‡iz',sig_sub:'Parmak veya mouse',
  w_thin:'Ä°nce',w_mid:'Orta',w_thick:'KalÄ±n',btn_clear:'ğŸ—‘ Temizle',btn_place:'âœ“ YerleÅŸtir',
  sig_hint:'âœï¸ Buraya imzanÄ± Ã§iz',
  pill:'Foto:',img_mode:'gÃ¶rsel',
  p_creating:'PDF OluÅŸturuluyorâ€¦',p_merging:'BirleÅŸtiriliyorâ€¦',
  p_load_pdf:'PDF YÃ¼kleniyorâ€¦',p_load_img:'GÃ¶rsel YÃ¼kleniyorâ€¦',
  p_signing:'Ä°mzalÄ± PDF HazÄ±rlanÄ±yorâ€¦',p_signing_img:'Ä°mzalÄ± GÃ¶rsel HazÄ±rlanÄ±yorâ€¦',
  t_pdf_ok:'âœ… PDF oluÅŸturuldu!',t_merge_ok:'âœ… PDF birleÅŸtirildi!',
  t_sign_ok:'âœ… Ä°mzalÄ± PDF indirildi!',t_sign_img_ok:'âœ… Ä°mzalÄ± gÃ¶rsel indirildi!',
  t_placed:'âœ… Ä°mza eklendi â€” sÃ¼rÃ¼kle, kÃ¶ÅŸeden boyutlandÄ±r',
  t_photo_loaded:'FotoÄŸraf yÃ¼klendi â€” imzanÄ± Ã§iz',
  t_crop_ok:'âœ… DÃ¼zenleme uygulandÄ±',t_sigs_cleared:'Ä°mzalar temizlendi',
  t_no_sig:'âš ï¸ Ã–nce imzanÄ± Ã§iz!',t_no_placed:'âš ï¸ HenÃ¼z imza eklemedin',
  t_confirm_ph:'TÃ¼m fotoÄŸraflar silinsin mi?',t_confirm_mg:'Liste temizlensin mi?',
  t_pdf_err:'âŒ PDF yÃ¼klenemedi',t_img_err:'âŒ GÃ¶rsel yÃ¼klenemedi',t_err:'âŒ Hata: ',
  nav_split:'PDF BÃ¶l',
  btn_share:'PaylaÅŸ',btn_save:'Kaydet',
  btn_scan:'ğŸ“„ Tarama',
  split_ttl:'PDF BÃ¶l',split_sub:'Sayfa aralÄ±ÄŸÄ± seÃ§erek yeni PDF oluÅŸtur',
  split_range_lbl:'SeÃ§ili sayfalar:',split_range_hint:'VirgÃ¼lle ayÄ±r Â· Ã–rnek: 1-3, 5, 8-10',
  btn_split:'âœ‚ï¸ BÃ¶l ve Ä°ndir',
  t_split_ok:'âœ… PDF bÃ¶lÃ¼ndÃ¼ ve indirildi!',t_split_err:'âŒ PDF bÃ¶lÃ¼nemedi',
  t_scan_on:'ğŸ“„ Tarama modu aktif',t_scan_off:'Tarama modu kapatÄ±ldÄ±',
  t_share_err:'âš ï¸ PaylaÅŸÄ±m desteklenmiyor, indirildi',
  t_no_pages:'âš ï¸ GeÃ§erli sayfa aralÄ±ÄŸÄ± gir',
  p_splitting:'PDF BÃ¶lÃ¼nÃ¼yorâ€¦'
},
en:{
  nav_photo:'Photoâ†’PDF',nav_merge:'Merge',nav_sign:'Sign',
  lbl_page:'Page',lbl_ori:'Orient',lbl_marg:'Margin',lbl_qual:'Quality:',
  lbl_ratio:'Ratio:',lbl_clr:'Color:',lbl_thk:'Size:',lbl_pages:'pages',
  opt_sq:'Square',opt_auto:'Auto',opt_port:'Portrait',opt_land:'Landscape',opt_none:'Borderless',opt_free:'Free',
  dz_ph_h:'Add Photos',dz_ph_p:'Tap or drag Â· JPG, PNG, WebP',
  dz_mg_h:'Add PDF Files',dz_mg_p:'Select PDFs to merge',
  empty_ph:'ğŸ“‚ No photos added.',empty_mg:'ğŸ“‚ No PDFs added.',
  btn_cpdf:'ğŸ“„ Create PDF',btn_merge:'ğŸ”— Merge',
  sign_ttl:'Select a file',sign_sub:'PDF or photo supported',
  btn_opdf:'Open PDF',btn_oimg:'Open Photo',
  btn_draw_sig:'âœï¸ Draw Signature',btn_dl_signed:'ğŸ“„ Download',
  crop_ttl:'Edit / Crop',btn_cancel:'Cancel',btn_reset:'Reset',btn_apply:'âœ“ Apply',
  sig_ttl:'Draw Signature',sig_sub:'Finger or mouse',
  w_thin:'Thin',w_mid:'Medium',w_thick:'Thick',btn_clear:'ğŸ—‘ Clear',btn_place:'âœ“ Place',
  sig_hint:'âœï¸ Draw here',
  pill:'Photos:',img_mode:'image',
  p_creating:'Creating PDFâ€¦',p_merging:'Mergingâ€¦',
  p_load_pdf:'Loading PDFâ€¦',p_load_img:'Loading Imageâ€¦',
  p_signing:'Creating Signed PDFâ€¦',p_signing_img:'Creating Signed Imageâ€¦',
  t_pdf_ok:'âœ… PDF created!',t_merge_ok:'âœ… PDFs merged!',
  t_sign_ok:'âœ… Signed PDF downloaded!',t_sign_img_ok:'âœ… Signed image downloaded!',
  t_placed:'âœ… Signature placed â€” drag & resize from corner',
  t_photo_loaded:'Photo loaded â€” draw your signature',
  t_crop_ok:'âœ… Edit applied',t_sigs_cleared:'Signatures cleared',
  t_no_sig:'âš ï¸ Draw your signature first!',t_no_placed:'âš ï¸ No signature yet',
  t_confirm_ph:'Delete all photos?',t_confirm_mg:'Clear list?',
  t_pdf_err:'âŒ Could not load PDF',t_img_err:'âŒ Could not load image',t_err:'âŒ Error: ',
  nav_split:'Split PDF',
  btn_share:'Share',btn_save:'Save',
  btn_scan:'ğŸ“„ Scan',
  split_ttl:'Split PDF',split_sub:'Select page range to create a new PDF',
  split_range_lbl:'Selected pages:',split_range_hint:'Comma-separated Â· Example: 1-3, 5, 8-10',
  btn_split:'âœ‚ï¸ Split & Download',
  t_split_ok:'âœ… PDF split and downloaded!',t_split_err:'âŒ Could not split PDF',
  t_scan_on:'ğŸ“„ Scan mode on',t_scan_off:'Scan mode off',
  t_share_err:'âš ï¸ Sharing not supported, saved instead',
  t_no_pages:'âš ï¸ Enter a valid page range',
  p_splitting:'Splitting PDFâ€¦'
}};

let lang='tr';
function tx(k){return S[lang][k]||S.tr[k]||k}
function applyLang(){
  document.querySelectorAll('[data-i]').forEach(el=>{
    const k=el.dataset.i; if(k)el.textContent=tx(k);
  });
  document.getElementById('btnTR').classList.toggle('active',lang==='tr');
  document.getElementById('btnEN').classList.toggle('active',lang==='en');
  updatePill();
}
function setLang(l){lang=l;localStorage.setItem('lang',l);applyLang()}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GLOBALS / HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const {jsPDF}=window.jspdf;
pdfjsLib.GlobalWorkerOptions.workerSrc=
  'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

let _tt;
function toast(msg,ms=3000){
  const el=document.getElementById('toast');
  el.textContent=msg;el.classList.add('show');
  clearTimeout(_tt);_tt=setTimeout(()=>el.classList.remove('show'),ms);
}
function showProg(t){
  document.getElementById('progTitle').textContent=t;
  document.getElementById('progFill').style.width='0%';
  document.getElementById('progNote').textContent='â€¦';
  document.getElementById('progBg').classList.add('open');
}
function setProg(p,n){
  document.getElementById('progFill').style.width=p+'%';
  if(n)document.getElementById('progNote').textContent=n;
}
function hideProg(){document.getElementById('progBg').classList.remove('open')}
function dlBytes(b,n){
  const u=URL.createObjectURL(new Blob([b],{type:'application/pdf'}));
  const a=document.createElement('a');a.href=u;a.download=n;a.click();
  setTimeout(()=>URL.revokeObjectURL(u),5000);
}
function dlDataUrl(du,n){const a=document.createElement('a');a.href=du;a.download=n;a.click()}
function nPhotos(){return document.querySelectorAll('#photo-list .pi').length}
function updatePill(){
  document.getElementById('cPill').innerHTML=tx('pill')+' <b>'+nPhotos()+'</b>';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NAVIGATION + BACK BUTTON
   Sentinel state at bottom prevents browser from leaving the app.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const MODALS=['cropModal','sigModal'];

// Push two states: sentinel (never popped away from) + initial tab
history.replaceState({k:'sentinel'},'');
history.pushState({k:'tab',v:'photo'},'');

function pushH(k,v){history.pushState({k,v},'')}
function openModal(id){pushH('modal',id);document.getElementById(id).classList.add('open')}
function closeModal(id){document.getElementById(id).classList.remove('open')}

function switchTab(id,push=true){
  if(push)pushH('tab',id);
  document.querySelectorAll('.nc').forEach(n=>n.classList.toggle('active',n.dataset.tab===id));
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.toggle('active',p.id==='tab-'+id));
}

window.addEventListener('popstate',e=>{
  const s=e.state;

  // Sentinel hit â€” push tab state back so we never leave the app
  if(!s || s.k==='sentinel'){
    history.pushState({k:'tab',v:'photo'},'');
    switchTab('photo',false);
    return;
  }

  // Close topmost open modal
  for(const id of MODALS){
    if(document.getElementById(id).classList.contains('open')){
      if(id==='cropModal')_closeCrop(false);
      else closeModal(id);
      return;
    }
  }

  if(s.k==='tab') switchTab(s.v,false);
  // else: unknown state, ignore
});

document.querySelectorAll('.nc').forEach(n=>
  n.addEventListener('click',()=>switchTab(n.dataset.tab)));

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAB 1 â€” PHOTO â†’ PDF
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const photoList=document.getElementById('photo-list');
const phPdfBtn=document.getElementById('phPdfBtn');
const phClearBtn=document.getElementById('phClearBtn');

document.getElementById('qrange').addEventListener('input',function(){
  document.getElementById('qval').textContent=this.value+'%';
});

[document.getElementById('photoIn'),document.getElementById('photoIn2')]
  .forEach(i=>i.addEventListener('change',e=>{loadPhotos(e.target.files);e.target.value=''}));

const photoDZ=document.getElementById('photoDZ');
photoDZ.addEventListener('dragover',e=>{e.preventDefault();photoDZ.classList.add('over')});
photoDZ.addEventListener('dragleave',()=>photoDZ.classList.remove('over'));
photoDZ.addEventListener('drop',e=>{e.preventDefault();photoDZ.classList.remove('over');loadPhotos(e.dataTransfer.files)});

new Sortable(photoList,{
  animation:160,handle:'.pi-hnd',
  ghostClass:'ghost',chosenClass:'chosen',
  filter:'.empty',touchStartThreshold:4,
  onEnd:()=>photoList.querySelectorAll('.pi .pi-num').forEach((b,i)=>b.textContent=i+1)
});

function loadPhotos(files){
  Array.from(files).filter(f=>f.type.startsWith('image/')).forEach(f=>{
    const r=new FileReader();r.onload=e=>addPhotoCard(e.target.result);r.readAsDataURL(f);
  });
}

function addPhotoCard(src, skipSave=false){
  document.getElementById('photoEmpty').style.display='none';
  const d=document.createElement('div');d.className='pi';
  const hnd=document.createElement('div');hnd.className='pi-hnd';hnd.textContent='â ¿ â ¿ â ¿';
  const img=document.createElement('img');img.src=src;img.draggable=false;
  const bar=document.createElement('div');bar.className='pi-bar';
  const num=document.createElement('span');num.className='pi-num';

  function mkib(cls,ico){
    const b=document.createElement('button');b.className='ib '+cls;b.textContent=ico;return b;
  }
  const eb=mkib('ed','âœï¸'); eb.addEventListener('click',e=>{e.stopPropagation();openCrop(d)});
  const sb=mkib('sg','âœï¸'); sb.addEventListener('click',e=>{e.stopPropagation();openPhotoSign(d)});
  const db=mkib('dl','ğŸ—‘'); db.addEventListener('click',e=>{
    e.stopPropagation();d.remove();
    photoList.querySelectorAll('.pi .pi-num').forEach((b,i)=>b.textContent=i+1);
    updatePhotoState();
    savePhotos();
  });
  bar.append(num,eb,sb,db);
  d.append(hnd,img,bar);
  photoList.appendChild(d);
  photoList.querySelectorAll('.pi .pi-num').forEach((b,i)=>b.textContent=i+1);
  updatePhotoState();
  if(!skipSave) savePhotos();
}

function updatePhotoState(){
  const n=nPhotos();
  updatePill();
  phPdfBtn.disabled=n===0;phClearBtn.disabled=n===0;
  if(n===0)document.getElementById('photoEmpty').style.display='';
}

phClearBtn.addEventListener('click',()=>{
  if(!confirm(tx('t_confirm_ph')))return;
  photoList.querySelectorAll('.pi').forEach(el=>el.remove());
  updatePhotoState();
  savePhotos(); // saves empty array â†’ clears DB
});

const PAGE_SIZES={a4:[210,297],a5:[148,210],letter:[215.9,279.4],square:[150,150]};
phPdfBtn.addEventListener('click',async()=>{
  const items=Array.from(photoList.querySelectorAll('.pi'));if(!items.length)return;
  const [pw0,ph0]=PAGE_SIZES[document.getElementById('selPage').value];
  const ori0=document.getElementById('selOri').value;
  const marg=parseInt(document.getElementById('selMarg').value);
  const qual=parseInt(document.getElementById('qrange').value)/100;
  showProg(tx('p_creating'));phPdfBtn.disabled=true;
  let doc=null;
  for(let i=0;i<items.length;i++){
    const img=items[i].querySelector('img');
    let ori='portrait';
    if(ori0==='landscape')ori='landscape';
    else if(ori0==='auto'&&img.naturalWidth>img.naturalHeight)ori='landscape';
    const pw=ori==='landscape'?ph0:pw0,ph=ori==='landscape'?pw0:ph0;
    if(!doc)doc=new jsPDF({orientation:ori,unit:'mm',format:[pw,ph]});
    else doc.addPage([pw,ph],ori);
    const avW=pw-marg*2,avH=ph-marg*2,rat=img.naturalWidth/img.naturalHeight;
    let dw=avW,dh=dw/rat;if(dh>avH){dh=avH;dw=dh*rat}
    const c=document.createElement('canvas');c.width=img.naturalWidth;c.height=img.naturalHeight;
    c.getContext('2d').drawImage(img,0,0);
    doc.addImage(c.toDataURL('image/jpeg',qual),'JPEG',(pw-dw)/2,(ph-dh)/2,dw,dh);
    setProg(Math.round((i+1)/items.length*100),`${i+1}/${items.length}`);
    await new Promise(r=>setTimeout(r,10));
  }
  const pdfBlob=new Blob([doc.output('arraybuffer')],{type:'application/pdf'});
  const pdfName=`photo-to-pdf-${Date.now()}.pdf`;
  const u=URL.createObjectURL(pdfBlob);
  const a=document.createElement('a');a.href=u;a.download=pdfName;a.click();
  setTimeout(()=>URL.revokeObjectURL(u),5000);
  hideProg();phPdfBtn.disabled=false;toast(tx('t_pdf_ok'));
  showShareBar('photoShareBar',pdfBlob,pdfName);
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CROP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let _cr=null,_crItem=null,_origSrc=null,_sx=1,_sy=1;

function openCrop(item){
  _crItem=item;_sx=1;_sy=1;
  const ci=document.getElementById('cropImg');
  _origSrc=item.querySelector('img').src;
  ci.src=_origSrc;
  const idx=Array.from(photoList.querySelectorAll('.pi')).indexOf(item);
  document.getElementById('cropIdx').textContent='#'+(idx+1);
  document.querySelectorAll('[data-ratio]').forEach(b=>b.classList.remove('active'));
  document.querySelector('[data-ratio="free"]').classList.add('active');
  openModal('cropModal');
  ci.onload=()=>{
    if(_cr){_cr.destroy();_cr=null}
    _cr=new Cropper(ci,{viewMode:1,autoCropArea:.88,movable:true,scalable:true,zoomable:true,background:true,responsive:true});
  };
  if(ci.complete)ci.onload();
}
function _closeCrop(back=true){
  if(_cr){_cr.destroy();_cr=null}
  closeModal('cropModal');_crItem=null;
  if(back)history.back();
}
document.getElementById('cancelCrop').addEventListener('click',()=>_closeCrop());
document.getElementById('resetCrop').addEventListener('click',()=>{
  _sx=1;_sy=1;const ci=document.getElementById('cropImg');ci.src=_origSrc;
  ci.onload=()=>{if(_cr){_cr.destroy();_cr=null}
    _cr=new Cropper(ci,{viewMode:1,autoCropArea:.88,movable:true,scalable:true,zoomable:true,background:true,responsive:true});
  };if(ci.complete)ci.onload();
});
document.getElementById('applyCrop').addEventListener('click',()=>{
  if(!_cr||!_crItem)return;
  const c=_cr.getCroppedCanvas({maxWidth:2400,maxHeight:2400,imageSmoothingQuality:'high'});
  if(!c)return;
  if(_scanOn) applyScanMode(c);
  _crItem.querySelector('img').src=c.toDataURL('image/jpeg',.94);
  _closeCrop();toast(tx('t_crop_ok'));savePhotos();
});
document.querySelectorAll('[data-ratio]').forEach(b=>b.addEventListener('click',()=>{
  document.querySelectorAll('[data-ratio]').forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
  _cr?.setAspectRatio(b.dataset.ratio==='free'?NaN:parseFloat(b.dataset.ratio));
}));
document.getElementById('rotL').addEventListener('click',()=>_cr?.rotate(-90));
document.getElementById('rotR').addEventListener('click',()=>_cr?.rotate(90));
document.getElementById('flipH').addEventListener('click',()=>{_sx*=-1;_cr?.scaleX(_sx)});
document.getElementById('flipV').addEventListener('click',()=>{_sy*=-1;_cr?.scaleY(_sy)});
document.getElementById('zIn').addEventListener('click',()=>_cr?.zoom(.1));
document.getElementById('zOut').addEventListener('click',()=>_cr?.zoom(-.1));

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAB 2 â€” MERGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let mFiles=[];
const mList=document.getElementById('mergeList');
new Sortable(mList,{animation:160,ghostClass:'ghost',chosenClass:'chosen',filter:'.empty'});

[document.getElementById('mergeIn'),document.getElementById('mergeIn2')]
  .forEach(i=>i.addEventListener('change',e=>{loadMerge(e.target.files);e.target.value=''}));

const mergeDZ=document.getElementById('mergeDZ');
mergeDZ.addEventListener('dragover',e=>{e.preventDefault();mergeDZ.classList.add('over')});
mergeDZ.addEventListener('dragleave',()=>mergeDZ.classList.remove('over'));
mergeDZ.addEventListener('drop',e=>{e.preventDefault();mergeDZ.classList.remove('over');loadMerge(e.dataTransfer.files)});

async function loadMerge(files){
  for(const f of Array.from(files).filter(f=>f.name.toLowerCase().endsWith('.pdf')||f.type==='application/pdf')){
    try{
      const ab=await f.arrayBuffer();
      const pdf=await PDFLib.PDFDocument.load(ab,{ignoreEncryption:true});
      const data={name:f.name,pages:pdf.getPageCount(),ab};
      mFiles.push(data);addMItem(data);
    }catch(e){toast(tx('t_pdf_err')+': '+f.name)}
  }
  updateMState();
}
function addMItem(data){
  document.getElementById('mergeEmpty').style.display='none';
  const d=document.createElement('div');d.className='mi';
  d.innerHTML=`<span class="mi-drag">â ¿</span>
    <div class="mi-info">
      <div class="mi-name" title="${data.name}">${data.name}</div>
      <div class="mi-pages">${data.pages} ${tx('lbl_pages')}</div>
    </div>
    <button class="mi-del">âœ•</button>`;
  d.querySelector('.mi-del').addEventListener('click',()=>{
    const i=mFiles.indexOf(data);if(i>-1)mFiles.splice(i,1);
    d.remove();updateMState();
  });
  mList.appendChild(d);
}
function updateMState(){
  const n=mFiles.length;
  document.getElementById('mgBtn').disabled=n<2;
  document.getElementById('mgClearBtn').disabled=n===0;
  if(n===0)document.getElementById('mergeEmpty').style.display='';
}
document.getElementById('mgClearBtn').addEventListener('click',()=>{
  if(!confirm(tx('t_confirm_mg')))return;
  mFiles=[];mList.querySelectorAll('.mi').forEach(el=>el.remove());updateMState();
});
document.getElementById('mgBtn').addEventListener('click',async()=>{
  if(mFiles.length<2)return;
  showProg(tx('p_merging'));document.getElementById('mgBtn').disabled=true;
  try{
    const merged=await PDFLib.PDFDocument.create();
    const order=Array.from(mList.querySelectorAll('.mi-name')).map(el=>el.title);
    const src=order.map(n=>mFiles.find(f=>f.name===n)).filter(Boolean);
    const list=src.length===mFiles.length?src:mFiles;
    for(let i=0;i<list.length;i++){
      const pdf=await PDFLib.PDFDocument.load(list[i].ab,{ignoreEncryption:true});
      const pages=await merged.copyPages(pdf,pdf.getPageIndices());
      pages.forEach(p=>merged.addPage(p));
      setProg(Math.round((i+1)/list.length*100),`${i+1}/${list.length}`);
      await new Promise(r=>setTimeout(r,8));
    }
    const bytes=await merged.save();
    const blob=new Blob([bytes],{type:'application/pdf'});
    const name=`merged-${Date.now()}.pdf`;
    dlBytes(bytes,name);
    toast(tx('t_merge_ok'));
    showShareBar('mergeShareBar',blob,name);
  }catch(e){console.error(e);toast(tx('t_err')+e.message)}
  hideProg();document.getElementById('mgBtn').disabled=false;
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAB 3 â€” SIGN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let sDoc=null,sBytes=null,sPage=1,sPageCount=0,sScale=1;
let sigs=[],isImg=false,imgW=0,imgH=0;

[document.getElementById('signPdfIn'),document.getElementById('signPdfIn2')]
  .forEach(i=>i.addEventListener('change',e=>{if(e.target.files[0])loadSPdf(e.target.files[0]);e.target.value=''}));
[document.getElementById('signImgIn'),document.getElementById('signImgIn2')]
  .forEach(i=>i.addEventListener('change',e=>{if(e.target.files[0])loadSImg(e.target.files[0]);e.target.value=''}));

// Close button logic for Sign Tab - FIXED
document.getElementById('closeSignFile').addEventListener('click',()=>{
  sDoc=null; sBytes=null; sigs=[]; isImg=false;
  document.getElementById('signLoaded').style.display='none';
  document.getElementById('signEmpty').style.display='flex'; // Force flex display
  document.getElementById('signAbar').style.display='none';
  document.getElementById('mainCvs').getContext('2d').clearRect(0,0,10,10); // Clear canvas ref
});

async function loadSPdf(file){
  showProg(tx('p_load_pdf'));
  try{
    const ab=await file.arrayBuffer();
    sBytes=ab;isImg=false;
    sDoc=await pdfjsLib.getDocument({data:ab.slice(0)}).promise;
    sPageCount=sDoc.numPages;sigs=[];sPage=1;
    document.getElementById('sFname').textContent=file.name.slice(0,30);
    document.getElementById('sPcount').textContent=sPageCount;
    document.getElementById('sPlabel').textContent=tx('lbl_pages');
    showSLoaded();
    await buildThumbs();
    await renderPage(1);
  }catch(e){console.error(e);toast(tx('t_pdf_err'))}
  hideProg();
}

async function loadSImg(file){
  showProg(tx('p_load_img'));
  try{
    const url=URL.createObjectURL(file);
    await new Promise((res,rej)=>{
      const img=new Image();
      img.onload=()=>{
        isImg=true;sDoc=null;sBytes=null;
        sPageCount=1;sigs=[];sPage=1;
        imgW=img.width;imgH=img.height;
        document.getElementById('sFname').textContent=file.name.slice(0,30);
        document.getElementById('sPcount').textContent='1';
        document.getElementById('sPlabel').textContent=tx('img_mode');
        showSLoaded();
        // thumbnail
        const thumbs=document.getElementById('signThumbs');thumbs.innerHTML='';
        const tw=document.createElement('div');tw.className='tw active';tw.dataset.p=1;
        const tc=document.createElement('canvas');
        const ts=Math.min(66/img.width,1);
        tc.width=Math.round(img.width*ts);tc.height=Math.round(img.height*ts);
        tc.getContext('2d').drawImage(img,0,0,tc.width,tc.height);
        const tn=document.createElement('div');tn.className='tn';tn.textContent='1';
        tw.append(tc,tn);thumbs.appendChild(tw);
        // render main
        const area=document.getElementById('signPreview');
        const maxW=Math.max((area.clientWidth||300)-32,160);
        sScale=Math.min(maxW/img.width,1.5);
        const mc=document.getElementById('mainCvs');
        mc.width=Math.round(img.width*sScale);
        mc.height=Math.round(img.height*sScale);
        mc.getContext('2d').drawImage(img,0,0,mc.width,mc.height);
        URL.revokeObjectURL(url);res();
      };
      img.onerror=rej;img.src=url;
    });
  }catch(e){console.error(e);toast(tx('t_img_err'))}
  hideProg();
}

function showSLoaded(){
  document.getElementById('signEmpty').style.display='none';
  document.getElementById('signLoaded').style.display='flex';
  document.getElementById('signAbar').style.display='flex';
}

async function buildThumbs(){
  const ct=document.getElementById('signThumbs');ct.innerHTML='';
  for(let p=1;p<=sPageCount;p++){
    const tw=document.createElement('div');tw.className='tw';tw.dataset.p=p;
    const c=document.createElement('canvas');
    const tn=document.createElement('div');tn.className='tn';tn.textContent=p;
    tw.append(c,tn);
    tw.addEventListener('click',()=>renderPage(p));
    ct.appendChild(tw);
    const pg=await sDoc.getPage(p);
    const vp=pg.getViewport({scale:.24});
    c.width=vp.width;c.height=vp.height;
    await pg.render({canvasContext:c.getContext('2d'),viewport:vp}).promise;
  }
  updateThumbs();
}

function updateThumbs(){
  document.querySelectorAll('.tw').forEach(w=>w.classList.toggle('active',parseInt(w.dataset.p||1)===sPage));
}

async function renderPage(p){
  sPage=p;updateThumbs();
  document.querySelectorAll('.sov').forEach(el=>el.remove());
  const pg=await sDoc.getPage(p);
  const area=document.getElementById('signPreview');
  const maxW=Math.max((area.clientWidth||300)-32,160);
  const vp0=pg.getViewport({scale:1});
  sScale=Math.min(maxW/vp0.width,1.5);
  const vp=pg.getViewport({scale:sScale});
  const mc=document.getElementById('mainCvs');
  mc.width=vp.width;mc.height=vp.height;
  await pg.render({canvasContext:mc.getContext('2d'),viewport:vp}).promise;
  sigs.filter(s=>s.page===p).forEach(s=>buildOverlay(s));
}

/* â”€â”€â”€ Place signature â”€â”€â”€ */
function placeSig(dataUrl){
  const mc=document.getElementById('mainCvs');
  const w=Math.round(mc.width*.38),h=Math.round(w*.28);
  const s={
    page:sPage,
    x:Math.round((mc.width-w)/2),
    y:Math.round((mc.height-h)/2),
    w,h,dataUrl
  };
  sigs.push(s);
  buildOverlay(s);
}

/* â”€â”€â”€ Build draggable/resizable overlay â”€â”€â”€ */
function buildOverlay(s){
  const wrap=document.getElementById('ppw');
  const el=document.createElement('div');
  el.className='sov';
  el.style.cssText=`width:${s.w}px;height:${s.h}px;transform:translate3d(${s.x}px,${s.y}px,0);cursor:move;touch-action:none`;

  const imgEl=document.createElement('img');imgEl.src=s.dataUrl;

  const delBtn=document.createElement('button');
  delBtn.className='sov-del';delBtn.textContent='âœ•';
  delBtn.addEventListener('pointerdown',e=>e.stopPropagation());
  delBtn.addEventListener('click',e=>{
    e.stopPropagation();el.remove();
    const i=sigs.indexOf(s);if(i>-1)sigs.splice(i,1);
  });

  const rzHnd=document.createElement('div');
  rzHnd.className='sov-rz';rzHnd.textContent='â‡²';
  rzHnd.style.touchAction='none';

  el.append(imgEl,delBtn,rzHnd);
  wrap.appendChild(el);

  /* â”€â”€ DRAG
     KEY: cache getBoundingClientRect + canvas size at pointerdown.
     NEVER call getBCR inside pointermove â€” it forces layout reflow = lag.
     Direct DOM write (no rAF) is faster on mobile for pointer events.
  â”€â”€ */
  let dragOn=false,wrL=0,wrT=0,maxX=0,maxY=0,offX=0,offY=0;

  el.addEventListener('pointerdown',e=>{
    if(e.target===delBtn||e.target===rzHnd)return;
    e.preventDefault();e.stopPropagation();
    el.setPointerCapture(e.pointerId);
    dragOn=true;
    // cache everything that forces layout â€” only at start, not during move
    const wr=wrap.getBoundingClientRect();
    const mc=document.getElementById('mainCvs');
    wrL=wr.left; wrT=wr.top;
    maxX=mc.width-s.w;  maxY=mc.height-s.h;
    offX=e.clientX-wrL-s.x;
    offY=e.clientY-wrT-s.y;
  });

  el.addEventListener('pointermove',e=>{
    if(!dragOn)return;
    e.preventDefault();
    // pure arithmetic â€” zero layout queries
    s.x=e.clientX-wrL-offX; if(s.x<0)s.x=0; else if(s.x>maxX)s.x=maxX;
    s.y=e.clientY-wrT-offY; if(s.y<0)s.y=0; else if(s.y>maxY)s.y=maxY;
    el.style.transform=`translate3d(${s.x}px,${s.y}px,0)`;
  });

  el.addEventListener('pointerup',   ()=>dragOn=false);
  el.addEventListener('pointercancel',()=>dragOn=false);

  /* â”€â”€ RESIZE â€” same principle: cache at pointerdown â”€â”€ */
  let rzOn=false,rzSX=0,rzSY=0,rzW0=0,rzH0=0;

  rzHnd.addEventListener('pointerdown',e=>{
    e.preventDefault();e.stopPropagation();
    rzHnd.setPointerCapture(e.pointerId);
    rzOn=true;rzSX=e.clientX;rzSY=e.clientY;rzW0=s.w;rzH0=s.h;
  });
  rzHnd.addEventListener('pointermove',e=>{
    if(!rzOn)return;
    e.preventDefault();
    s.w=rzW0+(e.clientX-rzSX); if(s.w<44)s.w=44;
    s.h=rzH0+(e.clientY-rzSY); if(s.h<18)s.h=18;
    el.style.width=s.w+'px';
    el.style.height=s.h+'px';
    // update maxX/maxY so drag bounds stay correct after resize
    maxX=document.getElementById('mainCvs').width-s.w;
    maxY=document.getElementById('mainCvs').height-s.h;
  });
  rzHnd.addEventListener('pointerup',   ()=>rzOn=false);
  rzHnd.addEventListener('pointercancel',()=>rzOn=false);
}

document.getElementById('clrSigsBtn').addEventListener('click',()=>{
  sigs=sigs.filter(s=>s.page!==sPage);
  document.querySelectorAll('.sov').forEach(el=>el.remove());
  toast(tx('t_sigs_cleared'));
});

/* â”€â”€â”€ Download signed â”€â”€â”€ */
document.getElementById('dlSignedBtn').addEventListener('click',async()=>{
  if(!sigs.length){toast(tx('t_no_placed'));return}

  if(isImg){
    showProg(tx('p_signing_img'));
    const mc=document.getElementById('mainCvs');
    const out=document.createElement('canvas');
    out.width=imgW;out.height=imgH;
    const ctx=out.getContext('2d');
    ctx.drawImage(mc,0,0,imgW,imgH);
    for(const s of sigs){
      const si=new Image();
      await new Promise(r=>{si.onload=r;si.src=s.dataUrl});
      const fx=imgW/mc.width,fy=imgH/mc.height;
      ctx.drawImage(si,s.x*fx,s.y*fy,s.w*fx,s.h*fy);
    }
    const imgName=`signed-${Date.now()}.png`;
    out.toBlob(blob=>{
      dlDataUrl(URL.createObjectURL(blob),imgName);
      showShareBar('signShareBar',blob,imgName);
    },'image/png');
    hideProg();toast(tx('t_sign_img_ok'));
    return;
  }

  if(!sBytes)return;
  showProg(tx('p_signing'));
  try{
    const pdfDoc=await PDFLib.PDFDocument.load(sBytes.slice(0),{ignoreEncryption:true});
    for(let i=0;i<sigs.length;i++){
      const s=sigs[i];
      const pg=pdfDoc.getPage(s.page-1);
      const{width:pW,height:pH}=pg.getSize();
      // get the viewport used when rendering this page
      const pjsPg=await sDoc.getPage(s.page);
      const rendVp=pjsPg.getViewport({scale:sScale});
      const rW=rendVp.width,rH=rendVp.height;
      // convert screen pixels â†’ PDF user-space (PDF y-axis is bottom-up)
      const pdfX=(s.x/rW)*pW;
      const pdfY=pH-((s.y+s.h)/rH)*pH;
      const pdfW=(s.w/rW)*pW;
      const pdfH=(s.h/rH)*pH;
      // embed PNG
      const b64=s.dataUrl.split(',')[1];
      const bytes=Uint8Array.from(atob(b64),c=>c.charCodeAt(0));
      const pngImg=await pdfDoc.embedPng(bytes);
      pg.drawImage(pngImg,{x:pdfX,y:pdfY,width:pdfW,height:Math.abs(pdfH)});
      setProg(Math.round((i+1)/sigs.length*100),`${i+1}/${sigs.length}`);
    }
    const pdfBytes=await pdfDoc.save();
    const pdfBlob2=new Blob([pdfBytes],{type:'application/pdf'});
    const signedName=`signed-${Date.now()}.pdf`;
    dlBytes(pdfBytes,signedName);
    toast(tx('t_sign_ok'));
    showShareBar('signShareBar',pdfBlob2,signedName);
  }catch(e){console.error(e);toast(tx('t_err')+e.message)}
  hideProg();
});

/* â”€â”€â”€ Photo card â†’ sign â”€â”€â”€ */
function openPhotoSign(card){
  const imgEl=card.querySelector('img');
  // convert dataURL â†’ File then load
  fetch(imgEl.src).then(r=>r.blob()).then(blob=>{
    const file=new File([blob],'photo.jpg',{type:'image/jpeg'});
    switchTab('sign');
    loadSImg(file);
    toast(tx('t_photo_loaded'));
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SIGNATURE DRAW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let _dn=false,_sc='#111111',_sw=3;
const sigCvs=document.getElementById('sigCvs');
const sigCtx=sigCvs.getContext('2d');

function resizeSig(){
  const r=sigCvs.parentElement.getBoundingClientRect();
  if(r.width<1||r.height<1)return;
  const tmp=document.createElement('canvas');
  tmp.width=sigCvs.width||1;tmp.height=sigCvs.height||1;
  tmp.getContext('2d').drawImage(sigCvs,0,0);
  sigCvs.width=Math.floor(r.width);
  sigCvs.height=Math.floor(r.height);
  sigCtx.lineCap='round';sigCtx.lineJoin='round';
  sigCtx.drawImage(tmp,0,0);
}

sigCvs.addEventListener('pointerdown',e=>{
  _dn=true;sigCvs.setPointerCapture(e.pointerId);
  const r=sigCvs.getBoundingClientRect();
  sigCtx.beginPath();sigCtx.moveTo(e.clientX-r.left,e.clientY-r.top);
  sigCtx.strokeStyle=_sc;sigCtx.lineWidth=_sw;
  document.getElementById('sigHint').classList.add('gone');
});
sigCvs.addEventListener('pointermove',e=>{
  if(!_dn)return;
  const r=sigCvs.getBoundingClientRect();
  sigCtx.lineTo(e.clientX-r.left,e.clientY-r.top);
  sigCtx.stroke();
  sigCtx.beginPath();sigCtx.moveTo(e.clientX-r.left,e.clientY-r.top);
});
sigCvs.addEventListener('pointerup',()=>_dn=false);
sigCvs.addEventListener('pointercancel',()=>_dn=false);

document.getElementById('clrSigCvs').addEventListener('click',()=>{
  sigCtx.clearRect(0,0,sigCvs.width,sigCvs.height);
  document.getElementById('sigHint').classList.remove('gone');
});

document.querySelectorAll('.cdot').forEach(d=>{
  d.addEventListener('click',()=>{
    document.querySelectorAll('.cdot').forEach(x=>x.classList.remove('active'));
    d.classList.add('active');_sc=d.dataset.c;
  });
});
document.querySelectorAll('[data-w]').forEach(b=>{
  b.addEventListener('click',()=>{
    document.querySelectorAll('[data-w]').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');_sw=parseInt(b.dataset.w);
  });
});

document.getElementById('drawSigBtn').addEventListener('click',()=>{
  sigCtx.clearRect(0,0,sigCvs.width,sigCvs.height);
  document.getElementById('sigHint').classList.remove('gone');
  openModal('sigModal');
  setTimeout(resizeSig,80);
});

document.getElementById('cancelSig').addEventListener('click',()=>{
  closeModal('sigModal');history.back();
});

document.getElementById('applySig').addEventListener('click',()=>{
  const d=sigCtx.getImageData(0,0,sigCvs.width,sigCvs.height);
  if(!d.data.some((_,i)=>i%4===3&&d.data[i]>10)){toast(tx('t_no_sig'));return}
  const dataUrl=cropSig().toDataURL('image/png');
  closeModal('sigModal');
  history.back();
  placeSig(dataUrl);
  toast(tx('t_placed'));
});

function cropSig(){
  const d=sigCtx.getImageData(0,0,sigCvs.width,sigCvs.height);
  let x0=sigCvs.width,y0=sigCvs.height,x1=0,y1=0;
  for(let y=0;y<sigCvs.height;y++)for(let x=0;x<sigCvs.width;x++){
    if(d.data[(y*sigCvs.width+x)*4+3]>8){
      if(x<x0)x0=x;if(x>x1)x1=x;if(y<y0)y0=y;if(y>y1)y1=y;
    }
  }
  const p=12;
  x0=Math.max(0,x0-p);y0=Math.max(0,y0-p);
  x1=Math.min(sigCvs.width,x1+p);y1=Math.min(sigCvs.height,y1+p);
  const w=x1-x0||sigCvs.width,h=y1-y0||sigCvs.height;
  const out=document.createElement('canvas');out.width=w;out.height=h;
  out.getContext('2d').putImageData(sigCtx.getImageData(x0,y0,w,h),0,0);
  return out;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SHARE HELPER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function shareOrDownload(blob, filename){
  // Modern Native Sharing
  if(navigator.share && navigator.canShare){
    const file = new File([blob], filename, {type: blob.type});
    const data = {
      files: [file],
      title: filename,
      text: filename
    };
    if(navigator.canShare(data)){
      try{
        await navigator.share(data);
        return; 
      } catch(e) {
        if(e.name === 'AbortError') return;
      }
    }
  }
  // Fallback
  const u=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=u;a.download=filename;a.click();
  setTimeout(()=>URL.revokeObjectURL(u),5000);
  toast(tx('t_share_err'));
}

function showShareBar(barId,blob,name){
  const bar=document.getElementById(barId);
  // CRITICAL FIX: If bar is missing in DOM (should be fixed now), prevent crash
  if(!bar){console.error('Share bar missing:', barId); return;}
  bar._blob=blob;bar._name=name;
  bar.classList.add('visible');
}

['photo','merge','sign','split'].forEach(prefix=>{
  const bar=document.getElementById(prefix+'ShareBar');
  if(!bar) return; // safety
  document.getElementById(prefix+'ShareBtn').addEventListener('click',()=>{
    if(bar._blob)shareOrDownload(bar._blob,bar._name);
  });
  document.getElementById(prefix+'SaveDlBtn').addEventListener('click',()=>{
    if(bar._blob){const u=URL.createObjectURL(bar._blob);const a=document.createElement('a');a.href=u;a.download=bar._name;a.click();setTimeout(()=>URL.revokeObjectURL(u),5000);}
  });
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCAN MODE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let _scanOn=false;
document.getElementById('scanBtn').addEventListener('click',()=>{
  _scanOn=!_scanOn;
  document.getElementById('scanBtn').classList.toggle('scan-on',_scanOn);
  toast(_scanOn?tx('t_scan_on'):tx('t_scan_off'));
});

function applyScanMode(canvas){
  const ctx=canvas.getContext('2d');
  const w=canvas.width,h=canvas.height;
  const id=ctx.getImageData(0,0,w,h);
  const d=id.data;
  // Grayscale + high contrast
  for(let i=0;i<d.length;i+=4){
    let v=0.299*d[i]+0.587*d[i+1]+0.114*d[i+2];
    v=Math.min(255,Math.max(0,(v-128)*1.85+148));
    d[i]=d[i+1]=d[i+2]=v;
  }
  // Sharpen (unsharp 3Ã—3)
  const src=new Uint8ClampedArray(d);
  const k=[0,-1,0,-1,5,-1,0,-1,0];
  for(let y=1;y<h-1;y++){
    for(let x=1;x<w-1;x++){
      for(let c=0;c<3;c++){
        let s=0;
        for(let ky=-1;ky<=1;ky++)for(let kx=-1;kx<=1;kx++)
          s+=src[((y+ky)*w+(x+kx))*4+c]*k[(ky+1)*3+(kx+1)];
        d[(y*w+x)*4+c]=Math.min(255,Math.max(0,s));
      }
    }
  }
  ctx.putImageData(id,0,0);
  return canvas;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAB 4 â€” PDF SPLIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let spDoc=null,spBytes=null,spCount=0;

document.getElementById('splitPdfIn').addEventListener('change',async e=>{
  const f=e.target.files[0];if(!f)return;e.target.value='';await loadSplitPdf(f);
});

async function loadSplitPdf(file){
  showProg(tx('p_load_pdf'));
  try{
    const ab=await file.arrayBuffer();
    spBytes=ab;
    spDoc=await pdfjsLib.getDocument({data:ab.slice(0)}).promise;
    spCount=spDoc.numPages;
    document.getElementById('splitFname').textContent=file.name.slice(0,30);
    document.getElementById('splitTotal').textContent=spCount;
    document.getElementById('splitRangeInp').value='';
    document.getElementById('splitPreview').textContent='-';
    document.getElementById('splitEmpty').style.display='none';
    document.getElementById('splitLoaded').style.display='flex';
    document.getElementById('splitAbar').style.display='flex';
    document.getElementById('splitBtn').disabled=true;
    // Hide previous share bar if any
    document.getElementById('splitShareBar').classList.remove('visible');
    await buildSpThumbs();
  }catch(e){console.error(e);toast(tx('t_pdf_err'))}
  hideProg();
}

async function buildSpThumbs(){
  const grid=document.getElementById('splitPageGrid');grid.innerHTML='';
  for(let p=1;p<=spCount;p++){
    const el=document.createElement('div');el.className='spt';el.dataset.p=p;
    const cv=document.createElement('canvas');
    const num=document.createElement('div');num.className='spt-num';num.textContent=p;
    el.append(cv,num);grid.appendChild(el);
    el.addEventListener('click',()=>{el.classList.toggle('sel');syncSpInput();});
    const pg=await spDoc.getPage(p);
    const vp=pg.getViewport({scale:.28});
    cv.width=vp.width;cv.height=vp.height;
    await pg.render({canvasContext:cv.getContext('2d'),viewport:vp}).promise;
  }
}

function parseRange(str,max){
  const pages=new Set();
  str.split(',').forEach(part=>{
    part=part.trim();
    const m=part.match(/^(\d+)\s*[-â€“]\s*(\d+)$/);
    if(m){const a=parseInt(m[1]),b=parseInt(m[2]);for(let i=Math.min(a,b);i<=Math.min(Math.max(a,b),max);i++)pages.add(i);}
    else{const n=parseInt(part);if(!isNaN(n)&&n>=1&&n<=max)pages.add(n);}
  });
  return [...pages].sort((a,b)=>a-b);
}

function syncSpInput(){
  const sel=Array.from(document.querySelectorAll('.spt.sel')).map(e=>parseInt(e.dataset.p)).sort((a,b)=>a-b);
  if(!sel.length){document.getElementById('splitRangeInp').value='';document.getElementById('splitPreview').textContent='-';document.getElementById('splitBtn').disabled=true;return;}
  const ranges=[];let s=sel[0],e2=sel[0];
  for(let i=1;i<sel.length;i++){if(sel[i]===e2+1){e2=sel[i]}else{ranges.push(s===e2?`${s}`:`${s}-${e2}`);s=e2=sel[i];}}
  ranges.push(s===e2?`${s}`:`${s}-${e2}`);
  const v=ranges.join(', ');
  document.getElementById('splitRangeInp').value=v;
  document.getElementById('splitPreview').textContent=v;
  document.getElementById('splitBtn').disabled=false;
}

document.getElementById('splitRangeInp').addEventListener('input',e=>{
  const pages=parseRange(e.target.value,spCount);
  const ps=new Set(pages);
  document.querySelectorAll('.spt').forEach(el=>el.classList.toggle('sel',ps.has(parseInt(el.dataset.p))));
  document.getElementById('splitPreview').textContent=pages.length?e.target.value.trim():'-';
  document.getElementById('splitBtn').disabled=pages.length===0;
});

document.getElementById('splitClearBtn').addEventListener('click',()=>{
  spDoc=null;spBytes=null;spCount=0;
  document.getElementById('splitLoaded').style.display='none';
  document.getElementById('splitEmpty').style.display='';
  document.getElementById('splitAbar').style.display='none';
  document.getElementById('splitPageGrid').innerHTML='';
  document.getElementById('splitShareBar').classList.remove('visible');
});

document.getElementById('splitBtn').addEventListener('click',async()=>{
  const pages=parseRange(document.getElementById('splitRangeInp').value,spCount);
  if(!pages.length){toast(tx('t_no_pages'));return}
  showProg(tx('p_splitting'));document.getElementById('splitBtn').disabled=true;
  try{
    const src=await PDFLib.PDFDocument.load(spBytes.slice(0),{ignoreEncryption:true});
    const out=await PDFLib.PDFDocument.create();
    const copied=await out.copyPages(src,pages.map(p=>p-1));
    copied.forEach(p=>out.addPage(p));
    const bytes=await out.save();
    const blob=new Blob([bytes],{type:'application/pdf'});
    const name=`split-${pages[0]}-${pages[pages.length-1]}-${Date.now()}.pdf`;
    dlBytes(bytes,name);
    toast(tx('t_split_ok'));
    // CRITICAL FIX: Reference the newly created ID
    showShareBar('splitShareBar',blob,name);
  }catch(e){console.error(e);toast(tx('t_split_err'))}
  hideProg();document.getElementById('splitBtn').disabled=false;
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PHOTO PERSISTENCE â€” IndexedDB
   Photos are saved after every add/delete/crop so they survive
   back-navigation, app switching, or accidental exit.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let _db=null;

function openDB(){
  return new Promise((res,rej)=>{
    if(_db){res(_db);return}
    const req=indexedDB.open('photopdf',1);
    req.onupgradeneeded=e=>{
      const db=e.target.result;
      if(!db.objectStoreNames.contains('photos'))
        db.createObjectStore('photos',{keyPath:'id',autoIncrement:true});
    };
    req.onsuccess=e=>{_db=e.target.result;res(_db)};
    req.onerror=()=>rej(req.error);
  });
}

async function savePhotos(){
  try{
    const db=await openDB();
    const srcs=Array.from(photoList.querySelectorAll('.pi img')).map(i=>i.src);
    const tx2=db.transaction('photos','readwrite');
    const store=tx2.objectStore('photos');
    store.clear();
    srcs.forEach((src,i)=>store.add({id:i+1,src}));
  }catch(e){/* silently ignore â€” persistence is best-effort */}
}

async function restorePhotos(){
  try{
    const db=await openDB();
    const tx2=db.transaction('photos','readonly');
    const store=tx2.objectStore('photos');
    const req=store.getAll();
    req.onsuccess=()=>{
      const rows=req.result||[];
      rows.forEach(row=>addPhotoCard(row.src,true));
    };
  }catch(e){}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
lang=localStorage.getItem('lang')||'tr';
applyLang();
restorePhotos();
</script>
</body>
</html>

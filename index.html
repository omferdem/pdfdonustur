<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>FotoPDF</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0d0d11;--surf:#16161e;--surf2:#1e1e28;--surf3:#252530;
  --acc:#f5c842;--acc2:#f07840;--green:#4caf82;--red:#e05252;--blue:#5b9cf6;--purple:#a78bfa;
  --text:#edeae2;--muted:#6a6a7e;--border:#252530;--r:12px;--ease:cubic-bezier(.4,0,.2,1);
}
html,body{height:100%;overflow:hidden}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);display:flex;flex-direction:column;height:100dvh}

/* HEADER */
header{flex-shrink:0;display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--surf);border-bottom:1px solid var(--border);gap:10px;z-index:10}
.logo{font-family:'Syne',sans-serif;font-weight:800;font-size:1.15rem;white-space:nowrap}
.logo span{color:var(--acc)}
.tabs{display:flex;gap:4px;background:var(--surf2);border:1px solid var(--border);border-radius:12px;padding:4px}
.tab-btn{
  padding:10px 16px;border-radius:9px;border:none;background:transparent;
  color:var(--muted);font-family:'Syne',sans-serif;font-weight:700;font-size:.82rem;
  cursor:pointer;transition:background .18s,color .18s,transform .1s;white-space:nowrap;
  touch-action:manipulation;
}
.tab-btn.active{background:var(--acc);color:#111;transform:none}
.tab-btn:not(.active):active{transform:scale(.95)}
.count-pill{background:var(--surf2);border:1px solid var(--border);padding:5px 13px;border-radius:999px;font-size:.75rem;color:var(--muted);white-space:nowrap;flex-shrink:0}
.count-pill b{color:var(--acc)}

/* SETTINGS */
.settings-bar{flex-shrink:0;display:flex;gap:8px;padding:8px 14px;background:var(--surf);border-bottom:1px solid var(--border);overflow-x:auto;scrollbar-width:none}
.settings-bar::-webkit-scrollbar{display:none}
.setting-chip{display:flex;flex-direction:column;gap:3px;flex-shrink:0}
.setting-chip label{font-size:.62rem;color:var(--muted);text-transform:uppercase;letter-spacing:.07em}
select{background:var(--surf2);border:1px solid var(--border);color:var(--text);border-radius:8px;padding:6px 10px;font-size:.8rem;font-family:inherit;cursor:pointer;outline:none}
select:focus{border-color:var(--acc)}
input[type=range]{accent-color:var(--acc);cursor:pointer;width:90px}
.quality-val{font-size:.77rem;color:var(--acc);font-weight:700;min-width:32px}

/* TAB PANELS */
.tab-panel{display:none;flex:1;flex-direction:column;overflow:hidden;min-height:0}
.tab-panel.active{display:flex}
.content-scroll{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;padding:14px}

/* DROP ZONE */
.drop-zone{border:2px dashed var(--border);border-radius:var(--r);padding:24px 16px;text-align:center;background:var(--surf);cursor:pointer;transition:border .2s,background .2s;margin-bottom:14px;position:relative}
.drop-zone:hover,.drop-zone.drag-over{border-color:var(--acc);background:rgba(245,200,66,.04)}
.drop-zone input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
.drop-icon{font-size:1.8rem;margin-bottom:5px}
.drop-zone h3{font-family:'Syne',sans-serif;font-size:.9rem;margin-bottom:3px}
.drop-zone p{font-size:.74rem;color:var(--muted)}

/* PHOTO GRID */
#photo-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:10px}

/* Kart yapÄ±sÄ±: drag-handle Ã¼stte, resim ortada, buton ÅŸeridi altta */
.photo-item{
  position:relative;border-radius:10px;
  animation:popIn .22s var(--ease);background:var(--surf2);
  display:flex;flex-direction:column;overflow:hidden;
  /* cursor normal â€” sadece handle sÃ¼rÃ¼kler */
  cursor:default;
}

/* SÃ¼rÃ¼kleme tutamacÄ± â€” sadece buraya dokunulduÄŸunda Sortable devreye girer */
.drag-handle{
  display:flex;align-items:center;justify-content:center;
  height:26px;background:rgba(255,255,255,.05);
  cursor:grab;flex-shrink:0;
  color:var(--muted);font-size:.85rem;letter-spacing:2px;
  user-select:none;touch-action:none;  /* Sortable bu element Ã¼zerinden Ã§alÄ±ÅŸÄ±r */
  border-bottom:1px solid rgba(255,255,255,.06);
}
.drag-handle:active{cursor:grabbing}

/* FotoÄŸraf alanÄ± â€” tÄ±klamayÄ± alacak ÅŸekilde pointer-events aÃ§Ä±k */
.photo-item img{
  width:100%;height:120px;object-fit:cover;display:block;
  pointer-events:none; /* drag-handle'a karÄ±ÅŸmasÄ±n */
}

/* Alt buton ÅŸeridi â€” her zaman gÃ¶rÃ¼nÃ¼r, hover gerektirmez */
.photo-actions{
  display:flex;align-items:center;padding:5px 6px;gap:5px;
  background:rgba(0,0,0,.35);
  border-top:1px solid rgba(255,255,255,.07);
  flex-shrink:0;
}
.order-num{
  font-size:.65rem;font-weight:700;color:var(--muted);
  flex:1;padding-left:2px;
}
.action-btn{
  /* BÃ¼yÃ¼k dokunma alanÄ± â€” minimum 44x44 px */
  width:38px;height:36px;
  border-radius:8px;border:none;cursor:pointer;
  font-size:14px;display:flex;align-items:center;justify-content:center;
  transition:transform .15s,opacity .15s;
  -webkit-tap-highlight-color:transparent;
  touch-action:manipulation;
}
.action-btn:active{transform:scale(.9);opacity:.75}
.action-btn.edit{background:rgba(91,156,246,.22);color:var(--blue)}
.action-btn.sign{background:rgba(167,139,250,.22);color:var(--purple)}
.action-btn.del {background:rgba(224,82,82,.22);color:var(--red)}

.sortable-ghost{opacity:.2;border:2px dashed var(--acc)}
.sortable-chosen{box-shadow:0 8px 28px rgba(0,0,0,.5);z-index:5;opacity:.85}
.sortable-drag{opacity:1!important}
@keyframes popIn{from{opacity:0;transform:scale(.88)}to{opacity:1;transform:scale(1)}}

/* MERGE LIST */
.merge-list{display:flex;flex-direction:column;gap:8px;margin-bottom:14px}
.merge-item{display:flex;align-items:center;gap:10px;background:var(--surf);border:1px solid var(--border);border-radius:10px;padding:10px 12px;cursor:grab;animation:popIn .22s var(--ease)}
.merge-item:active{cursor:grabbing}
.merge-drag{color:var(--muted);font-size:1rem;flex-shrink:0;user-select:none}
.merge-info{flex:1;min-width:0}
.merge-name{font-size:.83rem;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.merge-pages{font-size:.7rem;color:var(--muted);margin-top:2px}
.merge-del{background:transparent;border:1px solid var(--border);color:var(--red);border-radius:8px;width:30px;height:30px;cursor:pointer;font-size:13px;flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:background .15s}
.merge-del:hover{background:rgba(224,82,82,.12)}

/* SIGN TAB */
.sign-layout{display:flex;flex:1;overflow:hidden;min-height:0}
.sign-thumbs{flex-shrink:0;width:86px;overflow-y:auto;overflow-x:hidden;background:var(--surf);border-right:1px solid var(--border);padding:8px;display:flex;flex-direction:column;gap:6px;scrollbar-width:thin;scrollbar-color:var(--surf3) transparent}
.thumb-wrap{position:relative;cursor:pointer;border-radius:6px;overflow:hidden;border:2px solid transparent;transition:border-color .18s;flex-shrink:0}
.thumb-wrap.active{border-color:var(--acc)}
.thumb-wrap canvas{width:100%;display:block}
.thumb-num{position:absolute;bottom:3px;left:3px;background:rgba(0,0,0,.7);color:#fff;font-size:.56rem;font-weight:700;padding:1px 5px;border-radius:999px}
.sign-preview-area{flex:1;overflow:auto;background:#111;display:flex;align-items:flex-start;justify-content:center;padding:20px}
.page-preview-wrap{position:relative;display:inline-block;line-height:0;flex-shrink:0}
.page-preview-wrap canvas{border-radius:4px;box-shadow:0 8px 32px rgba(0,0,0,.6);display:block}
.sig-overlay{position:absolute;cursor:move;user-select:none;touch-action:none;border:1.5px dashed rgba(245,200,66,.7);border-radius:3px}
.sig-overlay img{width:100%;height:100%;display:block;pointer-events:none}
.sig-del{position:absolute;top:-11px;right:-11px;background:var(--red);color:#fff;border:2px solid var(--bg);border-radius:50%;width:22px;height:22px;cursor:pointer;font-size:11px;display:flex;align-items:center;justify-content:center;z-index:3;line-height:1}
.sig-resize{position:absolute;bottom:-9px;right:-9px;width:18px;height:18px;background:var(--acc);border-radius:3px;cursor:se-resize;z-index:3;display:flex;align-items:center;justify-content:center;font-size:10px;color:#111}
.sign-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;gap:12px;color:var(--muted);font-size:.88rem;text-align:center;padding:24px}
.sign-empty .big-icon{font-size:3rem;opacity:.35}

/* ACTION BAR */
.action-bar{
  flex-shrink:0;display:flex;gap:8px;
  padding:12px 14px;
  background:var(--surf);border-top:2px solid var(--border);
  padding-bottom:calc(12px + env(safe-area-inset-bottom));
}
.btn{
  padding:14px 18px;border:none;border-radius:12px;
  font-family:'Syne',sans-serif;font-weight:700;font-size:.92rem;
  cursor:pointer;display:flex;align-items:center;justify-content:center;gap:7px;
  transition:opacity .18s,transform .15s var(--ease);white-space:nowrap;
  min-height:50px;touch-action:manipulation;
  -webkit-tap-highlight-color:transparent;
}
.btn:hover:not(:disabled){opacity:.85;transform:translateY(-1px)}
.btn:active:not(:disabled){transform:scale(.96)}
.btn:disabled{opacity:.3;cursor:not-allowed}
.btn-ghost{background:var(--surf2);color:var(--text);border:1.5px solid var(--border);position:relative;overflow:hidden}
.btn-ghost input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer}
.btn-danger{background:rgba(224,82,82,.15);color:var(--red);border:1.5px solid var(--red)}
.btn-primary{background:linear-gradient(135deg,var(--acc),var(--acc2));color:#111;flex:1;font-size:.95rem}
.btn-green{background:linear-gradient(135deg,var(--green),#3a9e6a);color:#fff}
.btn-purple{background:linear-gradient(135deg,var(--purple),#7c3aed);color:#fff;flex:1}

/* MODALS */
.modal-back{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);backdrop-filter:blur(8px);z-index:400;flex-direction:column}
.modal-back.open{display:flex}
.modal-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--surf);border-bottom:1px solid var(--border);flex-shrink:0}
.modal-header h2{font-family:'Syne',sans-serif;font-size:.95rem}
.modal-header span{font-size:.74rem;color:var(--muted)}
.modal-toolbar{display:flex;gap:5px;padding:8px 12px;background:var(--surf2);flex-shrink:0;overflow-x:auto;scrollbar-width:none;align-items:center}
.modal-toolbar::-webkit-scrollbar{display:none}
.tool-btn{padding:6px 11px;border-radius:8px;border:1px solid var(--border);background:var(--surf);color:var(--text);font-family:'DM Sans',sans-serif;font-size:.77rem;cursor:pointer;white-space:nowrap;transition:background .15s,border-color .15s;display:flex;align-items:center;gap:4px;flex-shrink:0}
.tool-btn:hover{background:var(--surf3);border-color:var(--acc)}
.tool-btn.active{background:var(--acc);color:#111;border-color:var(--acc);font-weight:600}
.modal-canvas{flex:1;overflow:hidden;position:relative;background:#0a0a0e;display:flex;align-items:center;justify-content:center}
.modal-canvas img{max-width:100%;max-height:100%;display:block}
.modal-footer{display:flex;gap:8px;padding:10px 14px;background:var(--surf);border-top:1px solid var(--border);flex-shrink:0;padding-bottom:calc(10px + env(safe-area-inset-bottom))}
.divider{width:1px;background:var(--border);margin:0 2px;align-self:stretch;flex-shrink:0}

/* Signature draw */
.color-dot{width:26px;height:26px;border-radius:50%;cursor:pointer;border:3px solid transparent;transition:border-color .15s,transform .15s;flex-shrink:0;touch-action:manipulation}
.color-dot.active{border-color:#fff;transform:scale(1.18)}
.sig-canvas-wrap{
  flex:1;display:flex;align-items:stretch;justify-content:stretch;
  background:#f5f5ec;position:relative;overflow:hidden;
}
#sigCanvas{
  display:block;cursor:crosshair;touch-action:none;
  width:100%!important;height:100%!important; /* fill full area */
}
.sig-hint{
  position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  font-size:.85rem;color:#ccc;pointer-events:none;white-space:nowrap;
  transition:opacity .3s;
}
.sig-hint.hidden{opacity:0}

/* Progress */
.progress-back{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);backdrop-filter:blur(6px);z-index:600;align-items:center;justify-content:center}
.progress-back.open{display:flex}
.progress-card{background:var(--surf);border:1px solid var(--border);border-radius:16px;padding:26px 30px;text-align:center;min-width:230px}
.progress-card h3{font-family:'Syne',sans-serif;margin-bottom:14px;font-size:.94rem}
.progress-track{width:100%;height:7px;background:var(--surf2);border-radius:999px;overflow:hidden;margin-bottom:9px}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--acc),var(--acc2));border-radius:999px;transition:width .2s var(--ease);width:0%}
.progress-note{font-size:.77rem;color:var(--muted)}

.toast{position:fixed;top:64px;left:50%;transform:translateX(-50%) translateY(-6px);background:var(--surf2);border:1px solid var(--border);color:var(--text);padding:8px 18px;border-radius:10px;font-size:.81rem;opacity:0;pointer-events:none;transition:opacity .25s,transform .25s;z-index:700;white-space:nowrap}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.empty-state{grid-column:1/-1;text-align:center;padding:26px;color:var(--muted);font-size:.81rem;line-height:1.8}

@media(max-width:480px){
  .tabs .tab-btn{padding:5px 8px;font-size:.7rem}
  .sign-thumbs{width:68px}
  .photo-overlay{opacity:1;background:rgba(0,0,0,.25)}
}
</style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="logo">Foto<span>PDF</span></div>
  <div class="tabs">
    <button class="tab-btn active" data-tab="photo">ğŸ“· FotoÄŸraf</button>
    <button class="tab-btn" data-tab="merge">ğŸ”— BirleÅŸtir</button>
    <button class="tab-btn" data-tab="sign">âœï¸ Ä°mzala</button>
  </div>
  <div class="count-pill" id="countPill">Foto: <b>0</b></div>
</header>

<!-- â•â•â•â•â•â•â• TAB: PHOTO â•â•â•â•â•â•â• -->
<div class="tab-panel active" id="tab-photo">
  <div class="settings-bar">
    <div class="setting-chip">
      <label>Sayfa</label>
      <select id="pageSize"><option value="a4">A4</option><option value="a5">A5</option><option value="letter">Letter</option><option value="square">Kare</option></select>
    </div>
    <div class="setting-chip">
      <label>YÃ¶n</label>
      <select id="orientation"><option value="auto">Otomatik</option><option value="portrait">Dikey</option><option value="landscape">Yatay</option></select>
    </div>
    <div class="setting-chip">
      <label>Kenar</label>
      <select id="margin"><option value="8">8mm</option><option value="0">KenarsÄ±z</option><option value="15">15mm</option></select>
    </div>
    <div class="setting-chip">
      <label>Kalite: <span id="qualityVal" class="quality-val">85%</span></label>
      <input type="range" id="qualityRange" min="40" max="100" value="85">
    </div>
  </div>
  <div class="content-scroll">
    <div class="drop-zone" id="photoDropZone">
      <input type="file" id="photoFileInput" multiple accept="image/*">
      <div class="drop-icon">ğŸ“·</div>
      <h3>FotoÄŸraf Ekle</h3>
      <p>TÄ±kla veya sÃ¼rÃ¼kleyip bÄ±rak Â· JPG, PNG, WebP</p>
    </div>
    <div id="photo-list">
      <div class="empty-state" id="photoEmpty">ğŸ“‚ HenÃ¼z fotoÄŸraf eklenmedi.</div>
    </div>
  </div>
  <div class="action-bar">
    <button class="btn btn-ghost">ï¼‹ FotoÄŸraf Ekle<input type="file" id="photoFileInput2" multiple accept="image/*"></button>
    <button class="btn btn-danger" id="photoClearBtn" disabled>ğŸ—‘ Temizle</button>
    <button class="btn btn-primary" id="photoPdfBtn" disabled>ğŸ“„ PDF OluÅŸtur</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â• TAB: MERGE â•â•â•â•â•â•â• -->
<div class="tab-panel" id="tab-merge">
  <div class="content-scroll">
    <div class="drop-zone" id="mergeDropZone">
      <input type="file" id="mergeFileInput" multiple accept="application/pdf">
      <div class="drop-icon">ğŸ“„</div>
      <h3>PDF DosyalarÄ± Ekle</h3>
      <p>BirleÅŸtirmek istediÄŸin PDF'leri seÃ§ Â· SÃ¼rÃ¼kle sÄ±rala</p>
    </div>
    <div class="merge-list" id="mergeList">
      <div class="empty-state" id="mergeEmpty">ğŸ“‚ HenÃ¼z PDF eklenmedi.</div>
    </div>
  </div>
  <div class="action-bar">
    <button class="btn btn-ghost">ï¼‹ PDF Ekle<input type="file" id="mergeFileInput2" multiple accept="application/pdf"></button>
    <button class="btn btn-danger" id="mergeClearBtn" disabled>ğŸ—‘ Temizle</button>
    <button class="btn btn-primary" id="mergePdfBtn" disabled>ğŸ”— BirleÅŸtir ve Ä°ndir</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â• TAB: SIGN â•â•â•â•â•â•â• -->
<div class="tab-panel" id="tab-sign">
  <div class="sign-empty" id="signEmpty">
    <div class="big-icon">âœï¸</div>
    <div style="font-size:.95rem;font-weight:500;margin-bottom:4px">Ä°mzalamak istediÄŸin dosyayÄ± seÃ§</div>
    <div style="font-size:.78rem;color:var(--muted);margin-bottom:16px">PDF veya fotoÄŸraf dosyasÄ± desteklenir</div>
    <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center">
      <label class="btn btn-ghost" style="cursor:pointer">ğŸ“„ PDF AÃ§<input type="file" id="signFileInput" accept="application/pdf"></label>
      <label class="btn btn-ghost" style="cursor:pointer">ğŸ–¼ï¸ FotoÄŸraf AÃ§<input type="file" id="signImageInput" accept="image/*"></label>
    </div>
  </div>
  <div id="signLoaded" style="display:none;flex:1;flex-direction:column;overflow:hidden;min-height:0">
    <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 14px;background:var(--surf);border-bottom:1px solid var(--border);flex-shrink:0;gap:10px">
      <div style="font-size:.79rem;color:var(--muted);min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">
        <b style="color:var(--acc)" id="signFileName">-</b> Â· <span id="signPageCount">0</span> <span id="signPageLabel">sayfa</span>
      </div>
      <div style="display:flex;gap:6px;flex-shrink:0">
        <label class="btn btn-ghost" style="padding:6px 10px;font-size:.73rem;cursor:pointer">PDF<input type="file" id="signFileInput2" accept="application/pdf"></label>
        <label class="btn btn-ghost" style="padding:6px 10px;font-size:.73rem;cursor:pointer">Foto<input type="file" id="signImageInput2" accept="image/*"></label>
      </div>
    </div>
    <div class="sign-layout">
      <div class="sign-thumbs" id="signThumbs"></div>
      <div class="sign-preview-area" id="signPreviewArea">
        <div class="page-preview-wrap" id="pagePreviewWrap">
          <canvas id="mainPageCanvas"></canvas>
        </div>
      </div>
    </div>
  </div>
  <div class="action-bar" id="signActionBar" style="display:none">
    <button class="btn btn-purple" id="drawSigBtn">âœï¸ Ä°mza Ã‡iz</button>
    <button class="btn btn-danger" id="clearSigsBtn">ğŸ—‘ Temizle</button>
    <button class="btn btn-primary" id="downloadSignedBtn">ğŸ“„ Ä°mzalÄ± Ä°ndir</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â• CROP MODAL â•â•â•â•â•â•â• -->
<div class="modal-back" id="cropModal">
  <div class="modal-header"><h2>âœ‚ï¸ DÃ¼zenle / KÄ±rp</h2><span id="cropIndex"></span></div>
  <div class="modal-toolbar">
    <span style="font-size:.66rem;color:var(--muted)">Oran:</span>
    <button class="tool-btn active" data-ratio="free">Serbest</button>
    <button class="tool-btn" data-ratio="1">1:1</button>
    <button class="tool-btn" data-ratio="1.333">4:3</button>
    <button class="tool-btn" data-ratio="1.778">16:9</button>
    <button class="tool-btn" data-ratio="0.707">A4</button>
    <div class="divider"></div>
    <button class="tool-btn" id="rotL">â†º Sol</button>
    <button class="tool-btn" id="rotR">â†» SaÄŸ</button>
    <button class="tool-btn" id="flipH">â‡„</button>
    <button class="tool-btn" id="flipV">â‡…</button>
    <button class="tool-btn" id="zoomIn">ğŸ”+</button>
    <button class="tool-btn" id="zoomOut">ğŸ”âˆ’</button>
  </div>
  <div class="modal-canvas"><img id="cropImage" src="" alt=""></div>
  <div class="modal-footer">
    <button class="btn btn-ghost" id="cancelCrop" style="flex:1">Ä°ptal</button>
    <button class="btn btn-ghost" id="resetCrop">SÄ±fÄ±rla</button>
    <button class="btn btn-green" id="applyCrop" style="flex:2">âœ“ Uygula</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â• SIGNATURE DRAW MODAL â•â•â•â•â•â•â• -->
<div class="modal-back" id="sigDrawModal">
  <div class="modal-header"><h2>âœï¸ Ä°mzanÄ± Ã‡iz</h2><span>Parmak veya mouse ile</span></div>
  <div class="modal-toolbar" id="sigToolbar">
    <span style="font-size:.66rem;color:var(--muted)">Renk:</span>
    <div class="color-dot active" data-color="#111111" style="background:#111111"></div>
    <div class="color-dot" data-color="#1a3a8a" style="background:#1a3a8a"></div>
    <div class="color-dot" data-color="#8a1a1a" style="background:#8a1a1a"></div>
    <div class="divider"></div>
    <span style="font-size:.66rem;color:var(--muted)">KalÄ±nlÄ±k:</span>
    <button class="tool-btn" data-width="2">Ä°nce</button>
    <button class="tool-btn active" data-width="3">Orta</button>
    <button class="tool-btn" data-width="5">KalÄ±n</button>
    <div class="divider"></div>
    <button class="tool-btn" id="clearSigCanvas">ğŸ—‘ Temizle</button>
  </div>
  <div class="sig-canvas-wrap">
    <canvas id="sigCanvas"></canvas>
    <div class="sig-hint" id="sig-hint">âœï¸ Buraya imzanÄ± Ã§iz</div>
  </div>
  <div class="modal-footer">
    <button class="btn btn-ghost" id="cancelSig" style="flex:1">Ä°ptal</button>
    <button class="btn btn-green" id="applySig" style="flex:2">âœ“ Ä°mzayÄ± YerleÅŸtir</button>
  </div>
</div>

<!-- PROGRESS -->
<div class="progress-back" id="progressBack">
  <div class="progress-card">
    <h3 id="progressTitle">Ä°ÅŸleniyorâ€¦</h3>
    <div class="progress-track"><div class="progress-fill" id="progressFill"></div></div>
    <div class="progress-note" id="progressNote">LÃ¼tfen bekleyin</div>
  </div>
</div>
<div class="toast" id="toast"></div>

<script>
/* â•â•â•â• GLOBALS â•â•â•â• */
const {jsPDF} = window.jspdf;
pdfjsLib.GlobalWorkerOptions.workerSrc =
  'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

/* â•â•â•â• HELPERS â•â•â•â• */
let toastTimer;
function toast(msg,ms=2800){
  const t=document.getElementById('toast');
  t.textContent=msg;t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>t.classList.remove('show'),ms);
}
function showProgress(title){
  document.getElementById('progressTitle').textContent=title||'Ä°ÅŸleniyorâ€¦';
  document.getElementById('progressFill').style.width='0%';
  document.getElementById('progressNote').textContent='HazÄ±rlanÄ±yorâ€¦';
  document.getElementById('progressBack').classList.add('open');
}
function setProgress(pct,note){
  document.getElementById('progressFill').style.width=pct+'%';
  if(note)document.getElementById('progressNote').textContent=note;
}
function hideProgress(){document.getElementById('progressBack').classList.remove('open')}
function dlBytes(bytes,name){
  const b=new Blob([bytes],{type:'application/pdf'});
  const u=URL.createObjectURL(b);const a=document.createElement('a');
  a.href=u;a.download=name;a.click();setTimeout(()=>URL.revokeObjectURL(u),5000);
}

/* â•â•â•â• HISTORY / BACK BUTTON â•â•â•â•
   Her modal aÃ§Ä±lÄ±ÅŸÄ±nda ve tab deÄŸiÅŸiminde history'ye push yapÄ±yoruz.
   Android geri tuÅŸu (popstate) en Ã¼stteki modalÄ± kapatÄ±r, yoksa Ã¶nceki taba dÃ¶ner.
*/
const modalIds = ['cropModal','sigDrawModal'];
let activeTab = 'photo';

function pushState(kind, val){
  history.pushState({kind, val}, '');
}

window.addEventListener('popstate', e=>{
  const s = e.state;
  // AÃ§Ä±k modal varsa kapat
  for(const id of modalIds){
    const m = document.getElementById(id);
    if(m && m.classList.contains('open')){
      if(id==='cropModal') closeCrop();
      else if(id==='sigDrawModal') document.getElementById('sigDrawModal').classList.remove('open');
      return;
    }
  }
  // Modal yoksa Ã¶nceki taba dÃ¶n
  if(s && s.kind==='tab'){
    switchTab(s.val, false);
  } else {
    switchTab('photo', false);
  }
});

function switchTab(tabId, pushHist=true){
  if(pushHist) pushState('tab', tabId);
  activeTab = tabId;
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.toggle('active', b.dataset.tab===tabId));
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.toggle('active', p.id==='tab-'+tabId));
}

// Ä°lk yÃ¼kleme state'i
history.replaceState({kind:'tab', val:'photo'}, '');

document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click',()=> switchTab(btn.dataset.tab));
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAB 1 â€“ PHOTO â†’ PDF
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const photoList=document.getElementById('photo-list');
const photoEmpty=document.getElementById('photoEmpty');
const photoPdfBtn=document.getElementById('photoPdfBtn');
const photoClearBtn=document.getElementById('photoClearBtn');
const countPill=document.getElementById('countPill');

document.getElementById('qualityRange').addEventListener('input',function(){
  document.getElementById('qualityVal').textContent=this.value+'%';
});

[document.getElementById('photoFileInput'),document.getElementById('photoFileInput2')]
  .forEach(i=>i.addEventListener('change',e=>{loadPhotoFiles(e.target.files);e.target.value=''}));

const photoDZ=document.getElementById('photoDropZone');
photoDZ.addEventListener('dragover',e=>{e.preventDefault();photoDZ.classList.add('drag-over')});
photoDZ.addEventListener('dragleave',()=>photoDZ.classList.remove('drag-over'));
photoDZ.addEventListener('drop',e=>{e.preventDefault();photoDZ.classList.remove('drag-over');loadPhotoFiles(e.dataTransfer.files)});

new Sortable(photoList,{
  animation:200,
  handle:'.drag-handle',
  ghostClass:'sortable-ghost',
  chosenClass:'sortable-chosen',
  dragClass:'sortable-drag',
  filter:'.empty-state',
  delay:0,
  touchStartThreshold:3,
  forceFallback:false,
  onEnd:refreshBadges
});

function loadPhotoFiles(files){
  Array.from(files).filter(f=>f.type.startsWith('image/')).forEach(f=>{
    const r=new FileReader();r.onload=e=>createPhotoItem(e.target.result);r.readAsDataURL(f);
  });
}
function createPhotoItem(src){
  photoEmpty.style.display='none';

  const div=document.createElement('div');
  div.className='photo-item';

  // â”€â”€ Ãœst: sÃ¼rÃ¼kleme tutamacÄ± â”€â”€
  const handle=document.createElement('div');
  handle.className='drag-handle';
  handle.innerHTML='â ¿ â ¿ â ¿';
  handle.title='SÄ±rala';

  // â”€â”€ Orta: fotoÄŸraf â”€â”€
  const img=document.createElement('img');
  img.src=src;
  img.draggable=false;

  // â”€â”€ Alt: her zaman gÃ¶rÃ¼nÃ¼r butonlar â”€â”€
  const actions=document.createElement('div');
  actions.className='photo-actions';

  const num=document.createElement('span');
  num.className='order-num';

  const editBtn=document.createElement('button');
  editBtn.className='action-btn edit';
  editBtn.innerHTML='âœï¸';
  editBtn.title='DÃ¼zenle / KÄ±rp';
  // mousedown + touchend ikisi birden â†’ her cihazda Ã§alÄ±ÅŸÄ±r
  editBtn.addEventListener('click', e=>{
    e.stopPropagation();
    e.preventDefault();
    openCrop(div);
  });

  const delBtn=document.createElement('button');
  delBtn.className='action-btn del';
  delBtn.innerHTML='ğŸ—‘';
  delBtn.title='Sil';
  delBtn.addEventListener('click', e=>{
    e.stopPropagation();
    e.preventDefault();
    div.remove();
    refreshBadges();
    photoState();
  });

  const signBtn=document.createElement('button');
  signBtn.className='action-btn sign';
  signBtn.innerHTML='âœï¸';
  signBtn.title='Ä°mza Ekle';
  signBtn.addEventListener('click', e=>{
    e.stopPropagation();
    e.preventDefault();
    openPhotoSign(div);
  });

  actions.append(num, editBtn, signBtn, delBtn);
  div.append(handle, img, actions);
  photoList.appendChild(div);
  refreshBadges();
  photoState();
}
function refreshBadges(){
  photoList.querySelectorAll('.photo-item .order-num').forEach((b,i)=>b.textContent=i+1);
}
function photoState(){
  const n=photoList.querySelectorAll('.photo-item').length;
  countPill.innerHTML=`Foto: <b>${n}</b>`;
  photoPdfBtn.disabled=n===0;photoClearBtn.disabled=n===0;
  if(n===0)photoEmpty.style.display='';
}
photoClearBtn.addEventListener('click',()=>{
  if(!confirm('TÃ¼m fotoÄŸraflar silinsin mi?'))return;
  photoList.querySelectorAll('.photo-item').forEach(el=>el.remove());photoState();
});

const PAGE_SIZES={a4:[210,297],a5:[148,210],letter:[215.9,279.4],square:[150,150]};
photoPdfBtn.addEventListener('click',async()=>{
  const items=Array.from(photoList.querySelectorAll('.photo-item'));if(!items.length)return;
  const [pw0,ph0]=PAGE_SIZES[document.getElementById('pageSize').value];
  const ori0=document.getElementById('orientation').value;
  const marg=parseInt(document.getElementById('margin').value);
  const qual=parseInt(document.getElementById('qualityRange').value)/100;
  showProgress('PDF OluÅŸturuluyorâ€¦');photoPdfBtn.disabled=true;
  let doc=null;
  for(let i=0;i<items.length;i++){
    const img=items[i].querySelector('img');
    let ori='portrait';
    if(ori0==='landscape')ori='landscape';
    else if(ori0==='auto'&&img.naturalWidth>img.naturalHeight)ori='landscape';
    const pw=ori==='landscape'?ph0:pw0,ph=ori==='landscape'?pw0:ph0;
    if(i===0)doc=new jsPDF({orientation:ori,unit:'mm',format:[pw,ph]});
    else doc.addPage([pw,ph],ori);
    const avW=pw-marg*2,avH=ph-marg*2,ratio=img.naturalWidth/img.naturalHeight;
    let dw=avW,dh=dw/ratio;if(dh>avH){dh=avH;dw=dh*ratio}
    const c=document.createElement('canvas');c.width=img.naturalWidth;c.height=img.naturalHeight;
    c.getContext('2d').drawImage(img,0,0);
    doc.addImage(c.toDataURL('image/jpeg',qual),'JPEG',(pw-dw)/2,(ph-dh)/2,dw,dh);
    setProgress(Math.round((i+1)/items.length*100),`${i+1} / ${items.length} fotoÄŸraf`);
    await new Promise(r=>setTimeout(r,15));
  }
  doc.save(`fotopdf-${Date.now()}.pdf`);
  hideProgress();photoPdfBtn.disabled=false;toast('âœ… PDF indirildi!');
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CROP MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let cropper=null,editItem=null,origSrc=null,sx=1,sy=1;
function openCrop(item){
  editItem=item;sx=1;sy=1;
  const img=item.querySelector('img');origSrc=img.src;
  const ci=document.getElementById('cropImage');ci.src=img.src;
  document.getElementById('cropIndex').textContent=
    'FotoÄŸraf #'+(Array.from(photoList.querySelectorAll('.photo-item')).indexOf(item)+1);
  document.querySelectorAll('[data-ratio]').forEach(b=>b.classList.remove('active'));
  document.querySelector('[data-ratio="free"]').classList.add('active');
  pushState('modal','cropModal');
  document.getElementById('cropModal').classList.add('open');
  ci.onload=()=>{
    if(cropper){cropper.destroy();cropper=null}
    cropper=new Cropper(ci,{viewMode:1,autoCropArea:.88,movable:true,scalable:true,zoomable:true,background:true,responsive:true});
  };
  if(ci.complete)ci.onload();
}

/* â”€â”€ FotoÄŸrafa imza ekleme â”€â”€ */
let photoSignTarget=null; // imza eklenecek photo-item

function openPhotoSign(item){
  photoSignTarget=item;
  sigCtx.clearRect(0,0,sigCvs.width,sigCvs.height);
  document.getElementById('sig-hint').classList.remove('hidden');
  pushState('modal','sigDrawModal');
  document.getElementById('sigDrawModal').classList.add('open');
  setTimeout(resizeSigCanvas, 60);
}
function closeCrop(){
  if(cropper){cropper.destroy();cropper=null}
  document.getElementById('cropModal').classList.remove('open');editItem=null;
}
document.querySelectorAll('[data-ratio]').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('[data-ratio]').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    cropper?.setAspectRatio(btn.dataset.ratio==='free'?NaN:parseFloat(btn.dataset.ratio));
  });
});
document.getElementById('rotL').addEventListener('click',()=>cropper?.rotate(-90));
document.getElementById('rotR').addEventListener('click',()=>cropper?.rotate(90));
document.getElementById('flipH').addEventListener('click',()=>{sx*=-1;cropper?.scaleX(sx)});
document.getElementById('flipV').addEventListener('click',()=>{sy*=-1;cropper?.scaleY(sy)});
document.getElementById('zoomIn').addEventListener('click',()=>cropper?.zoom(.1));
document.getElementById('zoomOut').addEventListener('click',()=>cropper?.zoom(-.1));
document.getElementById('cancelCrop').addEventListener('click',closeCrop);
document.getElementById('resetCrop').addEventListener('click',()=>{
  sx=1;sy=1;const ci=document.getElementById('cropImage');ci.src=origSrc;
  ci.onload=()=>{if(cropper){cropper.destroy();cropper=null}
    cropper=new Cropper(ci,{viewMode:1,autoCropArea:.88,movable:true,scalable:true,zoomable:true,background:true,responsive:true});
  };if(ci.complete)ci.onload();
});
document.getElementById('applyCrop').addEventListener('click',()=>{
  if(!cropper||!editItem)return;
  const c=cropper.getCroppedCanvas({maxWidth:2400,maxHeight:2400,imageSmoothingQuality:'high'});
  if(!c)return;
  editItem.querySelector('img').src=c.toDataURL('image/jpeg',.94);
  closeCrop();toast('âœ… DÃ¼zenleme uygulandÄ±');
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAB 2 â€“ PDF MERGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const mergeListEl=document.getElementById('mergeList');
const mergeEmpty=document.getElementById('mergeEmpty');
const mergePdfBtn=document.getElementById('mergePdfBtn');
const mergeClearBtn=document.getElementById('mergeClearBtn');
let mergeFiles=[];

new Sortable(mergeListEl,{animation:200,ghostClass:'sortable-ghost',chosenClass:'sortable-chosen',filter:'.empty-state'});

[document.getElementById('mergeFileInput'),document.getElementById('mergeFileInput2')]
  .forEach(i=>i.addEventListener('change',e=>{loadMergeFiles(e.target.files);e.target.value=''}));

const mergeDZ=document.getElementById('mergeDropZone');
mergeDZ.addEventListener('dragover',e=>{e.preventDefault();mergeDZ.classList.add('drag-over')});
mergeDZ.addEventListener('dragleave',()=>mergeDZ.classList.remove('drag-over'));
mergeDZ.addEventListener('drop',e=>{e.preventDefault();mergeDZ.classList.remove('drag-over');loadMergeFiles(e.dataTransfer.files)});

async function loadMergeFiles(files){
  const pdfs=Array.from(files).filter(f=>f.type==='application/pdf'||f.name.endsWith('.pdf'));
  for(const f of pdfs){
    try{
      const ab=await f.arrayBuffer();
      const pdf=await PDFLib.PDFDocument.load(ab,{ignoreEncryption:true});
      const data={name:f.name,pages:pdf.getPageCount(),arrayBuffer:ab};
      mergeFiles.push(data);addMergeItem(data);
    }catch(e){toast('âŒ '+f.name+' okunamadÄ±')}
  }
  mergeState();
}
function addMergeItem(data){
  mergeEmpty.style.display='none';
  const div=document.createElement('div');div.className='merge-item';
  div.innerHTML=`<span class="merge-drag">â ¿</span>
    <div class="merge-info"><div class="merge-name" title="${data.name}">${data.name}</div>
    <div class="merge-pages">${data.pages} sayfa</div></div>
    <button class="merge-del">âœ•</button>`;
  div.querySelector('.merge-del').addEventListener('click',()=>{
    const i=mergeFiles.indexOf(data);if(i>-1)mergeFiles.splice(i,1);
    div.remove();mergeState();
  });
  mergeListEl.appendChild(div);
}
function mergeState(){
  const n=mergeFiles.length;
  mergePdfBtn.disabled=n<2;mergeClearBtn.disabled=n===0;
  if(n===0)mergeEmpty.style.display='';
}
mergeClearBtn.addEventListener('click',()=>{
  if(!confirm('Liste temizlensin mi?'))return;
  mergeFiles=[];mergeListEl.querySelectorAll('.merge-item').forEach(el=>el.remove());mergeState();
});
mergePdfBtn.addEventListener('click',async()=>{
  if(mergeFiles.length<2)return;
  showProgress('PDF\'ler BirleÅŸtiriliyorâ€¦');mergePdfBtn.disabled=true;
  try{
    const merged=await PDFLib.PDFDocument.create();
    // Respect DOM order for dragged items
    const domNames=Array.from(mergeListEl.querySelectorAll('.merge-name')).map(el=>el.title);
    const ordered=domNames.map(name=>mergeFiles.find(f=>f.name===name)).filter(Boolean);
    const src=ordered.length===mergeFiles.length?ordered:mergeFiles;
    for(let i=0;i<src.length;i++){
      const pdf=await PDFLib.PDFDocument.load(src[i].arrayBuffer,{ignoreEncryption:true});
      const pages=await merged.copyPages(pdf,pdf.getPageIndices());
      pages.forEach(p=>merged.addPage(p));
      setProgress(Math.round((i+1)/src.length*100),`${i+1} / ${src.length} dosya`);
      await new Promise(r=>setTimeout(r,10));
    }
    dlBytes(await merged.save(),`birlesik-${Date.now()}.pdf`);
    toast('âœ… PDF birleÅŸtirildi!');
  }catch(e){console.error(e);toast('âŒ Hata: '+e.message)}
  hideProgress();mergePdfBtn.disabled=false;
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAB 3 â€“ SIGN PDF
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let signDoc=null,signRawBytes=null,signCurrentPage=1,signPageCount=0;
let signaturePng=null,placedSigs=[],pageScale=1;
let signImageSrc=null; // gÃ¶rsel imzalama modu iÃ§in

[document.getElementById('signFileInput'),document.getElementById('signFileInput2')]
  .forEach(i=>i.addEventListener('change',e=>{if(e.target.files[0])loadSignPDF(e.target.files[0]);e.target.value=''}));

// FotoÄŸraf imzalama â€” imaj dosyasÄ±nÄ± canvas'a yÃ¼kle
[document.getElementById('signImageInput'),document.getElementById('signImageInput2')]
  .forEach(i=>i.addEventListener('change',e=>{if(e.target.files[0])loadSignImage(e.target.files[0]);e.target.value=''}));

async function loadSignImage(file){
  showProgress('FotoÄŸraf YÃ¼kleniyorâ€¦');
  try{
    const url=URL.createObjectURL(file);
    const img=new Image();
    img.onload=async()=>{
      // Reset
      signRawBytes=null;signDoc=null;placedSigs=[];signCurrentPage=1;signPageCount=1;
      document.getElementById('signFileName').textContent=
        file.name.length>30?file.name.slice(0,28)+'â€¦':file.name;
      document.getElementById('signPageCount').textContent='1';
      document.getElementById('signPageLabel').textContent='gÃ¶rsel';
      document.getElementById('signEmpty').style.display='none';
      const loaded=document.getElementById('signLoaded');
      loaded.style.display='flex';
      document.getElementById('signActionBar').style.display='flex';
      // Render image to main canvas
      const area=document.getElementById('signPreviewArea');
      const maxW=Math.max(area.clientWidth-40,200);
      const scale=Math.min(maxW/img.width,1.6);
      const c=document.getElementById('mainPageCanvas');
      c.width=Math.round(img.width*scale);
      c.height=Math.round(img.height*scale);
      c.getContext('2d').drawImage(img,0,0,c.width,c.height);
      pageScale=scale;
      // Thumbnail
      const thumbCt=document.getElementById('signThumbs');thumbCt.innerHTML='';
      const wrap=document.createElement('div');wrap.className='thumb-wrap active';
      const tc=document.createElement('canvas');
      const ts=0.26;tc.width=Math.round(img.width*ts);tc.height=Math.round(img.height*ts);
      tc.getContext('2d').drawImage(img,0,0,tc.width,tc.height);
      const tn=document.createElement('div');tn.className='thumb-num';tn.textContent='1';
      wrap.append(tc,tn);thumbCt.appendChild(wrap);
      // Store image for download
      signImageSrc=c.toDataURL('image/png');
      URL.revokeObjectURL(url);
      hideProgress();
    };
    img.onerror=()=>{toast('âŒ GÃ¶rsel yÃ¼klenemedi');hideProgress()};
    img.src=url;
  }catch(e){console.error(e);toast('âŒ Hata: '+e.message);hideProgress()}
}

async function loadSignPDF(file){
  showProgress('PDF YÃ¼kleniyorâ€¦');
  try{
    const ab=await file.arrayBuffer();
    signRawBytes=ab;
    signDoc=await pdfjsLib.getDocument({data:ab.slice(0)}).promise;
    signPageCount=signDoc.numPages;
    document.getElementById('signFileName').textContent=
      file.name.length>30?file.name.slice(0,28)+'â€¦':file.name;
    document.getElementById('signPageCount').textContent=signPageCount;
    placedSigs=[];signCurrentPage=1;
    document.getElementById('signEmpty').style.display='none';
    const loaded=document.getElementById('signLoaded');
    loaded.style.display='flex';
    document.getElementById('signActionBar').style.display='flex';
    await renderThumbs();
    await renderPage(1);
  }catch(e){console.error(e);toast('âŒ PDF yÃ¼klenemedi')}
  hideProgress();
}

async function renderThumbs(){
  const ct=document.getElementById('signThumbs');ct.innerHTML='';
  for(let p=1;p<=signPageCount;p++){
    const wrap=document.createElement('div');wrap.className='thumb-wrap';wrap.dataset.page=p;
    const c=document.createElement('canvas');
    const num=document.createElement('div');num.className='thumb-num';num.textContent=p;
    wrap.append(c,num);
    wrap.addEventListener('click',()=>renderPage(p));
    ct.appendChild(wrap);
    const pg=await signDoc.getPage(p);
    const vp=pg.getViewport({scale:.28});
    c.width=vp.width;c.height=vp.height;
    await pg.render({canvasContext:c.getContext('2d'),viewport:vp}).promise;
  }
  updateThumbActive();
}
function updateThumbActive(){
  document.querySelectorAll('.thumb-wrap').forEach(w=>
    w.classList.toggle('active',parseInt(w.dataset.page)===signCurrentPage));
}

async function renderPage(pageNum){
  signCurrentPage=pageNum;updateThumbActive();
  document.querySelectorAll('.sig-overlay').forEach(el=>el.remove());
  const pg=await signDoc.getPage(pageNum);
  const area=document.getElementById('signPreviewArea');
  const maxW=Math.max(area.clientWidth-40,200);
  const vp0=pg.getViewport({scale:1});
  const scale=Math.min(maxW/vp0.width,1.9);
  pageScale=scale;
  const vp=pg.getViewport({scale});
  const c=document.getElementById('mainPageCanvas');
  c.width=vp.width;c.height=vp.height;
  await pg.render({canvasContext:c.getContext('2d'),viewport:vp}).promise;
  // Restore sigs for this page
  placedSigs.filter(s=>s.pageNum===pageNum).forEach(s=>buildSigOverlay(s));
}

/* Signature overlays */
function addSigToPage(dataUrl){
  const c=document.getElementById('mainPageCanvas');
  const sigW=Math.round(c.width*.38),sigH=Math.round(sigW*.32);
  const sigData={pageNum:signCurrentPage,x:Math.round((c.width-sigW)/2),y:Math.round((c.height-sigH)/2),w:sigW,h:sigH,dataUrl};
  placedSigs.push(sigData);buildSigOverlay(sigData);
}
function buildSigOverlay(sigData){
  const wrap=document.getElementById('pagePreviewWrap');
  const el=document.createElement('div');el.className='sig-overlay';
  el.style.cssText=`left:${sigData.x}px;top:${sigData.y}px;width:${sigData.w}px;height:${sigData.h}px`;
  const img=document.createElement('img');img.src=sigData.dataUrl;
  const del=document.createElement('button');del.className='sig-del';del.innerHTML='âœ•';
  del.addEventListener('click',e=>{
    e.stopPropagation();el.remove();
    const i=placedSigs.indexOf(sigData);if(i>-1)placedSigs.splice(i,1);
  });
  const rz=document.createElement('div');rz.className='sig-resize';rz.textContent='â‡²';
  el.append(img,del,rz);wrap.appendChild(el);
  makeDraggable(el,sigData);makeResizable(el,rz,sigData);
}
function makeDraggable(el,d){
  let startX,startY,ox,oy;
  const move=e=>{
    e.preventDefault();
    const t=e.touches?e.touches[0]:e;
    const c=document.getElementById('mainPageCanvas');
    d.x=Math.max(0,Math.min(ox+(t.clientX-startX),c.width-d.w));
    d.y=Math.max(0,Math.min(oy+(t.clientY-startY),c.height-d.h));
    el.style.left=d.x+'px';el.style.top=d.y+'px';
  };
  const up=()=>{
    document.removeEventListener('mousemove',move);document.removeEventListener('mouseup',up);
    document.removeEventListener('touchmove',move);document.removeEventListener('touchend',up);
  };
  const down=e=>{
    if(e.target.classList.contains('sig-del')||e.target.classList.contains('sig-resize'))return;
    e.preventDefault();const t=e.touches?e.touches[0]:e;
    startX=t.clientX;startY=t.clientY;ox=d.x;oy=d.y;
    document.addEventListener('mousemove',move);document.addEventListener('mouseup',up);
    document.addEventListener('touchmove',move,{passive:false});document.addEventListener('touchend',up);
  };
  el.addEventListener('mousedown',down);
  el.addEventListener('touchstart',down,{passive:false});
}
function makeResizable(el,handle,d){
  let startX,startY,ow,oh;
  const move=e=>{
    e.preventDefault();const t=e.touches?e.touches[0]:e;
    d.w=Math.max(40,ow+(t.clientX-startX));d.h=Math.max(20,oh+(t.clientY-startY));
    el.style.width=d.w+'px';el.style.height=d.h+'px';
  };
  const up=()=>{
    document.removeEventListener('mousemove',move);document.removeEventListener('mouseup',up);
    document.removeEventListener('touchmove',move);document.removeEventListener('touchend',up);
  };
  handle.addEventListener('mousedown',e=>{
    e.stopPropagation();e.preventDefault();startX=e.clientX;startY=e.clientY;ow=d.w;oh=d.h;
    document.addEventListener('mousemove',move);document.addEventListener('mouseup',up);
  });
  handle.addEventListener('touchstart',e=>{
    e.stopPropagation();e.preventDefault();const t=e.touches[0];startX=t.clientX;startY=t.clientY;ow=d.w;oh=d.h;
    document.addEventListener('touchmove',move,{passive:false});document.addEventListener('touchend',up);
  },{passive:false});
}

document.getElementById('clearSigsBtn').addEventListener('click',()=>{
  placedSigs=placedSigs.filter(s=>s.pageNum!==signCurrentPage);
  document.querySelectorAll('.sig-overlay').forEach(el=>el.remove());
  toast('Ä°mzalar temizlendi');
});

document.getElementById('downloadSignedBtn').addEventListener('click',async()=>{
  if(!placedSigs.length){toast('âš ï¸ HenÃ¼z imza eklemedin');return}

  // â”€â”€ GÃ¶rsel modu: imzalÄ± PNG indir â”€â”€
  if(!signRawBytes && signImageSrc){
    showProgress('Ä°mzalÄ± GÃ¶rsel OluÅŸturuluyorâ€¦');
    const base=new Image();
    base.onload=async()=>{
      const canvas=document.createElement('canvas');
      canvas.width=base.width;canvas.height=base.height;
      const ctx=canvas.getContext('2d');
      ctx.drawImage(base,0,0);
      // TÃ¼m imzalarÄ± Ã¼ste Ã§iz (koordinatlarÄ± Ã¶lÃ§eklendirerek)
      const c=document.getElementById('mainPageCanvas');
      for(const s of placedSigs){
        const sImg=new Image();
        await new Promise(res=>{sImg.onload=res;sImg.src=s.dataUrl});
        const sx=(s.x/c.width)*base.width;
        const sy=(s.y/c.height)*base.height;
        const sw=(s.w/c.width)*base.width;
        const sh=(s.h/c.height)*base.height;
        ctx.drawImage(sImg,sx,sy,sw,sh);
        setProgress(100,'HazÄ±rlandÄ±');
      }
      canvas.toBlob(blob=>{
        const u=URL.createObjectURL(blob);
        const a=document.createElement('a');a.href=u;a.download=`imzali-${Date.now()}.png`;a.click();
        setTimeout(()=>URL.revokeObjectURL(u),5000);
        hideProgress();toast('âœ… Ä°mzalÄ± gÃ¶rsel indirildi!');
      },'image/png');
    };
    base.src=signImageSrc;
    return;
  }

  // â”€â”€ PDF modu â”€â”€
  if(!signRawBytes)return;
  showProgress('Ä°mzalÄ± PDF OluÅŸturuluyorâ€¦');
  try{
    const pdfDoc=await PDFLib.PDFDocument.load(signRawBytes.slice(0),{ignoreEncryption:true});
    for(let i=0;i<placedSigs.length;i++){
      const s=placedSigs[i];
      const page=pdfDoc.getPage(s.pageNum-1);
      const {width:pW,height:pH}=page.getSize();
      const pjsPage=await signDoc.getPage(s.pageNum);
      const vp=pjsPage.getViewport({scale:pageScale});
      const rendW=vp.width,rendH=vp.height;
      const pdfX=(s.x/rendW)*pW;
      const pdfY=pH-((s.y+s.h)/rendH)*pH;
      const pdfW=(s.w/rendW)*pW;
      const pdfH=(s.h/rendH)*pH;
      const b64=s.dataUrl.split(',')[1];
      const bytes=Uint8Array.from(atob(b64),c=>c.charCodeAt(0));
      const pngImg=await pdfDoc.embedPng(bytes);
      page.drawImage(pngImg,{x:pdfX,y:pdfY,width:pdfW,height:Math.abs(pdfH)});
      setProgress(Math.round((i+1)/placedSigs.length*100),`${i+1} / ${placedSigs.length} imza`);
    }
    dlBytes(await pdfDoc.save(),`imzali-${Date.now()}.pdf`);
    toast('âœ… Ä°mzalÄ± PDF indirildi!');
  }catch(e){console.error(e);toast('âŒ Hata: '+e.message)}
  hideProgress();
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SIGNATURE DRAW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let drawing=false,sigColor='#111111',sigLineWidth=3;
const sigCvs=document.getElementById('sigCanvas');
const sigCtx=sigCvs.getContext('2d');

function resizeSigCanvas(){
  const wrap=sigCvs.parentElement;
  const r=wrap.getBoundingClientRect();
  // Save current drawing
  const tmp=document.createElement('canvas');
  tmp.width=sigCvs.width;tmp.height=sigCvs.height;
  tmp.getContext('2d').drawImage(sigCvs,0,0);
  sigCvs.width=Math.floor(r.width)||700;
  sigCvs.height=Math.floor(r.height)||320;
  sigCtx.lineCap='round';sigCtx.lineJoin='round';
  sigCtx.drawImage(tmp,0,0);
}

function getSigPt(e){
  const r=sigCvs.getBoundingClientRect();
  const t=e.touches?e.touches[0]:e;
  return{x:(t.clientX-r.left),y:(t.clientY-r.top)};
}

sigCvs.addEventListener('pointerdown',e=>{
  drawing=true;const p=getSigPt(e);
  sigCtx.beginPath();sigCtx.moveTo(p.x,p.y);
  sigCtx.strokeStyle=sigColor;sigCtx.lineWidth=sigLineWidth;
  document.getElementById('sig-hint').classList.add('hidden');
  sigCvs.setPointerCapture(e.pointerId);
});
sigCvs.addEventListener('pointermove',e=>{
  if(!drawing)return;const p=getSigPt(e);
  sigCtx.lineTo(p.x,p.y);sigCtx.stroke();sigCtx.beginPath();sigCtx.moveTo(p.x,p.y);
});
sigCvs.addEventListener('pointerup',()=>drawing=false);
sigCvs.addEventListener('pointercancel',()=>drawing=false);

document.getElementById('clearSigCanvas').addEventListener('click',()=>{
  sigCtx.clearRect(0,0,sigCvs.width,sigCvs.height);
  document.getElementById('sig-hint').classList.remove('hidden');
});

document.querySelectorAll('.color-dot').forEach(dot=>{
  dot.addEventListener('click',()=>{
    document.querySelectorAll('.color-dot').forEach(d=>d.classList.remove('active'));
    dot.classList.add('active');sigColor=dot.dataset.color;
  });
});
document.querySelectorAll('[data-width]').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('[data-width]').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');sigLineWidth=parseInt(btn.dataset.width);
  });
});

document.getElementById('drawSigBtn').addEventListener('click',()=>{
  photoSignTarget=null; // PDF imzalama modu
  sigCtx.clearRect(0,0,sigCvs.width,sigCvs.height);
  document.getElementById('sig-hint').classList.remove('hidden');
  pushState('modal','sigDrawModal');
  document.getElementById('sigDrawModal').classList.add('open');
  setTimeout(resizeSigCanvas, 60);
});

document.getElementById('cancelSig').addEventListener('click',()=>{
  document.getElementById('sigDrawModal').classList.remove('open');
  photoSignTarget=null;
  history.back();
});

document.getElementById('applySig').addEventListener('click',()=>{
  const d=sigCtx.getImageData(0,0,sigCvs.width,sigCvs.height);
  const drawn=d.data.some((_,i)=>i%4===3&&d.data[i]>0);
  if(!drawn){toast('âš ï¸ Ã–nce imzanÄ± Ã§iz!');return}
  const cropped=cropSigCanvas();
  const signaturePng=cropped.toDataURL('image/png');
  document.getElementById('sigDrawModal').classList.remove('open');

  if(photoSignTarget){
    // â”€â”€ FotoÄŸrafa imza uygula â”€â”€
    applySignatureToPhoto(photoSignTarget, signaturePng);
    photoSignTarget=null;
    toast('âœ… Ä°mza fotoÄŸrafa eklendi!');
  } else {
    // â”€â”€ PDF imzalama â”€â”€
    addSigToPage(signaturePng);
    toast('âœ… Ä°mza yerleÅŸtirildi â€” sÃ¼rÃ¼kle & kÃ¶ÅŸeden boyutlandÄ±r');
  }
  history.back();
});

/* FotoÄŸrafa imzayÄ± doÄŸrudan uygula (canvas Ã¼zerinden flatten) */
function applySignatureToPhoto(item, sigPng){
  const img=item.querySelector('img');
  const canvas=document.createElement('canvas');
  canvas.width=img.naturalWidth||img.width;
  canvas.height=img.naturalHeight||img.height;
  const ctx=canvas.getContext('2d');
  ctx.drawImage(img,0,0,canvas.width,canvas.height);
  // Ä°mzayÄ± saÄŸ alt kÃ¶ÅŸeye, geniÅŸliÄŸin %35'i kadar ekle
  const sigImg=new Image();
  sigImg.onload=()=>{
    const sw=canvas.width*0.35;
    const sh=sw*(sigImg.height/sigImg.width);
    const sx=canvas.width-sw-canvas.width*0.04;
    const sy=canvas.height-sh-canvas.height*0.04;
    ctx.drawImage(sigImg,sx,sy,sw,sh);
    img.src=canvas.toDataURL('image/jpeg',0.95);
  };
  sigImg.src=sigPng;
}

function cropSigCanvas(){
  const d=sigCtx.getImageData(0,0,sigCvs.width,sigCvs.height);
  let mnX=sigCvs.width,mnY=sigCvs.height,mxX=0,mxY=0;
  for(let y=0;y<sigCvs.height;y++)for(let x=0;x<sigCvs.width;x++){
    if(d.data[(y*sigCvs.width+x)*4+3]>0){
      if(x<mnX)mnX=x;if(x>mxX)mxX=x;if(y<mnY)mnY=y;if(y>mxY)mxY=y;
    }
  }
  const pad=14;
  mnX=Math.max(0,mnX-pad);mnY=Math.max(0,mnY-pad);
  mxX=Math.min(sigCvs.width,mxX+pad);mxY=Math.min(sigCvs.height,mxY+pad);
  const w=mxX-mnX||sigCvs.width,h=mxY-mnY||sigCvs.height;
  const out=document.createElement('canvas');out.width=w;out.height=h;
  out.getContext('2d').putImageData(sigCtx.getImageData(mnX,mnY,w,h),0,0);
  return out;
}
</script>
</body>
</html>

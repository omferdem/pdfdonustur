<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Foto PDF Pro</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <style>
        /* Genel Mobil Uyumlu TasarÄ±m */
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; background-color: #f0f2f5; padding-bottom: 80px; }
        .header { background: #6200ea; color: white; padding: 15px; text-align: center; position: sticky; top: 0; z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        h2 { margin: 0; font-size: 1.2rem; }

        /* FotoÄŸraf IzgarasÄ± */
        #gallery { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); /* Mobilde yan yana 2 resim */
            gap: 10px; 
            padding: 10px;
        }
        
        .photo-card {
            background: white; border-radius: 8px; overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: relative;
            touch-action: none; /* SÃ¼rÃ¼klemeyi iyileÅŸtirir */
        }

        .photo-card img {
            width: 100%; height: 150px; object-fit: cover; display: block;
        }

        /* Kart Ãœzerindeki Butonlar */
        .card-actions {
            display: flex; justify-content: space-between; padding: 8px; background: #fff;
        }
        .btn-icon {
            border: none; background: #eee; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 14px;
        }
        .btn-edit { color: #2980b9; font-weight: bold; }
        .btn-del { color: #c0392b; font-weight: bold; }

        /* Alt Kontrol BarÄ± */
        .bottom-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: white; padding: 10px; display: flex; gap: 10px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 20;
        }
        .btn { flex: 1; padding: 12px; border: none; border-radius: 8px; color: white; font-weight: bold; font-size: 14px; cursor: pointer; }
        .btn-add { background-color: #6200ea; }
        .btn-preview { background-color: #f39c12; }
        .btn-pdf { background-color: #27ae60; }

        /* Modal (DÃ¼zenleme ve Ã–nizleme EkranlarÄ±) */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: black; z-index: 50; flex-direction: column;
        }
        .modal-header { padding: 10px; display: flex; justify-content: space-between; background: #333; color: white; }
        .modal-body { flex: 1; overflow: hidden; display: flex; align-items: center; justify-content: center; background: #222; }
        
        /* Cropper AlanÄ± */
        #image-to-crop { max-width: 100%; max-height: 80vh; }

        /* PDF Ã–nizleme Listesi */
        #preview-list {
            width: 100%; height: 100%; overflow-y: scroll; padding: 20px; box-sizing: border-box; background: #525659;
        }
        .preview-page {
            background: white; margin-bottom: 20px; padding: 10px; min-height: 300px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .preview-page img { max-width: 100%; max-height: 100%; }

    </style>
</head>
<body>

<div class="header">
    <h2>Foto SÄ±rala & DÃ¼zenle</h2>
</div>

<div id="gallery"></div>

<div class="bottom-bar">
    <button class="btn btn-add" onclick="document.getElementById('fileInput').click()">+ Ekle</button>
    <input type="file" id="fileInput" multiple accept="image/*" style="display:none">
    
    <button class="btn btn-preview" onclick="openPreview()">Ã–nizle</button>
    <button class="btn btn-pdf" onclick="generatePDF()">PDF Ä°ndir</button>
</div>

<div id="cropModal" class="modal">
    <div class="modal-header">
        <button class="btn-icon" onclick="closeCropModal()">Ä°ptal</button>
        <span>KÄ±rpma EkranÄ±</span>
        <button class="btn-icon" style="background:#27ae60; color:white;" onclick="saveCrop()">KAYDET</button>
    </div>
    <div class="modal-body">
        <img id="image-to-crop" src="">
    </div>
</div>

<div id="previewModal" class="modal">
    <div class="modal-header">
        <button class="btn-icon" onclick="closePreviewModal()">Kapat</button>
        <span>PDF Ã–nizleme</span>
        <button class="btn-icon" style="background:#27ae60; color:white;" onclick="generatePDF()">Ä°NDÄ°R</button>
    </div>
    <div id="preview-list"></div>
</div>

<script>
    const gallery = document.getElementById('gallery');
    const fileInput = document.getElementById('fileInput');
    let cropper;
    let currentEditImage = null; // Åžu an dÃ¼zenlenmekte olan resim elementi

    // 1. SÄ±ralama Ã–zelliÄŸi (SortableJS)
    new Sortable(gallery, {
        animation: 150,
        ghostClass: 'sortable-ghost',
        delay: 100, // Mobilde yanlÄ±ÅŸlÄ±kla sÃ¼rÃ¼klemeyi Ã¶nlemek iÃ§in hafif gecikme
        delayOnTouchOnly: true
    });

    // 2. FotoÄŸraf YÃ¼kleme
    fileInput.addEventListener('change', function(e) {
        const files = e.target.files;
        if (!files.length) return;

        Array.from(files).forEach(file => {
            const reader = new FileReader();
            reader.onload = function(event) {
                addPhotoToGallery(event.target.result);
            }
            reader.readAsDataURL(file);
        });
        fileInput.value = ''; // Reset
    });

    function addPhotoToGallery(imgSrc) {
        const div = document.createElement('div');
        div.className = 'photo-card';
        div.innerHTML = `
            <img src="${imgSrc}" class="gallery-img">
            <div class="card-actions">
                <button class="btn-icon btn-edit" onclick="openCropModal(this)">âœ‚ DÃ¼zenle</button>
                <button class="btn-icon btn-del" onclick="removePhoto(this)">ðŸ—‘ Sil</button>
            </div>
        `;
        gallery.appendChild(div);
    }

    function removePhoto(btn) {
        if(confirm("Bu fotoÄŸrafÄ± silmek istiyor musun?")) {
            btn.closest('.photo-card').remove();
        }
    }

    // 3. KÄ±rpma / DÃ¼zenleme Ä°ÅŸlemleri
    const cropModal = document.getElementById('cropModal');
    const imageToCrop = document.getElementById('image-to-crop');

    function openCropModal(btn) {
        const card = btn.closest('.photo-card');
        currentEditImage = card.querySelector('img');
        
        imageToCrop.src = currentEditImage.src;
        cropModal.style.display = 'flex';

        // Cropper'Ä± baÅŸlat
        if (cropper) cropper.destroy();
        cropper = new Cropper(imageToCrop, {
            viewMode: 1,
            autoCropArea: 1,
        });
    }

    function saveCrop() {
        if (!cropper) return;
        // KÄ±rpÄ±lan gÃ¶rseli al
        const canvas = cropper.getCroppedCanvas();
        currentEditImage.src = canvas.toDataURL('image/jpeg');
        closeCropModal();
    }

    function closeCropModal() {
        cropModal.style.display = 'none';
        if (cropper) cropper.destroy();
    }

    // 4. PDF Ã–nizleme Ä°ÅŸlemleri
    const previewModal = document.getElementById('previewModal');
    const previewList = document.getElementById('preview-list');

    function openPreview() {
        const images = document.querySelectorAll('.gallery-img');
        if (images.length === 0) { alert("LÃ¼tfen Ã¶nce fotoÄŸraf ekleyin."); return; }

        previewList.innerHTML = '';
        
        // Mevcut DOM sÄ±rasÄ±na gÃ¶re resimleri alÄ±p Ã¶nizlemeye koyuyoruz
        images.forEach((img, index) => {
            const pageDiv = document.createElement('div');
            pageDiv.className = 'preview-page';
            
            // Sayfa numarasÄ± ve resim
            pageDiv.innerHTML = `
                <div style="text-align:center; width:100%">
                    <img src="${img.src}" style="max-height:800px; width:auto; box-shadow:0 0 5px #ccc;">
                    <p style="margin-top:10px; font-weight:bold;">Sayfa ${index + 1}</p>
                </div>
            `;
            previewList.appendChild(pageDiv);
        });

        previewModal.style.display = 'flex';
    }

    function closePreviewModal() {
        previewModal.style.display = 'none';
    }

    // 5. PDF OluÅŸturma (Kesin SÄ±ralama ile)
    async function generatePDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Ã–NEMLÄ°: getElementsByClassName yerine querySelectorAll kullanÄ±yoruz.
        // Bu, HTML'deki anlÄ±k gÃ¶rÃ¼nÃ¼m sÄ±rasÄ±nÄ± garanti eder.
        const images = document.querySelectorAll('.gallery-img');

        if (images.length === 0) {
            alert("Listede fotoÄŸraf yok!");
            return;
        }

        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();

        for (let i = 0; i < images.length; i++) {
            if (i > 0) doc.addPage();

            const imgData = images[i].src;
            
            // GÃ¶rsel boyutlarÄ±nÄ± PDF sayfasÄ±na sÄ±ÄŸacak ÅŸekilde ayarla
            const imgProps = doc.getImageProperties(imgData);
            const margin = 10;
            const availableWidth = pageWidth - (margin * 2);
            const availableHeight = pageHeight - (margin * 2);
            
            let finalWidth = availableWidth;
            let finalHeight = (imgProps.height * availableWidth) / imgProps.width;

            // EÄŸer yÃ¼kseklik sayfadan taÅŸarsa, yÃ¼ksekliÄŸe gÃ¶re oranla
            if (finalHeight > availableHeight) {
                finalHeight = availableHeight;
                finalWidth = (imgProps.width * availableHeight) / imgProps.height;
            }

            // Sayfaya ortala
            const x = (pageWidth - finalWidth) / 2;
            const y = (pageHeight - finalHeight) / 2;

            doc.addImage(imgData, 'JPEG', x, y, finalWidth, finalHeight);
        }

        doc.save(`fotograf_album_${new Date().toISOString().slice(0,10)}.pdf`);
        closePreviewModal();
    }
</script>

</body>
</html>

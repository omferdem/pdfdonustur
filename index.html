<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sıralı Foto PDF Oluşturucu V3</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { 
            font-family: 'Segoe UI', sans-serif; 
            margin: 0; padding: 0; 
            background-color: #eef2f3; 
            padding-bottom: 90px; /* Alt bar için boşluk */
        }

        /* Üst Başlık */
        .header { 
            background: #2c3e50; 
            color: white; 
            padding: 15px; 
            text-align: center; 
            position: sticky; 
            top: 0; 
            z-index: 100; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); 
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h2 { margin: 0; font-size: 18px; }
        .page-counter { font-size: 12px; background: #e74c3c; padding: 2px 8px; border-radius: 10px; }

        /* Galeri Listesi */
        #gallery { 
            padding: 10px; 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
        }

        /* Fotoğraf Kartı Tasarımı */
        .photo-card {
            background: white; 
            border-radius: 10px; 
            overflow: hidden;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1); 
            display: flex;
            flex-direction: row; /* Yan yana dizilim */
            align-items: center;
            padding: 5px;
            position: relative;
        }

        /* Sürükleme Tutacağı */
        .drag-handle {
            width: 30px;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #bdc3c7;
            cursor: grab;
            font-size: 20px;
        }

        /* Resim Alanı */
        .img-container {
            width: 100px;
            height: 100px;
            flex-shrink: 0;
            background: #eee;
            border-radius: 5px;
            overflow: hidden;
        }
        .img-container img {
            width: 100%; height: 100%; object-fit: cover;
        }

        /* Buton Grubu */
        .action-group {
            flex: 1;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 0 10px;
        }

        .btn-action {
            background: none; border: none; cursor: pointer;
            display: flex; flex-direction: column; align-items: center;
            font-size: 12px; color: #555; gap: 5px;
        }
        .btn-action i { font-size: 18px; padding: 10px; border-radius: 50%; background: #f0f0f0; transition: 0.2s; }
        
        .btn-view i { color: #f39c12; }    /* Gör - Turuncu */
        .btn-edit i { color: #3498db; }    /* Düzenle - Mavi */
        .btn-del i { color: #e74c3c; }     /* Sil - Kırmızı */
        .btn-action:active i { transform: scale(0.9); }

        /* Sıra Numarası */
        .order-badge {
            position: absolute; top: 5px; left: 35px;
            background: rgba(0,0,0,0.6); color: white;
            font-size: 10px; padding: 2px 6px; border-radius: 4px;
            z-index: 5;
        }

        /* Alt Kontrol Barı */
        .bottom-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: white; padding: 10px 15px; 
            display: flex; gap: 10px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1); 
            z-index: 200;
        }
        .btn-main { 
            flex: 1; padding: 12px; border: none; border-radius: 8px; 
            color: white; font-weight: bold; font-size: 14px; 
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-add { background-color: #2c3e50; }
        .btn-pdf { background-color: #27ae60; }

        /* Modallar (Tam Ekran) */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: black; z-index: 300; flex-direction: column;
        }
        .modal-header { 
            padding: 15px; display: flex; justify-content: space-between; 
            background: #1a1a1a; color: white; align-items: center;
        }
        .modal-body { 
            flex: 1; overflow: hidden; display: flex; 
            align-items: center; justify-content: center; background: #000; 
        }
        #image-preview-full { max-width: 100%; max-height: 90vh; object-fit: contain; }
        #image-to-crop { max-width: 100%; max-height: 80vh; }

    </style>
</head>
<body>

<div class="header">
    <h2>Foto PDF V3</h2>
    <span class="page-counter" id="pageCounter">0 Sayfa</span>
</div>

<div id="gallery">
    <div style="text-align:center; color:#999; margin-top:50px;" id="empty-msg">
        <i class="fa-solid fa-images" style="font-size: 40px; margin-bottom:10px;"></i>
        <p>Henüz fotoğraf eklenmedi.<br>Aşağıdan ekleyerek başla.</p>
    </div>
</div>

<div class="bottom-bar">
    <button class="btn-main btn-add" onclick="document.getElementById('fileInput').click()">
        <i class="fa-solid fa-plus"></i> Foto Ekle
    </button>
    <input type="file" id="fileInput" multiple accept="image/*" style="display:none">
    
    <button class="btn-main btn-pdf" onclick="generatePDF()">
        <i class="fa-solid fa-file-pdf"></i> PDF İndir
    </button>
</div>

<div id="viewModal" class="modal">
    <div class="modal-header">
        <button class="btn-main" style="background:transparent; padding:0;" onclick="closeViewModal()">
            <i class="fa-solid fa-arrow-left"></i> Geri
        </button>
        <span>Önizleme</span>
        <div style="width:30px;"></div> </div>
    <div class="modal-body">
        <img id="image-preview-full" src="">
    </div>
</div>

<div id="cropModal" class="modal">
    <div class="modal-header">
        <button class="btn-main" style="background:transparent; padding:0;" onclick="closeCropModal()">İptal</button>
        <span>Kırpma</span>
        <button class="btn-main" style="background:#27ae60; padding:5px 15px;" onclick="saveCrop()">KAYDET</button>
    </div>
    <div class="modal-body">
        <img id="image-to-crop" src="">
    </div>
</div>

<script>
    const gallery = document.getElementById('gallery');
    const fileInput = document.getElementById('fileInput');
    const emptyMsg = document.getElementById('empty-msg');
    const pageCounter = document.getElementById('pageCounter');
    
    let cropper;
    let currentEditImgElement = null;

    // 1. SortableJS: Sürükle Bırak Ayarı
    new Sortable(gallery, {
        handle: '.drag-handle', // Sadece tutma yerinden sürüklenir
        animation: 150,
        onEnd: updateOrderNumbers // Sıralama değişince numaraları güncelle
    });

    // 2. Fotoğraf Yükleme (Sıralama Garantili - Promise Yapısı)
    fileInput.addEventListener('change', async function(e) {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;
        
        if(emptyMsg) emptyMsg.style.display = 'none';

        // Dosyaları okurken sıralamayı bozmamak için Promise kullanıyoruz
        const readPromises = files.map(file => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.readAsDataURL(file);
            });
        });

        // Tüm dosyalar okunduğunda, orijinal sırayla listeye ekle
        const images = await Promise.all(readPromises);
        images.forEach(imgSrc => addPhotoToUI(imgSrc));
        
        updateOrderNumbers();
        fileInput.value = ''; // Reset
    });

    function addPhotoToUI(imgSrc) {
        const div = document.createElement('div');
        div.className = 'photo-card';
        div.innerHTML = `
            <div class="drag-handle"><i class="fa-solid fa-bars"></i></div>
            <span class="order-badge">0</span>
            <div class="img-container">
                <img src="${imgSrc}" class="gallery-img">
            </div>
            <div class="action-group">
                <button class="btn-action btn-view" onclick="openViewModal(this)">
                    <i class="fa-solid fa-eye"></i> Gör
                </button>
                <button class="btn-action btn-edit" onclick="openCropModal(this)">
                    <i class="fa-solid fa-crop-simple"></i> Düzenle
                </button>
                <button class="btn-action btn-del" onclick="removePhoto(this)">
                    <i class="fa-solid fa-trash"></i> Sil
                </button>
            </div>
        `;
        gallery.appendChild(div);
    }

    // 3. Sıra Numaralarını Güncelleme Fonksiyonu
    function updateOrderNumbers() {
        const badges = document.querySelectorAll('.order-badge');
        badges.forEach((badge, index) => {
            badge.innerText = index + 1;
        });
        pageCounter.innerText = badges.length + " Sayfa";
    }

    // 4. Silme İşlemi
    window.removePhoto = function(btn) {
        if(confirm("Bu sayfayı silmek istiyor musun?")) {
            btn.closest('.photo-card').remove();
            updateOrderNumbers();
        }
    }

    // 5. GÖR (View) İşlemi
    const viewModal = document.getElementById('viewModal');
    const previewFull = document.getElementById('image-preview-full');

    window.openViewModal = function(btn) {
        const img = btn.closest('.photo-card').querySelector('img');
        previewFull.src = img.src;
        viewModal.style.display = 'flex';
    }

    window.closeViewModal = function() {
        viewModal.style.display = 'none';
    }

    // 6. DÜZENLE (Crop) İşlemi
    const cropModal = document.getElementById('cropModal');
    const imageToCrop = document.getElementById('image-to-crop');

    window.openCropModal = function(btn) {
        const card = btn.closest('.photo-card');
        currentEditImgElement = card.querySelector('img');
        
        imageToCrop.src = currentEditImgElement.src;
        cropModal.style.display = 'flex';

        if (cropper) cropper.destroy();
        cropper = new Cropper(imageToCrop, {
            viewMode: 1,
            autoCropArea: 1
        });
    }

    window.saveCrop = function() {
        if (!cropper) return;
        const canvas = cropper.getCroppedCanvas();
        currentEditImgElement.src = canvas.toDataURL('image/jpeg');
        closeCropModal();
    }

    window.closeCropModal = function() {
        cropModal.style.display = 'none';
        if (cropper) cropper.destroy();
    }

    // 7. PDF Çıktısı Alma
    window.generatePDF = async function() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Ekrandaki sıraya göre resimleri al
        const images = document.querySelectorAll('.gallery-img');

        if (images.length === 0) {
            alert("Listede hiç fotoğraf yok!");
            return;
        }

        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();

        for (let i = 0; i < images.length; i++) {
            if (i > 0) doc.addPage();

            const imgData = images[i].src;
            const imgProps = doc.getImageProperties(imgData);
            
            // Sayfaya tam sığdırma mantığı
            const margin = 10;
            const availableWidth = pageWidth - (margin * 2);
            const availableHeight = pageHeight - (margin * 2);
            
            let finalWidth = availableWidth;
            let finalHeight = (imgProps.height * availableWidth) / imgProps.width;

            if (finalHeight > availableHeight) {
                finalHeight = availableHeight;
                finalWidth = (imgProps.width * availableHeight) / imgProps.height;
            }

            const x = (pageWidth - finalWidth) / 2;
            const y = (pageHeight - finalHeight) / 2;

            doc.addImage(imgData, 'JPEG', x, y, finalWidth, finalHeight);
            
            // Sayfa numarası ekle (isteğe bağlı, istenmezse silinebilir)
            doc.text(`${i + 1}`, pageWidth - 10, pageHeight - 10);
        }

        const dateStr = new Date().toISOString().slice(0,19).replace(/:/g,"-");
        doc.save(`Belge_${dateStr}.pdf`);
    }

</script>

</body>
</html>

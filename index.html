<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>FotoPDF</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=DM+Sans:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0d0d11;--surf:#16161e;--surf2:#1e1e28;--surf3:#252530;
  --acc:#f5c842;--acc2:#f07840;--green:#3db87a;--red:#e05252;
  --blue:#2563eb;--teal:#059669;--purple:#7c3aed;
  --text:#edeae2;--muted:#6a6a7e;--border:#252530;
  --r:12px;--ease:cubic-bezier(.4,0,.2,1);
}
html,body{height:100%;overflow:hidden}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);
  display:flex;flex-direction:column;height:100dvh}

/* â”€â”€â”€ HEADER â”€â”€â”€ */
header{
  flex-shrink:0;display:flex;align-items:center;justify-content:space-between;
  padding:11px 16px;background:var(--surf);border-bottom:1px solid var(--border);
}
.logo{font-family:'Syne',sans-serif;font-weight:800;font-size:1.2rem}
.logo span{color:var(--acc)}
.hpill{background:var(--surf2);border:1px solid var(--border);padding:5px 13px;
  border-radius:999px;font-size:.76rem;color:var(--muted)}
.hpill b{color:var(--acc)}

/* â”€â”€â”€ 3 NAV CARDS â”€â”€â”€ */
.nav-cards{
  flex-shrink:0;display:grid;grid-template-columns:repeat(3,1fr);gap:8px;
  padding:10px 12px;background:var(--bg);
}
.nc{
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:4px;padding:13px 4px;border-radius:14px;border:2.5px solid transparent;
  cursor:pointer;font-family:'Syne',sans-serif;font-weight:700;font-size:.72rem;
  text-align:center;line-height:1.2;color:#fff;
  transition:transform .13s,opacity .13s,border-color .13s;
  touch-action:manipulation;-webkit-tap-highlight-color:transparent;
  user-select:none;
}
.nc:active{transform:scale(.93)}
.nc.active{border-color:rgba(255,255,255,.5);box-shadow:0 4px 18px rgba(0,0,0,.45)}
.nc:not(.active){opacity:.55}
.nc-icon{font-size:1.45rem;line-height:1}
.nc.c1{background:linear-gradient(135deg,#1d4ed8,#2563eb)}
.nc.c2{background:linear-gradient(135deg,#047857,#059669)}
.nc.c3{background:linear-gradient(135deg,#6d28d9,#7c3aed)}

/* â”€â”€â”€ TAB PANELS â”€â”€â”€ */
.tab-panel{display:none;flex:1;flex-direction:column;overflow:hidden;min-height:0}
.tab-panel.active{display:flex}
.scroll{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;padding:10px 12px}

/* â”€â”€â”€ SETTINGS BAR â”€â”€â”€ */
.settings-bar{
  flex-shrink:0;display:flex;gap:8px;padding:7px 12px;
  background:var(--surf);border-bottom:1px solid var(--border);
  overflow-x:auto;scrollbar-width:none;
}
.settings-bar::-webkit-scrollbar{display:none}
.sc{display:flex;flex-direction:column;gap:2px;flex-shrink:0}
.sc label{font-size:.6rem;color:var(--muted);text-transform:uppercase;letter-spacing:.07em}
select{background:var(--surf2);border:1px solid var(--border);color:var(--text);
  border-radius:8px;padding:5px 9px;font-size:.79rem;font-family:inherit;cursor:pointer;outline:none}
select:focus{border-color:var(--acc)}
input[type=range]{accent-color:var(--acc);cursor:pointer;width:86px}
.qval{font-size:.76rem;color:var(--acc);font-weight:700;min-width:30px}

/* â”€â”€â”€ DROP ZONE â”€â”€â”€ */
.dz{
  border:2px dashed var(--border);border-radius:var(--r);padding:22px 14px;
  text-align:center;background:var(--surf);cursor:pointer;
  transition:border .2s,background .2s;margin-bottom:12px;position:relative;
}
.dz:hover,.dz.hover{border-color:var(--acc);background:rgba(245,200,66,.04)}
.dz input{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
.dz-icon{font-size:1.7rem;margin-bottom:4px}
.dz h3{font-family:'Syne',sans-serif;font-size:.88rem;margin-bottom:3px}
.dz p{font-size:.72rem;color:var(--muted)}

/* â”€â”€â”€ PHOTO GRID â”€â”€â”€ */
#photo-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:9px}
.pi{
  border-radius:10px;background:var(--surf2);
  display:flex;flex-direction:column;overflow:hidden;
  animation:popIn .2s var(--ease);cursor:default;
}
@keyframes popIn{from{opacity:0;transform:scale(.88)}to{opacity:1;transform:scale(1)}}
.pi-handle{
  height:24px;background:rgba(255,255,255,.04);
  display:flex;align-items:center;justify-content:center;
  cursor:grab;color:var(--muted);font-size:.8rem;letter-spacing:3px;
  user-select:none;touch-action:none;
  border-bottom:1px solid rgba(255,255,255,.05);flex-shrink:0;
}
.pi-handle:active{cursor:grabbing}
.pi img{width:100%;height:115px;object-fit:cover;display:block;pointer-events:none}
.pi-bar{
  display:flex;align-items:center;padding:4px 5px;gap:4px;
  background:rgba(0,0,0,.3);border-top:1px solid rgba(255,255,255,.06);flex-shrink:0;
}
.pi-num{font-size:.63rem;font-weight:700;color:var(--muted);flex:1;padding-left:2px}
.ib{
  width:36px;height:34px;border-radius:7px;border:none;cursor:pointer;
  font-size:13px;display:flex;align-items:center;justify-content:center;
  transition:transform .12s;touch-action:manipulation;-webkit-tap-highlight-color:transparent;
}
.ib:active{transform:scale(.88)}
.ib.edit{background:rgba(37,99,235,.25);color:#60a5fa}
.ib.sign{background:rgba(124,58,237,.25);color:#a78bfa}
.ib.del {background:rgba(224,82,82,.22);color:#f87171}

/* Sortable */
.sg{opacity:.2;border:2px dashed var(--acc)}
.sc2{box-shadow:0 6px 24px rgba(0,0,0,.5);z-index:5}

/* â”€â”€â”€ ACTION BAR â”€â”€â”€ */
.abar{
  flex-shrink:0;display:flex;align-items:center;gap:8px;
  padding:10px 12px;background:var(--surf);border-top:2px solid var(--border);
  padding-bottom:calc(10px + env(safe-area-inset-bottom));
}
/* Small icon-only buttons */
.abar-sm{
  width:46px;height:46px;border-radius:11px;border:1.5px solid var(--border);
  background:var(--surf2);color:var(--text);cursor:pointer;
  display:flex;align-items:center;justify-content:center;font-size:1.1rem;
  flex-shrink:0;touch-action:manipulation;transition:opacity .15s,transform .12s;
}
.abar-sm:active{transform:scale(.9)}
.abar-sm:disabled{opacity:.3;cursor:not-allowed}
.abar-sm.danger{border-color:var(--red);color:var(--red);background:rgba(224,82,82,.1)}
/* Main CTA */
.abar-main{
  flex:1;height:46px;border-radius:11px;border:none;
  font-family:'Syne',sans-serif;font-weight:700;font-size:.9rem;
  cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;
  touch-action:manipulation;transition:opacity .15s,transform .12s;
  -webkit-tap-highlight-color:transparent;
}
.abar-main:active{transform:scale(.97)}
.abar-main:disabled{opacity:.3;cursor:not-allowed}
.abar-main.blue  {background:linear-gradient(135deg,#1d4ed8,#3b82f6);color:#fff}
.abar-main.teal  {background:linear-gradient(135deg,#047857,#10b981);color:#fff}
.abar-main.purple{background:linear-gradient(135deg,#6d28d9,#8b5cf6);color:#fff}

/* â”€â”€â”€ MERGE LIST â”€â”€â”€ */
.merge-list{display:flex;flex-direction:column;gap:8px;margin-bottom:12px}
.mi{
  display:flex;align-items:center;gap:9px;
  background:var(--surf);border:1px solid var(--border);border-radius:10px;
  padding:10px 12px;cursor:grab;animation:popIn .2s var(--ease);
}
.mi:active{cursor:grabbing}
.mi-drag{color:var(--muted);font-size:.95rem;flex-shrink:0;user-select:none}
.mi-info{flex:1;min-width:0}
.mi-name{font-size:.82rem;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.mi-pages{font-size:.7rem;color:var(--muted);margin-top:1px}
.mi-del{background:transparent;border:1px solid var(--border);color:var(--red);
  border-radius:7px;width:32px;height:32px;cursor:pointer;font-size:13px;
  flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:background .15s}
.mi-del:hover{background:rgba(224,82,82,.12)}

/* â”€â”€â”€ SIGN TAB â”€â”€â”€ */
.sign-empty{
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  flex:1;gap:14px;color:var(--muted);font-size:.88rem;text-align:center;padding:24px;
}
.sign-empty .big{font-size:3.2rem;opacity:.3}
.sign-empty-btns{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
.open-btn{
  padding:11px 18px;border-radius:11px;border:1.5px solid var(--border);
  background:var(--surf2);color:var(--text);font-family:'Syne',sans-serif;
  font-weight:700;font-size:.84rem;cursor:pointer;
  display:flex;align-items:center;gap:7px;position:relative;overflow:hidden;
  touch-action:manipulation;
}
.open-btn input{position:absolute;inset:0;opacity:0;cursor:pointer}
.sign-loaded{display:none;flex:1;flex-direction:column;overflow:hidden;min-height:0}
.sign-topbar{
  display:flex;align-items:center;justify-content:space-between;
  padding:7px 13px;background:var(--surf);border-bottom:1px solid var(--border);
  flex-shrink:0;gap:8px;
}
.sign-fname{font-size:.78rem;color:var(--muted);min-width:0;overflow:hidden;
  text-overflow:ellipsis;white-space:nowrap;flex:1}
.sign-fname b{color:var(--acc)}
.sign-change-btns{display:flex;gap:5px;flex-shrink:0}
.chbtn{
  padding:5px 9px;border-radius:8px;border:1px solid var(--border);
  background:var(--surf2);color:var(--muted);font-size:.71rem;cursor:pointer;
  position:relative;overflow:hidden;font-family:'DM Sans',sans-serif;
  touch-action:manipulation;
}
.chbtn input{position:absolute;inset:0;opacity:0;cursor:pointer}
.sign-layout{display:flex;flex:1;overflow:hidden;min-height:0}
.sign-thumbs{
  flex-shrink:0;width:82px;overflow-y:auto;overflow-x:hidden;
  background:var(--surf);border-right:1px solid var(--border);
  padding:7px;display:flex;flex-direction:column;gap:6px;
  scrollbar-width:thin;scrollbar-color:var(--surf3) transparent;
}
.tw{position:relative;cursor:pointer;border-radius:6px;overflow:hidden;
  border:2px solid transparent;transition:border-color .18s;flex-shrink:0}
.tw.active{border-color:var(--acc)}
.tw canvas{width:100%;display:block}
.tn{position:absolute;bottom:3px;left:3px;background:rgba(0,0,0,.7);
  color:#fff;font-size:.55rem;font-weight:700;padding:1px 5px;border-radius:999px}
.sign-preview{
  flex:1;overflow:auto;background:#0a0a0e;
  display:flex;align-items:flex-start;justify-content:center;padding:18px;
}
.ppw{position:relative;display:inline-block;line-height:0;flex-shrink:0}
.ppw canvas{border-radius:4px;box-shadow:0 8px 32px rgba(0,0,0,.7);display:block}
/* Sig overlay */
.sov{
  position:absolute;cursor:move;user-select:none;touch-action:none;
  border:1.5px dashed rgba(245,200,66,.8);border-radius:3px;
}
.sov img{width:100%;height:100%;display:block;pointer-events:none}
.sov-del{
  position:absolute;top:-11px;right:-11px;background:var(--red);color:#fff;
  border:2px solid var(--bg);border-radius:50%;width:24px;height:24px;
  cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center;z-index:3;
}
.sov-rz{
  position:absolute;bottom:-9px;right:-9px;width:20px;height:20px;
  background:var(--acc);border-radius:3px;cursor:se-resize;z-index:3;
  display:flex;align-items:center;justify-content:center;font-size:11px;color:#111;
}

/* â”€â”€â”€ MODALS â”€â”€â”€ */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.88);
  backdrop-filter:blur(8px);z-index:400;flex-direction:column}
.modal.open{display:flex}
.mh{display:flex;align-items:center;justify-content:space-between;
  padding:12px 15px;background:var(--surf);border-bottom:1px solid var(--border);flex-shrink:0}
.mh h2{font-family:'Syne',sans-serif;font-size:.95rem}
.mh span{font-size:.74rem;color:var(--muted)}
.mtb{
  display:flex;gap:5px;padding:8px 11px;background:var(--surf2);
  flex-shrink:0;overflow-x:auto;scrollbar-width:none;align-items:center;
}
.mtb::-webkit-scrollbar{display:none}
.tb{
  padding:6px 11px;border-radius:8px;border:1px solid var(--border);
  background:var(--surf);color:var(--text);font-family:'DM Sans',sans-serif;
  font-size:.77rem;cursor:pointer;white-space:nowrap;flex-shrink:0;
  display:flex;align-items:center;gap:4px;transition:background .15s,border-color .15s;
}
.tb:hover{background:var(--surf3);border-color:var(--acc)}
.tb.active{background:var(--acc);color:#111;border-color:var(--acc);font-weight:600}
.mc{flex:1;overflow:hidden;position:relative;background:#0a0a0e;
  display:flex;align-items:center;justify-content:center}
.mc img{max-width:100%;max-height:100%;display:block}
.mf{
  display:flex;gap:8px;padding:10px 13px;background:var(--surf);
  border-top:1px solid var(--border);flex-shrink:0;
  padding-bottom:calc(10px + env(safe-area-inset-bottom));
}
.mf-btn{
  padding:12px 16px;border-radius:10px;border:none;
  font-family:'Syne',sans-serif;font-weight:700;font-size:.86rem;
  cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;
  touch-action:manipulation;transition:opacity .15s;
}
.mf-btn:active{opacity:.75}
.mf-cancel{background:var(--surf2);color:var(--text);border:1px solid var(--border);flex:1}
.mf-reset {background:var(--surf2);color:var(--muted);border:1px solid var(--border)}
.mf-apply {background:linear-gradient(135deg,var(--green),#27a065);color:#fff;flex:2}
.divv{width:1px;background:var(--border);margin:0 2px;align-self:stretch;flex-shrink:0}

/* â”€â”€â”€ SIG CANVAS MODAL â”€â”€â”€ */
.sig-wrap{flex:1;display:flex;position:relative;background:#f4f4ec;overflow:hidden}
#sigCanvas{display:block;cursor:crosshair;touch-action:none;width:100%;height:100%}
.sig-hint{
  position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  font-size:.95rem;color:#bbb;pointer-events:none;transition:opacity .25s;
}
.sig-hint.gone{opacity:0}
.cdot{
  width:26px;height:26px;border-radius:50%;cursor:pointer;
  border:3px solid transparent;transition:border-color .15s,transform .15s;flex-shrink:0;
}
.cdot.active{border-color:#fff;transform:scale(1.15)}

/* â”€â”€â”€ PROGRESS â”€â”€â”€ */
.prog-back{
  display:none;position:fixed;inset:0;background:rgba(0,0,0,.82);
  backdrop-filter:blur(6px);z-index:600;align-items:center;justify-content:center;
}
.prog-back.open{display:flex}
.prog-card{
  background:var(--surf);border:1px solid var(--border);border-radius:16px;
  padding:26px 30px;text-align:center;min-width:230px;
}
.prog-card h3{font-family:'Syne',sans-serif;margin-bottom:14px;font-size:.94rem}
.prog-track{width:100%;height:7px;background:var(--surf2);border-radius:999px;overflow:hidden;margin-bottom:9px}
.prog-fill{height:100%;background:linear-gradient(90deg,var(--acc),var(--acc2));
  border-radius:999px;transition:width .2s var(--ease);width:0%}
.prog-note{font-size:.78rem;color:var(--muted)}

/* â”€â”€â”€ TOAST â”€â”€â”€ */
.toast{
  position:fixed;top:62px;left:50%;
  transform:translateX(-50%) translateY(-8px);
  background:var(--surf2);border:1px solid var(--border);
  color:var(--text);padding:8px 18px;border-radius:10px;
  font-size:.81rem;opacity:0;pointer-events:none;
  transition:opacity .25s,transform .25s;z-index:700;white-space:nowrap;
}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.empty{grid-column:1/-1;text-align:center;padding:24px;color:var(--muted);font-size:.8rem;line-height:1.9}

@media(max-width:380px){
  .nc{padding:11px 2px;font-size:.67rem}
  .nc-icon{font-size:1.25rem}
}
</style>
</head>
<body>

<!-- â•â•â• HEADER â•â•â• -->
<header>
  <div class="logo">Foto<span>PDF</span></div>
  <div class="hpill" id="countPill">Foto: <b>0</b></div>
</header>

<!-- â•â•â• 3 NAV CARDS â•â•â• -->
<div class="nav-cards">
  <div class="nc c1 active" data-tab="photo">
    <div class="nc-icon">ğŸ“·</div>
    <div>Foto â†’ PDF</div>
  </div>
  <div class="nc c2" data-tab="merge">
    <div class="nc-icon">ğŸ”—</div>
    <div>PDF BirleÅŸtir</div>
  </div>
  <div class="nc c3" data-tab="sign">
    <div class="nc-icon">âœï¸</div>
    <div>Ä°mzala</div>
  </div>
</div>

<!-- â•â•â• TAB: PHOTO â•â•â• -->
<div class="tab-panel active" id="tab-photo">
  <div class="settings-bar">
    <div class="sc">
      <label>Sayfa</label>
      <select id="pageSize">
        <option value="a4">A4</option><option value="a5">A5</option>
        <option value="letter">Letter</option><option value="square">Kare</option>
      </select>
    </div>
    <div class="sc">
      <label>YÃ¶n</label>
      <select id="orientation">
        <option value="auto">Otomatik</option>
        <option value="portrait">Dikey</option><option value="landscape">Yatay</option>
      </select>
    </div>
    <div class="sc">
      <label>Kenar</label>
      <select id="margin">
        <option value="8">8mm</option><option value="0">KenarsÄ±z</option><option value="15">15mm</option>
      </select>
    </div>
    <div class="sc">
      <label>Kalite: <span class="qval" id="qval">85%</span></label>
      <input type="range" id="qrange" min="40" max="100" value="85">
    </div>
  </div>

  <div class="scroll">
    <div class="dz" id="photoDZ">
      <input type="file" id="photoIn" multiple accept="image/*">
      <div class="dz-icon">ğŸ“·</div>
      <h3>FotoÄŸraf Ekle</h3>
      <p>TÄ±kla veya buraya sÃ¼rÃ¼kleyip bÄ±rak Â· JPG, PNG, WebP</p>
    </div>
    <div id="photo-list">
      <div class="empty" id="photoEmpty">ğŸ“‚ HenÃ¼z fotoÄŸraf eklenmedi.</div>
    </div>
  </div>

  <div class="abar">
    <button class="abar-sm" id="photoAddBtn" title="FotoÄŸraf Ekle" style="position:relative;overflow:hidden">
      ï¼‹<input type="file" id="photoIn2" multiple accept="image/*" style="position:absolute;inset:0;opacity:0;cursor:pointer">
    </button>
    <button class="abar-sm danger" id="photoClearBtn" disabled title="Hepsini Sil">ğŸ—‘</button>
    <button class="abar-main blue" id="photoPdfBtn" disabled>ğŸ“„ PDF OluÅŸtur</button>
  </div>
</div>

<!-- â•â•â• TAB: MERGE â•â•â• -->
<div class="tab-panel" id="tab-merge">
  <div class="scroll">
    <div class="dz" id="mergeDZ">
      <input type="file" id="mergeIn" multiple accept="application/pdf">
      <div class="dz-icon">ğŸ“„</div>
      <h3>PDF DosyalarÄ± Ekle</h3>
      <p>BirleÅŸtirmek istediÄŸin PDF'leri seÃ§ Â· SÃ¼rÃ¼kle sÄ±rala</p>
    </div>
    <div class="merge-list" id="mergeList">
      <div class="empty" id="mergeEmpty">ğŸ“‚ HenÃ¼z PDF eklenmedi.</div>
    </div>
  </div>
  <div class="abar">
    <button class="abar-sm" style="position:relative;overflow:hidden" title="PDF Ekle">
      ï¼‹<input type="file" id="mergeIn2" multiple accept="application/pdf" style="position:absolute;inset:0;opacity:0;cursor:pointer">
    </button>
    <button class="abar-sm danger" id="mergeClearBtn" disabled title="Hepsini Sil">ğŸ—‘</button>
    <button class="abar-main teal" id="mergePdfBtn" disabled>ğŸ”— BirleÅŸtir ve Ä°ndir</button>
  </div>
</div>

<!-- â•â•â• TAB: SIGN â•â•â• -->
<div class="tab-panel" id="tab-sign">
  <!-- boÅŸ durum -->
  <div class="sign-empty" id="signEmpty">
    <div class="big">âœï¸</div>
    <div style="font-weight:500;font-size:.92rem;color:var(--text)">Ä°mzalamak istediÄŸin dosyayÄ± seÃ§</div>
    <div style="font-size:.77rem">PDF veya fotoÄŸraf desteklenir</div>
    <div class="sign-empty-btns">
      <label class="open-btn">ğŸ“„ PDF AÃ§<input type="file" id="signPdfIn" accept="application/pdf"></label>
      <label class="open-btn">ğŸ–¼ï¸ FotoÄŸraf AÃ§<input type="file" id="signImgIn" accept="image/*"></label>
    </div>
  </div>

  <!-- yÃ¼klÃ¼ durum -->
  <div class="sign-loaded" id="signLoaded">
    <div class="sign-topbar">
      <div class="sign-fname"><b id="signFname">-</b> &nbsp;Â·&nbsp; <span id="signPcount">0</span> <span id="signPlabel">sayfa</span></div>
      <div class="sign-change-btns">
        <label class="chbtn">PDF<input type="file" id="signPdfIn2" accept="application/pdf"></label>
        <label class="chbtn">Foto<input type="file" id="signImgIn2" accept="image/*"></label>
      </div>
    </div>
    <div class="sign-layout">
      <div class="sign-thumbs" id="signThumbs"></div>
      <div class="sign-preview" id="signPreview">
        <div class="ppw" id="ppw">
          <canvas id="mainCanvas"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="abar" id="signAbar" style="display:none">
    <button class="abar-sm danger" id="clearSigsBtn" title="Ä°mzalarÄ± Temizle">ğŸ—‘</button>
    <button class="abar-main purple" id="drawSigBtn">âœï¸ Ä°mza Ã‡iz</button>
    <button class="abar-main blue" id="dlSignedBtn">ğŸ“„ Ä°ndir</button>
  </div>
</div>

<!-- â•â•â• CROP MODAL â•â•â• -->
<div class="modal" id="cropModal">
  <div class="mh"><h2>âœ‚ï¸ DÃ¼zenle / KÄ±rp</h2><span id="cropIdx"></span></div>
  <div class="mtb">
    <span style="font-size:.66rem;color:var(--muted)">Oran:</span>
    <button class="tb active" data-ratio="free">Serbest</button>
    <button class="tb" data-ratio="1">1:1</button>
    <button class="tb" data-ratio="1.333">4:3</button>
    <button class="tb" data-ratio="1.778">16:9</button>
    <button class="tb" data-ratio="0.707">A4</button>
    <div class="divv"></div>
    <button class="tb" id="rotL">â†º</button>
    <button class="tb" id="rotR">â†»</button>
    <button class="tb" id="flipH">â‡„</button>
    <button class="tb" id="flipV">â‡…</button>
    <button class="tb" id="zIn">ğŸ”+</button>
    <button class="tb" id="zOut">ğŸ”âˆ’</button>
  </div>
  <div class="mc"><img id="cropImg" src="" alt=""></div>
  <div class="mf">
    <button class="mf-btn mf-cancel" id="cancelCrop">Ä°ptal</button>
    <button class="mf-btn mf-reset" id="resetCrop">SÄ±fÄ±rla</button>
    <button class="mf-btn mf-apply" id="applyCrop">âœ“ Uygula</button>
  </div>
</div>

<!-- â•â•â• SIGNATURE DRAW MODAL â•â•â• -->
<div class="modal" id="sigModal">
  <div class="mh"><h2>âœï¸ Ä°mzanÄ± Ã‡iz</h2><span>Parmak veya mouse ile</span></div>
  <div class="mtb">
    <span style="font-size:.66rem;color:var(--muted)">Renk:</span>
    <div class="cdot active" data-c="#111" style="background:#111"></div>
    <div class="cdot" data-c="#1a3580" style="background:#1a3580"></div>
    <div class="cdot" data-c="#8a1414" style="background:#8a1414"></div>
    <div class="divv"></div>
    <span style="font-size:.66rem;color:var(--muted)">KalÄ±nlÄ±k:</span>
    <button class="tb" data-w="2">Ä°nce</button>
    <button class="tb active" data-w="3">Orta</button>
    <button class="tb" data-w="5">KalÄ±n</button>
    <div class="divv"></div>
    <button class="tb" id="clearSigCvs">ğŸ—‘ Temizle</button>
  </div>
  <div class="sig-wrap">
    <canvas id="sigCanvas"></canvas>
    <div class="sig-hint" id="sigHint">âœï¸ Buraya imzanÄ± Ã§iz</div>
  </div>
  <div class="mf">
    <button class="mf-btn mf-cancel" id="cancelSig">Ä°ptal</button>
    <button class="mf-btn mf-apply" id="applySig">âœ“ Ä°mzayÄ± YerleÅŸtir</button>
  </div>
</div>

<!-- â•â•â• PROGRESS â•â•â• -->
<div class="prog-back" id="progBack">
  <div class="prog-card">
    <h3 id="progTitle">Ä°ÅŸleniyorâ€¦</h3>
    <div class="prog-track"><div class="prog-fill" id="progFill"></div></div>
    <div class="prog-note" id="progNote">LÃ¼tfen bekleyin</div>
  </div>
</div>
<div class="toast" id="toast"></div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GLOBALS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const {jsPDF} = window.jspdf;
pdfjsLib.GlobalWorkerOptions.workerSrc =
  'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

/* â”€â”€â”€ helpers â”€â”€â”€ */
let _toastT;
function toast(msg,ms=2800){
  const el=document.getElementById('toast');
  el.textContent=msg;el.classList.add('show');
  clearTimeout(_toastT);_toastT=setTimeout(()=>el.classList.remove('show'),ms);
}
function showProg(t){
  document.getElementById('progTitle').textContent=t||'Ä°ÅŸleniyorâ€¦';
  document.getElementById('progFill').style.width='0%';
  document.getElementById('progNote').textContent='HazÄ±rlanÄ±yorâ€¦';
  document.getElementById('progBack').classList.add('open');
}
function setProg(p,n){
  document.getElementById('progFill').style.width=p+'%';
  if(n)document.getElementById('progNote').textContent=n;
}
function hideProg(){document.getElementById('progBack').classList.remove('open')}
function dlBytes(b,n){
  const u=URL.createObjectURL(new Blob([b],{type:'application/pdf'}));
  const a=document.createElement('a');a.href=u;a.download=n;a.click();
  setTimeout(()=>URL.revokeObjectURL(u),5000);
}
function dlDataUrl(dataUrl, name){
  const a=document.createElement('a');a.href=dataUrl;a.download=name;a.click();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NAVIGATION  +  Android Back Button
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const MODALS = ['cropModal','sigModal'];
let curTab = 'photo';

history.replaceState({k:'tab',v:'photo'},'');

function pushHist(k,v){ history.pushState({k,v},''); }

function switchTab(id, push=true){
  curTab=id;
  if(push) pushHist('tab',id);
  document.querySelectorAll('.nc').forEach(n=>n.classList.toggle('active',n.dataset.tab===id));
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.toggle('active',p.id==='tab-'+id));
  // count pill only shows on photo tab
  document.getElementById('countPill').style.display = id==='photo'?'':'none';
}

function openModal(id){ pushHist('modal',id); document.getElementById(id).classList.add('open'); }
function closeModal(id){ document.getElementById(id).classList.remove('open'); }

window.addEventListener('popstate',e=>{
  const s=e.state;
  // close topmost open modal
  for(const id of MODALS){
    const m=document.getElementById(id);
    if(m.classList.contains('open')){
      if(id==='cropModal') _closeCrop(false);
      else closeModal(id);
      return;
    }
  }
  if(s&&s.k==='tab') switchTab(s.v,false);
  else switchTab('photo',false);
});

document.querySelectorAll('.nc').forEach(n=>{
  n.addEventListener('click',()=>switchTab(n.dataset.tab));
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAB 1 â€“ PHOTO â†’ PDF
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const photoList=document.getElementById('photo-list');
const photoEmpty=document.getElementById('photoEmpty');
const photoPdfBtn=document.getElementById('photoPdfBtn');
const photoClearBtn=document.getElementById('photoClearBtn');
const countPill=document.getElementById('countPill');

document.getElementById('qrange').addEventListener('input',function(){
  document.getElementById('qval').textContent=this.value+'%';
});

// file inputs
[document.getElementById('photoIn'),document.getElementById('photoIn2')]
  .forEach(i=>i.addEventListener('change',e=>{loadPhotos(e.target.files);e.target.value=''}));

// drag-drop on dz
const photoDZ=document.getElementById('photoDZ');
photoDZ.addEventListener('dragover',e=>{e.preventDefault();photoDZ.classList.add('hover')});
photoDZ.addEventListener('dragleave',()=>photoDZ.classList.remove('hover'));
photoDZ.addEventListener('drop',e=>{e.preventDefault();photoDZ.classList.remove('hover');loadPhotos(e.dataTransfer.files)});

// sortable â€” handle only
new Sortable(photoList,{
  animation:180,handle:'.pi-handle',
  ghostClass:'sg',chosenClass:'sc2',
  filter:'.empty',touchStartThreshold:4,
  onEnd:()=>photoList.querySelectorAll('.pi .pi-num').forEach((b,i)=>b.textContent=i+1)
});

function loadPhotos(files){
  Array.from(files).filter(f=>f.type.startsWith('image/')).forEach(f=>{
    const r=new FileReader();r.onload=e=>addPhotoCard(e.target.result);r.readAsDataURL(f);
  });
}

function addPhotoCard(src){
  photoEmpty.style.display='none';
  const d=document.createElement('div');d.className='pi';

  const handle=document.createElement('div');handle.className='pi-handle';handle.textContent='â ¿ â ¿ â ¿';
  const img=document.createElement('img');img.src=src;img.draggable=false;

  const bar=document.createElement('div');bar.className='pi-bar';
  const num=document.createElement('span');num.className='pi-num';

  const editB=document.createElement('button');editB.className='ib edit';editB.textContent='âœï¸';editB.title='DÃ¼zenle';
  editB.addEventListener('click',e=>{e.stopPropagation();openCrop(d)});

  const signB=document.createElement('button');signB.className='ib sign';signB.textContent='âœï¸';signB.title='Ä°mza Ekle';
  signB.addEventListener('click',e=>{e.stopPropagation();openPhotoSignFlow(d)});

  const delB=document.createElement('button');delB.className='ib del';delB.textContent='ğŸ—‘';delB.title='Sil';
  delB.addEventListener('click',e=>{
    e.stopPropagation();d.remove();
    photoList.querySelectorAll('.pi .pi-num').forEach((b,i)=>b.textContent=i+1);
    updatePhotoState();
  });

  bar.append(num,editB,signB,delB);
  d.append(handle,img,bar);
  photoList.appendChild(d);
  photoList.querySelectorAll('.pi .pi-num').forEach((b,i)=>b.textContent=i+1);
  updatePhotoState();
}

function updatePhotoState(){
  const n=photoList.querySelectorAll('.pi').length;
  countPill.innerHTML=`Foto: <b>${n}</b>`;
  photoPdfBtn.disabled=n===0;photoClearBtn.disabled=n===0;
  if(n===0)photoEmpty.style.display='';
}

photoClearBtn.addEventListener('click',()=>{
  if(!confirm('TÃ¼m fotoÄŸraflar silinsin mi?'))return;
  photoList.querySelectorAll('.pi').forEach(el=>el.remove());updatePhotoState();
});

const PAGE_SIZES={a4:[210,297],a5:[148,210],letter:[215.9,279.4],square:[150,150]};
photoPdfBtn.addEventListener('click',async()=>{
  const items=Array.from(photoList.querySelectorAll('.pi'));if(!items.length)return;
  const [pw0,ph0]=PAGE_SIZES[document.getElementById('pageSize').value];
  const ori0=document.getElementById('orientation').value;
  const marg=parseInt(document.getElementById('margin').value);
  const qual=parseInt(document.getElementById('qrange').value)/100;
  showProg('PDF OluÅŸturuluyorâ€¦');photoPdfBtn.disabled=true;
  let doc=null;
  for(let i=0;i<items.length;i++){
    const img=items[i].querySelector('img');
    let ori='portrait';
    if(ori0==='landscape')ori='landscape';
    else if(ori0==='auto'&&img.naturalWidth>img.naturalHeight)ori='landscape';
    const pw=ori==='landscape'?ph0:pw0,ph=ori==='landscape'?pw0:ph0;
    if(!doc)doc=new jsPDF({orientation:ori,unit:'mm',format:[pw,ph]});
    else doc.addPage([pw,ph],ori);
    const avW=pw-marg*2,avH=ph-marg*2,rat=img.naturalWidth/img.naturalHeight;
    let dw=avW,dh=dw/rat;if(dh>avH){dh=avH;dw=dh*rat}
    const c=document.createElement('canvas');c.width=img.naturalWidth;c.height=img.naturalHeight;
    c.getContext('2d').drawImage(img,0,0);
    doc.addImage(c.toDataURL('image/jpeg',qual),'JPEG',(pw-dw)/2,(ph-dh)/2,dw,dh);
    setProg(Math.round((i+1)/items.length*100),`${i+1} / ${items.length} fotoÄŸraf`);
    await new Promise(r=>setTimeout(r,12));
  }
  doc.save(`fotopdf-${Date.now()}.pdf`);
  hideProg();photoPdfBtn.disabled=false;toast('âœ… PDF oluÅŸturuldu ve indirildi!');
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CROP MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let _cropper=null,_cropItem=null,_origSrc=null,_sx=1,_sy=1;

function openCrop(item){
  _cropItem=item;_sx=1;_sy=1;
  const img=item.querySelector('img');_origSrc=img.src;
  const ci=document.getElementById('cropImg');ci.src=img.src;
  const idx=Array.from(photoList.querySelectorAll('.pi')).indexOf(item);
  document.getElementById('cropIdx').textContent='#'+(idx+1);
  document.querySelectorAll('[data-ratio]').forEach(b=>b.classList.remove('active'));
  document.querySelector('[data-ratio="free"]').classList.add('active');
  openModal('cropModal');
  ci.onload=()=>{
    if(_cropper){_cropper.destroy();_cropper=null}
    _cropper=new Cropper(ci,{viewMode:1,autoCropArea:.88,movable:true,scalable:true,zoomable:true,background:true,responsive:true});
  };
  if(ci.complete)ci.onload();
}
function _closeCrop(goBack=true){
  if(_cropper){_cropper.destroy();_cropper=null}
  closeModal('cropModal');_cropItem=null;
  if(goBack)history.back();
}
document.getElementById('cancelCrop').addEventListener('click',()=>_closeCrop());
document.getElementById('resetCrop').addEventListener('click',()=>{
  _sx=1;_sy=1;const ci=document.getElementById('cropImg');ci.src=_origSrc;
  ci.onload=()=>{if(_cropper){_cropper.destroy();_cropper=null}
    _cropper=new Cropper(ci,{viewMode:1,autoCropArea:.88,movable:true,scalable:true,zoomable:true,background:true,responsive:true});
  };if(ci.complete)ci.onload();
});
document.getElementById('applyCrop').addEventListener('click',()=>{
  if(!_cropper||!_cropItem)return;
  const c=_cropper.getCroppedCanvas({maxWidth:2400,maxHeight:2400,imageSmoothingQuality:'high'});
  if(!c)return;
  _cropItem.querySelector('img').src=c.toDataURL('image/jpeg',.94);
  _closeCrop();toast('âœ… DÃ¼zenleme uygulandÄ±');
});
document.querySelectorAll('[data-ratio]').forEach(b=>b.addEventListener('click',()=>{
  document.querySelectorAll('[data-ratio]').forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
  _cropper?.setAspectRatio(b.dataset.ratio==='free'?NaN:parseFloat(b.dataset.ratio));
}));
document.getElementById('rotL').addEventListener('click',()=>_cropper?.rotate(-90));
document.getElementById('rotR').addEventListener('click',()=>_cropper?.rotate(90));
document.getElementById('flipH').addEventListener('click',()=>{_sx*=-1;_cropper?.scaleX(_sx)});
document.getElementById('flipV').addEventListener('click',()=>{_sy*=-1;_cropper?.scaleY(_sy)});
document.getElementById('zIn').addEventListener('click',()=>_cropper?.zoom(.1));
document.getElementById('zOut').addEventListener('click',()=>_cropper?.zoom(-.1));

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAB 2 â€“ PDF MERGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const mergeListEl=document.getElementById('mergeList');
const mergeEmpty=document.getElementById('mergeEmpty');
const mergePdfBtn=document.getElementById('mergePdfBtn');
const mergeClearBtn=document.getElementById('mergeClearBtn');
let mergeFiles=[];

new Sortable(mergeListEl,{animation:180,ghostClass:'sg',chosenClass:'sc2',filter:'.empty'});

[document.getElementById('mergeIn'),document.getElementById('mergeIn2')]
  .forEach(i=>i.addEventListener('change',e=>{loadMerge(e.target.files);e.target.value=''}));

const mergeDZ=document.getElementById('mergeDZ');
mergeDZ.addEventListener('dragover',e=>{e.preventDefault();mergeDZ.classList.add('hover')});
mergeDZ.addEventListener('dragleave',()=>mergeDZ.classList.remove('hover'));
mergeDZ.addEventListener('drop',e=>{e.preventDefault();mergeDZ.classList.remove('hover');loadMerge(e.dataTransfer.files)});

async function loadMerge(files){
  for(const f of Array.from(files).filter(f=>f.name.endsWith('.pdf')||f.type==='application/pdf')){
    try{
      const ab=await f.arrayBuffer();
      const pdf=await PDFLib.PDFDocument.load(ab,{ignoreEncryption:true});
      const data={name:f.name,pages:pdf.getPageCount(),ab};
      mergeFiles.push(data);addMergeItem(data);
    }catch(e){toast('âŒ '+f.name+' okunamadÄ±')}
  }
  updateMergeState();
}
function addMergeItem(data){
  mergeEmpty.style.display='none';
  const d=document.createElement('div');d.className='mi';
  d.innerHTML=`<span class="mi-drag">â ¿</span>
    <div class="mi-info">
      <div class="mi-name" title="${data.name}">${data.name}</div>
      <div class="mi-pages">${data.pages} sayfa</div>
    </div>
    <button class="mi-del">âœ•</button>`;
  d.querySelector('.mi-del').addEventListener('click',()=>{
    const i=mergeFiles.indexOf(data);if(i>-1)mergeFiles.splice(i,1);
    d.remove();updateMergeState();
  });
  mergeListEl.appendChild(d);
}
function updateMergeState(){
  const n=mergeFiles.length;
  mergePdfBtn.disabled=n<2;mergeClearBtn.disabled=n===0;
  if(n===0)mergeEmpty.style.display='';
}
mergeClearBtn.addEventListener('click',()=>{
  if(!confirm('Liste temizlensin mi?'))return;
  mergeFiles=[];mergeListEl.querySelectorAll('.mi').forEach(el=>el.remove());updateMergeState();
});
mergePdfBtn.addEventListener('click',async()=>{
  if(mergeFiles.length<2)return;
  showProg('BirleÅŸtiriliyorâ€¦');mergePdfBtn.disabled=true;
  try{
    const merged=await PDFLib.PDFDocument.create();
    const domOrder=Array.from(mergeListEl.querySelectorAll('.mi-name')).map(el=>el.title);
    const ordered=domOrder.map(n=>mergeFiles.find(f=>f.name===n)).filter(Boolean);
    const src=ordered.length===mergeFiles.length?ordered:mergeFiles;
    for(let i=0;i<src.length;i++){
      const pdf=await PDFLib.PDFDocument.load(src[i].ab,{ignoreEncryption:true});
      const pages=await merged.copyPages(pdf,pdf.getPageIndices());
      pages.forEach(p=>merged.addPage(p));
      setProg(Math.round((i+1)/src.length*100),`${i+1} / ${src.length} dosya`);
      await new Promise(r=>setTimeout(r,8));
    }
    dlBytes(await merged.save(),`birlesik-${Date.now()}.pdf`);
    toast('âœ… PDF birleÅŸtirildi!');
  }catch(e){console.error(e);toast('âŒ Hata: '+e.message)}
  hideProg();mergePdfBtn.disabled=false;
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAB 3 â€“ SIGN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let signDoc=null,signBytes=null,signPage=1,signPageCount=0,signPageScale=1;
let placedSigs=[],isImageMode=false,signImgNaturalW=0,signImgNaturalH=0;
let photoSignTarget=null; // photo card being signed

[document.getElementById('signPdfIn'),document.getElementById('signPdfIn2')]
  .forEach(i=>i.addEventListener('change',e=>{if(e.target.files[0])loadSignPdf(e.target.files[0]);e.target.value=''}));
[document.getElementById('signImgIn'),document.getElementById('signImgIn2')]
  .forEach(i=>i.addEventListener('change',e=>{if(e.target.files[0])loadSignImg(e.target.files[0]);e.target.value=''}));

async function loadSignPdf(file){
  showProg('PDF YÃ¼kleniyorâ€¦');
  try{
    const ab=await file.arrayBuffer();
    signBytes=ab;isImageMode=false;
    signDoc=await pdfjsLib.getDocument({data:ab.slice(0)}).promise;
    signPageCount=signDoc.numPages;
    placedSigs=[];signPage=1;
    document.getElementById('signFname').textContent=file.name.slice(0,32);
    document.getElementById('signPcount').textContent=signPageCount;
    document.getElementById('signPlabel').textContent='sayfa';
    showSignLoaded();
    await buildThumbs();
    await renderSignPage(1);
  }catch(e){console.error(e);toast('âŒ PDF yÃ¼klenemedi')}
  hideProg();
}

async function loadSignImg(file, fromPhotoCard=false){
  showProg('GÃ¶rsel YÃ¼kleniyorâ€¦');
  try{
    const url=URL.createObjectURL(file);
    await new Promise((res,rej)=>{
      const img=new Image();
      img.onload=()=>{
        isImageMode=true;signDoc=null;signBytes=null;
        signPageCount=1;placedSigs=[];signPage=1;
        signImgNaturalW=img.width;signImgNaturalH=img.height;
        document.getElementById('signFname').textContent=file.name.slice(0,32);
        document.getElementById('signPcount').textContent='1';
        document.getElementById('signPlabel').textContent='gÃ¶rsel';
        showSignLoaded();
        // build thumbs
        const thumbs=document.getElementById('signThumbs');thumbs.innerHTML='';
        const tw=document.createElement('div');tw.className='tw active';
        const tc=document.createElement('canvas');
        const ts=Math.min(68/img.width,1);
        tc.width=Math.round(img.width*ts);tc.height=Math.round(img.height*ts);
        tc.getContext('2d').drawImage(img,0,0,tc.width,tc.height);
        const tn=document.createElement('div');tn.className='tn';tn.textContent='1';
        tw.append(tc,tn);thumbs.appendChild(tw);
        // render main canvas
        const area=document.getElementById('signPreview');
        const maxW=Math.max(area.clientWidth-36,180);
        const scale=Math.min(maxW/img.width,1.8);
        signPageScale=scale;
        const c=document.getElementById('mainCanvas');
        c.width=Math.round(img.width*scale);c.height=Math.round(img.height*scale);
        c.getContext('2d').drawImage(img,0,0,c.width,c.height);
        URL.revokeObjectURL(url);
        res();
      };
      img.onerror=rej;
      img.src=url;
    });
  }catch(e){console.error(e);toast('âŒ GÃ¶rsel yÃ¼klenemedi')}
  hideProg();
}

function showSignLoaded(){
  document.getElementById('signEmpty').style.display='none';
  document.getElementById('signLoaded').style.display='flex';
  document.getElementById('signAbar').style.display='flex';
}

async function buildThumbs(){
  const ct=document.getElementById('signThumbs');ct.innerHTML='';
  for(let p=1;p<=signPageCount;p++){
    const tw=document.createElement('div');tw.className='tw';tw.dataset.p=p;
    const c=document.createElement('canvas');
    const tn=document.createElement('div');tn.className='tn';tn.textContent=p;
    tw.append(c,tn);
    tw.addEventListener('click',()=>renderSignPage(p));
    ct.appendChild(tw);
    const pg=await signDoc.getPage(p);
    const vp=pg.getViewport({scale:.26});
    c.width=vp.width;c.height=vp.height;
    await pg.render({canvasContext:c.getContext('2d'),viewport:vp}).promise;
  }
  updateThumbActive();
}

function updateThumbActive(){
  document.querySelectorAll('.tw').forEach(w=>w.classList.toggle('active',parseInt(w.dataset.p||1)===signPage));
}

async function renderSignPage(p){
  signPage=p;updateThumbActive();
  document.querySelectorAll('.sov').forEach(el=>el.remove());
  const pg=await signDoc.getPage(p);
  const area=document.getElementById('signPreview');
  const maxW=Math.max(area.clientWidth-36,180);
  const vp0=pg.getViewport({scale:1});
  const scale=Math.min(maxW/vp0.width,1.8);
  signPageScale=scale;
  const vp=pg.getViewport({scale});
  const c=document.getElementById('mainCanvas');
  c.width=vp.width;c.height=vp.height;
  await pg.render({canvasContext:c.getContext('2d'),viewport:vp}).promise;
  placedSigs.filter(s=>s.page===p).forEach(s=>buildSigOverlay(s));
}

/* â”€â”€â”€ Sig overlays â”€â”€â”€ */
function placeSig(dataUrl){
  const c=document.getElementById('mainCanvas');
  const w=Math.round(c.width*.4),h=Math.round(w*.3);
  const s={page:signPage,x:Math.round((c.width-w)/2),y:Math.round((c.height-h)/2),w,h,dataUrl};
  placedSigs.push(s);buildSigOverlay(s);
}

function buildSigOverlay(s){
  const wrap=document.getElementById('ppw');
  const el=document.createElement('div');el.className='sov';
  el.style.cssText=`left:${s.x}px;top:${s.y}px;width:${s.w}px;height:${s.h}px`;
  const img=document.createElement('img');img.src=s.dataUrl;
  const del=document.createElement('button');del.className='sov-del';del.textContent='âœ•';
  del.addEventListener('click',e=>{
    e.stopPropagation();el.remove();
    const i=placedSigs.indexOf(s);if(i>-1)placedSigs.splice(i,1);
  });
  const rz=document.createElement('div');rz.className='sov-rz';rz.textContent='â‡²';
  el.append(img,del,rz);wrap.appendChild(el);
  dragEl(el,s);resizeEl(el,rz,s);
}

function dragEl(el,d){
  let sx,sy,ox,oy;
  const mv=e=>{
    e.preventDefault();const t=e.touches?e.touches[0]:e;
    const c=document.getElementById('mainCanvas');
    d.x=Math.max(0,Math.min(ox+(t.clientX-sx),c.width-d.w));
    d.y=Math.max(0,Math.min(oy+(t.clientY-sy),c.height-d.h));
    el.style.left=d.x+'px';el.style.top=d.y+'px';
  };
  const up=()=>{
    document.removeEventListener('mousemove',mv);document.removeEventListener('mouseup',up);
    document.removeEventListener('touchmove',mv);document.removeEventListener('touchend',up);
  };
  const dn=e=>{
    if(e.target===del||e.target===rz)return; // let the vars resolve
    const del_=el.querySelector('.sov-del'),rz_=el.querySelector('.sov-rz');
    if(e.target===del_||e.target===rz_)return;
    e.preventDefault();const t=e.touches?e.touches[0]:e;
    sx=t.clientX;sy=t.clientY;ox=d.x;oy=d.y;
    document.addEventListener('mousemove',mv);document.addEventListener('mouseup',up);
    document.addEventListener('touchmove',mv,{passive:false});document.addEventListener('touchend',up);
  };
  el.addEventListener('mousedown',dn);el.addEventListener('touchstart',dn,{passive:false});
}

function resizeEl(el,handle,d){
  let sx,sy,ow,oh;
  const mv=e=>{
    e.preventDefault();const t=e.touches?e.touches[0]:e;
    d.w=Math.max(40,ow+(t.clientX-sx));d.h=Math.max(18,oh+(t.clientY-sy));
    el.style.width=d.w+'px';el.style.height=d.h+'px';
  };
  const up=()=>{
    document.removeEventListener('mousemove',mv);document.removeEventListener('mouseup',up);
    document.removeEventListener('touchmove',mv);document.removeEventListener('touchend',up);
  };
  handle.addEventListener('mousedown',e=>{
    e.stopPropagation();e.preventDefault();sx=e.clientX;sy=e.clientY;ow=d.w;oh=d.h;
    document.addEventListener('mousemove',mv);document.addEventListener('mouseup',up);
  });
  handle.addEventListener('touchstart',e=>{
    e.stopPropagation();e.preventDefault();const t=e.touches[0];sx=t.clientX;sy=t.clientY;ow=d.w;oh=d.h;
    document.addEventListener('touchmove',mv,{passive:false});document.addEventListener('touchend',up);
  },{passive:false});
}

document.getElementById('clearSigsBtn').addEventListener('click',()=>{
  placedSigs=placedSigs.filter(s=>s.page!==signPage);
  document.querySelectorAll('.sov').forEach(el=>el.remove());
  toast('Ä°mzalar temizlendi');
});

/* â”€â”€â”€ Download signed â”€â”€â”€ */
document.getElementById('dlSignedBtn').addEventListener('click',async()=>{
  if(!placedSigs.length){toast('âš ï¸ HenÃ¼z imza eklemedin');return}

  if(isImageMode){
    // Render flat image with all sigs at natural resolution
    showProg('Ä°mzalÄ± GÃ¶rsel HazÄ±rlanÄ±yorâ€¦');
    const c2=document.getElementById('mainCanvas');
    const out=document.createElement('canvas');
    out.width=signImgNaturalW;out.height=signImgNaturalH;
    const ctx=out.getContext('2d');
    // draw base from screen canvas scaled up
    ctx.drawImage(c2,0,0,signImgNaturalW,signImgNaturalH);
    // draw sigs
    for(const s of placedSigs){
      const si=new Image();
      await new Promise(res=>{si.onload=res;si.src=s.dataUrl});
      const fx=signImgNaturalW/c2.width,fy=signImgNaturalH/c2.height;
      ctx.globalAlpha=1;
      ctx.drawImage(si,s.x*fx,s.y*fy,s.w*fx,s.h*fy);
    }
    dlDataUrl(out.toDataURL('image/png'),`imzali-${Date.now()}.png`);
    hideProg();toast('âœ… Ä°mzalÄ± gÃ¶rsel indirildi!');
    return;
  }

  if(!signBytes)return;
  showProg('Ä°mzalÄ± PDF HazÄ±rlanÄ±yorâ€¦');
  try{
    const pdfDoc=await PDFLib.PDFDocument.load(signBytes.slice(0),{ignoreEncryption:true});
    for(let i=0;i<placedSigs.length;i++){
      const s=placedSigs[i];
      const pg=pdfDoc.getPage(s.page-1);
      const {width:pW,height:pH}=pg.getSize();
      const pjsPg=await signDoc.getPage(s.page);
      const vp=pjsPg.getViewport({scale:signPageScale});
      const pdfX=(s.x/vp.width)*pW;
      const pdfY=pH-((s.y+s.h)/vp.height)*pH;
      const pdfW=(s.w/vp.width)*pW;
      const pdfH=(s.h/vp.height)*pH;
      const b64=s.dataUrl.split(',')[1];
      const byt=Uint8Array.from(atob(b64),c=>c.charCodeAt(0));
      const pngImg=await pdfDoc.embedPng(byt);
      pg.drawImage(pngImg,{x:pdfX,y:pdfY,width:pdfW,height:Math.abs(pdfH)});
      setProg(Math.round((i+1)/placedSigs.length*100),`${i+1} / ${placedSigs.length} imza`);
    }
    dlBytes(await pdfDoc.save(),`imzali-${Date.now()}.pdf`);
    toast('âœ… Ä°mzalÄ± PDF indirildi!');
  }catch(e){console.error(e);toast('âŒ Hata: '+e.message)}
  hideProg();
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PHOTO CARD â†’ SIGN FLOW
   FotoÄŸraf kartÄ±ndaki âœï¸ butonu: fotoÄŸrafÄ± imzala sekmesine yÃ¼kler
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openPhotoSignFlow(card){
  photoSignTarget=card;
  // KartÄ±n img src'sini blob'a Ã§evir
  const imgEl=card.querySelector('img');
  fetch(imgEl.src).then(r=>r.blob()).then(blob=>{
    const file=new File([blob],'photo.jpg',{type:'image/jpeg'});
    switchTab('sign');
    loadSignImg(file,true);
    toast('FotoÄŸraf yÃ¼klendi â€” imzanÄ± Ã§iz ve konumlandÄ±r');
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SIGNATURE DRAW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let _drawing=false,_sigColor='#111',_sigW=3;
const sigCvs=document.getElementById('sigCanvas');
const sigCtx=sigCvs.getContext('2d');

function resizeSigCvs(){
  const r=sigCvs.parentElement.getBoundingClientRect();
  const tmp=document.createElement('canvas');
  tmp.width=sigCvs.width;tmp.height=sigCvs.height;
  tmp.getContext('2d').drawImage(sigCvs,0,0);
  sigCvs.width=Math.max(Math.floor(r.width),100);
  sigCvs.height=Math.max(Math.floor(r.height),100);
  sigCtx.lineCap='round';sigCtx.lineJoin='round';
  sigCtx.drawImage(tmp,0,0);
}

function getSigPt(e){
  const r=sigCvs.getBoundingClientRect();
  const t=e.touches?e.touches[0]:e;
  return{x:t.clientX-r.left,y:t.clientY-r.top};
}

sigCvs.addEventListener('pointerdown',e=>{
  _drawing=true;sigCvs.setPointerCapture(e.pointerId);
  const p=getSigPt(e);
  sigCtx.beginPath();sigCtx.moveTo(p.x,p.y);
  sigCtx.strokeStyle=_sigColor;sigCtx.lineWidth=_sigW;
  document.getElementById('sigHint').classList.add('gone');
});
sigCvs.addEventListener('pointermove',e=>{
  if(!_drawing)return;
  const p=getSigPt(e);
  sigCtx.lineTo(p.x,p.y);sigCtx.stroke();sigCtx.beginPath();sigCtx.moveTo(p.x,p.y);
});
sigCvs.addEventListener('pointerup',()=>_drawing=false);
sigCvs.addEventListener('pointercancel',()=>_drawing=false);

document.getElementById('clearSigCvs').addEventListener('click',()=>{
  sigCtx.clearRect(0,0,sigCvs.width,sigCvs.height);
  document.getElementById('sigHint').classList.remove('gone');
});

document.querySelectorAll('.cdot').forEach(d=>{
  d.addEventListener('click',()=>{
    document.querySelectorAll('.cdot').forEach(x=>x.classList.remove('active'));
    d.classList.add('active');_sigColor=d.dataset.c;
  });
});
document.querySelectorAll('[data-w]').forEach(b=>{
  b.addEventListener('click',()=>{
    document.querySelectorAll('[data-w]').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');_sigW=parseInt(b.dataset.w);
  });
});

document.getElementById('drawSigBtn').addEventListener('click',()=>{
  sigCtx.clearRect(0,0,sigCvs.width,sigCvs.height);
  document.getElementById('sigHint').classList.remove('gone');
  openModal('sigModal');
  setTimeout(resizeSigCvs,60);
});

document.getElementById('cancelSig').addEventListener('click',()=>{
  closeModal('sigModal');history.back();
});

document.getElementById('applySig').addEventListener('click',()=>{
  const d=sigCtx.getImageData(0,0,sigCvs.width,sigCvs.height);
  const hasPixels=d.data.some((_,i)=>i%4===3&&d.data[i]>10);
  if(!hasPixels){toast('âš ï¸ Ã–nce imzanÄ± Ã§iz!');return}
  const cropped=cropSigCvs();
  const dataUrl=cropped.toDataURL('image/png');
  closeModal('sigModal');
  history.back();
  placeSig(dataUrl);
  toast('âœ… Ä°mza eklendi â€” sÃ¼rÃ¼kle & kÃ¶ÅŸeden boyutlandÄ±r');
});

function cropSigCvs(){
  const d=sigCtx.getImageData(0,0,sigCvs.width,sigCvs.height);
  let x0=sigCvs.width,y0=sigCvs.height,x1=0,y1=0;
  for(let y=0;y<sigCvs.height;y++)for(let x=0;x<sigCvs.width;x++){
    if(d.data[(y*sigCvs.width+x)*4+3]>8){
      if(x<x0)x0=x;if(x>x1)x1=x;if(y<y0)y0=y;if(y>y1)y1=y;
    }
  }
  const pad=14;
  x0=Math.max(0,x0-pad);y0=Math.max(0,y0-pad);
  x1=Math.min(sigCvs.width,x1+pad);y1=Math.min(sigCvs.height,y1+pad);
  const w=x1-x0||sigCvs.width,h=y1-y0||sigCvs.height;
  const out=document.createElement('canvas');out.width=w;out.height=h;
  out.getContext('2d').putImageData(sigCtx.getImageData(x0,y0,w,h),0,0);
  return out;
}
</script>
</body>
</html>

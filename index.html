<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Photo to PDF</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=DM+Sans:wght@400;500&family=Dancing+Script:wght@600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0d0d11;--surf:#16161e;--surf2:#1e1e28;--surf3:#252530;
  --acc:#f5c842;--acc2:#f07840;--green:#3db87a;--red:#e05252;
  --blue:#2563eb;--teal:#059669;--purple:#7c3aed;
  --text:#edeae2;--muted:#6a6a7e;--border:#252530;
  --r:12px;--ease:cubic-bezier(.4,0,.2,1);
}
html,body{height:100%;overflow:hidden}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);display:flex;flex-direction:column;height:100dvh}

/* ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê */
header{
  flex-shrink:0;display:flex;align-items:center;
  height:54px;overflow:hidden;
  background:var(--surf);border-bottom:1px solid var(--border);
}
.h-logo{
  font-family:'Syne',sans-serif;font-weight:800;font-size:.95rem;
  white-space:nowrap;padding:0 12px;flex-shrink:0;letter-spacing:-.2px;
}
.h-logo span{color:var(--acc)}
/* glowing center signature band */
.h-center{
  flex:1;height:100%;display:flex;align-items:center;justify-content:center;
  background:linear-gradient(90deg,
    transparent 0%,
    rgba(245,200,66,.05) 20%,
    rgba(245,200,66,.12) 50%,
    rgba(245,200,66,.05) 80%,
    transparent 100%);
  position:relative;overflow:hidden;
}
.h-center::before{
  content:'';position:absolute;inset:0;
  background:radial-gradient(ellipse 60% 80% at 50% 50%,rgba(245,200,66,.08),transparent);
  pointer-events:none;
}
.zaphyros{
  font-family:'Dancing Script',cursive;
  font-size:1.65rem;font-weight:700;
  background:linear-gradient(135deg,#f5c842 0%,#f0b820 40%,#e8860a 100%);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
  filter:drop-shadow(0 0 10px rgba(245,200,66,.5)) drop-shadow(0 0 3px rgba(245,200,66,.3));
  letter-spacing:1.5px;user-select:none;position:relative;z-index:1;
}
.h-right{display:flex;align-items:center;gap:7px;padding:0 10px;flex-shrink:0}
.lang-btn{
  background:var(--surf2);border:1px solid var(--border);
  color:var(--muted);font-family:'Syne',sans-serif;font-weight:700;font-size:.68rem;
  padding:4px 8px;border-radius:7px;cursor:pointer;letter-spacing:.05em;
  touch-action:manipulation;transition:all .15s;
}
.lang-btn:hover,.lang-btn.active{background:var(--acc);border-color:var(--acc);color:#111}
.hpill{
  background:var(--surf2);border:1px solid var(--border);
  padding:4px 11px;border-radius:999px;font-size:.73rem;color:var(--muted);white-space:nowrap;
}
.hpill b{color:var(--acc)}

/* ‚ïê‚ïê‚ïê NAV CARDS ‚ïê‚ïê‚ïê */
.nav-cards{
  flex-shrink:0;display:grid;grid-template-columns:repeat(3,1fr);gap:8px;
  padding:10px 12px;background:var(--bg);
}
.nc{
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:4px;padding:13px 4px;border-radius:14px;border:2.5px solid transparent;
  cursor:pointer;font-family:'Syne',sans-serif;font-weight:700;font-size:.72rem;
  text-align:center;line-height:1.2;color:#fff;
  transition:transform .13s,opacity .13s,border-color .13s,box-shadow .13s;
  touch-action:manipulation;-webkit-tap-highlight-color:transparent;user-select:none;
}
.nc:active{transform:scale(.93)}
.nc.active{border-color:rgba(255,255,255,.5);box-shadow:0 4px 18px rgba(0,0,0,.45)}
.nc:not(.active){opacity:.52}
.nc-icon{font-size:1.4rem;line-height:1}
.nc.c1{background:linear-gradient(135deg,#1d4ed8,#2563eb)}
.nc.c2{background:linear-gradient(135deg,#047857,#059669)}
.nc.c3{background:linear-gradient(135deg,#6d28d9,#7c3aed)}

/* ‚ïê‚ïê‚ïê PANELS ‚ïê‚ïê‚ïê */
.tab-panel{display:none;flex:1;flex-direction:column;overflow:hidden;min-height:0}
.tab-panel.active{display:flex}
.scroll{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;padding:10px 12px}

/* ‚ïê‚ïê‚ïê SETTINGS BAR ‚ïê‚ïê‚ïê */
.settings-bar{
  flex-shrink:0;display:flex;gap:8px;padding:7px 12px;
  background:var(--surf);border-bottom:1px solid var(--border);
  overflow-x:auto;scrollbar-width:none;
}
.settings-bar::-webkit-scrollbar{display:none}
.sc{display:flex;flex-direction:column;gap:2px;flex-shrink:0}
.sc label{font-size:.6rem;color:var(--muted);text-transform:uppercase;letter-spacing:.07em}
select{background:var(--surf2);border:1px solid var(--border);color:var(--text);
  border-radius:8px;padding:5px 9px;font-size:.79rem;font-family:inherit;cursor:pointer;outline:none}
select:focus{border-color:var(--acc)}
input[type=range]{accent-color:var(--acc);cursor:pointer;width:86px}
.qval{font-size:.76rem;color:var(--acc);font-weight:700;min-width:30px}

/* ‚ïê‚ïê‚ïê DROP ZONE ‚ïê‚ïê‚ïê */
.dz{
  border:2px dashed var(--border);border-radius:var(--r);padding:22px 14px;
  text-align:center;background:var(--surf);cursor:pointer;
  transition:border .2s,background .2s;margin-bottom:12px;position:relative;
}
.dz:hover,.dz.hover{border-color:var(--acc);background:rgba(245,200,66,.04)}
.dz input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
.dz-icon{font-size:1.7rem;margin-bottom:4px}
.dz h3{font-family:'Syne',sans-serif;font-size:.88rem;margin-bottom:3px}
.dz p{font-size:.72rem;color:var(--muted)}

/* ‚ïê‚ïê‚ïê PHOTO GRID ‚ïê‚ïê‚ïê */
#photo-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:9px}
.pi{border-radius:10px;background:var(--surf2);display:flex;flex-direction:column;overflow:hidden;animation:popIn .2s var(--ease);cursor:default;}
@keyframes popIn{from{opacity:0;transform:scale(.88)}to{opacity:1;transform:scale(1)}}
.pi-handle{height:24px;background:rgba(255,255,255,.04);display:flex;align-items:center;justify-content:center;cursor:grab;color:var(--muted);font-size:.8rem;letter-spacing:3px;user-select:none;touch-action:none;border-bottom:1px solid rgba(255,255,255,.05);flex-shrink:0;}
.pi-handle:active{cursor:grabbing}
.pi img{width:100%;height:115px;object-fit:cover;display:block;pointer-events:none}
.pi-bar{display:flex;align-items:center;padding:4px 5px;gap:4px;background:rgba(0,0,0,.3);border-top:1px solid rgba(255,255,255,.06);flex-shrink:0;}
.pi-num{font-size:.63rem;font-weight:700;color:var(--muted);flex:1;padding-left:2px}
.ib{width:36px;height:34px;border-radius:7px;border:none;cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center;transition:transform .12s;touch-action:manipulation;-webkit-tap-highlight-color:transparent;}
.ib:active{transform:scale(.88)}
.ib.edit{background:rgba(37,99,235,.25);color:#60a5fa}
.ib.sign{background:rgba(124,58,237,.25);color:#a78bfa}
.ib.del{background:rgba(224,82,82,.22);color:#f87171}
.sg{opacity:.2;border:2px dashed var(--acc)}
.sc2{box-shadow:0 6px 24px rgba(0,0,0,.5);z-index:5}

/* ‚ïê‚ïê‚ïê ACTION BAR ‚ïê‚ïê‚ïê */
.abar{flex-shrink:0;display:flex;align-items:center;gap:8px;padding:10px 12px;background:var(--surf);border-top:2px solid var(--border);padding-bottom:calc(10px + env(safe-area-inset-bottom));}
.abar-sm{width:46px;height:46px;border-radius:11px;border:1.5px solid var(--border);background:var(--surf2);color:var(--text);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0;touch-action:manipulation;transition:opacity .15s,transform .12s;position:relative;overflow:hidden;}
.abar-sm:active{transform:scale(.9)}
.abar-sm:disabled{opacity:.3;cursor:not-allowed}
.abar-sm.danger{border-color:var(--red);color:var(--red);background:rgba(224,82,82,.1)}
.abar-main{flex:1;height:46px;border-radius:11px;border:none;font-family:'Syne',sans-serif;font-weight:700;font-size:.9rem;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;touch-action:manipulation;transition:opacity .15s,transform .12s;-webkit-tap-highlight-color:transparent;}
.abar-main:active{transform:scale(.97)}
.abar-main:disabled{opacity:.3;cursor:not-allowed}
.abar-main.blue{background:linear-gradient(135deg,#1d4ed8,#3b82f6);color:#fff}
.abar-main.teal{background:linear-gradient(135deg,#047857,#10b981);color:#fff}
.abar-main.purple{background:linear-gradient(135deg,#6d28d9,#8b5cf6);color:#fff}

/* ‚ïê‚ïê‚ïê MERGE LIST ‚ïê‚ïê‚ïê */
.merge-list{display:flex;flex-direction:column;gap:8px;margin-bottom:12px}
.mi{display:flex;align-items:center;gap:9px;background:var(--surf);border:1px solid var(--border);border-radius:10px;padding:10px 12px;cursor:grab;animation:popIn .2s var(--ease);}
.mi:active{cursor:grabbing}
.mi-drag{color:var(--muted);font-size:.95rem;flex-shrink:0;user-select:none}
.mi-info{flex:1;min-width:0}
.mi-name{font-size:.82rem;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.mi-pages{font-size:.7rem;color:var(--muted);margin-top:1px}
.mi-del{background:transparent;border:1px solid var(--border);color:var(--red);border-radius:7px;width:32px;height:32px;cursor:pointer;font-size:13px;flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:background .15s}
.mi-del:hover{background:rgba(224,82,82,.12)}

/* ‚ïê‚ïê‚ïê SIGN TAB ‚ïê‚ïê‚ïê */
.sign-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;gap:14px;color:var(--muted);font-size:.88rem;text-align:center;padding:24px;}
.sign-empty .big{font-size:3.2rem;opacity:.3}
.sign-empty-btns{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
.open-btn{padding:11px 18px;border-radius:11px;border:1.5px solid var(--border);background:var(--surf2);color:var(--text);font-family:'Syne',sans-serif;font-weight:700;font-size:.84rem;cursor:pointer;display:flex;align-items:center;gap:7px;position:relative;overflow:hidden;touch-action:manipulation;}
.open-btn input{position:absolute;inset:0;opacity:0;cursor:pointer}
.sign-loaded{display:none;flex:1;flex-direction:column;overflow:hidden;min-height:0}
.sign-topbar{display:flex;align-items:center;justify-content:space-between;padding:7px 13px;background:var(--surf);border-bottom:1px solid var(--border);flex-shrink:0;gap:8px;}
.sign-fname{font-size:.78rem;color:var(--muted);min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1}
.sign-fname b{color:var(--acc)}
.sign-change-btns{display:flex;gap:5px;flex-shrink:0}
.chbtn{padding:5px 9px;border-radius:8px;border:1px solid var(--border);background:var(--surf2);color:var(--muted);font-size:.71rem;cursor:pointer;position:relative;overflow:hidden;font-family:'DM Sans',sans-serif;touch-action:manipulation;}
.chbtn input{position:absolute;inset:0;opacity:0;cursor:pointer}
.sign-layout{display:flex;flex:1;overflow:hidden;min-height:0}
.sign-thumbs{flex-shrink:0;width:82px;overflow-y:auto;overflow-x:hidden;background:var(--surf);border-right:1px solid var(--border);padding:7px;display:flex;flex-direction:column;gap:6px;scrollbar-width:thin;scrollbar-color:var(--surf3) transparent;}
.tw{position:relative;cursor:pointer;border-radius:6px;overflow:hidden;border:2px solid transparent;transition:border-color .18s;flex-shrink:0}
.tw.active{border-color:var(--acc)}
.tw canvas{width:100%;display:block}
.tn{position:absolute;bottom:3px;left:3px;background:rgba(0,0,0,.7);color:#fff;font-size:.55rem;font-weight:700;padding:1px 5px;border-radius:999px}
.sign-preview{flex:1;overflow:auto;background:#0a0a0e;display:flex;align-items:flex-start;justify-content:center;padding:18px;}
/* page preview wrap ‚Äî position:relative for overlays */
.ppw{position:relative;display:inline-block;line-height:0;flex-shrink:0}
.ppw canvas{border-radius:4px;box-shadow:0 8px 32px rgba(0,0,0,.7);display:block}

/* ‚ïê‚ïê‚ïê SIGNATURE OVERLAY ‚ïê‚ïê‚ïê */
.sov{
  position:absolute;
  border:1.5px dashed rgba(245,200,66,.85);
  border-radius:3px;
  /* NO pointer-events on this container ‚Äî handled manually */
  touch-action:none;
}
/* image inside: pointer-events none so touches reach the container */
.sov img{width:100%;height:100%;display:block;pointer-events:none;user-select:none}
.sov-del{
  position:absolute;top:-12px;right:-12px;
  background:var(--red);color:#fff;border:2px solid #0d0d11;
  border-radius:50%;width:24px;height:24px;
  cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center;
  z-index:10;touch-action:manipulation;line-height:1;
  pointer-events:auto; /* explicitly clickable */
}
.sov-rz{
  position:absolute;bottom:-10px;right:-10px;
  width:22px;height:22px;background:var(--acc);border-radius:4px;
  cursor:se-resize;z-index:10;display:flex;align-items:center;justify-content:center;
  font-size:12px;color:#111;
  pointer-events:auto; /* explicitly resizable */
  touch-action:none;
}

/* ‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.88);backdrop-filter:blur(8px);z-index:400;flex-direction:column}
.modal.open{display:flex}
.mh{display:flex;align-items:center;justify-content:space-between;padding:12px 15px;background:var(--surf);border-bottom:1px solid var(--border);flex-shrink:0}
.mh h2{font-family:'Syne',sans-serif;font-size:.95rem}
.mh span{font-size:.74rem;color:var(--muted)}
.mtb{display:flex;gap:5px;padding:8px 11px;background:var(--surf2);flex-shrink:0;overflow-x:auto;scrollbar-width:none;align-items:center;}
.mtb::-webkit-scrollbar{display:none}
.tb{padding:6px 11px;border-radius:8px;border:1px solid var(--border);background:var(--surf);color:var(--text);font-family:'DM Sans',sans-serif;font-size:.77rem;cursor:pointer;white-space:nowrap;flex-shrink:0;display:flex;align-items:center;gap:4px;transition:background .15s,border-color .15s;}
.tb:hover{background:var(--surf3);border-color:var(--acc)}
.tb.active{background:var(--acc);color:#111;border-color:var(--acc);font-weight:600}
.mc{flex:1;overflow:hidden;position:relative;background:#0a0a0e;display:flex;align-items:center;justify-content:center}
.mc img{max-width:100%;max-height:100%;display:block}
.mf{display:flex;gap:8px;padding:10px 13px;background:var(--surf);border-top:1px solid var(--border);flex-shrink:0;padding-bottom:calc(10px + env(safe-area-inset-bottom));}
.mf-btn{padding:12px 16px;border-radius:10px;border:none;font-family:'Syne',sans-serif;font-weight:700;font-size:.86rem;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;touch-action:manipulation;transition:opacity .15s;}
.mf-btn:active{opacity:.75}
.mf-cancel{background:var(--surf2);color:var(--text);border:1px solid var(--border);flex:1}
.mf-reset{background:var(--surf2);color:var(--muted);border:1px solid var(--border)}
.mf-apply{background:linear-gradient(135deg,var(--green),#27a065);color:#fff;flex:2}
.divv{width:1px;background:var(--border);margin:0 2px;align-self:stretch;flex-shrink:0}

/* ‚ïê‚ïê‚ïê SIG CANVAS ‚ïê‚ïê‚ïê */
.sig-wrap{flex:1;display:flex;position:relative;background:#f4f4ec;overflow:hidden}
#sigCanvas{display:block;touch-action:none;width:100%;height:100%;cursor:crosshair}
.sig-hint{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:.95rem;color:#bbb;pointer-events:none;transition:opacity .25s;}
.sig-hint.gone{opacity:0}
.cdot{width:26px;height:26px;border-radius:50%;cursor:pointer;border:3px solid transparent;transition:border-color .15s,transform .15s;flex-shrink:0;touch-action:manipulation;}
.cdot.active{border-color:#fff;transform:scale(1.15)}

/* ‚ïê‚ïê‚ïê PROGRESS ‚ïê‚ïê‚ïê */
.prog-back{display:none;position:fixed;inset:0;background:rgba(0,0,0,.82);backdrop-filter:blur(6px);z-index:600;align-items:center;justify-content:center;}
.prog-back.open{display:flex}
.prog-card{background:var(--surf);border:1px solid var(--border);border-radius:16px;padding:26px 30px;text-align:center;min-width:230px;}
.prog-card h3{font-family:'Syne',sans-serif;margin-bottom:14px;font-size:.94rem}
.prog-track{width:100%;height:7px;background:var(--surf2);border-radius:999px;overflow:hidden;margin-bottom:9px}
.prog-fill{height:100%;background:linear-gradient(90deg,var(--acc),var(--acc2));border-radius:999px;transition:width .2s var(--ease);width:0%}
.prog-note{font-size:.78rem;color:var(--muted)}

/* ‚ïê‚ïê‚ïê TOAST ‚ïê‚ïê‚ïê */
.toast{position:fixed;top:62px;left:50%;transform:translateX(-50%) translateY(-8px);background:var(--surf2);border:1px solid var(--border);color:var(--text);padding:8px 18px;border-radius:10px;font-size:.81rem;opacity:0;pointer-events:none;transition:opacity .25s,transform .25s;z-index:700;white-space:nowrap;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.empty{grid-column:1/-1;text-align:center;padding:24px;color:var(--muted);font-size:.8rem;line-height:1.9}

@media(max-width:380px){
  .nc{padding:10px 2px;font-size:.66rem}
  .nc-icon{font-size:1.2rem}
  .h-logo{font-size:.82rem;padding:0 8px}
  .zaphyros{font-size:1.35rem}
}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê -->
<header>
  <div class="h-logo">Photo to <span>PDF</span></div>
  <div class="h-center">
    <span class="zaphyros">zaphyros</span>
  </div>
  <div class="h-right">
    <button class="lang-btn active" id="langTR" onclick="setLang('tr')">TR</button>
    <button class="lang-btn" id="langEN" onclick="setLang('en')">EN</button>
    <div class="hpill" id="countPill">Photo: <b>0</b></div>
  </div>
</header>

<!-- ‚ïê‚ïê‚ïê NAV CARDS ‚ïê‚ïê‚ïê -->
<div class="nav-cards">
  <div class="nc c1 active" data-tab="photo">
    <div class="nc-icon">üì∑</div>
    <div data-i="nav_photo">Foto ‚Üí PDF</div>
  </div>
  <div class="nc c2" data-tab="merge">
    <div class="nc-icon">üîó</div>
    <div data-i="nav_merge">Birle≈ütir</div>
  </div>
  <div class="nc c3" data-tab="sign">
    <div class="nc-icon">‚úçÔ∏è</div>
    <div data-i="nav_sign">ƒ∞mzala</div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê TAB: PHOTO ‚ïê‚ïê‚ïê -->
<div class="tab-panel active" id="tab-photo">
  <div class="settings-bar">
    <div class="sc">
      <label data-i="lbl_page">Sayfa</label>
      <select id="pageSize">
        <option value="a4">A4</option><option value="a5">A5</option>
        <option value="letter">Letter</option><option value="square" data-i="opt_square">Kare</option>
      </select>
    </div>
    <div class="sc">
      <label data-i="lbl_orient">Y√∂n</label>
      <select id="orientation">
        <option value="auto" data-i="opt_auto">Otomatik</option>
        <option value="portrait" data-i="opt_portrait">Dikey</option>
        <option value="landscape" data-i="opt_landscape">Yatay</option>
      </select>
    </div>
    <div class="sc">
      <label data-i="lbl_margin">Kenar</label>
      <select id="margin">
        <option value="8">8mm</option><option value="0" data-i="opt_none">Kenarsƒ±z</option><option value="15">15mm</option>
      </select>
    </div>
    <div class="sc">
      <label data-i="lbl_quality">Kalite: <span class="qval" id="qval">85%</span></label>
      <input type="range" id="qrange" min="40" max="100" value="85">
    </div>
  </div>

  <div class="scroll">
    <div class="dz" id="photoDZ">
      <input type="file" id="photoIn" multiple accept="image/*">
      <div class="dz-icon">üì∑</div>
      <h3 data-i="dz_photo_h">Fotoƒüraf Ekle</h3>
      <p data-i="dz_photo_p">Tƒ±kla veya s√ºr√ºkle ¬∑ JPG, PNG, WebP</p>
    </div>
    <div id="photo-list">
      <div class="empty" id="photoEmpty" data-i="empty_photo">üìÇ Hen√ºz fotoƒüraf eklenmedi.</div>
    </div>
  </div>

  <div class="abar">
    <button class="abar-sm" title="Add" style="position:relative;overflow:hidden">
      Ôºã<input type="file" id="photoIn2" multiple accept="image/*" style="position:absolute;inset:0;opacity:0;cursor:pointer">
    </button>
    <button class="abar-sm danger" id="photoClearBtn" disabled>üóë</button>
    <button class="abar-main blue" id="photoPdfBtn" disabled data-i="btn_create_pdf">üìÑ PDF Olu≈ütur</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê TAB: MERGE ‚ïê‚ïê‚ïê -->
<div class="tab-panel" id="tab-merge">
  <div class="scroll">
    <div class="dz" id="mergeDZ">
      <!-- accept=".pdf" forces file manager on Android, not gallery -->
      <input type="file" id="mergeIn" multiple accept=".pdf">
      <div class="dz-icon">üìÑ</div>
      <h3 data-i="dz_merge_h">PDF Dosyalarƒ± Ekle</h3>
      <p data-i="dz_merge_p">Birle≈ütirmek istediƒüin PDF'leri se√ß ¬∑ Sƒ±rala</p>
    </div>
    <div class="merge-list" id="mergeList">
      <div class="empty" id="mergeEmpty" data-i="empty_merge">üìÇ Hen√ºz PDF eklenmedi.</div>
    </div>
  </div>
  <div class="abar">
    <button class="abar-sm" style="position:relative;overflow:hidden">
      Ôºã<input type="file" id="mergeIn2" multiple accept=".pdf" style="position:absolute;inset:0;opacity:0;cursor:pointer">
    </button>
    <button class="abar-sm danger" id="mergeClearBtn" disabled>üóë</button>
    <button class="abar-main teal" id="mergePdfBtn" disabled data-i="btn_merge">üîó Birle≈ütir ve ƒ∞ndir</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê TAB: SIGN ‚ïê‚ïê‚ïê -->
<div class="tab-panel" id="tab-sign">
  <div class="sign-empty" id="signEmpty">
    <div class="big">‚úçÔ∏è</div>
    <div style="font-weight:500;font-size:.92rem;color:var(--text)" data-i="sign_pick_title">ƒ∞mzalamak istediƒüin dosyayƒ± se√ß</div>
    <div style="font-size:.77rem" data-i="sign_pick_sub">PDF veya fotoƒüraf desteklenir</div>
    <div class="sign-empty-btns">
      <label class="open-btn">üìÑ <span data-i="btn_open_pdf">PDF A√ß</span><input type="file" id="signPdfIn" accept=".pdf"></label>
      <label class="open-btn">üñºÔ∏è <span data-i="btn_open_img">Fotoƒüraf A√ß</span><input type="file" id="signImgIn" accept="image/*"></label>
    </div>
  </div>

  <div class="sign-loaded" id="signLoaded">
    <div class="sign-topbar">
      <div class="sign-fname"><b id="signFname">-</b> ¬∑ <span id="signPcount">0</span> <span id="signPlabel" data-i="lbl_page_count">sayfa</span></div>
      <div class="sign-change-btns">
        <label class="chbtn">PDF<input type="file" id="signPdfIn2" accept=".pdf"></label>
        <label class="chbtn"><span data-i="lbl_photo_short">Foto</span><input type="file" id="signImgIn2" accept="image/*"></label>
      </div>
    </div>
    <div class="sign-layout">
      <div class="sign-thumbs" id="signThumbs"></div>
      <div class="sign-preview" id="signPreview">
        <div class="ppw" id="ppw"><canvas id="mainCanvas"></canvas></div>
      </div>
    </div>
  </div>

  <div class="abar" id="signAbar" style="display:none">
    <button class="abar-sm danger" id="clearSigsBtn" title="Clear">üóë</button>
    <button class="abar-main purple" id="drawSigBtn" data-i="btn_sign">‚úçÔ∏è ƒ∞mza √áiz</button>
    <button class="abar-main blue" id="dlSignedBtn" data-i="btn_dl_signed">üìÑ ƒ∞ndir</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê CROP MODAL ‚ïê‚ïê‚ïê -->
<div class="modal" id="cropModal">
  <div class="mh"><h2>‚úÇÔ∏è <span data-i="crop_title">D√ºzenle / Kƒ±rp</span></h2><span id="cropIdx"></span></div>
  <div class="mtb">
    <span style="font-size:.66rem;color:var(--muted)" data-i="lbl_ratio">Oran:</span>
    <button class="tb active" data-ratio="free" data-i="opt_free">Serbest</button>
    <button class="tb" data-ratio="1">1:1</button>
    <button class="tb" data-ratio="1.333">4:3</button>
    <button class="tb" data-ratio="1.778">16:9</button>
    <button class="tb" data-ratio="0.707">A4</button>
    <div class="divv"></div>
    <button class="tb" id="rotL">‚Ü∫</button>
    <button class="tb" id="rotR">‚Üª</button>
    <button class="tb" id="flipH">‚áÑ</button>
    <button class="tb" id="flipV">‚áÖ</button>
    <button class="tb" id="zIn">üîç+</button>
    <button class="tb" id="zOut">üîç‚àí</button>
  </div>
  <div class="mc"><img id="cropImg" src="" alt=""></div>
  <div class="mf">
    <button class="mf-btn mf-cancel" id="cancelCrop" data-i="btn_cancel">ƒ∞ptal</button>
    <button class="mf-btn mf-reset" id="resetCrop" data-i="btn_reset">Sƒ±fƒ±rla</button>
    <button class="mf-btn mf-apply" id="applyCrop" data-i="btn_apply">‚úì Uygula</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê SIG DRAW MODAL ‚ïê‚ïê‚ïê -->
<div class="modal" id="sigModal">
  <div class="mh">
    <h2>‚úçÔ∏è <span data-i="sig_draw_title">ƒ∞mzanƒ± √áiz</span></h2>
    <span data-i="sig_draw_sub">Parmak veya mouse ile</span>
  </div>
  <div class="mtb">
    <span style="font-size:.66rem;color:var(--muted)" data-i="lbl_color">Renk:</span>
    <div class="cdot active" data-c="#111111" style="background:#111111" title="Siyah"></div>
    <div class="cdot" data-c="#1a3a8f" style="background:#1a3a8f" title="Lacivert"></div>
    <div class="cdot" data-c="#1565C0" style="background:#1565C0" title="M√ºrekkep Mavi"></div>
    <div class="cdot" data-c="#8a1414" style="background:#8a1414" title="Kƒ±rmƒ±zƒ±"></div>
    <div class="divv"></div>
    <span style="font-size:.66rem;color:var(--muted)" data-i="lbl_thickness">Kalƒ±nlƒ±k:</span>
    <button class="tb" data-w="2" data-i="w_thin">ƒ∞nce</button>
    <button class="tb active" data-w="3" data-i="w_mid">Orta</button>
    <button class="tb" data-w="5" data-i="w_thick">Kalƒ±n</button>
    <div class="divv"></div>
    <button class="tb" id="clearSigCvs" data-i="btn_clear">üóë Temizle</button>
  </div>
  <div class="sig-wrap">
    <canvas id="sigCanvas"></canvas>
    <div class="sig-hint" id="sigHint" data-i="sig_hint">‚úçÔ∏è Buraya imzanƒ± √ßiz</div>
  </div>
  <div class="mf">
    <button class="mf-btn mf-cancel" id="cancelSig" data-i="btn_cancel">ƒ∞ptal</button>
    <button class="mf-btn mf-apply" id="applySig" data-i="btn_place_sig">‚úì ƒ∞mzayƒ± Yerle≈ütir</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê PROGRESS ‚ïê‚ïê‚ïê -->
<div class="prog-back" id="progBack">
  <div class="prog-card">
    <h3 id="progTitle">ƒ∞≈üleniyor‚Ä¶</h3>
    <div class="prog-track"><div class="prog-fill" id="progFill"></div></div>
    <div class="prog-note" id="progNote">L√ºtfen bekleyin</div>
  </div>
</div>
<div class="toast" id="toast"></div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   i18n
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const STRINGS = {
  tr:{
    nav_photo:'Foto ‚Üí PDF', nav_merge:'Birle≈ütir', nav_sign:'ƒ∞mzala',
    lbl_page:'Sayfa', lbl_orient:'Y√∂n', lbl_margin:'Kenar',
    lbl_quality:'Kalite:', lbl_ratio:'Oran:', lbl_color:'Renk:', lbl_thickness:'Kalƒ±nlƒ±k:',
    opt_square:'Kare', opt_auto:'Otomatik', opt_portrait:'Dikey', opt_landscape:'Yatay', opt_none:'Kenarsƒ±z', opt_free:'Serbest',
    dz_photo_h:'Fotoƒüraf Ekle', dz_photo_p:'Tƒ±kla veya s√ºr√ºkle ¬∑ JPG, PNG, WebP',
    dz_merge_h:'PDF Dosyalarƒ± Ekle', dz_merge_p:'Birle≈ütirmek istediƒüin PDF\'leri se√ß ¬∑ Sƒ±rala',
    empty_photo:'üìÇ Hen√ºz fotoƒüraf eklenmedi.', empty_merge:'üìÇ Hen√ºz PDF eklenmedi.',
    btn_create_pdf:'üìÑ PDF Olu≈ütur', btn_merge:'üîó Birle≈ütir ve ƒ∞ndir',
    sign_pick_title:'ƒ∞mzalamak istediƒüin dosyayƒ± se√ß', sign_pick_sub:'PDF veya fotoƒüraf desteklenir',
    btn_open_pdf:'PDF A√ß', btn_open_img:'Fotoƒüraf A√ß', lbl_page_count:'sayfa', lbl_photo_short:'Foto',
    btn_sign:'‚úçÔ∏è ƒ∞mza √áiz', btn_dl_signed:'üìÑ ƒ∞ndir',
    crop_title:'D√ºzenle / Kƒ±rp', btn_cancel:'ƒ∞ptal', btn_reset:'Sƒ±fƒ±rla', btn_apply:'‚úì Uygula',
    sig_draw_title:'ƒ∞mzanƒ± √áiz', sig_draw_sub:'Parmak veya mouse ile',
    w_thin:'ƒ∞nce', w_mid:'Orta', w_thick:'Kalƒ±n', btn_clear:'üóë Temizle',
    btn_place_sig:'‚úì ƒ∞mzayƒ± Yerle≈ütir', sig_hint:'‚úçÔ∏è Buraya imzanƒ± √ßiz',
    pill_photo:'Foto:', prog_creating:'PDF Olu≈üturuluyor‚Ä¶', prog_merging:'Birle≈ütiriliyor‚Ä¶',
    prog_loading_pdf:'PDF Y√ºkleniyor‚Ä¶', prog_loading_img:'G√∂rsel Y√ºkleniyor‚Ä¶',
    prog_signing:'ƒ∞mzalƒ± PDF Hazƒ±rlanƒ±yor‚Ä¶', prog_signing_img:'ƒ∞mzalƒ± G√∂rsel Hazƒ±rlanƒ±yor‚Ä¶',
    toast_pdf_done:'‚úÖ PDF olu≈üturuldu!', toast_merge_done:'‚úÖ PDF birle≈ütirildi!',
    toast_sign_done:'‚úÖ ƒ∞mzalƒ± PDF indirildi!', toast_sign_img_done:'‚úÖ ƒ∞mzalƒ± g√∂rsel indirildi!',
    toast_placed:'‚úÖ ƒ∞mza eklendi ‚Äî s√ºr√ºkle & k√∂≈üeden boyutlandƒ±r',
    toast_photo_loaded:'Fotoƒüraf y√ºklendi ‚Äî imzanƒ± √ßiz',
    toast_crop_done:'‚úÖ D√ºzenleme uygulandƒ±',
    toast_sigs_cleared:'ƒ∞mzalar temizlendi',
    toast_no_sig:'‚ö†Ô∏è √ñnce imzanƒ± √ßiz!',
    toast_no_placed:'‚ö†Ô∏è Hen√ºz imza eklemedin',
    toast_confirm_clear_photos:'T√ºm fotoƒüraflar silinsin mi?',
    toast_confirm_clear_merge:'Liste temizlensin mi?',
    toast_pdf_unreadable:'‚ùå PDF okunamadƒ±',
    toast_pdf_err:'‚ùå PDF y√ºklenemedi',
    toast_img_err:'‚ùå G√∂rsel y√ºklenemedi',
    toast_err:'‚ùå Hata: ',
    sig_image_mode:'g√∂rsel',
  },
  en:{
    nav_photo:'Photo‚ÜíPDF', nav_merge:'Merge', nav_sign:'Sign',
    lbl_page:'Page', lbl_orient:'Orient', lbl_margin:'Margin',
    lbl_quality:'Quality:', lbl_ratio:'Ratio:', lbl_color:'Color:', lbl_thickness:'Size:',
    opt_square:'Square', opt_auto:'Auto', opt_portrait:'Portrait', opt_landscape:'Landscape', opt_none:'Borderless', opt_free:'Free',
    dz_photo_h:'Add Photos', dz_photo_p:'Tap or drag here ¬∑ JPG, PNG, WebP',
    dz_merge_h:'Add PDF Files', dz_merge_p:'Select PDFs to merge ¬∑ Drag to sort',
    empty_photo:'üìÇ No photos added yet.', empty_merge:'üìÇ No PDFs added yet.',
    btn_create_pdf:'üìÑ Create PDF', btn_merge:'üîó Merge & Download',
    sign_pick_title:'Select a file to sign', sign_pick_sub:'PDF or photo supported',
    btn_open_pdf:'Open PDF', btn_open_img:'Open Photo', lbl_page_count:'pages', lbl_photo_short:'Photo',
    btn_sign:'‚úçÔ∏è Draw Signature', btn_dl_signed:'üìÑ Download',
    crop_title:'Edit / Crop', btn_cancel:'Cancel', btn_reset:'Reset', btn_apply:'‚úì Apply',
    sig_draw_title:'Draw Your Signature', sig_draw_sub:'Finger or mouse',
    w_thin:'Thin', w_mid:'Medium', w_thick:'Thick', btn_clear:'üóë Clear',
    btn_place_sig:'‚úì Place Signature', sig_hint:'‚úçÔ∏è Draw here',
    pill_photo:'Photos:', prog_creating:'Creating PDF‚Ä¶', prog_merging:'Merging‚Ä¶',
    prog_loading_pdf:'Loading PDF‚Ä¶', prog_loading_img:'Loading Image‚Ä¶',
    prog_signing:'Creating Signed PDF‚Ä¶', prog_signing_img:'Creating Signed Image‚Ä¶',
    toast_pdf_done:'‚úÖ PDF created!', toast_merge_done:'‚úÖ PDFs merged!',
    toast_sign_done:'‚úÖ Signed PDF downloaded!', toast_sign_img_done:'‚úÖ Signed image downloaded!',
    toast_placed:'‚úÖ Signature placed ‚Äî drag & resize from corner',
    toast_photo_loaded:'Photo loaded ‚Äî draw your signature',
    toast_crop_done:'‚úÖ Edit applied',
    toast_sigs_cleared:'Signatures cleared',
    toast_no_sig:'‚ö†Ô∏è Draw your signature first!',
    toast_no_placed:'‚ö†Ô∏è No signature added yet',
    toast_confirm_clear_photos:'Delete all photos?',
    toast_confirm_clear_merge:'Clear the list?',
    toast_pdf_unreadable:'‚ùå Could not read PDF',
    toast_pdf_err:'‚ùå Could not load PDF',
    toast_img_err:'‚ùå Could not load image',
    toast_err:'‚ùå Error: ',
    sig_image_mode:'image',
  }
};

let lang = 'tr';

function t(key){ return STRINGS[lang][key] || STRINGS.tr[key] || key; }

function applyLang(){
  document.querySelectorAll('[data-i]').forEach(el=>{
    const k=el.dataset.i;
    if(k) el.textContent=t(k);
  });
  document.getElementById('countPill').innerHTML = t('pill_photo')+' <b>'+photoCount()+'</b>';
  document.getElementById('langTR').classList.toggle('active', lang==='tr');
  document.getElementById('langEN').classList.toggle('active', lang==='en');
}

function setLang(l){
  lang=l;
  localStorage.setItem('ptpLang',l);
  applyLang();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   GLOBALS & HELPERS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const {jsPDF} = window.jspdf;
pdfjsLib.GlobalWorkerOptions.workerSrc =
  'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

let _toastT;
function toast(msg,ms=2800){
  const el=document.getElementById('toast');
  el.textContent=msg;el.classList.add('show');
  clearTimeout(_toastT);_toastT=setTimeout(()=>el.classList.remove('show'),ms);
}
function showProg(txt){
  document.getElementById('progTitle').textContent=txt;
  document.getElementById('progFill').style.width='0%';
  document.getElementById('progNote').textContent='‚Ä¶';
  document.getElementById('progBack').classList.add('open');
}
function setProg(p,n){
  document.getElementById('progFill').style.width=p+'%';
  if(n)document.getElementById('progNote').textContent=n;
}
function hideProg(){document.getElementById('progBack').classList.remove('open')}
function dlBytes(b,n){
  const u=URL.createObjectURL(new Blob([b],{type:'application/pdf'}));
  const a=document.createElement('a');a.href=u;a.download=n;a.click();
  setTimeout(()=>URL.revokeObjectURL(u),5000);
}
function dlDataUrl(du,n){const a=document.createElement('a');a.href=du;a.download=n;a.click()}
function photoCount(){return document.querySelectorAll('#photo-list .pi').length}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   NAVIGATION + ANDROID BACK
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const MODALS=['cropModal','sigModal'];
let curTab='photo';

history.replaceState({k:'tab',v:'photo'},'');
function pushHist(k,v){history.pushState({k,v},'')}
function switchTab(id,push=true){
  curTab=id;
  if(push)pushHist('tab',id);
  document.querySelectorAll('.nc').forEach(n=>n.classList.toggle('active',n.dataset.tab===id));
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.toggle('active',p.id==='tab-'+id));
}
function openModal(id){pushHist('modal',id);document.getElementById(id).classList.add('open')}
function closeModal(id){document.getElementById(id).classList.remove('open')}

window.addEventListener('popstate',e=>{
  const s=e.state;
  for(const id of MODALS){
    const m=document.getElementById(id);
    if(m.classList.contains('open')){
      if(id==='cropModal')_closeCrop(false);
      else closeModal(id);
      return;
    }
  }
  if(s&&s.k==='tab')switchTab(s.v,false);
  else switchTab('photo',false);
});

document.querySelectorAll('.nc').forEach(n=>{
  n.addEventListener('click',()=>switchTab(n.dataset.tab));
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   TAB 1 ‚Äì PHOTO ‚Üí PDF
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const photoList=document.getElementById('photo-list');
const photoEmpty=document.getElementById('photoEmpty');
const photoPdfBtn=document.getElementById('photoPdfBtn');
const photoClearBtn=document.getElementById('photoClearBtn');

document.getElementById('qrange').addEventListener('input',function(){
  document.getElementById('qval').textContent=this.value+'%';
});

[document.getElementById('photoIn'),document.getElementById('photoIn2')]
  .forEach(i=>i.addEventListener('change',e=>{loadPhotos(e.target.files);e.target.value=''}));

const photoDZ=document.getElementById('photoDZ');
photoDZ.addEventListener('dragover',e=>{e.preventDefault();photoDZ.classList.add('hover')});
photoDZ.addEventListener('dragleave',()=>photoDZ.classList.remove('hover'));
photoDZ.addEventListener('drop',e=>{e.preventDefault();photoDZ.classList.remove('hover');loadPhotos(e.dataTransfer.files)});

new Sortable(photoList,{
  animation:180,handle:'.pi-handle',ghostClass:'sg',chosenClass:'sc2',
  filter:'.empty',touchStartThreshold:4,
  onEnd:()=>photoList.querySelectorAll('.pi .pi-num').forEach((b,i)=>b.textContent=i+1)
});

function loadPhotos(files){
  Array.from(files).filter(f=>f.type.startsWith('image/')).forEach(f=>{
    const r=new FileReader();r.onload=e=>addPhotoCard(e.target.result);r.readAsDataURL(f);
  });
}

function addPhotoCard(src){
  photoEmpty.style.display='none';
  const d=document.createElement('div');d.className='pi';
  const handle=document.createElement('div');handle.className='pi-handle';handle.textContent='‚†ø ‚†ø ‚†ø';
  const img=document.createElement('img');img.src=src;img.draggable=false;
  const bar=document.createElement('div');bar.className='pi-bar';
  const num=document.createElement('span');num.className='pi-num';

  const editB=document.createElement('button');editB.className='ib edit';editB.textContent='‚úèÔ∏è';
  editB.addEventListener('click',e=>{e.stopPropagation();openCrop(d)});

  const signB=document.createElement('button');signB.className='ib sign';signB.textContent='‚úçÔ∏è';
  signB.addEventListener('click',e=>{e.stopPropagation();openPhotoSignFlow(d)});

  const delB=document.createElement('button');delB.className='ib del';delB.textContent='üóë';
  delB.addEventListener('click',e=>{
    e.stopPropagation();d.remove();
    photoList.querySelectorAll('.pi .pi-num').forEach((b,i)=>b.textContent=i+1);
    updatePhotoState();
  });

  bar.append(num,editB,signB,delB);
  d.append(handle,img,bar);
  photoList.appendChild(d);
  photoList.querySelectorAll('.pi .pi-num').forEach((b,i)=>b.textContent=i+1);
  updatePhotoState();
}

function updatePhotoState(){
  const n=photoCount();
  document.getElementById('countPill').innerHTML=t('pill_photo')+' <b>'+n+'</b>';
  photoPdfBtn.disabled=n===0;photoClearBtn.disabled=n===0;
  if(n===0)photoEmpty.style.display='';
}

photoClearBtn.addEventListener('click',()=>{
  if(!confirm(t('toast_confirm_clear_photos')))return;
  photoList.querySelectorAll('.pi').forEach(el=>el.remove());updatePhotoState();
});

const PAGE_SIZES={a4:[210,297],a5:[148,210],letter:[215.9,279.4],square:[150,150]};
photoPdfBtn.addEventListener('click',async()=>{
  const items=Array.from(photoList.querySelectorAll('.pi'));if(!items.length)return;
  const [pw0,ph0]=PAGE_SIZES[document.getElementById('pageSize').value];
  const ori0=document.getElementById('orientation').value;
  const marg=parseInt(document.getElementById('margin').value);
  const qual=parseInt(document.getElementById('qrange').value)/100;
  showProg(t('prog_creating'));photoPdfBtn.disabled=true;
  let doc=null;
  for(let i=0;i<items.length;i++){
    const img=items[i].querySelector('img');
    let ori='portrait';
    if(ori0==='landscape')ori='landscape';
    else if(ori0==='auto'&&img.naturalWidth>img.naturalHeight)ori='landscape';
    const pw=ori==='landscape'?ph0:pw0,ph=ori==='landscape'?pw0:ph0;
    if(!doc)doc=new jsPDF({orientation:ori,unit:'mm',format:[pw,ph]});
    else doc.addPage([pw,ph],ori);
    const avW=pw-marg*2,avH=ph-marg*2,rat=img.naturalWidth/img.naturalHeight;
    let dw=avW,dh=dw/rat;if(dh>avH){dh=avH;dw=dh*rat}
    const c=document.createElement('canvas');c.width=img.naturalWidth;c.height=img.naturalHeight;
    c.getContext('2d').drawImage(img,0,0);
    doc.addImage(c.toDataURL('image/jpeg',qual),'JPEG',(pw-dw)/2,(ph-dh)/2,dw,dh);
    setProg(Math.round((i+1)/items.length*100),`${i+1} / ${items.length}`);
    await new Promise(r=>setTimeout(r,12));
  }
  doc.save(`photo-to-pdf-${Date.now()}.pdf`);
  hideProg();photoPdfBtn.disabled=false;toast(t('toast_pdf_done'));
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CROP MODAL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let _cropper=null,_cropItem=null,_origSrc=null,_sx=1,_sy=1;

function openCrop(item){
  _cropItem=item;_sx=1;_sy=1;
  const img=item.querySelector('img');_origSrc=img.src;
  const ci=document.getElementById('cropImg');ci.src=img.src;
  const idx=Array.from(photoList.querySelectorAll('.pi')).indexOf(item);
  document.getElementById('cropIdx').textContent='#'+(idx+1);
  document.querySelectorAll('[data-ratio]').forEach(b=>b.classList.remove('active'));
  document.querySelector('[data-ratio="free"]').classList.add('active');
  openModal('cropModal');
  ci.onload=()=>{
    if(_cropper){_cropper.destroy();_cropper=null}
    _cropper=new Cropper(ci,{viewMode:1,autoCropArea:.88,movable:true,scalable:true,zoomable:true,background:true,responsive:true});
  };
  if(ci.complete)ci.onload();
}
function _closeCrop(goBack=true){
  if(_cropper){_cropper.destroy();_cropper=null}
  closeModal('cropModal');_cropItem=null;
  if(goBack)history.back();
}
document.getElementById('cancelCrop').addEventListener('click',()=>_closeCrop());
document.getElementById('resetCrop').addEventListener('click',()=>{
  _sx=1;_sy=1;const ci=document.getElementById('cropImg');ci.src=_origSrc;
  ci.onload=()=>{if(_cropper){_cropper.destroy();_cropper=null}
    _cropper=new Cropper(ci,{viewMode:1,autoCropArea:.88,movable:true,scalable:true,zoomable:true,background:true,responsive:true});
  };if(ci.complete)ci.onload();
});
document.getElementById('applyCrop').addEventListener('click',()=>{
  if(!_cropper||!_cropItem)return;
  const c=_cropper.getCroppedCanvas({maxWidth:2400,maxHeight:2400,imageSmoothingQuality:'high'});
  if(!c)return;
  _cropItem.querySelector('img').src=c.toDataURL('image/jpeg',.94);
  _closeCrop();toast(t('toast_crop_done'));
});
document.querySelectorAll('[data-ratio]').forEach(b=>b.addEventListener('click',()=>{
  document.querySelectorAll('[data-ratio]').forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
  _cropper?.setAspectRatio(b.dataset.ratio==='free'?NaN:parseFloat(b.dataset.ratio));
}));
document.getElementById('rotL').addEventListener('click',()=>_cropper?.rotate(-90));
document.getElementById('rotR').addEventListener('click',()=>_cropper?.rotate(90));
document.getElementById('flipH').addEventListener('click',()=>{_sx*=-1;_cropper?.scaleX(_sx)});
document.getElementById('flipV').addEventListener('click',()=>{_sy*=-1;_cropper?.scaleY(_sy)});
document.getElementById('zIn').addEventListener('click',()=>_cropper?.zoom(.1));
document.getElementById('zOut').addEventListener('click',()=>_cropper?.zoom(-.1));

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   TAB 2 ‚Äì MERGE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const mergeListEl=document.getElementById('mergeList');
let mergeFiles=[];

new Sortable(mergeListEl,{animation:180,ghostClass:'sg',chosenClass:'sc2',filter:'.empty'});

[document.getElementById('mergeIn'),document.getElementById('mergeIn2')]
  .forEach(i=>i.addEventListener('change',e=>{loadMerge(e.target.files);e.target.value=''}));

const mergeDZ=document.getElementById('mergeDZ');
mergeDZ.addEventListener('dragover',e=>{e.preventDefault();mergeDZ.classList.add('hover')});
mergeDZ.addEventListener('dragleave',()=>mergeDZ.classList.remove('hover'));
mergeDZ.addEventListener('drop',e=>{e.preventDefault();mergeDZ.classList.remove('hover');loadMerge(e.dataTransfer.files)});

async function loadMerge(files){
  for(const f of Array.from(files).filter(f=>f.name.toLowerCase().endsWith('.pdf')||f.type==='application/pdf')){
    try{
      const ab=await f.arrayBuffer();
      const pdf=await PDFLib.PDFDocument.load(ab,{ignoreEncryption:true});
      const data={name:f.name,pages:pdf.getPageCount(),ab};
      mergeFiles.push(data);addMergeItem(data);
    }catch(e){toast(t('toast_pdf_unreadable')+': '+f.name)}
  }
  updateMergeState();
}
function addMergeItem(data){
  document.getElementById('mergeEmpty').style.display='none';
  const d=document.createElement('div');d.className='mi';
  d.innerHTML=`<span class="mi-drag">‚†ø</span>
    <div class="mi-info">
      <div class="mi-name" title="${data.name}">${data.name}</div>
      <div class="mi-pages">${data.pages} ${t('lbl_page_count')}</div>
    </div>
    <button class="mi-del">‚úï</button>`;
  d.querySelector('.mi-del').addEventListener('click',()=>{
    const i=mergeFiles.indexOf(data);if(i>-1)mergeFiles.splice(i,1);
    d.remove();updateMergeState();
  });
  mergeListEl.appendChild(d);
}
function updateMergeState(){
  const n=mergeFiles.length;
  document.getElementById('mergePdfBtn').disabled=n<2;
  document.getElementById('mergeClearBtn').disabled=n===0;
  if(n===0)document.getElementById('mergeEmpty').style.display='';
}
document.getElementById('mergeClearBtn').addEventListener('click',()=>{
  if(!confirm(t('toast_confirm_clear_merge')))return;
  mergeFiles=[];mergeListEl.querySelectorAll('.mi').forEach(el=>el.remove());updateMergeState();
});
document.getElementById('mergePdfBtn').addEventListener('click',async()=>{
  if(mergeFiles.length<2)return;
  showProg(t('prog_merging'));document.getElementById('mergePdfBtn').disabled=true;
  try{
    const merged=await PDFLib.PDFDocument.create();
    const domOrder=Array.from(mergeListEl.querySelectorAll('.mi-name')).map(el=>el.title);
    const ordered=domOrder.map(n=>mergeFiles.find(f=>f.name===n)).filter(Boolean);
    const src=ordered.length===mergeFiles.length?ordered:mergeFiles;
    for(let i=0;i<src.length;i++){
      const pdf=await PDFLib.PDFDocument.load(src[i].ab,{ignoreEncryption:true});
      const pages=await merged.copyPages(pdf,pdf.getPageIndices());
      pages.forEach(p=>merged.addPage(p));
      setProg(Math.round((i+1)/src.length*100),`${i+1} / ${src.length}`);
      await new Promise(r=>setTimeout(r,8));
    }
    dlBytes(await merged.save(),`merged-${Date.now()}.pdf`);
    toast(t('toast_merge_done'));
  }catch(e){console.error(e);toast(t('toast_err')+e.message)}
  hideProg();document.getElementById('mergePdfBtn').disabled=false;
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   TAB 3 ‚Äì SIGN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let signDoc=null,signBytes=null,signPage=1,signPageCount=0,signPageScale=1;
let placedSigs=[],isImageMode=false,signImgNaturalW=0,signImgNaturalH=0;

[document.getElementById('signPdfIn'),document.getElementById('signPdfIn2')]
  .forEach(i=>i.addEventListener('change',e=>{if(e.target.files[0])loadSignPdf(e.target.files[0]);e.target.value=''}));
[document.getElementById('signImgIn'),document.getElementById('signImgIn2')]
  .forEach(i=>i.addEventListener('change',e=>{if(e.target.files[0])loadSignImg(e.target.files[0]);e.target.value=''}));

async function loadSignPdf(file){
  showProg(t('prog_loading_pdf'));
  try{
    const ab=await file.arrayBuffer();
    signBytes=ab;isImageMode=false;
    signDoc=await pdfjsLib.getDocument({data:ab.slice(0)}).promise;
    signPageCount=signDoc.numPages;
    placedSigs=[];signPage=1;
    document.getElementById('signFname').textContent=file.name.slice(0,32);
    document.getElementById('signPcount').textContent=signPageCount;
    document.getElementById('signPlabel').textContent=t('lbl_page_count');
    showSignLoaded();
    await buildThumbs();
    await renderSignPage(1);
  }catch(e){console.error(e);toast(t('toast_pdf_err'))}
  hideProg();
}

async function loadSignImg(file){
  showProg(t('prog_loading_img'));
  try{
    const url=URL.createObjectURL(file);
    await new Promise((res,rej)=>{
      const img=new Image();
      img.onload=()=>{
        isImageMode=true;signDoc=null;signBytes=null;
        signPageCount=1;placedSigs=[];signPage=1;
        signImgNaturalW=img.width;signImgNaturalH=img.height;
        document.getElementById('signFname').textContent=file.name.slice(0,32);
        document.getElementById('signPcount').textContent='1';
        document.getElementById('signPlabel').textContent=t('sig_image_mode');
        showSignLoaded();
        const thumbs=document.getElementById('signThumbs');thumbs.innerHTML='';
        const tw=document.createElement('div');tw.className='tw active';
        const tc=document.createElement('canvas');
        const ts=Math.min(68/img.width,1);
        tc.width=Math.round(img.width*ts);tc.height=Math.round(img.height*ts);
        tc.getContext('2d').drawImage(img,0,0,tc.width,tc.height);
        const tn=document.createElement('div');tn.className='tn';tn.textContent='1';
        tw.append(tc,tn);thumbs.appendChild(tw);
        const area=document.getElementById('signPreview');
        const maxW=Math.max(area.clientWidth-36,180);
        const scale=Math.min(maxW/img.width,1.8);
        signPageScale=scale;
        const c=document.getElementById('mainCanvas');
        c.width=Math.round(img.width*scale);c.height=Math.round(img.height*scale);
        c.getContext('2d').drawImage(img,0,0,c.width,c.height);
        URL.revokeObjectURL(url);res();
      };
      img.onerror=rej;img.src=url;
    });
  }catch(e){console.error(e);toast(t('toast_img_err'))}
  hideProg();
}

function showSignLoaded(){
  document.getElementById('signEmpty').style.display='none';
  document.getElementById('signLoaded').style.display='flex';
  document.getElementById('signAbar').style.display='flex';
}

async function buildThumbs(){
  const ct=document.getElementById('signThumbs');ct.innerHTML='';
  for(let p=1;p<=signPageCount;p++){
    const tw=document.createElement('div');tw.className='tw';tw.dataset.p=p;
    const c=document.createElement('canvas');
    const tn=document.createElement('div');tn.className='tn';tn.textContent=p;
    tw.append(c,tn);
    tw.addEventListener('click',()=>renderSignPage(p));
    ct.appendChild(tw);
    const pg=await signDoc.getPage(p);
    const vp=pg.getViewport({scale:.26});
    c.width=vp.width;c.height=vp.height;
    await pg.render({canvasContext:c.getContext('2d'),viewport:vp}).promise;
  }
  updateThumbActive();
}

function updateThumbActive(){
  document.querySelectorAll('.tw').forEach(w=>w.classList.toggle('active',parseInt(w.dataset.p||1)===signPage));
}

async function renderSignPage(p){
  signPage=p;updateThumbActive();
  document.querySelectorAll('.sov').forEach(el=>el.remove());
  const pg=await signDoc.getPage(p);
  const area=document.getElementById('signPreview');
  const maxW=Math.max(area.clientWidth-36,180);
  const vp0=pg.getViewport({scale:1});
  const scale=Math.min(maxW/vp0.width,1.8);
  signPageScale=scale;
  const vp=pg.getViewport({scale});
  const c=document.getElementById('mainCanvas');
  c.width=vp.width;c.height=vp.height;
  await pg.render({canvasContext:c.getContext('2d'),viewport:vp}).promise;
  placedSigs.filter(s=>s.page===p).forEach(s=>buildSigOverlay(s));
}

/* ‚îÄ‚îÄ‚îÄ Overlay placement ‚îÄ‚îÄ‚îÄ */
function placeSig(dataUrl){
  const c=document.getElementById('mainCanvas');
  const w=Math.round(c.width*.4),h=Math.round(w*.3);
  const s={page:signPage,x:Math.round((c.width-w)/2),y:Math.round((c.height-h)/2),w,h,dataUrl};
  placedSigs.push(s);
  buildSigOverlay(s);
}

/* ‚îÄ‚îÄ‚îÄ buildSigOverlay: pointer-event‚Äìaware drag & resize ‚îÄ‚îÄ‚îÄ */
function buildSigOverlay(s){
  const wrap=document.getElementById('ppw');
  const el=document.createElement('div');
  el.className='sov';
  el.style.cssText=`left:${s.x}px;top:${s.y}px;width:${s.w}px;height:${s.h}px`;

  const img=document.createElement('img');img.src=s.dataUrl;

  // Delete button
  const del=document.createElement('button');del.className='sov-del';del.textContent='‚úï';
  del.addEventListener('pointerdown',e=>{e.stopPropagation()});
  del.addEventListener('click',e=>{
    e.stopPropagation();el.remove();
    const i=placedSigs.indexOf(s);if(i>-1)placedSigs.splice(i,1);
  });

  // Resize handle
  const rz=document.createElement('div');rz.className='sov-rz';rz.textContent='‚á≤';

  el.append(img,del,rz);
  wrap.appendChild(el);

  // ‚îÄ‚îÄ Drag (pointer events on element, blocked by del/rz) ‚îÄ‚îÄ
  let dragActive=false,dStartX,dStartY,dOrigX,dOrigY;

  el.addEventListener('pointerdown',e=>{
    // skip if clicking del or rz
    if(e.target===del||e.target===rz)return;
    e.preventDefault();e.stopPropagation();
    dragActive=true;
    el.setPointerCapture(e.pointerId);
    dStartX=e.clientX;dStartY=e.clientY;
    dOrigX=s.x;dOrigY=s.y;
  });

  el.addEventListener('pointermove',e=>{
    if(!dragActive)return;
    e.preventDefault();
    const c=document.getElementById('mainCanvas');
    s.x=Math.max(0,Math.min(dOrigX+(e.clientX-dStartX), c.width-s.w));
    s.y=Math.max(0,Math.min(dOrigY+(e.clientY-dStartY), c.height-s.h));
    el.style.left=s.x+'px';
    el.style.top=s.y+'px';
  });

  el.addEventListener('pointerup',e=>{dragActive=false});
  el.addEventListener('pointercancel',e=>{dragActive=false});

  // ‚îÄ‚îÄ Resize (pointer on rz handle) ‚îÄ‚îÄ
  let rzActive=false,rzStartX,rzStartY,rzOrigW,rzOrigH;

  rz.addEventListener('pointerdown',e=>{
    e.preventDefault();e.stopPropagation();
    rzActive=true;
    rz.setPointerCapture(e.pointerId);
    rzStartX=e.clientX;rzStartY=e.clientY;
    rzOrigW=s.w;rzOrigH=s.h;
  });

  rz.addEventListener('pointermove',e=>{
    if(!rzActive)return;
    e.preventDefault();
    s.w=Math.max(40,rzOrigW+(e.clientX-rzStartX));
    s.h=Math.max(18,rzOrigH+(e.clientY-rzStartY));
    el.style.width=s.w+'px';
    el.style.height=s.h+'px';
  });

  rz.addEventListener('pointerup',()=>rzActive=false);
  rz.addEventListener('pointercancel',()=>rzActive=false);
}

document.getElementById('clearSigsBtn').addEventListener('click',()=>{
  placedSigs=placedSigs.filter(s=>s.page!==signPage);
  document.querySelectorAll('.sov').forEach(el=>el.remove());
  toast(t('toast_sigs_cleared'));
});

/* ‚îÄ‚îÄ‚îÄ Download signed ‚îÄ‚îÄ‚îÄ */
document.getElementById('dlSignedBtn').addEventListener('click',async()=>{
  if(!placedSigs.length){toast(t('toast_no_placed'));return}

  if(isImageMode){
    showProg(t('prog_signing_img'));
    const c2=document.getElementById('mainCanvas');
    const out=document.createElement('canvas');
    out.width=signImgNaturalW;out.height=signImgNaturalH;
    const ctx=out.getContext('2d');
    ctx.drawImage(c2,0,0,signImgNaturalW,signImgNaturalH);
    for(const s of placedSigs){
      const si=new Image();
      await new Promise(res=>{si.onload=res;si.src=s.dataUrl});
      const fx=signImgNaturalW/c2.width,fy=signImgNaturalH/c2.height;
      ctx.drawImage(si,s.x*fx,s.y*fy,s.w*fx,s.h*fy);
    }
    dlDataUrl(out.toDataURL('image/png'),`signed-${Date.now()}.png`);
    hideProg();toast(t('toast_sign_img_done'));
    return;
  }

  if(!signBytes)return;
  showProg(t('prog_signing'));
  try{
    const pdfDoc=await PDFLib.PDFDocument.load(signBytes.slice(0),{ignoreEncryption:true});
    for(let i=0;i<placedSigs.length;i++){
      const s=placedSigs[i];
      const pg=pdfDoc.getPage(s.page-1);
      const{width:pW,height:pH}=pg.getSize();
      const pjsPg=await signDoc.getPage(s.page);
      const vp=pjsPg.getViewport({scale:signPageScale});
      const pdfX=(s.x/vp.width)*pW;
      const pdfY=pH-((s.y+s.h)/vp.height)*pH;
      const pdfW=(s.w/vp.width)*pW;
      const pdfH=(s.h/vp.height)*pH;
      const b64=s.dataUrl.split(',')[1];
      const byt=Uint8Array.from(atob(b64),c=>c.charCodeAt(0));
      const pngImg=await pdfDoc.embedPng(byt);
      pg.drawImage(pngImg,{x:pdfX,y:pdfY,width:pdfW,height:Math.abs(pdfH)});
      setProg(Math.round((i+1)/placedSigs.length*100),`${i+1}/${placedSigs.length}`);
    }
    dlBytes(await pdfDoc.save(),`signed-${Date.now()}.pdf`);
    toast(t('toast_sign_done'));
  }catch(e){console.error(e);toast(t('toast_err')+e.message)}
  hideProg();
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PHOTO ‚Üí SIGN FLOW
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function openPhotoSignFlow(card){
  const imgEl=card.querySelector('img');
  fetch(imgEl.src).then(r=>r.blob()).then(blob=>{
    const file=new File([blob],'photo.jpg',{type:'image/jpeg'});
    switchTab('sign');
    loadSignImg(file);
    toast(t('toast_photo_loaded'));
  });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SIGNATURE DRAW
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let _drawing=false,_sigColor='#111111',_sigW=3;
const sigCvs=document.getElementById('sigCanvas');
const sigCtx=sigCvs.getContext('2d');

function resizeSigCvs(){
  const r=sigCvs.parentElement.getBoundingClientRect();
  // save existing strokes
  const tmp=document.createElement('canvas');
  tmp.width=sigCvs.width||1;tmp.height=sigCvs.height||1;
  tmp.getContext('2d').drawImage(sigCvs,0,0);
  sigCvs.width=Math.max(Math.floor(r.width),100);
  sigCvs.height=Math.max(Math.floor(r.height),100);
  sigCtx.lineCap='round';sigCtx.lineJoin='round';
  sigCtx.drawImage(tmp,0,0);
}

sigCvs.addEventListener('pointerdown',e=>{
  _drawing=true;sigCvs.setPointerCapture(e.pointerId);
  const r=sigCvs.getBoundingClientRect();
  sigCtx.beginPath();sigCtx.moveTo(e.clientX-r.left,e.clientY-r.top);
  sigCtx.strokeStyle=_sigColor;sigCtx.lineWidth=_sigW;
  document.getElementById('sigHint').classList.add('gone');
});
sigCvs.addEventListener('pointermove',e=>{
  if(!_drawing)return;
  const r=sigCvs.getBoundingClientRect();
  sigCtx.lineTo(e.clientX-r.left,e.clientY-r.top);
  sigCtx.stroke();
  sigCtx.beginPath();sigCtx.moveTo(e.clientX-r.left,e.clientY-r.top);
});
sigCvs.addEventListener('pointerup',()=>_drawing=false);
sigCvs.addEventListener('pointercancel',()=>_drawing=false);

document.getElementById('clearSigCvs').addEventListener('click',()=>{
  sigCtx.clearRect(0,0,sigCvs.width,sigCvs.height);
  document.getElementById('sigHint').classList.remove('gone');
});

document.querySelectorAll('.cdot').forEach(d=>{
  d.addEventListener('click',()=>{
    document.querySelectorAll('.cdot').forEach(x=>x.classList.remove('active'));
    d.classList.add('active');_sigColor=d.dataset.c;
  });
});
document.querySelectorAll('[data-w]').forEach(b=>{
  b.addEventListener('click',()=>{
    document.querySelectorAll('[data-w]').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');_sigW=parseInt(b.dataset.w);
  });
});

document.getElementById('drawSigBtn').addEventListener('click',()=>{
  sigCtx.clearRect(0,0,sigCvs.width,sigCvs.height);
  document.getElementById('sigHint').classList.remove('gone');
  openModal('sigModal');
  setTimeout(resizeSigCvs,60);
});

document.getElementById('cancelSig').addEventListener('click',()=>{
  closeModal('sigModal');history.back();
});

document.getElementById('applySig').addEventListener('click',()=>{
  const d=sigCtx.getImageData(0,0,sigCvs.width,sigCvs.height);
  const hasPixels=d.data.some((_,i)=>i%4===3&&d.data[i]>10);
  if(!hasPixels){toast(t('toast_no_sig'));return}
  const cropped=cropSigCvs();
  const dataUrl=cropped.toDataURL('image/png');
  closeModal('sigModal');history.back();
  placeSig(dataUrl);
  toast(t('toast_placed'));
});

function cropSigCvs(){
  const d=sigCtx.getImageData(0,0,sigCvs.width,sigCvs.height);
  let x0=sigCvs.width,y0=sigCvs.height,x1=0,y1=0;
  for(let y=0;y<sigCvs.height;y++)for(let x=0;x<sigCvs.width;x++){
    if(d.data[(y*sigCvs.width+x)*4+3]>8){
      if(x<x0)x0=x;if(x>x1)x1=x;if(y<y0)y0=y;if(y>y1)y1=y;
    }
  }
  const pad=14;
  x0=Math.max(0,x0-pad);y0=Math.max(0,y0-pad);
  x1=Math.min(sigCvs.width,x1+pad);y1=Math.min(sigCvs.height,y1+pad);
  const w=x1-x0||sigCvs.width,h=y1-y0||sigCvs.height;
  const out=document.createElement('canvas');out.width=w;out.height=h;
  out.getContext('2d').putImageData(sigCtx.getImageData(x0,y0,w,h),0,0);
  return out;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   INIT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
lang = localStorage.getItem('ptpLang') || 'tr';
applyLang();
</script>
</body>
</html>

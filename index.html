<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Photo to PDF</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=DM+Sans:wght@400;500&family=Dancing+Script:wght@600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0d0d11;--surf:#16161e;--surf2:#1e1e28;--surf3:#252530;
  --acc:#f5c842;--acc2:#f07840;--green:#3db87a;--red:#e05252;
  --blue:#2563eb;--teal:#059669;--purple:#7c3aed;
  --text:#edeae2;--muted:#6a6a7e;--border:#252530;
  --ease:cubic-bezier(.4,0,.2,1);
}
html,body{height:100%;overflow:hidden}
body{
  font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);
  display:flex;flex-direction:column;height:100dvh;max-width:100vw;overflow-x:hidden;
}

/* ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ */
header{
  flex-shrink:0;display:flex;align-items:center;justify-content:space-between;
  padding:8px 12px;background:var(--surf);border-bottom:1px solid var(--border);
  gap:8px;min-height:56px;
}
.h-brand{
  display:flex;flex-direction:column;align-items:flex-start;gap:0;flex-shrink:0;
}
.h-title{
  font-family:'Syne',sans-serif;font-weight:800;font-size:1rem;
  color:var(--text);letter-spacing:-.2px;line-height:1.1;
}
.h-title span{color:var(--acc)}
.h-sig{
  font-family:'Dancing Script',cursive;font-weight:600;font-size:.88rem;
  background:linear-gradient(120deg,#f5c842,#e8920a);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
  filter:drop-shadow(0 0 6px rgba(245,200,66,.4));
  letter-spacing:.5px;line-height:1.2;margin-top:-1px;
}
.h-right{display:flex;align-items:center;gap:6px;flex-shrink:0}
.lang-btn{
  background:var(--surf2);border:1px solid var(--border);
  color:var(--muted);font-family:'Syne',sans-serif;font-weight:700;font-size:.66rem;
  padding:4px 7px;border-radius:7px;cursor:pointer;
  touch-action:manipulation;transition:all .15s;flex-shrink:0;
}
.lang-btn.active{background:var(--acc);border-color:var(--acc);color:#111}
.hpill{
  background:var(--surf2);border:1px solid var(--border);
  padding:4px 10px;border-radius:999px;font-size:.7rem;color:var(--muted);white-space:nowrap;
}
.hpill b{color:var(--acc)}

/* ‚îÄ‚îÄ‚îÄ NAV CARDS ‚îÄ‚îÄ‚îÄ */
.nav-cards{
  flex-shrink:0;display:grid;grid-template-columns:repeat(3,1fr);gap:7px;
  padding:9px 10px;
}
.nc{
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:3px;padding:11px 3px;border-radius:12px;border:2px solid transparent;
  cursor:pointer;font-family:'Syne',sans-serif;font-weight:700;font-size:.69rem;
  text-align:center;line-height:1.2;color:#fff;
  transition:opacity .13s,border-color .13s,transform .1s;
  touch-action:manipulation;-webkit-tap-highlight-color:transparent;user-select:none;
}
.nc:active{transform:scale(.93)}
.nc.active{border-color:rgba(255,255,255,.5);box-shadow:0 3px 14px rgba(0,0,0,.4)}
.nc:not(.active){opacity:.5}
.nc-icon{font-size:1.3rem;line-height:1}
.nc.c1{background:linear-gradient(135deg,#1d4ed8,#2563eb)}
.nc.c2{background:linear-gradient(135deg,#047857,#059669)}
.nc.c3{background:linear-gradient(135deg,#6d28d9,#7c3aed)}

/* ‚îÄ‚îÄ‚îÄ TAB PANELS ‚îÄ‚îÄ‚îÄ */
.tab-panel{display:none;flex:1;flex-direction:column;overflow:hidden;min-height:0;min-width:0}
.tab-panel.active{display:flex}
.scroll{
  flex:1;overflow-y:auto;overflow-x:hidden;
  -webkit-overflow-scrolling:touch;padding:10px;
}

/* ‚îÄ‚îÄ‚îÄ SETTINGS BAR ‚îÄ‚îÄ‚îÄ */
.sbar{
  flex-shrink:0;display:flex;gap:8px;padding:7px 10px;
  background:var(--surf);border-bottom:1px solid var(--border);
  overflow-x:auto;scrollbar-width:none;
}
.sbar::-webkit-scrollbar{display:none}
.sc{display:flex;flex-direction:column;gap:2px;flex-shrink:0}
.sc label{font-size:.59rem;color:var(--muted);text-transform:uppercase;letter-spacing:.06em}
select{
  background:var(--surf2);border:1px solid var(--border);color:var(--text);
  border-radius:7px;padding:5px 8px;font-size:.78rem;font-family:inherit;cursor:pointer;outline:none;
}
input[type=range]{accent-color:var(--acc);cursor:pointer;width:80px}
.qval{font-size:.75rem;color:var(--acc);font-weight:700;min-width:28px}

/* ‚îÄ‚îÄ‚îÄ DROP ZONE ‚îÄ‚îÄ‚îÄ */
.dz{
  border:2px dashed var(--border);border-radius:11px;padding:20px 12px;
  text-align:center;background:var(--surf);cursor:pointer;
  transition:border .2s,background .2s;margin-bottom:10px;
  position:relative;
}
.dz:hover,.dz.over{border-color:var(--acc);background:rgba(245,200,66,.04)}
.dz input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
.dz-icon{font-size:1.6rem;margin-bottom:3px}
.dz h3{font-family:'Syne',sans-serif;font-size:.86rem;margin-bottom:2px}
.dz p{font-size:.71rem;color:var(--muted)}

/* ‚îÄ‚îÄ‚îÄ PHOTO GRID ‚îÄ‚îÄ‚îÄ */
#photo-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(115px,1fr));gap:8px}
.pi{
  border-radius:10px;background:var(--surf2);
  display:flex;flex-direction:column;overflow:hidden;
  animation:pop .2s var(--ease);cursor:default;
}
@keyframes pop{from{opacity:0;transform:scale(.88)}to{opacity:1;transform:scale(1)}}
.pi-hnd{
  height:22px;background:rgba(255,255,255,.04);
  display:flex;align-items:center;justify-content:center;
  cursor:grab;color:var(--muted);font-size:.78rem;letter-spacing:3px;
  user-select:none;touch-action:none;
  border-bottom:1px solid rgba(255,255,255,.05);flex-shrink:0;
}
.pi img{width:100%;height:110px;object-fit:cover;display:block;pointer-events:none}
.pi-bar{
  display:flex;align-items:center;padding:4px 5px;gap:3px;
  background:rgba(0,0,0,.3);border-top:1px solid rgba(255,255,255,.05);flex-shrink:0;
}
.pi-num{font-size:.62rem;font-weight:700;color:var(--muted);flex:1;padding-left:1px}
.ib{
  width:34px;height:32px;border-radius:7px;border:none;cursor:pointer;
  font-size:12px;display:flex;align-items:center;justify-content:center;
  touch-action:manipulation;-webkit-tap-highlight-color:transparent;transition:opacity .12s;
}
.ib:active{opacity:.65}
.ib.ed{background:rgba(37,99,235,.25);color:#60a5fa}
.ib.sg{background:rgba(124,58,237,.25);color:#a78bfa}
.ib.dl{background:rgba(224,82,82,.22);color:#f87171}
.ghost{opacity:.2;border:2px dashed var(--acc)}
.chosen{box-shadow:0 6px 24px rgba(0,0,0,.5);z-index:5}

/* ‚îÄ‚îÄ‚îÄ ACTION BAR ‚îÄ‚îÄ‚îÄ */
.abar{
  flex-shrink:0;display:flex;align-items:center;gap:7px;
  padding:9px 10px;background:var(--surf);border-top:2px solid var(--border);
  padding-bottom:calc(9px + env(safe-area-inset-bottom));
}
.abtn-sm{
  width:44px;height:44px;flex-shrink:0;
  border-radius:10px;border:1.5px solid var(--border);
  background:var(--surf2);color:var(--text);
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  font-size:1rem;touch-action:manipulation;transition:opacity .12s;
  position:relative;overflow:hidden;
}
.abtn-sm:disabled{opacity:.3;cursor:not-allowed}
.abtn-sm.red{border-color:var(--red);color:var(--red);background:rgba(224,82,82,.1)}
.abtn-main{
  flex:1;height:44px;min-width:0;
  border-radius:10px;border:none;
  font-family:'Syne',sans-serif;font-weight:700;font-size:.88rem;
  cursor:pointer;display:flex;align-items:center;justify-content:center;gap:5px;
  touch-action:manipulation;transition:opacity .12s;
  -webkit-tap-highlight-color:transparent;white-space:nowrap;overflow:hidden;
}
.abtn-main:disabled{opacity:.3;cursor:not-allowed}
.abtn-main:active{opacity:.8}
.abtn-blue  {background:linear-gradient(135deg,#1d4ed8,#3b82f6);color:#fff}
.abtn-teal  {background:linear-gradient(135deg,#047857,#10b981);color:#fff}
.abtn-purple{background:linear-gradient(135deg,#6d28d9,#8b5cf6);color:#fff}

/* ‚îÄ‚îÄ‚îÄ MERGE LIST ‚îÄ‚îÄ‚îÄ */
.mlist{display:flex;flex-direction:column;gap:8px;margin-bottom:10px}
.mi{
  display:flex;align-items:center;gap:8px;
  background:var(--surf);border:1px solid var(--border);
  border-radius:10px;padding:10px 11px;cursor:grab;animation:pop .2s var(--ease);
}
.mi-drag{color:var(--muted);font-size:.9rem;flex-shrink:0;user-select:none}
.mi-info{flex:1;min-width:0}
.mi-name{font-size:.81rem;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.mi-pages{font-size:.7rem;color:var(--muted);margin-top:1px}
.mi-del{
  background:transparent;border:1px solid var(--border);color:var(--red);
  border-radius:7px;width:30px;height:30px;cursor:pointer;font-size:13px;
  flex-shrink:0;display:flex;align-items:center;justify-content:center;
}

/* ‚îÄ‚îÄ‚îÄ SIGN TAB ‚îÄ‚îÄ‚îÄ */
.sign-empty{
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  flex:1;gap:14px;color:var(--muted);text-align:center;padding:24px;
}
.sign-empty .big{font-size:3rem;opacity:.3}
.sign-empty-row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
.open-btn{
  padding:10px 16px;border-radius:10px;border:1.5px solid var(--border);
  background:var(--surf2);color:var(--text);font-family:'Syne',sans-serif;
  font-weight:700;font-size:.82rem;cursor:pointer;
  display:flex;align-items:center;gap:6px;
  position:relative;overflow:hidden;touch-action:manipulation;
}
.open-btn input{position:absolute;inset:0;opacity:0;cursor:pointer}
.sign-loaded{display:none;flex:1;flex-direction:column;overflow:hidden;min-height:0}
.sign-topbar{
  flex-shrink:0;display:flex;align-items:center;justify-content:space-between;
  padding:6px 12px;background:var(--surf);border-bottom:1px solid var(--border);gap:8px;
}
.sfname{font-size:.76rem;color:var(--muted);flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.sfname b{color:var(--acc)}
.schange{display:flex;gap:5px;flex-shrink:0}
.sch{
  padding:4px 8px;border-radius:7px;border:1px solid var(--border);
  background:var(--surf2);color:var(--muted);font-size:.7rem;cursor:pointer;
  position:relative;overflow:hidden;
}
.sch input{position:absolute;inset:0;opacity:0;cursor:pointer}
.sign-layout{display:flex;flex:1;overflow:hidden;min-height:0}
.sign-thumbs{
  flex-shrink:0;width:78px;overflow-y:auto;overflow-x:hidden;
  background:var(--surf);border-right:1px solid var(--border);
  padding:6px;display:flex;flex-direction:column;gap:5px;
  scrollbar-width:thin;
}
.tw{
  position:relative;cursor:pointer;border-radius:5px;overflow:hidden;
  border:2px solid transparent;transition:border-color .15s;flex-shrink:0;
}
.tw.active{border-color:var(--acc)}
.tw canvas{width:100%;display:block}
.tn{
  position:absolute;bottom:2px;left:3px;
  background:rgba(0,0,0,.7);color:#fff;font-size:.55rem;font-weight:700;
  padding:1px 4px;border-radius:999px;
}
/* The key: sign-preview is the scroll container, ppw is relative-positioned */
.sign-preview{
  flex:1;overflow:auto;background:#0a0a0e;
  display:flex;align-items:flex-start;justify-content:center;
  padding:16px;
}
.ppw{
  position:relative; /* overlay anchor */
  display:inline-block;line-height:0;flex-shrink:0;
}
.ppw canvas{display:block;border-radius:3px;box-shadow:0 6px 28px rgba(0,0,0,.7)}

/* ‚îÄ‚îÄ‚îÄ SIGNATURE OVERLAY ‚îÄ‚îÄ‚îÄ */
.sov{
  position:absolute;left:0;top:0; /* base position; actual pos via transform */
  border:1.5px dashed rgba(245,200,66,.9);
  border-radius:3px;
  will-change:transform;
  -webkit-transform:translateZ(0);
}
.sov img{
  display:block;width:100%;height:100%;
  pointer-events:none;user-select:none;
  -webkit-user-drag:none;
}
.sov-del{
  position:absolute;top:-12px;right:-12px;
  background:var(--red);color:#fff;border:2px solid #0d0d11;
  border-radius:50%;width:24px;height:24px;
  cursor:pointer;font-size:12px;
  display:flex;align-items:center;justify-content:center;
  z-index:3;line-height:1;touch-action:manipulation;
}
.sov-rz{
  position:absolute;bottom:-10px;right:-10px;
  width:22px;height:22px;background:var(--acc);
  border-radius:4px;cursor:se-resize;z-index:3;
  display:flex;align-items:center;justify-content:center;
  font-size:12px;color:#111;touch-action:none;
}

/* ‚îÄ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ‚îÄ */
.modal{
  display:none;position:fixed;inset:0;
  background:rgba(0,0,0,.9);backdrop-filter:blur(8px);
  z-index:400;flex-direction:column;max-width:100vw;overflow:hidden;
}
.modal.open{display:flex}
.mhdr{
  flex-shrink:0;display:flex;align-items:center;justify-content:space-between;
  padding:11px 14px;background:var(--surf);border-bottom:1px solid var(--border);
}
.mhdr h2{font-family:'Syne',sans-serif;font-size:.92rem}
.mhdr span{font-size:.72rem;color:var(--muted)}
.mtb{
  flex-shrink:0;display:flex;gap:5px;padding:7px 10px;
  background:var(--surf2);overflow-x:auto;scrollbar-width:none;align-items:center;
}
.mtb::-webkit-scrollbar{display:none}
.tb{
  padding:5px 10px;border-radius:7px;border:1px solid var(--border);
  background:var(--surf);color:var(--text);font-size:.75rem;cursor:pointer;
  white-space:nowrap;flex-shrink:0;display:flex;align-items:center;gap:3px;
  touch-action:manipulation;
}
.tb.active{background:var(--acc);color:#111;border-color:var(--acc);font-weight:600}
.mcvs{
  flex:1;overflow:hidden;position:relative;background:#0a0a0e;
  display:flex;align-items:center;justify-content:center;
}
.mcvs img{max-width:100%;max-height:100%;display:block}
.mftr{
  flex-shrink:0;display:flex;gap:7px;padding:9px 12px;
  background:var(--surf);border-top:1px solid var(--border);
  padding-bottom:calc(9px + env(safe-area-inset-bottom));
}
.mfbtn{
  padding:11px 14px;border-radius:10px;border:none;
  font-family:'Syne',sans-serif;font-weight:700;font-size:.84rem;
  cursor:pointer;display:flex;align-items:center;justify-content:center;gap:5px;
  touch-action:manipulation;transition:opacity .12s;
}
.mfbtn:active{opacity:.75}
.mf-cancel{background:var(--surf2);color:var(--text);border:1px solid var(--border);flex:1}
.mf-reset {background:var(--surf2);color:var(--muted);border:1px solid var(--border)}
.mf-apply {background:linear-gradient(135deg,var(--green),#27a065);color:#fff;flex:2}
.divv{width:1px;background:var(--border);margin:0 1px;align-self:stretch;flex-shrink:0}

/* ‚îÄ‚îÄ‚îÄ SIGNATURE DRAW ‚îÄ‚îÄ‚îÄ */
.sig-wrap{flex:1;display:flex;position:relative;background:#f4f4ec;overflow:hidden}
#sigCvs{display:block;touch-action:none;width:100%;height:100%}
.sig-hint{
  position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  font-size:.92rem;color:#bbb;pointer-events:none;transition:opacity .2s;
}
.sig-hint.gone{opacity:0}
.cdot{
  width:24px;height:24px;border-radius:50%;cursor:pointer;
  border:3px solid transparent;transition:border-color .15s,transform .12s;flex-shrink:0;
  touch-action:manipulation;
}
.cdot.active{border-color:#fff;transform:scale(1.15)}

/* ‚îÄ‚îÄ‚îÄ PROGRESS ‚îÄ‚îÄ‚îÄ */
.prog-bg{
  display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);
  backdrop-filter:blur(6px);z-index:600;align-items:center;justify-content:center;
}
.prog-bg.open{display:flex}
.prog-card{
  background:var(--surf);border:1px solid var(--border);
  border-radius:14px;padding:24px 28px;text-align:center;min-width:220px;max-width:80vw;
}
.prog-card h3{font-family:'Syne',sans-serif;margin-bottom:12px;font-size:.92rem}
.prog-track{width:100%;height:6px;background:var(--surf2);border-radius:999px;overflow:hidden;margin-bottom:8px}
.prog-fill{height:100%;background:linear-gradient(90deg,var(--acc),var(--acc2));border-radius:999px;transition:width .2s var(--ease);width:0%}
.prog-note{font-size:.76rem;color:var(--muted)}

/* ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ */
.toast{
  position:fixed;top:60px;left:50%;max-width:90vw;
  transform:translateX(-50%) translateY(-8px);
  background:var(--surf2);border:1px solid var(--border);
  color:var(--text);padding:7px 16px;border-radius:9px;
  font-size:.79rem;opacity:0;pointer-events:none;
  transition:opacity .25s,transform .25s;z-index:700;
  white-space:normal;text-align:center;
}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.empty{
  grid-column:1/-1;text-align:center;padding:22px;
  color:var(--muted);font-size:.79rem;line-height:1.9;
}
</style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="h-brand">
    <div class="h-title">Photo to <span>PDF</span></div>
    <div class="h-sig">zaphyros</div>
  </div>
  <div class="h-right">
    <button class="lang-btn active" id="btnTR" onclick="setLang('tr')">TR</button>
    <button class="lang-btn" id="btnEN" onclick="setLang('en')">EN</button>
    <div class="hpill" id="cPill">Foto: <b>0</b></div>
  </div>
</header>

<!-- NAV CARDS -->
<div class="nav-cards">
  <div class="nc c1 active" data-tab="photo">
    <div class="nc-icon">üì∑</div>
    <div data-i="nav_photo">Foto‚ÜíPDF</div>
  </div>
  <div class="nc c2" data-tab="merge">
    <div class="nc-icon">üîó</div>
    <div data-i="nav_merge">Birle≈ütir</div>
  </div>
  <div class="nc c3" data-tab="sign">
    <div class="nc-icon">‚úçÔ∏è</div>
    <div data-i="nav_sign">ƒ∞mzala</div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê PHOTO TAB ‚ïê‚ïê‚ïê -->
<div class="tab-panel active" id="tab-photo">
  <div class="sbar">
    <div class="sc">
      <label data-i="lbl_page">Sayfa</label>
      <select id="selPage">
        <option value="a4">A4</option><option value="a5">A5</option>
        <option value="letter">Letter</option><option value="square" data-i="opt_sq">Kare</option>
      </select>
    </div>
    <div class="sc">
      <label data-i="lbl_ori">Y√∂n</label>
      <select id="selOri">
        <option value="auto" data-i="opt_auto">Otomatik</option>
        <option value="portrait" data-i="opt_port">Dikey</option>
        <option value="landscape" data-i="opt_land">Yatay</option>
      </select>
    </div>
    <div class="sc">
      <label data-i="lbl_marg">Kenar</label>
      <select id="selMarg">
        <option value="8">8mm</option>
        <option value="0" data-i="opt_none">Kenarsƒ±z</option>
        <option value="15">15mm</option>
      </select>
    </div>
    <div class="sc">
      <label data-i="lbl_qual">Kalite: <span class="qval" id="qval">85%</span></label>
      <input type="range" id="qrange" min="40" max="100" value="85">
    </div>
  </div>
  <div class="scroll">
    <div class="dz" id="photoDZ">
      <input type="file" id="photoIn" multiple accept="image/*">
      <div class="dz-icon">üì∑</div>
      <h3 data-i="dz_ph_h">Fotoƒüraf Ekle</h3>
      <p data-i="dz_ph_p">Tƒ±kla veya s√ºr√ºkle ¬∑ JPG, PNG, WebP</p>
    </div>
    <div id="photo-list">
      <div class="empty" id="photoEmpty" data-i="empty_ph">üìÇ Hen√ºz fotoƒüraf eklenmedi.</div>
    </div>
  </div>
  <div class="abar">
    <button class="abtn-sm" title="Ekle">
      Ôºã<input type="file" id="photoIn2" multiple accept="image/*" style="position:absolute;inset:0;opacity:0;cursor:pointer">
    </button>
    <button class="abtn-sm red" id="phClearBtn" disabled>üóë</button>
    <button class="abtn-main abtn-blue" id="phPdfBtn" disabled data-i="btn_cpdf">üìÑ PDF Olu≈ütur</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê MERGE TAB ‚ïê‚ïê‚ïê -->
<div class="tab-panel" id="tab-merge">
  <div class="scroll">
    <div class="dz" id="mergeDZ">
      <input type="file" id="mergeIn" multiple accept="application/pdf,.pdf">
      <div class="dz-icon">üìÑ</div>
      <h3 data-i="dz_mg_h">PDF Dosyalarƒ± Ekle</h3>
      <p data-i="dz_mg_p">Birle≈ütirmek istediƒüin PDF'leri se√ß</p>
    </div>
    <div class="mlist" id="mergeList">
      <div class="empty" id="mergeEmpty" data-i="empty_mg">üìÇ Hen√ºz PDF eklenmedi.</div>
    </div>
  </div>
  <div class="abar">
    <button class="abtn-sm">
      Ôºã<input type="file" id="mergeIn2" multiple accept="application/pdf,.pdf" style="position:absolute;inset:0;opacity:0;cursor:pointer">
    </button>
    <button class="abtn-sm red" id="mgClearBtn" disabled>üóë</button>
    <button class="abtn-main abtn-teal" id="mgBtn" disabled data-i="btn_merge">üîó Birle≈ütir</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê SIGN TAB ‚ïê‚ïê‚ïê -->
<div class="tab-panel" id="tab-sign">
  <div class="sign-empty" id="signEmpty">
    <div class="big">‚úçÔ∏è</div>
    <div style="font-weight:500;color:var(--text);font-size:.9rem" data-i="sign_ttl">Dosyayƒ± se√ß</div>
    <div style="font-size:.75rem" data-i="sign_sub">PDF veya fotoƒüraf</div>
    <div class="sign-empty-row">
      <label class="open-btn">üìÑ <span data-i="btn_opdf">PDF A√ß</span><input type="file" id="signPdfIn" accept="application/pdf,.pdf"></label>
      <label class="open-btn">üñºÔ∏è <span data-i="btn_oimg">Foto A√ß</span><input type="file" id="signImgIn" accept="image/*"></label>
    </div>
  </div>
  <div class="sign-loaded" id="signLoaded">
    <div class="sign-topbar">
      <div class="sfname"><b id="sFname">-</b> ¬∑ <span id="sPcount">0</span> <span id="sPlabel" data-i="lbl_pages">sayfa</span></div>
      <div class="schange">
        <label class="sch">PDF<input type="file" id="signPdfIn2" accept="application/pdf,.pdf"></label>
        <label class="sch"><span data-i="btn_oimg">Foto</span><input type="file" id="signImgIn2" accept="image/*"></label>
      </div>
    </div>
    <div class="sign-layout">
      <div class="sign-thumbs" id="signThumbs"></div>
      <div class="sign-preview" id="signPreview">
        <div class="ppw" id="ppw"><canvas id="mainCvs"></canvas></div>
      </div>
    </div>
  </div>
  <div class="abar" id="signAbar" style="display:none">
    <button class="abtn-sm red" id="clrSigsBtn">üóë</button>
    <button class="abtn-main abtn-purple" id="drawSigBtn" data-i="btn_draw_sig">‚úçÔ∏è ƒ∞mza √áiz</button>
    <button class="abtn-main abtn-blue" id="dlSignedBtn" data-i="btn_dl_signed">üìÑ ƒ∞ndir</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê CROP MODAL ‚ïê‚ïê‚ïê -->
<div class="modal" id="cropModal">
  <div class="mhdr"><h2>‚úÇÔ∏è <span data-i="crop_ttl">D√ºzenle</span></h2><span id="cropIdx"></span></div>
  <div class="mtb">
    <span style="font-size:.64rem;color:var(--muted)" data-i="lbl_ratio">Oran:</span>
    <button class="tb active" data-ratio="free" data-i="opt_free">Serbest</button>
    <button class="tb" data-ratio="1">1:1</button>
    <button class="tb" data-ratio="1.333">4:3</button>
    <button class="tb" data-ratio="1.778">16:9</button>
    <button class="tb" data-ratio="0.707">A4</button>
    <div class="divv"></div>
    <button class="tb" id="rotL">‚Ü∫</button>
    <button class="tb" id="rotR">‚Üª</button>
    <button class="tb" id="flipH">‚áÑ</button>
    <button class="tb" id="flipV">‚áÖ</button>
    <button class="tb" id="zIn">+</button>
    <button class="tb" id="zOut">‚àí</button>
  </div>
  <div class="mcvs"><img id="cropImg" src="" alt=""></div>
  <div class="mftr">
    <button class="mfbtn mf-cancel" id="cancelCrop" data-i="btn_cancel">ƒ∞ptal</button>
    <button class="mfbtn mf-reset" id="resetCrop" data-i="btn_reset">Sƒ±fƒ±rla</button>
    <button class="mfbtn mf-apply" id="applyCrop" data-i="btn_apply">‚úì Uygula</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê SIGNATURE MODAL ‚ïê‚ïê‚ïê -->
<div class="modal" id="sigModal">
  <div class="mhdr">
    <h2>‚úçÔ∏è <span data-i="sig_ttl">ƒ∞mzanƒ± √áiz</span></h2>
    <span data-i="sig_sub">Parmak veya mouse</span>
  </div>
  <div class="mtb">
    <span style="font-size:.64rem;color:var(--muted)" data-i="lbl_clr">Renk:</span>
    <div class="cdot active" data-c="#111111" style="background:#111111"></div>
    <div class="cdot" data-c="#1a3a8f" style="background:#1a3a8f" title="Lacivert"></div>
    <div class="cdot" data-c="#1565C0" style="background:#1565C0" title="M√ºrekkep Mavi"></div>
    <div class="cdot" data-c="#8a1414" style="background:#8a1414" title="Kƒ±rmƒ±zƒ±"></div>
    <div class="divv"></div>
    <span style="font-size:.64rem;color:var(--muted)" data-i="lbl_thk">Kalƒ±nlƒ±k:</span>
    <button class="tb" data-w="2" data-i="w_thin">ƒ∞nce</button>
    <button class="tb active" data-w="3" data-i="w_mid">Orta</button>
    <button class="tb" data-w="5" data-i="w_thick">Kalƒ±n</button>
    <div class="divv"></div>
    <button class="tb" id="clrSigCvs" data-i="btn_clear">üóë Temizle</button>
  </div>
  <div class="sig-wrap">
    <canvas id="sigCvs"></canvas>
    <div class="sig-hint" id="sigHint" data-i="sig_hint">‚úçÔ∏è Buraya imzanƒ± √ßiz</div>
  </div>
  <div class="mftr">
    <button class="mfbtn mf-cancel" id="cancelSig" data-i="btn_cancel">ƒ∞ptal</button>
    <button class="mfbtn mf-apply" id="applySig" data-i="btn_place">‚úì Yerle≈ütir</button>
  </div>
</div>

<!-- PROGRESS -->
<div class="prog-bg" id="progBg">
  <div class="prog-card">
    <h3 id="progTitle">ƒ∞≈üleniyor‚Ä¶</h3>
    <div class="prog-track"><div class="prog-fill" id="progFill"></div></div>
    <div class="prog-note" id="progNote">‚Ä¶</div>
  </div>
</div>
<div class="toast" id="toast"></div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   i18n
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const S={
tr:{
  nav_photo:'Foto‚ÜíPDF',nav_merge:'Birle≈ütir',nav_sign:'ƒ∞mzala',
  lbl_page:'Sayfa',lbl_ori:'Y√∂n',lbl_marg:'Kenar',lbl_qual:'Kalite:',
  lbl_ratio:'Oran:',lbl_clr:'Renk:',lbl_thk:'Kalƒ±nlƒ±k:',lbl_pages:'sayfa',
  opt_sq:'Kare',opt_auto:'Otomatik',opt_port:'Dikey',opt_land:'Yatay',opt_none:'Kenarsƒ±z',opt_free:'Serbest',
  dz_ph_h:'Fotoƒüraf Ekle',dz_ph_p:'Tƒ±kla veya s√ºr√ºkle ¬∑ JPG, PNG, WebP',
  dz_mg_h:'PDF Dosyalarƒ± Ekle',dz_mg_p:'Birle≈ütirmek istediƒüin PDF\'leri se√ß',
  empty_ph:'üìÇ Hen√ºz fotoƒüraf eklenmedi.',empty_mg:'üìÇ Hen√ºz PDF eklenmedi.',
  btn_cpdf:'üìÑ PDF Olu≈ütur',btn_merge:'üîó Birle≈ütir',
  sign_ttl:'Dosyayƒ± se√ß',sign_sub:'PDF veya fotoƒüraf desteklenir',
  btn_opdf:'PDF A√ß',btn_oimg:'Foto A√ß',
  btn_draw_sig:'‚úçÔ∏è ƒ∞mza √áiz',btn_dl_signed:'üìÑ ƒ∞ndir',
  crop_ttl:'D√ºzenle / Kƒ±rp',btn_cancel:'ƒ∞ptal',btn_reset:'Sƒ±fƒ±rla',btn_apply:'‚úì Uygula',
  sig_ttl:'ƒ∞mzanƒ± √áiz',sig_sub:'Parmak veya mouse',
  w_thin:'ƒ∞nce',w_mid:'Orta',w_thick:'Kalƒ±n',btn_clear:'üóë Temizle',btn_place:'‚úì Yerle≈ütir',
  sig_hint:'‚úçÔ∏è Buraya imzanƒ± √ßiz',
  pill:'Foto:',img_mode:'g√∂rsel',
  p_creating:'PDF Olu≈üturuluyor‚Ä¶',p_merging:'Birle≈ütiriliyor‚Ä¶',
  p_load_pdf:'PDF Y√ºkleniyor‚Ä¶',p_load_img:'G√∂rsel Y√ºkleniyor‚Ä¶',
  p_signing:'ƒ∞mzalƒ± PDF Hazƒ±rlanƒ±yor‚Ä¶',p_signing_img:'ƒ∞mzalƒ± G√∂rsel Hazƒ±rlanƒ±yor‚Ä¶',
  t_pdf_ok:'‚úÖ PDF olu≈üturuldu!',t_merge_ok:'‚úÖ PDF birle≈ütirildi!',
  t_sign_ok:'‚úÖ ƒ∞mzalƒ± PDF indirildi!',t_sign_img_ok:'‚úÖ ƒ∞mzalƒ± g√∂rsel indirildi!',
  t_placed:'‚úÖ ƒ∞mza eklendi ‚Äî s√ºr√ºkle, k√∂≈üeden boyutlandƒ±r',
  t_photo_loaded:'Fotoƒüraf y√ºklendi ‚Äî imzanƒ± √ßiz',
  t_crop_ok:'‚úÖ D√ºzenleme uygulandƒ±',t_sigs_cleared:'ƒ∞mzalar temizlendi',
  t_no_sig:'‚ö†Ô∏è √ñnce imzanƒ± √ßiz!',t_no_placed:'‚ö†Ô∏è Hen√ºz imza eklemedin',
  t_confirm_ph:'T√ºm fotoƒüraflar silinsin mi?',t_confirm_mg:'Liste temizlensin mi?',
  t_pdf_err:'‚ùå PDF y√ºklenemedi',t_img_err:'‚ùå G√∂rsel y√ºklenemedi',t_err:'‚ùå Hata: '
},
en:{
  nav_photo:'Photo‚ÜíPDF',nav_merge:'Merge',nav_sign:'Sign',
  lbl_page:'Page',lbl_ori:'Orient',lbl_marg:'Margin',lbl_qual:'Quality:',
  lbl_ratio:'Ratio:',lbl_clr:'Color:',lbl_thk:'Size:',lbl_pages:'pages',
  opt_sq:'Square',opt_auto:'Auto',opt_port:'Portrait',opt_land:'Landscape',opt_none:'Borderless',opt_free:'Free',
  dz_ph_h:'Add Photos',dz_ph_p:'Tap or drag ¬∑ JPG, PNG, WebP',
  dz_mg_h:'Add PDF Files',dz_mg_p:'Select PDFs to merge',
  empty_ph:'üìÇ No photos added.',empty_mg:'üìÇ No PDFs added.',
  btn_cpdf:'üìÑ Create PDF',btn_merge:'üîó Merge',
  sign_ttl:'Select a file',sign_sub:'PDF or photo supported',
  btn_opdf:'Open PDF',btn_oimg:'Open Photo',
  btn_draw_sig:'‚úçÔ∏è Draw Signature',btn_dl_signed:'üìÑ Download',
  crop_ttl:'Edit / Crop',btn_cancel:'Cancel',btn_reset:'Reset',btn_apply:'‚úì Apply',
  sig_ttl:'Draw Signature',sig_sub:'Finger or mouse',
  w_thin:'Thin',w_mid:'Medium',w_thick:'Thick',btn_clear:'üóë Clear',btn_place:'‚úì Place',
  sig_hint:'‚úçÔ∏è Draw here',
  pill:'Photos:',img_mode:'image',
  p_creating:'Creating PDF‚Ä¶',p_merging:'Merging‚Ä¶',
  p_load_pdf:'Loading PDF‚Ä¶',p_load_img:'Loading Image‚Ä¶',
  p_signing:'Creating Signed PDF‚Ä¶',p_signing_img:'Creating Signed Image‚Ä¶',
  t_pdf_ok:'‚úÖ PDF created!',t_merge_ok:'‚úÖ PDFs merged!',
  t_sign_ok:'‚úÖ Signed PDF downloaded!',t_sign_img_ok:'‚úÖ Signed image downloaded!',
  t_placed:'‚úÖ Signature placed ‚Äî drag & resize from corner',
  t_photo_loaded:'Photo loaded ‚Äî draw your signature',
  t_crop_ok:'‚úÖ Edit applied',t_sigs_cleared:'Signatures cleared',
  t_no_sig:'‚ö†Ô∏è Draw your signature first!',t_no_placed:'‚ö†Ô∏è No signature yet',
  t_confirm_ph:'Delete all photos?',t_confirm_mg:'Clear list?',
  t_pdf_err:'‚ùå Could not load PDF',t_img_err:'‚ùå Could not load image',t_err:'‚ùå Error: '
}};

let lang='tr';
function tx(k){return S[lang][k]||S.tr[k]||k}
function applyLang(){
  document.querySelectorAll('[data-i]').forEach(el=>{
    const k=el.dataset.i; if(k)el.textContent=tx(k);
  });
  document.getElementById('btnTR').classList.toggle('active',lang==='tr');
  document.getElementById('btnEN').classList.toggle('active',lang==='en');
  updatePill();
}
function setLang(l){lang=l;localStorage.setItem('lang',l);applyLang()}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   GLOBALS / HELPERS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const {jsPDF}=window.jspdf;
pdfjsLib.GlobalWorkerOptions.workerSrc=
  'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

let _tt;
function toast(msg,ms=3000){
  const el=document.getElementById('toast');
  el.textContent=msg;el.classList.add('show');
  clearTimeout(_tt);_tt=setTimeout(()=>el.classList.remove('show'),ms);
}
function showProg(t){
  document.getElementById('progTitle').textContent=t;
  document.getElementById('progFill').style.width='0%';
  document.getElementById('progNote').textContent='‚Ä¶';
  document.getElementById('progBg').classList.add('open');
}
function setProg(p,n){
  document.getElementById('progFill').style.width=p+'%';
  if(n)document.getElementById('progNote').textContent=n;
}
function hideProg(){document.getElementById('progBg').classList.remove('open')}
function dlBytes(b,n){
  const u=URL.createObjectURL(new Blob([b],{type:'application/pdf'}));
  const a=document.createElement('a');a.href=u;a.download=n;a.click();
  setTimeout(()=>URL.revokeObjectURL(u),5000);
}
function dlDataUrl(du,n){const a=document.createElement('a');a.href=du;a.download=n;a.click()}
function nPhotos(){return document.querySelectorAll('#photo-list .pi').length}
function updatePill(){
  document.getElementById('cPill').innerHTML=tx('pill')+' <b>'+nPhotos()+'</b>';
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   NAVIGATION + BACK BUTTON
   Sentinel state at bottom prevents browser from leaving the app.
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const MODALS=['cropModal','sigModal'];

// Push two states: sentinel (never popped away from) + initial tab
history.replaceState({k:'sentinel'},'');
history.pushState({k:'tab',v:'photo'},'');

function pushH(k,v){history.pushState({k,v},'')}
function openModal(id){pushH('modal',id);document.getElementById(id).classList.add('open')}
function closeModal(id){document.getElementById(id).classList.remove('open')}

function switchTab(id,push=true){
  if(push)pushH('tab',id);
  document.querySelectorAll('.nc').forEach(n=>n.classList.toggle('active',n.dataset.tab===id));
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.toggle('active',p.id==='tab-'+id));
}

window.addEventListener('popstate',e=>{
  const s=e.state;

  // Sentinel hit ‚Äî push tab state back so we never leave the app
  if(!s || s.k==='sentinel'){
    history.pushState({k:'tab',v:'photo'},'');
    switchTab('photo',false);
    return;
  }

  // Close topmost open modal
  for(const id of MODALS){
    if(document.getElementById(id).classList.contains('open')){
      if(id==='cropModal')_closeCrop(false);
      else closeModal(id);
      return;
    }
  }

  if(s.k==='tab') switchTab(s.v,false);
  // else: unknown state, ignore
});

document.querySelectorAll('.nc').forEach(n=>
  n.addEventListener('click',()=>switchTab(n.dataset.tab)));

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   TAB 1 ‚Äî PHOTO ‚Üí PDF
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const photoList=document.getElementById('photo-list');
const phPdfBtn=document.getElementById('phPdfBtn');
const phClearBtn=document.getElementById('phClearBtn');

document.getElementById('qrange').addEventListener('input',function(){
  document.getElementById('qval').textContent=this.value+'%';
});

[document.getElementById('photoIn'),document.getElementById('photoIn2')]
  .forEach(i=>i.addEventListener('change',e=>{loadPhotos(e.target.files);e.target.value=''}));

const photoDZ=document.getElementById('photoDZ');
photoDZ.addEventListener('dragover',e=>{e.preventDefault();photoDZ.classList.add('over')});
photoDZ.addEventListener('dragleave',()=>photoDZ.classList.remove('over'));
photoDZ.addEventListener('drop',e=>{e.preventDefault();photoDZ.classList.remove('over');loadPhotos(e.dataTransfer.files)});

new Sortable(photoList,{
  animation:160,handle:'.pi-hnd',
  ghostClass:'ghost',chosenClass:'chosen',
  filter:'.empty',touchStartThreshold:4,
  onEnd:()=>photoList.querySelectorAll('.pi .pi-num').forEach((b,i)=>b.textContent=i+1)
});

function loadPhotos(files){
  Array.from(files).filter(f=>f.type.startsWith('image/')).forEach(f=>{
    const r=new FileReader();r.onload=e=>addPhotoCard(e.target.result);r.readAsDataURL(f);
  });
}

function addPhotoCard(src, skipSave=false){
  document.getElementById('photoEmpty').style.display='none';
  const d=document.createElement('div');d.className='pi';
  const hnd=document.createElement('div');hnd.className='pi-hnd';hnd.textContent='‚†ø ‚†ø ‚†ø';
  const img=document.createElement('img');img.src=src;img.draggable=false;
  const bar=document.createElement('div');bar.className='pi-bar';
  const num=document.createElement('span');num.className='pi-num';

  function mkib(cls,ico){
    const b=document.createElement('button');b.className='ib '+cls;b.textContent=ico;return b;
  }
  const eb=mkib('ed','‚úèÔ∏è'); eb.addEventListener('click',e=>{e.stopPropagation();openCrop(d)});
  const sb=mkib('sg','‚úçÔ∏è'); sb.addEventListener('click',e=>{e.stopPropagation();openPhotoSign(d)});
  const db=mkib('dl','üóë'); db.addEventListener('click',e=>{
    e.stopPropagation();d.remove();
    photoList.querySelectorAll('.pi .pi-num').forEach((b,i)=>b.textContent=i+1);
    updatePhotoState();
    savePhotos();
  });
  bar.append(num,eb,sb,db);
  d.append(hnd,img,bar);
  photoList.appendChild(d);
  photoList.querySelectorAll('.pi .pi-num').forEach((b,i)=>b.textContent=i+1);
  updatePhotoState();
  if(!skipSave) savePhotos();
}

function updatePhotoState(){
  const n=nPhotos();
  updatePill();
  phPdfBtn.disabled=n===0;phClearBtn.disabled=n===0;
  if(n===0)document.getElementById('photoEmpty').style.display='';
}

phClearBtn.addEventListener('click',()=>{
  if(!confirm(tx('t_confirm_ph')))return;
  photoList.querySelectorAll('.pi').forEach(el=>el.remove());
  updatePhotoState();
  savePhotos(); // saves empty array ‚Üí clears DB
});

const PAGE_SIZES={a4:[210,297],a5:[148,210],letter:[215.9,279.4],square:[150,150]};
phPdfBtn.addEventListener('click',async()=>{
  const items=Array.from(photoList.querySelectorAll('.pi'));if(!items.length)return;
  const [pw0,ph0]=PAGE_SIZES[document.getElementById('selPage').value];
  const ori0=document.getElementById('selOri').value;
  const marg=parseInt(document.getElementById('selMarg').value);
  const qual=parseInt(document.getElementById('qrange').value)/100;
  showProg(tx('p_creating'));phPdfBtn.disabled=true;
  let doc=null;
  for(let i=0;i<items.length;i++){
    const img=items[i].querySelector('img');
    let ori='portrait';
    if(ori0==='landscape')ori='landscape';
    else if(ori0==='auto'&&img.naturalWidth>img.naturalHeight)ori='landscape';
    const pw=ori==='landscape'?ph0:pw0,ph=ori==='landscape'?pw0:ph0;
    if(!doc)doc=new jsPDF({orientation:ori,unit:'mm',format:[pw,ph]});
    else doc.addPage([pw,ph],ori);
    const avW=pw-marg*2,avH=ph-marg*2,rat=img.naturalWidth/img.naturalHeight;
    let dw=avW,dh=dw/rat;if(dh>avH){dh=avH;dw=dh*rat}
    const c=document.createElement('canvas');c.width=img.naturalWidth;c.height=img.naturalHeight;
    c.getContext('2d').drawImage(img,0,0);
    doc.addImage(c.toDataURL('image/jpeg',qual),'JPEG',(pw-dw)/2,(ph-dh)/2,dw,dh);
    setProg(Math.round((i+1)/items.length*100),`${i+1}/${items.length}`);
    await new Promise(r=>setTimeout(r,10));
  }
  doc.save(`photo-to-pdf-${Date.now()}.pdf`);
  hideProg();phPdfBtn.disabled=false;toast(tx('t_pdf_ok'));
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CROP
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let _cr=null,_crItem=null,_origSrc=null,_sx=1,_sy=1;

function openCrop(item){
  _crItem=item;_sx=1;_sy=1;
  const ci=document.getElementById('cropImg');
  _origSrc=item.querySelector('img').src;
  ci.src=_origSrc;
  const idx=Array.from(photoList.querySelectorAll('.pi')).indexOf(item);
  document.getElementById('cropIdx').textContent='#'+(idx+1);
  document.querySelectorAll('[data-ratio]').forEach(b=>b.classList.remove('active'));
  document.querySelector('[data-ratio="free"]').classList.add('active');
  openModal('cropModal');
  ci.onload=()=>{
    if(_cr){_cr.destroy();_cr=null}
    _cr=new Cropper(ci,{viewMode:1,autoCropArea:.88,movable:true,scalable:true,zoomable:true,background:true,responsive:true});
  };
  if(ci.complete)ci.onload();
}
function _closeCrop(back=true){
  if(_cr){_cr.destroy();_cr=null}
  closeModal('cropModal');_crItem=null;
  if(back)history.back();
}
document.getElementById('cancelCrop').addEventListener('click',()=>_closeCrop());
document.getElementById('resetCrop').addEventListener('click',()=>{
  _sx=1;_sy=1;const ci=document.getElementById('cropImg');ci.src=_origSrc;
  ci.onload=()=>{if(_cr){_cr.destroy();_cr=null}
    _cr=new Cropper(ci,{viewMode:1,autoCropArea:.88,movable:true,scalable:true,zoomable:true,background:true,responsive:true});
  };if(ci.complete)ci.onload();
});
document.getElementById('applyCrop').addEventListener('click',()=>{
  if(!_cr||!_crItem)return;
  const c=_cr.getCroppedCanvas({maxWidth:2400,maxHeight:2400,imageSmoothingQuality:'high'});
  if(!c)return;
  _crItem.querySelector('img').src=c.toDataURL('image/jpeg',.94);
  _closeCrop();toast(tx('t_crop_ok'));savePhotos();
});
document.querySelectorAll('[data-ratio]').forEach(b=>b.addEventListener('click',()=>{
  document.querySelectorAll('[data-ratio]').forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
  _cr?.setAspectRatio(b.dataset.ratio==='free'?NaN:parseFloat(b.dataset.ratio));
}));
document.getElementById('rotL').addEventListener('click',()=>_cr?.rotate(-90));
document.getElementById('rotR').addEventListener('click',()=>_cr?.rotate(90));
document.getElementById('flipH').addEventListener('click',()=>{_sx*=-1;_cr?.scaleX(_sx)});
document.getElementById('flipV').addEventListener('click',()=>{_sy*=-1;_cr?.scaleY(_sy)});
document.getElementById('zIn').addEventListener('click',()=>_cr?.zoom(.1));
document.getElementById('zOut').addEventListener('click',()=>_cr?.zoom(-.1));

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   TAB 2 ‚Äî MERGE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let mFiles=[];
const mList=document.getElementById('mergeList');
new Sortable(mList,{animation:160,ghostClass:'ghost',chosenClass:'chosen',filter:'.empty'});

[document.getElementById('mergeIn'),document.getElementById('mergeIn2')]
  .forEach(i=>i.addEventListener('change',e=>{loadMerge(e.target.files);e.target.value=''}));

const mergeDZ=document.getElementById('mergeDZ');
mergeDZ.addEventListener('dragover',e=>{e.preventDefault();mergeDZ.classList.add('over')});
mergeDZ.addEventListener('dragleave',()=>mergeDZ.classList.remove('over'));
mergeDZ.addEventListener('drop',e=>{e.preventDefault();mergeDZ.classList.remove('over');loadMerge(e.dataTransfer.files)});

async function loadMerge(files){
  for(const f of Array.from(files).filter(f=>f.name.toLowerCase().endsWith('.pdf')||f.type==='application/pdf')){
    try{
      const ab=await f.arrayBuffer();
      const pdf=await PDFLib.PDFDocument.load(ab,{ignoreEncryption:true});
      const data={name:f.name,pages:pdf.getPageCount(),ab};
      mFiles.push(data);addMItem(data);
    }catch(e){toast(tx('t_pdf_err')+': '+f.name)}
  }
  updateMState();
}
function addMItem(data){
  document.getElementById('mergeEmpty').style.display='none';
  const d=document.createElement('div');d.className='mi';
  d.innerHTML=`<span class="mi-drag">‚†ø</span>
    <div class="mi-info">
      <div class="mi-name" title="${data.name}">${data.name}</div>
      <div class="mi-pages">${data.pages} ${tx('lbl_pages')}</div>
    </div>
    <button class="mi-del">‚úï</button>`;
  d.querySelector('.mi-del').addEventListener('click',()=>{
    const i=mFiles.indexOf(data);if(i>-1)mFiles.splice(i,1);
    d.remove();updateMState();
  });
  mList.appendChild(d);
}
function updateMState(){
  const n=mFiles.length;
  document.getElementById('mgBtn').disabled=n<2;
  document.getElementById('mgClearBtn').disabled=n===0;
  if(n===0)document.getElementById('mergeEmpty').style.display='';
}
document.getElementById('mgClearBtn').addEventListener('click',()=>{
  if(!confirm(tx('t_confirm_mg')))return;
  mFiles=[];mList.querySelectorAll('.mi').forEach(el=>el.remove());updateMState();
});
document.getElementById('mgBtn').addEventListener('click',async()=>{
  if(mFiles.length<2)return;
  showProg(tx('p_merging'));document.getElementById('mgBtn').disabled=true;
  try{
    const merged=await PDFLib.PDFDocument.create();
    const order=Array.from(mList.querySelectorAll('.mi-name')).map(el=>el.title);
    const src=order.map(n=>mFiles.find(f=>f.name===n)).filter(Boolean);
    const list=src.length===mFiles.length?src:mFiles;
    for(let i=0;i<list.length;i++){
      const pdf=await PDFLib.PDFDocument.load(list[i].ab,{ignoreEncryption:true});
      const pages=await merged.copyPages(pdf,pdf.getPageIndices());
      pages.forEach(p=>merged.addPage(p));
      setProg(Math.round((i+1)/list.length*100),`${i+1}/${list.length}`);
      await new Promise(r=>setTimeout(r,8));
    }
    dlBytes(await merged.save(),`merged-${Date.now()}.pdf`);
    toast(tx('t_merge_ok'));
  }catch(e){console.error(e);toast(tx('t_err')+e.message)}
  hideProg();document.getElementById('mgBtn').disabled=false;
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   TAB 3 ‚Äî SIGN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let sDoc=null,sBytes=null,sPage=1,sPageCount=0,sScale=1;
let sigs=[],isImg=false,imgW=0,imgH=0;

[document.getElementById('signPdfIn'),document.getElementById('signPdfIn2')]
  .forEach(i=>i.addEventListener('change',e=>{if(e.target.files[0])loadSPdf(e.target.files[0]);e.target.value=''}));
[document.getElementById('signImgIn'),document.getElementById('signImgIn2')]
  .forEach(i=>i.addEventListener('change',e=>{if(e.target.files[0])loadSImg(e.target.files[0]);e.target.value=''}));

async function loadSPdf(file){
  showProg(tx('p_load_pdf'));
  try{
    const ab=await file.arrayBuffer();
    sBytes=ab;isImg=false;
    sDoc=await pdfjsLib.getDocument({data:ab.slice(0)}).promise;
    sPageCount=sDoc.numPages;sigs=[];sPage=1;
    document.getElementById('sFname').textContent=file.name.slice(0,30);
    document.getElementById('sPcount').textContent=sPageCount;
    document.getElementById('sPlabel').textContent=tx('lbl_pages');
    showSLoaded();
    await buildThumbs();
    await renderPage(1);
  }catch(e){console.error(e);toast(tx('t_pdf_err'))}
  hideProg();
}

async function loadSImg(file){
  showProg(tx('p_load_img'));
  try{
    const url=URL.createObjectURL(file);
    await new Promise((res,rej)=>{
      const img=new Image();
      img.onload=()=>{
        isImg=true;sDoc=null;sBytes=null;
        sPageCount=1;sigs=[];sPage=1;
        imgW=img.width;imgH=img.height;
        document.getElementById('sFname').textContent=file.name.slice(0,30);
        document.getElementById('sPcount').textContent='1';
        document.getElementById('sPlabel').textContent=tx('img_mode');
        showSLoaded();
        // thumbnail
        const thumbs=document.getElementById('signThumbs');thumbs.innerHTML='';
        const tw=document.createElement('div');tw.className='tw active';tw.dataset.p=1;
        const tc=document.createElement('canvas');
        const ts=Math.min(66/img.width,1);
        tc.width=Math.round(img.width*ts);tc.height=Math.round(img.height*ts);
        tc.getContext('2d').drawImage(img,0,0,tc.width,tc.height);
        const tn=document.createElement('div');tn.className='tn';tn.textContent='1';
        tw.append(tc,tn);thumbs.appendChild(tw);
        // render main
        const area=document.getElementById('signPreview');
        const maxW=Math.max((area.clientWidth||300)-32,160);
        sScale=Math.min(maxW/img.width,1.5);
        const mc=document.getElementById('mainCvs');
        mc.width=Math.round(img.width*sScale);
        mc.height=Math.round(img.height*sScale);
        mc.getContext('2d').drawImage(img,0,0,mc.width,mc.height);
        URL.revokeObjectURL(url);res();
      };
      img.onerror=rej;img.src=url;
    });
  }catch(e){console.error(e);toast(tx('t_img_err'))}
  hideProg();
}

function showSLoaded(){
  document.getElementById('signEmpty').style.display='none';
  document.getElementById('signLoaded').style.display='flex';
  document.getElementById('signAbar').style.display='flex';
}

async function buildThumbs(){
  const ct=document.getElementById('signThumbs');ct.innerHTML='';
  for(let p=1;p<=sPageCount;p++){
    const tw=document.createElement('div');tw.className='tw';tw.dataset.p=p;
    const c=document.createElement('canvas');
    const tn=document.createElement('div');tn.className='tn';tn.textContent=p;
    tw.append(c,tn);
    tw.addEventListener('click',()=>renderPage(p));
    ct.appendChild(tw);
    const pg=await sDoc.getPage(p);
    const vp=pg.getViewport({scale:.24});
    c.width=vp.width;c.height=vp.height;
    await pg.render({canvasContext:c.getContext('2d'),viewport:vp}).promise;
  }
  updateThumbs();
}

function updateThumbs(){
  document.querySelectorAll('.tw').forEach(w=>w.classList.toggle('active',parseInt(w.dataset.p||1)===sPage));
}

async function renderPage(p){
  sPage=p;updateThumbs();
  document.querySelectorAll('.sov').forEach(el=>el.remove());
  const pg=await sDoc.getPage(p);
  const area=document.getElementById('signPreview');
  const maxW=Math.max((area.clientWidth||300)-32,160);
  const vp0=pg.getViewport({scale:1});
  sScale=Math.min(maxW/vp0.width,1.5);
  const vp=pg.getViewport({scale:sScale});
  const mc=document.getElementById('mainCvs');
  mc.width=vp.width;mc.height=vp.height;
  await pg.render({canvasContext:mc.getContext('2d'),viewport:vp}).promise;
  sigs.filter(s=>s.page===p).forEach(s=>buildOverlay(s));
}

/* ‚îÄ‚îÄ‚îÄ Place signature ‚îÄ‚îÄ‚îÄ */
function placeSig(dataUrl){
  const mc=document.getElementById('mainCvs');
  const w=Math.round(mc.width*.38),h=Math.round(w*.28);
  const s={
    page:sPage,
    x:Math.round((mc.width-w)/2),
    y:Math.round((mc.height-h)/2),
    w,h,dataUrl
  };
  sigs.push(s);
  buildOverlay(s);
}

/* ‚îÄ‚îÄ‚îÄ Build draggable/resizable overlay ‚îÄ‚îÄ‚îÄ */
function buildOverlay(s){
  const wrap=document.getElementById('ppw');
  const el=document.createElement('div');
  el.className='sov';
  el.style.cssText=`width:${s.w}px;height:${s.h}px;transform:translate3d(${s.x}px,${s.y}px,0);cursor:move;touch-action:none`;

  const imgEl=document.createElement('img');imgEl.src=s.dataUrl;

  const delBtn=document.createElement('button');
  delBtn.className='sov-del';delBtn.textContent='‚úï';
  delBtn.addEventListener('pointerdown',e=>e.stopPropagation());
  delBtn.addEventListener('click',e=>{
    e.stopPropagation();el.remove();
    const i=sigs.indexOf(s);if(i>-1)sigs.splice(i,1);
  });

  const rzHnd=document.createElement('div');
  rzHnd.className='sov-rz';rzHnd.textContent='‚á≤';
  rzHnd.style.touchAction='none';

  el.append(imgEl,delBtn,rzHnd);
  wrap.appendChild(el);

  /* ‚îÄ‚îÄ DRAG
     KEY: cache getBoundingClientRect + canvas size at pointerdown.
     NEVER call getBCR inside pointermove ‚Äî it forces layout reflow = lag.
     Direct DOM write (no rAF) is faster on mobile for pointer events.
  ‚îÄ‚îÄ */
  let dragOn=false,wrL=0,wrT=0,maxX=0,maxY=0,offX=0,offY=0;

  el.addEventListener('pointerdown',e=>{
    if(e.target===delBtn||e.target===rzHnd)return;
    e.preventDefault();e.stopPropagation();
    el.setPointerCapture(e.pointerId);
    dragOn=true;
    // cache everything that forces layout ‚Äî only at start, not during move
    const wr=wrap.getBoundingClientRect();
    const mc=document.getElementById('mainCvs');
    wrL=wr.left; wrT=wr.top;
    maxX=mc.width-s.w;  maxY=mc.height-s.h;
    offX=e.clientX-wrL-s.x;
    offY=e.clientY-wrT-s.y;
  });

  el.addEventListener('pointermove',e=>{
    if(!dragOn)return;
    e.preventDefault();
    // pure arithmetic ‚Äî zero layout queries
    s.x=e.clientX-wrL-offX; if(s.x<0)s.x=0; else if(s.x>maxX)s.x=maxX;
    s.y=e.clientY-wrT-offY; if(s.y<0)s.y=0; else if(s.y>maxY)s.y=maxY;
    el.style.transform=`translate3d(${s.x}px,${s.y}px,0)`;
  });

  el.addEventListener('pointerup',   ()=>dragOn=false);
  el.addEventListener('pointercancel',()=>dragOn=false);

  /* ‚îÄ‚îÄ RESIZE ‚Äî same principle: cache at pointerdown ‚îÄ‚îÄ */
  let rzOn=false,rzSX=0,rzSY=0,rzW0=0,rzH0=0;

  rzHnd.addEventListener('pointerdown',e=>{
    e.preventDefault();e.stopPropagation();
    rzHnd.setPointerCapture(e.pointerId);
    rzOn=true;rzSX=e.clientX;rzSY=e.clientY;rzW0=s.w;rzH0=s.h;
  });
  rzHnd.addEventListener('pointermove',e=>{
    if(!rzOn)return;
    e.preventDefault();
    s.w=rzW0+(e.clientX-rzSX); if(s.w<44)s.w=44;
    s.h=rzH0+(e.clientY-rzSY); if(s.h<18)s.h=18;
    el.style.width=s.w+'px';
    el.style.height=s.h+'px';
    // update maxX/maxY so drag bounds stay correct after resize
    maxX=document.getElementById('mainCvs').width-s.w;
    maxY=document.getElementById('mainCvs').height-s.h;
  });
  rzHnd.addEventListener('pointerup',   ()=>rzOn=false);
  rzHnd.addEventListener('pointercancel',()=>rzOn=false);
}

document.getElementById('clrSigsBtn').addEventListener('click',()=>{
  sigs=sigs.filter(s=>s.page!==sPage);
  document.querySelectorAll('.sov').forEach(el=>el.remove());
  toast(tx('t_sigs_cleared'));
});

/* ‚îÄ‚îÄ‚îÄ Download signed ‚îÄ‚îÄ‚îÄ */
document.getElementById('dlSignedBtn').addEventListener('click',async()=>{
  if(!sigs.length){toast(tx('t_no_placed'));return}

  if(isImg){
    showProg(tx('p_signing_img'));
    const mc=document.getElementById('mainCvs');
    const out=document.createElement('canvas');
    out.width=imgW;out.height=imgH;
    const ctx=out.getContext('2d');
    ctx.drawImage(mc,0,0,imgW,imgH);
    for(const s of sigs){
      const si=new Image();
      await new Promise(r=>{si.onload=r;si.src=s.dataUrl});
      const fx=imgW/mc.width,fy=imgH/mc.height;
      ctx.drawImage(si,s.x*fx,s.y*fy,s.w*fx,s.h*fy);
    }
    dlDataUrl(out.toDataURL('image/png'),`signed-${Date.now()}.png`);
    hideProg();toast(tx('t_sign_img_ok'));
    return;
  }

  if(!sBytes)return;
  showProg(tx('p_signing'));
  try{
    const pdfDoc=await PDFLib.PDFDocument.load(sBytes.slice(0),{ignoreEncryption:true});
    for(let i=0;i<sigs.length;i++){
      const s=sigs[i];
      const pg=pdfDoc.getPage(s.page-1);
      const{width:pW,height:pH}=pg.getSize();
      // get the viewport used when rendering this page
      const pjsPg=await sDoc.getPage(s.page);
      const rendVp=pjsPg.getViewport({scale:sScale});
      const rW=rendVp.width,rH=rendVp.height;
      // convert screen pixels ‚Üí PDF user-space (PDF y-axis is bottom-up)
      const pdfX=(s.x/rW)*pW;
      const pdfY=pH-((s.y+s.h)/rH)*pH;
      const pdfW=(s.w/rW)*pW;
      const pdfH=(s.h/rH)*pH;
      // embed PNG
      const b64=s.dataUrl.split(',')[1];
      const bytes=Uint8Array.from(atob(b64),c=>c.charCodeAt(0));
      const pngImg=await pdfDoc.embedPng(bytes);
      pg.drawImage(pngImg,{x:pdfX,y:pdfY,width:pdfW,height:Math.abs(pdfH)});
      setProg(Math.round((i+1)/sigs.length*100),`${i+1}/${sigs.length}`);
    }
    dlBytes(await pdfDoc.save(),`signed-${Date.now()}.pdf`);
    toast(tx('t_sign_ok'));
  }catch(e){console.error(e);toast(tx('t_err')+e.message)}
  hideProg();
});

/* ‚îÄ‚îÄ‚îÄ Photo card ‚Üí sign ‚îÄ‚îÄ‚îÄ */
function openPhotoSign(card){
  const imgEl=card.querySelector('img');
  // convert dataURL ‚Üí File then load
  fetch(imgEl.src).then(r=>r.blob()).then(blob=>{
    const file=new File([blob],'photo.jpg',{type:'image/jpeg'});
    switchTab('sign');
    loadSImg(file);
    toast(tx('t_photo_loaded'));
  });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SIGNATURE DRAW
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let _dn=false,_sc='#111111',_sw=3;
const sigCvs=document.getElementById('sigCvs');
const sigCtx=sigCvs.getContext('2d');

function resizeSig(){
  const r=sigCvs.parentElement.getBoundingClientRect();
  if(r.width<1||r.height<1)return;
  const tmp=document.createElement('canvas');
  tmp.width=sigCvs.width||1;tmp.height=sigCvs.height||1;
  tmp.getContext('2d').drawImage(sigCvs,0,0);
  sigCvs.width=Math.floor(r.width);
  sigCvs.height=Math.floor(r.height);
  sigCtx.lineCap='round';sigCtx.lineJoin='round';
  sigCtx.drawImage(tmp,0,0);
}

sigCvs.addEventListener('pointerdown',e=>{
  _dn=true;sigCvs.setPointerCapture(e.pointerId);
  const r=sigCvs.getBoundingClientRect();
  sigCtx.beginPath();sigCtx.moveTo(e.clientX-r.left,e.clientY-r.top);
  sigCtx.strokeStyle=_sc;sigCtx.lineWidth=_sw;
  document.getElementById('sigHint').classList.add('gone');
});
sigCvs.addEventListener('pointermove',e=>{
  if(!_dn)return;
  const r=sigCvs.getBoundingClientRect();
  sigCtx.lineTo(e.clientX-r.left,e.clientY-r.top);
  sigCtx.stroke();
  sigCtx.beginPath();sigCtx.moveTo(e.clientX-r.left,e.clientY-r.top);
});
sigCvs.addEventListener('pointerup',()=>_dn=false);
sigCvs.addEventListener('pointercancel',()=>_dn=false);

document.getElementById('clrSigCvs').addEventListener('click',()=>{
  sigCtx.clearRect(0,0,sigCvs.width,sigCvs.height);
  document.getElementById('sigHint').classList.remove('gone');
});

document.querySelectorAll('.cdot').forEach(d=>{
  d.addEventListener('click',()=>{
    document.querySelectorAll('.cdot').forEach(x=>x.classList.remove('active'));
    d.classList.add('active');_sc=d.dataset.c;
  });
});
document.querySelectorAll('[data-w]').forEach(b=>{
  b.addEventListener('click',()=>{
    document.querySelectorAll('[data-w]').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');_sw=parseInt(b.dataset.w);
  });
});

document.getElementById('drawSigBtn').addEventListener('click',()=>{
  sigCtx.clearRect(0,0,sigCvs.width,sigCvs.height);
  document.getElementById('sigHint').classList.remove('gone');
  openModal('sigModal');
  setTimeout(resizeSig,80);
});

document.getElementById('cancelSig').addEventListener('click',()=>{
  closeModal('sigModal');history.back();
});

document.getElementById('applySig').addEventListener('click',()=>{
  const d=sigCtx.getImageData(0,0,sigCvs.width,sigCvs.height);
  if(!d.data.some((_,i)=>i%4===3&&d.data[i]>10)){toast(tx('t_no_sig'));return}
  const dataUrl=cropSig().toDataURL('image/png');
  closeModal('sigModal');
  history.back();
  placeSig(dataUrl);
  toast(tx('t_placed'));
});

function cropSig(){
  const d=sigCtx.getImageData(0,0,sigCvs.width,sigCvs.height);
  let x0=sigCvs.width,y0=sigCvs.height,x1=0,y1=0;
  for(let y=0;y<sigCvs.height;y++)for(let x=0;x<sigCvs.width;x++){
    if(d.data[(y*sigCvs.width+x)*4+3]>8){
      if(x<x0)x0=x;if(x>x1)x1=x;if(y<y0)y0=y;if(y>y1)y1=y;
    }
  }
  const p=12;
  x0=Math.max(0,x0-p);y0=Math.max(0,y0-p);
  x1=Math.min(sigCvs.width,x1+p);y1=Math.min(sigCvs.height,y1+p);
  const w=x1-x0||sigCvs.width,h=y1-y0||sigCvs.height;
  const out=document.createElement('canvas');out.width=w;out.height=h;
  out.getContext('2d').putImageData(sigCtx.getImageData(x0,y0,w,h),0,0);
  return out;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PHOTO PERSISTENCE ‚Äî IndexedDB
   Photos are saved after every add/delete/crop so they survive
   back-navigation, app switching, or accidental exit.
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let _db=null;

function openDB(){
  return new Promise((res,rej)=>{
    if(_db){res(_db);return}
    const req=indexedDB.open('photopdf',1);
    req.onupgradeneeded=e=>{
      const db=e.target.result;
      if(!db.objectStoreNames.contains('photos'))
        db.createObjectStore('photos',{keyPath:'id',autoIncrement:true});
    };
    req.onsuccess=e=>{_db=e.target.result;res(_db)};
    req.onerror=()=>rej(req.error);
  });
}

async function savePhotos(){
  try{
    const db=await openDB();
    const srcs=Array.from(photoList.querySelectorAll('.pi img')).map(i=>i.src);
    const tx2=db.transaction('photos','readwrite');
    const store=tx2.objectStore('photos');
    store.clear();
    srcs.forEach((src,i)=>store.add({id:i+1,src}));
  }catch(e){/* silently ignore ‚Äî persistence is best-effort */}
}

async function restorePhotos(){
  try{
    const db=await openDB();
    const tx2=db.transaction('photos','readonly');
    const store=tx2.objectStore('photos');
    const req=store.getAll();
    req.onsuccess=()=>{
      const rows=req.result||[];
      rows.forEach(row=>addPhotoCard(row.src,true));
    };
  }catch(e){}
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   INIT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
lang=localStorage.getItem('lang')||'tr';
applyLang();
restorePhotos();
</script>
</body>
</html>

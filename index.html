<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FotoPDF</title>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        :root {
            --bg: #0d0d11;
            --surface: #16161e;
            --surface2: #1e1e28;
            --surface3: #252530;
            --accent: #f5c842;
            --accent2: #f07840;
            --green: #4caf82;
            --red: #e05252;
            --blue: #5b9cf6;
            --text: #edeae2;
            --muted: #6a6a7e;
            --border: #252530;
            --radius: 12px;
            --ease: cubic-bezier(.4,0,.2,1);
        }

        html, body { height: 100%; overflow: hidden; }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            height: 100dvh;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           HEADER
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        header {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 18px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            z-index: 10;
        }
        .logo {
            font-family: 'Syne', sans-serif;
            font-weight: 800;
            font-size: 1.2rem;
        }
        .logo span { color: var(--accent); }
        .count-pill {
            background: var(--surface2);
            border: 1px solid var(--border);
            padding: 5px 14px;
            border-radius: 999px;
            font-size: 0.78rem;
            color: var(--muted);
        }
        .count-pill b { color: var(--accent); }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           SETTINGS BAR
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .settings-bar {
            flex-shrink: 0;
            display: flex;
            gap: 8px;
            padding: 10px 14px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            overflow-x: auto;
            scrollbar-width: none;
        }
        .settings-bar::-webkit-scrollbar { display: none; }
        .setting-chip {
            display: flex;
            flex-direction: column;
            gap: 3px;
            flex-shrink: 0;
        }
        .setting-chip label {
            font-size: 0.65rem;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.07em;
            white-space: nowrap;
        }
        select {
            background: var(--surface2);
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 8px;
            padding: 6px 10px;
            font-size: 0.82rem;
            font-family: inherit;
            cursor: pointer;
            outline: none;
        }
        select:focus { border-color: var(--accent); }
        .quality-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        input[type="range"] {
            width: 90px;
            accent-color: var(--accent);
            cursor: pointer;
        }
        .quality-val { font-size: 0.8rem; color: var(--accent); font-weight: 700; min-width: 34px; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           SCROLLABLE CONTENT
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .content-scroll {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            padding: 14px;
        }

        /* Drop Zone */
        .drop-zone {
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            padding: 28px 16px;
            text-align: center;
            background: var(--surface);
            cursor: pointer;
            transition: border 0.2s var(--ease), background 0.2s var(--ease);
            margin-bottom: 14px;
            position: relative;
        }
        .drop-zone:hover, .drop-zone.drag-over {
            border-color: var(--accent);
            background: rgba(245,200,66,0.04);
        }
        .drop-zone input[type="file"] {
            position: absolute;
            inset: 0;
            opacity: 0;
            cursor: pointer;
            width: 100%;
            height: 100%;
        }
        .drop-icon { font-size: 2rem; margin-bottom: 6px; }
        .drop-zone h3 { font-family: 'Syne', sans-serif; font-size: 0.95rem; margin-bottom: 4px; }
        .drop-zone p { font-size: 0.78rem; color: var(--muted); }

        /* Photo Grid */
        #photo-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 10px;
        }

        .photo-item {
            position: relative;
            border-radius: 10px;
            cursor: grab;
            animation: popIn 0.25s var(--ease);
            background: var(--surface2);
        }
        @keyframes popIn {
            from { opacity:0; transform:scale(.88); }
            to   { opacity:1; transform:scale(1); }
        }
        .photo-item:active { cursor: grabbing; }

        .photo-item img {
            width: 100%;
            height: 130px;
            object-fit: cover;
            border-radius: 10px;
            display: block;
            pointer-events: none;
        }

        /* Order badge */
        .order-badge {
            position: absolute;
            bottom: 6px;
            left: 6px;
            background: rgba(0,0,0,0.68);
            color: #fff;
            font-size: 0.68rem;
            font-weight: 700;
            padding: 2px 7px;
            border-radius: 999px;
            pointer-events: none;
            backdrop-filter: blur(3px);
        }

        /* Overlay buttons on hover */
        .photo-overlay {
            position: absolute;
            inset: 0;
            border-radius: 10px;
            background: rgba(0,0,0,0.45);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            opacity: 0;
            transition: opacity 0.18s var(--ease);
        }
        .photo-item:hover .photo-overlay { opacity: 1; }

        .overlay-btn {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.15s;
        }
        .overlay-btn:hover { transform: scale(1.12); }
        .overlay-btn.edit  { background: var(--blue); color: #fff; }
        .overlay-btn.del   { background: var(--red);  color: #fff; }

        /* Sortable states */
        .sortable-ghost   { opacity: 0.25; }
        .sortable-chosen  { transform: scale(1.04); box-shadow: 0 8px 28px rgba(0,0,0,.5); z-index: 5; }

        /* Empty state */
        .empty-state {
            grid-column: 1/-1;
            text-align: center;
            padding: 30px;
            color: var(--muted);
            font-size: 0.85rem;
            line-height: 1.7;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ACTION BAR (fixed bottom)
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .action-bar {
            flex-shrink: 0;
            display: flex;
            gap: 8px;
            padding: 10px 14px;
            background: var(--surface);
            border-top: 1px solid var(--border);
            /* safe area for phones */
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
        }

        .btn {
            padding: 12px 18px;
            border: none;
            border-radius: 10px;
            font-family: 'Syne', sans-serif;
            font-weight: 700;
            font-size: 0.88rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: opacity 0.18s, transform 0.18s var(--ease);
            white-space: nowrap;
        }
        .btn:hover:not(:disabled) { opacity: 0.85; transform: translateY(-1px); }
        .btn:active:not(:disabled) { transform: translateY(0); }
        .btn:disabled { opacity: 0.35; cursor: not-allowed; }

        .btn-select {
            background: var(--surface2);
            color: var(--text);
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }
        .btn-select input[type="file"] {
            position: absolute;
            inset: 0;
            opacity: 0;
            cursor: pointer;
        }

        .btn-clear {
            background: transparent;
            color: var(--red);
            border: 1px solid var(--red);
        }

        .btn-pdf {
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            color: #111;
            flex: 1;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           CROP MODAL
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .modal-backdrop {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(8px);
            z-index: 500;
            flex-direction: column;
        }
        .modal-backdrop.open { display: flex; }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }
        .modal-header h2 { font-family: 'Syne', sans-serif; font-size: 1rem; }

        .modal-toolbar {
            display: flex;
            gap: 6px;
            padding: 10px 14px;
            background: var(--surface2);
            flex-shrink: 0;
            overflow-x: auto;
            scrollbar-width: none;
        }
        .modal-toolbar::-webkit-scrollbar { display: none; }

        .tool-btn {
            padding: 7px 14px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text);
            font-family: 'DM Sans', sans-serif;
            font-size: 0.8rem;
            cursor: pointer;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background 0.15s, border-color 0.15s;
        }
        .tool-btn:hover { background: var(--surface3); border-color: var(--accent); }
        .tool-btn.active { background: var(--accent); color: #111; border-color: var(--accent); font-weight: 600; }

        .aspect-group {
            display: flex;
            gap: 4px;
            align-items: center;
        }
        .aspect-label {
            font-size: 0.7rem;
            color: var(--muted);
            white-space: nowrap;
            margin-left: 4px;
        }

        .modal-canvas-area {
            flex: 1;
            overflow: hidden;
            position: relative;
            background: #0a0a0e;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-canvas-area img {
            max-width: 100%;
            max-height: 100%;
            display: block;
        }

        .modal-footer {
            display: flex;
            gap: 8px;
            padding: 10px 14px;
            background: var(--surface);
            border-top: 1px solid var(--border);
            flex-shrink: 0;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
        }
        .btn-cancel { background: var(--surface2); color: var(--text); border: 1px solid var(--border); flex: 1; }
        .btn-reset  { background: transparent; color: var(--muted); border: 1px solid var(--border); }
        .btn-apply  { background: linear-gradient(135deg, var(--green), #3a9e6a); color: #fff; flex: 2; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           PROGRESS OVERLAY
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .progress-backdrop {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(6px);
            z-index: 600;
            align-items: center;
            justify-content: center;
        }
        .progress-backdrop.open { display: flex; }
        .progress-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 28px 32px;
            text-align: center;
            min-width: 240px;
        }
        .progress-card h3 { font-family: 'Syne', sans-serif; margin-bottom: 16px; }
        .progress-track {
            width: 100%;
            height: 7px;
            background: var(--surface2);
            border-radius: 999px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--accent2));
            border-radius: 999px;
            transition: width 0.2s var(--ease);
            width: 0%;
        }
        .progress-note { font-size: 0.8rem; color: var(--muted); }

        /* Toast */
        .toast {
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%) translateY(-6px);
            background: var(--surface2);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 9px 18px;
            border-radius: 10px;
            font-size: 0.84rem;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.25s, transform 0.25s;
            z-index: 700;
            white-space: nowrap;
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        /* Responsive */
        @media (max-width: 420px) {
            #photo-list { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); }
            .photo-item img { height: 100px; }
            .photo-overlay { opacity: 1; background: rgba(0,0,0,0.25); }
            .overlay-btn { width: 28px; height: 28px; font-size: 12px; }
        }
    </style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â• HEADER â•â•â•â•â•â•â•â•â•â• -->
<header>
    <div class="logo">Foto<span>PDF</span></div>
    <div class="count-pill" id="countPill">FotoÄŸraf: <b>0</b></div>
</header>

<!-- â•â•â•â•â•â•â•â•â•â• SETTINGS â•â•â•â•â•â•â•â•â•â• -->
<div class="settings-bar">
    <div class="setting-chip">
        <label>Sayfa Boyutu</label>
        <select id="pageSize">
            <option value="a4">A4</option>
            <option value="a5">A5</option>
            <option value="letter">Letter</option>
            <option value="square">Kare 15cm</option>
        </select>
    </div>
    <div class="setting-chip">
        <label>YÃ¶n</label>
        <select id="orientation">
            <option value="auto">Otomatik</option>
            <option value="portrait">Dikey</option>
            <option value="landscape">Yatay</option>
        </select>
    </div>
    <div class="setting-chip">
        <label>Kenar BoÅŸluk</label>
        <select id="margin">
            <option value="8">Normal (8mm)</option>
            <option value="0">KenarsÄ±z</option>
            <option value="15">GeniÅŸ (15mm)</option>
        </select>
    </div>
    <div class="setting-chip">
        <label>Kalite: <span id="qualityVal" class="quality-val">85%</span></label>
        <div class="quality-row">
            <input type="range" id="qualityRange" min="40" max="100" value="85">
        </div>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• SCROLL AREA â•â•â•â•â•â•â•â•â•â• -->
<div class="content-scroll">
    <!-- Drop Zone -->
    <div class="drop-zone" id="dropZone">
        <input type="file" id="fileInput" multiple accept="image/*">
        <div class="drop-icon">ğŸ“·</div>
        <h3>FotoÄŸraf Ekle</h3>
        <p>TÄ±kla veya sÃ¼rÃ¼kleyip bÄ±rak Â· JPG, PNG, WebP</p>
    </div>

    <!-- Photo Grid -->
    <div id="photo-list">
        <div class="empty-state" id="emptyState">
            ğŸ“‚ HenÃ¼z fotoÄŸraf eklenmedi.<br>
            YukarÄ±dan seÃ§erek baÅŸlayÄ±n.
        </div>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• ACTION BAR â•â•â•â•â•â•â•â•â•â• -->
<div class="action-bar">
    <button class="btn btn-select">
        ï¼‹ Ekle
        <input type="file" id="fileInput2" multiple accept="image/*">
    </button>
    <button class="btn btn-clear" id="clearBtn" disabled>ğŸ—‘</button>
    <button class="btn btn-pdf" id="pdfBtn" disabled>ğŸ“„ PDF Ä°ndir</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• CROP MODAL â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-backdrop" id="cropModal">
    <div class="modal-header">
        <h2>âœ‚ï¸ FotoÄŸrafÄ± DÃ¼zenle</h2>
        <span style="color:var(--muted);font-size:0.8rem;" id="editIndex"></span>
    </div>

    <div class="modal-toolbar">
        <!-- Aspect ratios -->
        <span class="aspect-label">Oran:</span>
        <button class="tool-btn active" data-ratio="free">Serbest</button>
        <button class="tool-btn" data-ratio="1">1:1</button>
        <button class="tool-btn" data-ratio="1.333">4:3</button>
        <button class="tool-btn" data-ratio="1.778">16:9</button>
        <button class="tool-btn" data-ratio="0.707">A4</button>

        <div style="width:1px;background:var(--border);margin:0 4px;flex-shrink:0;"></div>

        <!-- Actions -->
        <button class="tool-btn" id="rotateLeft">â†º Sol</button>
        <button class="tool-btn" id="rotateRight">â†» SaÄŸ</button>
        <button class="tool-btn" id="flipH">â‡„ Yatay</button>
        <button class="tool-btn" id="flipV">â‡… Dikey</button>
        <button class="tool-btn" id="zoomIn">ğŸ”+</button>
        <button class="tool-btn" id="zoomOut">ğŸ”âˆ’</button>
    </div>

    <div class="modal-canvas-area">
        <img id="cropImage" src="" alt="">
    </div>

    <div class="modal-footer">
        <button class="btn btn-cancel" id="cancelEdit">Ä°ptal</button>
        <button class="btn btn-reset"  id="resetEdit">SÄ±fÄ±rla</button>
        <button class="btn btn-apply"  id="applyEdit">âœ“ Uygula</button>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• PROGRESS â•â•â•â•â•â•â•â•â•â• -->
<div class="progress-backdrop" id="progressBack">
    <div class="progress-card">
        <h3>PDF OluÅŸturuluyorâ€¦</h3>
        <div class="progress-track">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-note" id="progressNote">HazÄ±rlanÄ±yorâ€¦</div>
    </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const { jsPDF } = window.jspdf;
const photoList   = document.getElementById('photo-list');
const emptyState  = document.getElementById('emptyState');
const countPill   = document.getElementById('countPill');
const pdfBtn      = document.getElementById('pdfBtn');
const clearBtn    = document.getElementById('clearBtn');
const cropModal   = document.getElementById('cropModal');
const cropImage   = document.getElementById('cropImage');
const progressBack  = document.getElementById('progressBack');
const progressFill  = document.getElementById('progressFill');
const progressNote  = document.getElementById('progressNote');
const toastEl     = document.getElementById('toast');

let cropper = null;
let editingItem = null;   // DOM element being edited
let originalSrc = null;   // untouched src for reset

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SORTABLE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
new Sortable(photoList, {
    animation: 200,
    ghostClass: 'sortable-ghost',
    chosenClass: 'sortable-chosen',
    filter: '.empty-state',
    onEnd: refreshBadges
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FILE INPUT EVENTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.getElementById('fileInput').addEventListener('change',  e => loadFiles(e.target.files));
document.getElementById('fileInput2').addEventListener('change', e => loadFiles(e.target.files));

/* Drag & drop on the drop zone */
const dropZone = document.getElementById('dropZone');
dropZone.addEventListener('dragover',  e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
dropZone.addEventListener('dragleave', ()=> dropZone.classList.remove('drag-over'));
dropZone.addEventListener('drop',      e => { e.preventDefault(); dropZone.classList.remove('drag-over'); loadFiles(e.dataTransfer.files); });

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOAD FILES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function loadFiles(files) {
    const imgs = Array.from(files).filter(f => f.type.startsWith('image/'));
    if (!imgs.length) return;
    imgs.forEach(f => {
        const reader = new FileReader();
        reader.onload = e => createPhotoItem(e.target.result);
        reader.readAsDataURL(f);
    });
    document.getElementById('fileInput').value  = '';
    document.getElementById('fileInput2').value = '';
}

function createPhotoItem(src) {
    // Remove empty state
    emptyState.style.display = 'none';

    const div = document.createElement('div');
    div.className = 'photo-item';

    const img = document.createElement('img');
    img.src = src;
    img.draggable = false;

    const badge = document.createElement('div');
    badge.className = 'order-badge';

    // Overlay with edit & delete
    const overlay = document.createElement('div');
    overlay.className = 'photo-overlay';

    const editBtn = document.createElement('button');
    editBtn.className = 'overlay-btn edit';
    editBtn.innerHTML = 'âœï¸';
    editBtn.title = 'DÃ¼zenle / KÄ±rp';
    editBtn.onclick = (e) => { e.stopPropagation(); openEditor(div); };

    const delBtn = document.createElement('button');
    delBtn.className = 'overlay-btn del';
    delBtn.innerHTML = 'âœ•';
    delBtn.title = 'Sil';
    delBtn.onclick = (e) => { e.stopPropagation(); removeItem(div); };

    overlay.appendChild(editBtn);
    overlay.appendChild(delBtn);
    div.appendChild(img);
    div.appendChild(badge);
    div.appendChild(overlay);
    photoList.appendChild(div);

    refreshBadges();
    updateState();
}

function removeItem(div) {
    div.style.animation = 'popIn 0.2s reverse';
    setTimeout(() => { div.remove(); refreshBadges(); updateState(); }, 180);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CLEAR ALL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
clearBtn.addEventListener('click', () => {
    if (!confirm('TÃ¼m fotoÄŸraflar silinsin mi?')) return;
    photoList.querySelectorAll('.photo-item').forEach(el => el.remove());
    updateState();
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BADGES & STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function refreshBadges() {
    photoList.querySelectorAll('.photo-item .order-badge').forEach((b, i) => {
        b.textContent = i + 1;
    });
}

function updateState() {
    const count = photoList.querySelectorAll('.photo-item').length;
    countPill.innerHTML = `FotoÄŸraf: <b>${count}</b>`;
    pdfBtn.disabled   = count === 0;
    clearBtn.disabled = count === 0;
    if (count === 0) emptyState.style.display = '';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   QUALITY SLIDER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.getElementById('qualityRange').addEventListener('input', function() {
    document.getElementById('qualityVal').textContent = this.value + '%';
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CROP / EDIT MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openEditor(item) {
    editingItem = item;
    const img = item.querySelector('img');
    originalSrc = img.src;

    cropImage.src = img.src;
    document.getElementById('editIndex').textContent =
        '#' + (Array.from(photoList.querySelectorAll('.photo-item')).indexOf(item) + 1);

    cropModal.classList.add('open');

    // Reset aspect buttons
    document.querySelectorAll('[data-ratio]').forEach(b => b.classList.remove('active'));
    document.querySelector('[data-ratio="free"]').classList.add('active');

    // Init Cropper after image loads
    cropImage.onload = () => {
        if (cropper) { cropper.destroy(); cropper = null; }
        cropper = new Cropper(cropImage, {
            viewMode: 1,
            autoCropArea: 0.9,
            movable: true,
            scalable: true,
            zoomable: true,
            background: true,
            responsive: true,
        });
    };
    // If already cached:
    if (cropImage.complete) cropImage.onload();
}

function closeEditor() {
    if (cropper) { cropper.destroy(); cropper = null; }
    cropModal.classList.remove('open');
    editingItem = null;
}

// Aspect ratio buttons
document.querySelectorAll('[data-ratio]').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('[data-ratio]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        if (!cropper) return;
        const val = btn.dataset.ratio;
        cropper.setAspectRatio(val === 'free' ? NaN : parseFloat(val));
    });
});

// Tool buttons
document.getElementById('rotateLeft').addEventListener('click',  () => cropper?.rotate(-90));
document.getElementById('rotateRight').addEventListener('click', () => cropper?.rotate(90));
document.getElementById('zoomIn').addEventListener('click',  () => cropper?.zoom(0.1));
document.getElementById('zoomOut').addEventListener('click', () => cropper?.zoom(-0.1));

let scaleX = 1, scaleY = 1;
document.getElementById('flipH').addEventListener('click', () => {
    scaleX *= -1;
    cropper?.scaleX(scaleX);
});
document.getElementById('flipV').addEventListener('click', () => {
    scaleY *= -1;
    cropper?.scaleY(scaleY);
});

// Reset
document.getElementById('resetEdit').addEventListener('click', () => {
    scaleX = 1; scaleY = 1;
    cropImage.src = originalSrc;
    if (cropper) { cropper.destroy(); cropper = null; }
    cropImage.onload = () => {
        cropper = new Cropper(cropImage, {
            viewMode: 1, autoCropArea: 0.9, movable: true, scalable: true, zoomable: true, background: true, responsive: true,
        });
    };
    if (cropImage.complete) cropImage.onload();
});

// Cancel
document.getElementById('cancelEdit').addEventListener('click', closeEditor);

// Apply crop
document.getElementById('applyEdit').addEventListener('click', () => {
    if (!cropper || !editingItem) return;
    const canvas = cropper.getCroppedCanvas({ maxWidth: 2400, maxHeight: 2400, imageSmoothingQuality: 'high' });
    if (!canvas) return;
    const newSrc = canvas.toDataURL('image/jpeg', 0.95);
    editingItem.querySelector('img').src = newSrc;
    closeEditor();
    showToast('âœ… DÃ¼zenleme uygulandÄ±');
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PDF GENERATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const PAGE_SIZES = {
    a4:     [210, 297],
    a5:     [148, 210],
    letter: [215.9, 279.4],
    square: [150, 150]
};

pdfBtn.addEventListener('click', async () => {
    const items = Array.from(photoList.querySelectorAll('.photo-item'));
    if (!items.length) return;

    const sizeKey    = document.getElementById('pageSize').value;
    const orientation= document.getElementById('orientation').value;
    const marginMM   = parseInt(document.getElementById('margin').value);
    const quality    = parseInt(document.getElementById('qualityRange').value) / 100;
    const [pw0, ph0] = PAGE_SIZES[sizeKey];

    progressBack.classList.add('open');
    pdfBtn.disabled = true;

    let doc = null;

    for (let i = 0; i < items.length; i++) {
        const img = items[i].querySelector('img');

        // Determine page orientation
        let ori = 'portrait';
        if (orientation === 'landscape') ori = 'landscape';
        else if (orientation === 'auto' && img.naturalWidth > img.naturalHeight) ori = 'landscape';

        const pw = ori === 'landscape' ? ph0 : pw0;
        const ph = ori === 'landscape' ? pw0 : ph0;

        if (i === 0) {
            doc = new jsPDF({ orientation: ori, unit: 'mm', format: [pw, ph] });
        } else {
            doc.addPage([pw, ph], ori);
        }

        // Scale image to fit page with margin
        const avW = pw - marginMM * 2;
        const avH = ph - marginMM * 2;
        const ratio = img.naturalWidth / img.naturalHeight;
        let dw = avW, dh = dw / ratio;
        if (dh > avH) { dh = avH; dw = dh * ratio; }
        const x = (pw - dw) / 2;
        const y = (ph - dh) / 2;

        // Render to canvas with quality
        const canvas = document.createElement('canvas');
        canvas.width  = img.naturalWidth;
        canvas.height = img.naturalHeight;
        canvas.getContext('2d').drawImage(img, 0, 0);
        const data = canvas.toDataURL('image/jpeg', quality);

        doc.addImage(data, 'JPEG', x, y, dw, dh);

        const pct = Math.round(((i + 1) / items.length) * 100);
        progressFill.style.width = pct + '%';
        progressNote.textContent = `${i + 1} / ${items.length} fotoÄŸraf iÅŸlendi`;

        await new Promise(r => setTimeout(r, 20));
    }

    doc.save(`fotopdf-${Date.now()}.pdf`);
    progressBack.classList.remove('open');
    progressFill.style.width = '0%';
    pdfBtn.disabled = false;
    showToast('âœ… PDF baÅŸarÄ±yla indirildi!');
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let toastTimer;
function showToast(msg, ms = 2600) {
    toastEl.textContent = msg;
    toastEl.classList.add('show');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => toastEl.classList.remove('show'), ms);
}
</script>
</body>
</html>
